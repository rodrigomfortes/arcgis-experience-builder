System.register(["jimu-core","jimu-ui","esri/form/FormTemplate","esri/rest/support/Query","esri/form/elements/FieldElement","esri/form/elements/GroupElement","esri/widgets/FeatureForm","esri/Graphic","jimu-arcgis","esri/core/reactiveUtils","esri/widgets/Editor"],(function(e,t){var i={},a={},o={},n={},r={},l={},s={},d={},c={},u={},f={};return{setters:[function(e){i.DataSourceComponent=e.DataSourceComponent,i.DataSourceManager=e.DataSourceManager,i.DataSourceTypes=e.DataSourceTypes,i.ExBAddedJSAPIProperties=e.ExBAddedJSAPIProperties,i.Immutable=e.Immutable,i.JSAPILayerTypes=e.JSAPILayerTypes,i.React=e.React,i.ServiceManager=e.ServiceManager,i.SessionManager=e.SessionManager,i.SupportedLayerServiceTypes=e.SupportedLayerServiceTypes,i.WidgetVersionManager=e.WidgetVersionManager,i.classNames=e.classNames,i.css=e.css,i.dataSourceUtils=e.dataSourceUtils,i.defaultMessages=e.defaultMessages,i.esri=e.esri,i.hooks=e.hooks,i.jsx=e.jsx,i.privilegeUtils=e.privilegeUtils,i.useIntl=e.useIntl},function(e){a.Button=e.Button,a.ConfirmDialog=e.ConfirmDialog,a.Loading=e.Loading,a.Select=e.Select,a.TextInput=e.TextInput,a.WidgetPlaceholder=e.WidgetPlaceholder,a.defaultMessages=e.defaultMessages},function(e){o.default=e.default},function(e){n.default=e.default},function(e){r.default=e.default},function(e){l.default=e.default},function(e){s.default=e.default},function(e){d.default=e.default},function(e){c.JimuMapViewComponent=e.JimuMapViewComponent,c.SnappingUtils=e.SnappingUtils},function(e){u.watch=e.watch},function(e){f.default=e.default}],execute:function(){e((()=>{var e={14321:e=>{"use strict";e.exports=a},18200:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" fill-rule="evenodd" d="m14.071 2.828 1.414-1.414 2.829 2.829-1.415 1.414zm-.707.708L8.038 8.86l.236 2.593 2.593.236 5.325-5.326zm-6.01 8.838 3.889.354 8.485-8.485L15.485 0 7 8.485zM8.5 3H0v17h17v-8.5h-1V19H1V4h7.5z" clip-rule="evenodd"></path></svg>'},20277:e=>{"use strict";e.exports=l},22089:e=>{"use strict";e.exports=d},23662:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M7.5 0a.5.5 0 0 0-.5.5V7H.5a.5.5 0 0 0 0 1H7v6.5a.5.5 0 0 0 1 0V8h6.5a.5.5 0 0 0 0-1H8V.5a.5.5 0 0 0-.5-.5"></path></svg>'},28996:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M8 2.125 14.334 14H1.667zm-.882-.47a1 1 0 0 1 1.765 0l6.333 11.874A1 1 0 0 1 14.334 15H1.667a1 1 0 0 1-.882-1.47zM8 4.874a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0L8.9 5.87a.905.905 0 0 0-.9-.995m1 7a1 1 0 1 1-2 0 1 1 0 0 1 2 0" clip-rule="evenodd"></path></svg>'},36510:e=>{"use strict";e.exports=n},38410:e=>{"use strict";e.exports=o},45508:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2M6.5 7.5A.5.5 0 0 1 7 7h1.5v4.5h1a.5.5 0 0 1 0 1h-3a.5.5 0 0 1 0-1h1V8H7a.5.5 0 0 1-.5-.5"></path><path fill="#000" fill-rule="evenodd" d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16m0-1A7 7 0 1 0 8 1a7 7 0 0 0 0 14" clip-rule="evenodd"></path></svg>'},48816:e=>{"use strict";e.exports=f},50170:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0m-1.27 4.936a6.5 6.5 0 1 1 .707-.707l4.136 4.137a.5.5 0 1 1-.707.707z" clip-rule="evenodd"></path></svg>'},62243:e=>{"use strict";e.exports=u},62686:e=>{"use strict";e.exports=c},73387:e=>{"use strict";e.exports=s},79244:e=>{"use strict";e.exports=i},82228:e=>{"use strict";e.exports=r}},t={};function p(i){var a=t[i];if(void 0!==a)return a.exports;var o=t[i]={exports:{}};return e[i](o,o.exports,p),o.exports}p.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return p.d(t,{a:t}),t},p.d=(e,t)=>{for(var i in t)p.o(t,i)&&!p.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},p.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),p.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},p.p="";var v={};return p.p=window.jimuConfig.baseUrl,(()=>{"use strict";p.r(v),p.d(v,{__set_webpack_public_path__:()=>et,default:()=>Ze});var e,t,i,a,o=p(79244);!function(e){e.Attribute="ATTRIBUTE",e.Geometry="GEOMETRY"}(e||(e={})),function(e){e.Webmap="WEBMAP",e.Custom="CUSTOM"}(t||(t={})),function(e){e.NoMap="NOMAP",e.NoLayer="NOEDITABLE"}(i||(i={})),function(e){e.Prescriptive="PRESCRIPTIVE",e.Flexible="FLEXIBLE"}(a||(a={}));var n=p(14321),r=p(38410);const l={_widgetLabel:"Edit",initAttEmptyMessage:"Please add an editable source.",noRecordTips:"No valid record is selected, select one or add one.",addFeature:"Add feature",update:"Update",deleteRecord:"Delete this record?",deleteRecordTips:"This record will be permanently removed.",keepRecord:"Keep record",_action_edit_label:"Edit",selectionChangeConfirmTitle:"Discard the edits?",selectionChangeConfirmTips:"You have unsaved edits that could be lost.",discardConfirm:"Discard edits",discardCancel:"Continue editing",ownerAdminNotice:"Editing is restricted but you have privileges to edit this layer."},s=["CreationDate","Creator","EditDate","Editor","GlobalID"],d=[o.JSAPILayerTypes.FeatureLayer,o.JSAPILayerTypes.SceneLayer,o.JSAPILayerTypes.BuildingComponentSublayer,o.JSAPILayerTypes.OrientedImageryLayer,o.JSAPILayerTypes.SubtypeSublayer],c=(0,o.Immutable)([o.DataSourceTypes.FeatureLayer,o.DataSourceTypes.SceneLayer,o.DataSourceTypes.BuildingComponentSubLayer,o.DataSourceTypes.OrientedImageryLayer,o.DataSourceTypes.SubtypeSublayer]),u=(e,t)=>!!e&&(Array.isArray(e)?null==e?void 0:e.join().toLowerCase().includes(t):null==e?void 0:e.toLowerCase().includes(t)),f=e=>{const t=null==e?void 0:e.allowGeometryUpdates,i=null==e?void 0:e.capabilities;return{allowGeometryUpdates:t,create:u(i,"create"),update:u(i,"update"),deletable:u(i,"delete")}};function m(e){if(!e)return[];const t=e.objectIdField,{creationDateField:i,creatorField:a,editDateField:o,editorField:n}=e.editFieldsInfo||{},{shapeAreaFieldName:r,shapeLengthFieldName:l}=e.geometryProperties||{};return[t,i,a,o,n,r,l].filter(Boolean)}const g=e=>{const t=[];return null==e||e.forEach((e=>{"group"===e.type?t.push(...g(e.elements)):t.push(e)})),t},y=e=>o.DataSourceManager.getInstance().getDataSource(e),b=e=>{const t=(null==e?void 0:e.type)===o.DataSourceTypes.SceneLayer||(null==e?void 0:e.type)===o.DataSourceTypes.BuildingComponentSubLayer;null==e||e.type,o.DataSourceTypes.OrientedImageryLayer;let i;return i=t?e.getAssociatedDataSource():e,i};var h=p(36510),S=p(82228),w=p(20277),x=function(e,t,i,a){return new(i||(i=Promise))((function(o,n){function r(e){try{s(a.next(e))}catch(e){n(e)}}function l(e){try{s(a.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}s((a=a.apply(e,t||[])).next())}))};const j="esri-item-list",C="esri-widget",I="esri-editor__header",R="esri-feature-form__form-header",E="esri-feature-form__description-text",_="esri-button--disabled",N="esri-widget__heading",k="esri-feature-form",T="esri-editor__scroller",L="esri-editor__content",D="esri-item-list__list",F="esri-item-list__group",O="esri-item-list__no-matches-message",M="esri-item-list__list-item-label",A="esri-item-list__list-item-container",V="esri-item-list__list-item",P="esri-item-list__group-header",B="esri-editor__back-button",U="esri-widget__heading",J="esri-editor__warning-option",G="esri-editor__warning-option--primary",W="esri-editor__warning-option--positive",$="esri-editor__prompt--danger",H="esri-editor__prompt__header",z="esri-editor__prompt__header__heading",q="esri-editor__prompt__message",K="esri-editor__prompt__divider",Y="esri-editor__prompt__actions",X=e=>{const t=[];for(const i in e)(null==e?void 0:e[i])&&t.push(...e[i]);return t},Q=(e,t)=>{const i=[],a=null==t?void 0:t.dataSourceId;for(const t in e)0===t.indexOf(a)&&(null==e?void 0:e[t])&&i.push(...e[t]);return i};const Z=e=>x(void 0,void 0,void 0,(function*(){if(!e)return!1;const t=o.esri.restRequest.request;try{const i=yield t(`${e}?f=json`);return!Object.keys(i).includes("error")}catch(e){return!1}})),ee=e=>x(void 0,void 0,void 0,(function*(){var t;const i=yield null==e?void 0:e.fetchItemInfo().then((e=>e)).catch((e=>{console.error(e)}));if(!i||!i.url)return!1;const a=null===(t=yield o.ServiceManager.getInstance().fetchArcGISServerInfo(i.url))||void 0===t?void 0:t.owningSystemUrl;if(!a)return!1;const n=o.SessionManager.getInstance().getSessionByUrl(a);if(!n)return!1;const r=yield n.getUser(),l="org_admin"===(null==r?void 0:r.role),s=null==i?void 0:i.isOrgItem,d=((null==r?void 0:r.privileges)||[]).includes("portal:admin:updateItems"),c=l&&s&&d,u=i.owner===(null==r?void 0:r.username),f=yield o.privilegeUtils.isItemInTheUpdatedGroup(i.id,n);return c||u||f})),te=e=>o.dataSourceUtils.getTimezoneAPIFromRuntime(e.getTimezone()),ie=(e,t)=>Array.isArray(e)&&Array.isArray(t)&&e.length===t.length&&e.every(((e,i)=>t[i]===e)),ae=e=>{var t;const i=null==e?void 0:e.getLayerDefinition(),a=null===(t=e.belongToDataSource)||void 0===t?void 0:t.getLayerDefinition();return(null==i?void 0:i.displayField)||(null==a?void 0:a.displayField)||(null==i?void 0:i.objectIdField)||(null==a?void 0:a.objectIdField)||"OBJECTID"},oe=e=>({layer:e,enabled:!1,addEnabled:!1,updateEnabled:!1,deleteEnabled:!1,attributeUpdatesEnabled:!1,geometryUpdatesEnabled:!1,attachmentsOnUpdateEnabled:!1}),ne=(e,t,i)=>e.filter((e=>!t.includes(e.jimuName))).map((e=>{if(e.children)return new w.default({label:e.name,description:e.subDescription||(null==e?void 0:e.description),elements:e.children.filter((e=>!t.includes(e.jimuName))).map((e=>new S.default({fieldName:e.jimuName,label:e.alias||e.name,description:e.subDescription||e.description,editableExpression:e.editAuthority?"true":"false"})))});{const t=i.find((t=>t.fieldName===e.jimuName)),a=t?t.clone():new S.default({fieldName:e.jimuName,label:(null==e?void 0:e.alias)||(null==e?void 0:e.name)});return a.description=e.subDescription||(null==e?void 0:e.description),a.editableExpression=e.editAuthority&&!a.valueExpression?"true":"false",a}})),re=(e,i,a,n,l)=>x(void 0,void 0,void 0,(function*(){let s,d=!1;const c=a.layer,u=null==c?void 0:c.userHasFullEditingPrivileges,p=yield ee(e),v=c.editingEnabled;let y=i;y||(y=((e,i)=>{var a,n,r,l,s;const d=e.getLayerDefinition(),{allowGeometryUpdates:c,create:u,update:p,deletable:v}=f(d),y=(null===(r=null===(n=null===(a=e.getSchema())||void 0===a?void 0:a.fields)||void 0===n?void 0:n.asMutable)||void 0===r?void 0:r.call(n,{deep:!0}))||{};let b=Object.values(y);b=b.filter((e=>!m(d).includes(e.name)));const h=null===(l=i.formTemplate)||void 0===l?void 0:l.elements;if(h){const e=g(h).filter((e=>"field"===e.type)).map((e=>e.fieldName));b=b.filter((t=>e.includes(t.name)))}(null==b?void 0:b.length)>50&&(b=b.slice(0,50));const S=(null==d?void 0:d.fields)||[],w=b.map((e=>{const t=S.find((t=>t.name===e.jimuName)),i=null==t?void 0:t.editable;return Object.assign(Object.assign({},e),{editAuthority:i,subDescription:(null==e?void 0:e.description)||"",editable:i})})),x={dataSourceId:e.id,mainDataSourceId:e.id,dataViewId:e.dataViewId,rootDataSourceId:null===(s=e.getRootDataSource())||void 0===s?void 0:s.id};return{id:e.id,name:e.getLabel(),useDataSource:(0,o.Immutable)(x),addRecords:u,deleteRecords:v,updateRecords:p,updateAttributes:p,updateGeometries:c&&p,showFields:b,groupedFields:w,layerHonorMode:t.Webmap}})(e,c));const b=e.getLayerDefinition(),h=m(b),S=((e,i,a,o)=>{const{groupedFields:n,layerHonorMode:l}=i,s=e.formTemplate,d=s?s.clone():new r.default,c=((null==s?void 0:s.elements)||[]).filter((e=>"field"===e.type));if(l===t.Custom&&(d.elements=ne(n,o,c)),!a&&d.elements)for(const e of d.elements)"relationship"===e.type&&(e.editableExpression="false");return d.title=(null==s?void 0:s.title)||e.title,d})(c,y,n,h);if(p||u)d=!0,s={layer:c,formTemplate:S,enabled:!0,addEnabled:!0,updateEnabled:!0,deleteEnabled:!0,attributeUpdatesEnabled:!0,geometryUpdatesEnabled:!0};else if(v&&e){const{addRecords:e,deleteRecords:t,updateRecords:i,updateAttributes:a,updateGeometries:o}=y;(p||(i||t))&&(d=!0);const n=(yield Z(null==c?void 0:c.url))||l,{allowGeometryUpdates:r,create:u,update:v,deletable:m}=f(b);s={layer:c,formTemplate:S,enabled:n&&(e||i||t),addEnabled:e&&u,updateEnabled:i&&v,deleteEnabled:t&&m,attributeUpdatesEnabled:a&&v,geometryUpdatesEnabled:o&&r}}else s=oe(c);return{showUpdateBtn:d,editorLayerInfo:s}})),le=(e,t)=>{var i;const{addFeatures:a=[],updateFeatures:o=[],deleteFeatures:n=[]}=t;for(const t of a){const i=e.buildRecord(t);e.afterAddRecord(i)}const r=e.getIdField();for(const t of o){const a=t.attributes[r],o=null===(i=e.getRecordById(a))||void 0===i?void 0:i.feature,n=(null==o?void 0:o.attributes)||{},l=Object.assign(n,null==t?void 0:t.attributes);t.attributes=l;const s=e.buildRecord(t);e.afterUpdateRecord(s)}for(const t of n){const i=e.buildRecord(t);e.afterDeleteRecordById(i.getId())}},se=(e,t)=>x(void 0,void 0,void 0,(function*(){const i=e.dataSource,a=e.layer,o=i.getGDBVersion();return a.applyEdits(t,{gdbVersion:o})}));var de=p(45508),ce=p.n(de),ue=function(e,t){var i={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(i[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(a=Object.getOwnPropertySymbols(e);o<a.length;o++)t.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(e,a[o])&&(i[a[o]]=e[a[o]])}return i};const fe=e=>{const t=window.SVG,{className:i}=e,a=ue(e,["className"]),n=(0,o.classNames)("jimu-icon jimu-icon-component",i);return t?o.React.createElement(t,Object.assign({className:n,src:ce()},a)):o.React.createElement("svg",Object.assign({className:n},a))},pe=e=>{const{emptyTips:t}=e;return(0,o.jsx)("div",{className:"surface-1 border-0 h-100",css:o.css`
    .edit-blank {
      min-height: 300px;
      .placeholder-icon{
        color: var(--ref-palette-neutral-800);
      }
      & > div{
        top: calc(50% + 20px);
        transform: translateY(-50%);
      }
      p{
        font-size: 14px;
        margin-top: 16px;
        line-height: 19px;
        color: var(--ref-palette-neutral-1000);
      }
    }
  `},(0,o.jsx)("div",{className:"w-100 text-center edit-blank"},(0,o.jsx)("div",{className:"position-absolute edit-blank-content w-100"},(0,o.jsx)(fe,{size:32,className:"placeholder-icon"}),(0,o.jsx)("p",null,t))))};var ve=p(28996),me=p.n(ve),ge=function(e,t){var i={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(i[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(a=Object.getOwnPropertySymbols(e);o<a.length;o++)t.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(e,a[o])&&(i[a[o]]=e[a[o]])}return i};const ye=e=>{const t=window.SVG,{className:i}=e,a=ge(e,["className"]),n=(0,o.classNames)("jimu-icon jimu-icon-component",i);return t?o.React.createElement(t,Object.assign({className:n,src:me()},a)):o.React.createElement("svg",Object.assign({className:n},a))},be=e=>{const{title:t,message:i,confirmText:a,cancelText:r,onConfirm:l,onCancel:s}=e;return(0,o.jsx)(o.React.Fragment,null,(0,o.jsx)("div",{className:"confirm-scrim",css:o.css`
    &.confirm-scrim{
      position: absolute;
      background-color: var(--calcite-scrim-background);
      width: 100%;
      height: 100%;
      top: 0;
    }
  `}),(0,o.jsx)("div",{className:$,css:o.css`
    &.confirm-scrim{
      position: absolute;
      background-color: var(--calcite-scrim-background);
      width: 100%;
      height: 100%;
      top: 0;
    }
    .esri-editor__prompt__actions{
      .esri-editor__warning-option--primary,
      .esri-editor__warning-option--positive{
        text-align: center;
        padding: 4px 16px;
        line-height: 22px;
        border: 1px solid var(--calcite-ui-danger);
        border-radius: 0;
        flex: 1;
      }
      .esri-editor__warning-option--primary{
        background-color: transparent;
        color: var(--calcite-ui-danger);
        :hover{
          border-color: var(--calcite-ui-danger-hover);
          color: var(--calcite-ui-danger-hover);
          box-shadow: inset 0 0 0 1px var(--calcite-ui-danger-hover);
        }
      }
      .esri-editor__warning-option--positive{
        background-color: var(--calcite-ui-danger);
        color: var(--ref-palette-white);
        :hover{
          border-color: var(--calcite-ui-danger-hover);
          background-color: var(--calcite-ui-danger-hover);
        }
      }
    }
  `},(0,o.jsx)("div",{className:H},(0,o.jsx)(ye,{width:24,height:24}),(0,o.jsx)("h4",{className:(0,o.classNames)(U,z)},t)),(0,o.jsx)("div",{className:q},i),(0,o.jsx)("div",{className:K}),(0,o.jsx)("div",{className:Y},(0,o.jsx)(n.Button,{className:(0,o.classNames)(J,G),onClick:s},r),(0,o.jsx)(n.Button,{className:(0,o.classNames)(J,W),onClick:l},a))))};var he=p(23662),Se=p.n(he),we=function(e,t){var i={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(i[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(a=Object.getOwnPropertySymbols(e);o<a.length;o++)t.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(e,a[o])&&(i[a[o]]=e[a[o]])}return i};const xe=e=>{const t=window.SVG,{className:i}=e,a=we(e,["className"]),n=(0,o.classNames)("jimu-icon jimu-icon-component",i);return t?o.React.createElement(t,Object.assign({className:n,src:Se()},a)):o.React.createElement("svg",Object.assign({className:n},a))},je=e=>{const{activeLayerInfo:t,widgetLabel:i,description:a,activeFeature:r,editCount:s,hasTableLayerAdd:d,featureFormStep:c,onBack:u,onNew:f}=e,p="list"===c||"empty"===c,v="form"===c||"new"===c;let m="";const g=o.hooks.useTranslation(l);if("new"===c)m=g("addFeature");else if("form"===c&&t&&r){const{dataSource:e}=t,i=ae(e);m=r.attributes[i]||""}const y=(0,o.useIntl)(),b=s>1?` (${y.formatNumber(s)})`:"";return(0,o.jsx)("div",{className:(0,o.classNames)({"d-flex":v}),css:o.css`
    border-bottom: 1px solid var(--sys-color-divider-secondary);
    .esri-feature-form__input:focus,
    calcite-input:focus{
      outline: unset !important;
      outline-offset: unset !important;
    }
    .esri-feature-form{
      background-color: unset;
      .esri-feature-form__form-header{
        margin: 0;
        .esri-feature-form__description-text{
          font-weight: 500;
          font-size: 13px;
          margin: 0;
        }
      }
    }
    .esri-editor__header{
      min-height: 56px;
      .esri-widget__heading{
        font-weight: 600;
        font-size: 16px;
        margin: 0 8px;
        text-align: left;
        padding: 1px 0;
        height: 56px;
        line-height: 54px
      }
    }
    .back-button{
      width: 32px;
      padding-inline: 8px;
      padding-block: 4px;
      line-height: 16px;
      color: var(--ref-palette-black);
      border-top: 0px !important;
      border-left: 0px !important;
      border-bottom: 0px !important;
      border-style: solid;
      border-color: var(--sys-color-divider-secondary);
      border-inline-end-width: 1px;
    }
    .add-feature-btn {
      position: absolute;
      right: 15px;
      top: 12px;
      button{
        width: 32px;
        height: 32px;
      }
    }
  `},v&&(0,o.jsx)("button",{id:"back_home",className:(0,o.classNames)("back-button surface-1",B),title:g("back"),onClick:u},"<"),p&&(0,o.jsx)("div",{className:k},(0,o.jsx)("div",{className:R},(0,o.jsx)("h2",{className:N},i+b),a&&(0,o.jsx)("p",{className:(0,o.classNames)(`text-truncate ${E}`),title:a},a))),v&&(0,o.jsx)("header",{className:I},(0,o.jsx)("h4",{className:(0,o.classNames)("text-truncate",N),title:m},m)),d&&p&&(0,o.jsx)(n.Button,{size:"sm",icon:!0,type:"tertiary",className:"add-feature-btn",onClick:f,title:g("addFeature"),"aria-label":g("addFeature")},(0,o.jsx)(xe,{className:"mr-1"}),g("add")))},Ce=e=>{const{buttons:t}=e;return(0,o.jsx)("div",{className:"d-flex justify-content-between form-buttons",css:o.css`
  &.form-buttons{
    border-top: 1px solid var(--sys-color-divider-secondary);
    padding: 12px 15px;
    display: flex;
    .single-button {
      flex: 1;
    }
    .multi-buttons {
      width: 49%;
    }
  }
`},t.map((({disabled:e=!1,label:i,type:a,clickHandler:r},l)=>(0,o.jsx)(n.Button,{key:l,className:(0,o.classNames)({"single-button":1===t.length,"multi-buttons":t.length>1,[_]:e}),type:a,disabled:e,onClick:r},i))))};var Ie=p(50170),Re=p.n(Ie),Ee=function(e,t){var i={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(i[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(a=Object.getOwnPropertySymbols(e);o<a.length;o++)t.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(e,a[o])&&(i[a[o]]=e[a[o]])}return i};const _e=e=>{const t=window.SVG,{className:i}=e,a=Ee(e,["className"]),n=(0,o.classNames)("jimu-icon jimu-icon-component",i);return t?o.React.createElement(t,Object.assign({className:n,src:Re()},a)):o.React.createElement("svg",Object.assign({className:n},a))},Ne=e=>{const{editFeatures:t,layersOrder:i,layersInfo:a,onClickItem:r}=e,[l,s]=o.React.useState(""),d=o.hooks.useTranslation(o.defaultMessages),{count:c,groupedSelectedFeatures:u}=o.React.useMemo((()=>{var e;let o=0;const n=[];for(const i in t){const r=t[i];if(0===r.length||!a[i])continue;const s=null===(e=a[i])||void 0===e?void 0:e.dataSource,d=s.getLabel(),c=ae(s),u=s.getIdField(),f={id:i,dsId:i,label:d,items:r.filter((e=>{var t,i,a,o;const n=(null===(t=e.feature.attributes)||void 0===t?void 0:t[c])||(null===(i=e.feature.attributes)||void 0===i?void 0:i[u])||(null===(a=e.feature.attributes)||void 0===a?void 0:a.objectid),r=l.toLowerCase();return!r||(null===(o=null==n?void 0:n.toString())||void 0===o?void 0:o.toLowerCase().indexOf(r))>-1})).map((e=>{var t,i,a;return{label:(null===(t=e.feature.attributes)||void 0===t?void 0:t[c])||(null===(i=e.feature.attributes)||void 0===i?void 0:i[u])||(null===(a=e.feature.attributes)||void 0===a?void 0:a.objectid),data:e.feature}}))};o+=f.items.length,n.push(f)}return n.sort(((e,t)=>i.findIndex((t=>t===e.id))-i.findIndex((e=>e===t.id)))),{count:o,groupedSelectedFeatures:n}}),[t,l,a,i]);return 0===c?(0,o.jsx)("div",{className:O,key:"no-matches"},d("noItemsFound")):(0,o.jsx)("div",{className:"surface-1 border-0",css:o.css`
    flex: 1;
    height: 0;
    .esri-editor__content{
      padding: 8px 16px;
    }
    .feature-list{
      background-color: var(--calcite-color-background);
      max-height: unset;
      .esri-item-list{
        background-color: unset;
      }
      .esri-item-list__list-item{
        background-color: var(--calcite-color-foreground-1);
        :hover{
          cursor: pointer;
          background-color: var(--calcite-color-foreground-2);
        }
      }
      .esri-item-list__group{
        padding: 0 12px;
      }
      .esri-item-list__list-item{
        :focus,
        :focus-visible {
          outline-offset: -2px !important;
        }
      }
      .esri-item-list__list{
        list-style: none;
        margin: 0;
        padding: 0;
        .esri-item-list__list-item{
          cursor: pointer;
          margin-bottom: 6px;
          min-height: 48px;
          transition: border 250ms ease-in-out;
          display: flex;
          justify-content: space-between;
          .esri-item-list__list-item-container{
            display: flex;
            margin: 9px 2px;
            width: 100%;
            .esri-item-list__list-item-label{
              flex: 1;
              margin: 0;
              display: flex;
              align-items: center;
              word-break: break-word;
              padding-left: 20px;
            }
          }
        }
      }
      .esri-editor__scroller{
        overflow-y: auto;
        max-height: unset;
      }
    }
    .esri-editor__scroller{
      overflow-y: auto;
      max-height: unset;
      .esri-item-list__scroller{
        max-height: unset;
      }
    }
  `},(0,o.jsx)("div",{className:(0,o.classNames)("feature-list h-100 overflow-auto",L,T)},(0,o.jsx)("div",{className:(0,o.classNames)(j,C)},(0,o.jsx)("div",{className:"d-flex align-items-center m-2"},(0,o.jsx)(n.TextInput,{className:"w-100",placeholder:d("search"),onChange:e=>{s(e.target.value)},value:l,prefix:(0,o.jsx)(_e,{color:"var(--ref-palette-neutral-700)"}),allowClear:!0,title:l})),(0,o.jsx)("div",{key:"content",className:T},(0,o.jsx)("div",{key:"item-container"},u.map((e=>(0,o.jsx)("div",{role:"group","aria-label":e.label,className:F,key:e.id},(0,o.jsx)("h4",{className:(0,o.classNames)(P,N)},(0,o.jsx)("span",{className:M},e.label)),(0,o.jsx)("div",{className:D,role:"listbox"},e.items.map(((t,i)=>(0,o.jsx)(n.Button,{key:`${e.dsId}__${t.label}_${i}`,role:"option",className:(0,o.classNames)(`w-100 border-0 ${V}`),onClick:()=>{r(e.dsId,t.data)}},(0,o.jsx)("div",{className:A},(0,o.jsx)("span",{className:M},t.label))))))))))))))},ke=e=>{const{activeId:t,addLayersConfig:i,onChange:a}=e,r=o.hooks.useTranslation(n.defaultMessages),l=o.React.useCallback((e=>{var t;const i=null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.value;a(i)}),[a]);return(0,o.jsx)("div",{className:"layer-selector",css:o.css`
    &.layer-selector{
      padding: 12px 15px;
    }
  `},(0,o.jsx)("label",{className:"esri-feature-form__label"},r("selectLayer")),(0,o.jsx)(n.Select,{value:t,onChange:l},i.map((e=>(0,o.jsx)("option",{key:e.id,value:e.id},e.name)))))};class Te extends o.React.PureComponent{constructor(){super(...arguments),this.onDataSourceCreated=e=>{var t,i;null===(i=null===(t=this.props)||void 0===t?void 0:t.onDataSourceCreated)||void 0===i||i.call(t,this.props.useDataSource.dataSourceId,e)},this.onSelectionChange=(e,t)=>{var i,a;!ie(e,t)&&(0!==(null==e?void 0:e.length)||0!==(null==t?void 0:t.length))&&(null===(a=(i=this.props).onSelectionChange)||void 0===a||a.call(i,this.props.useDataSource.dataSourceId))},this.onDataSourceInfoChange=(e,t)=>{var i,a;if(!e)return;e.sourceVersion!==(null==t?void 0:t.sourceVersion)&&(null===(a=(i=this.props).onSourceVersionChange)||void 0===a||a.call(i,this.props.useDataSource.dataSourceId,e.sourceVersion))}}render(){const{useDataSource:e}=this.props;return(0,o.jsx)(o.DataSourceComponent,{useDataSource:e,onDataSourceCreated:this.onDataSourceCreated,onSelectionChange:this.onSelectionChange,onDataSourceInfoChange:this.onDataSourceInfoChange})}}const Le=e=>{const{useDataSources:t,unsavedChange:i,onDataSourceCreated:a,onSelectionChange:r,onSourceVersionChange:s}=e,[d,c]=o.React.useState(!1),u=o.React.useRef([]),f=o.React.useRef(null),p=o.React.useCallback((()=>{u.current.length>0&&(null!==f.current&&window.clearTimeout(f.current),f.current=window.setTimeout((()=>{null==r||r(u.current),u.current=[]}),500))}),[r]),v=o.React.useCallback((e=>{u.current.includes(e)||u.current.push(e),i?c(!0):p()}),[p,i]),m=o.React.useCallback((()=>{c(!1),p()}),[p]),g=o.React.useCallback((()=>{c(!1)}),[]);o.React.useEffect((()=>{i||p()}),[p,i]);const y=o.hooks.useTranslation(l);return(0,o.jsx)(o.React.Fragment,null,null==t?void 0:t.map((e=>(0,o.jsx)(Te,{key:e.dataSourceId,useDataSource:e,onDataSourceCreated:a,onSelectionChange:v,onSourceVersionChange:s}))),d&&(0,o.jsx)(n.ConfirmDialog,{level:"warning",title:y("selectionChangeConfirmTitle"),hasNotShowAgainOption:!1,content:y("selectionChangeConfirmTips"),confirmLabel:y("discardConfirm"),cancelLabel:y("discardCancel"),onConfirm:m,onClose:g}))};var De=p(73387),Fe=p(22089),Oe=function(e,t,i,a){return new(i||(i=Promise))((function(o,n){function r(e){try{s(a.next(e))}catch(e){n(e)}}function l(e){try{s(a.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}s((a=a.apply(e,t||[])).next())}))};const Me=e=>{const{activeId:t,activeLayer:i,activeFeature:a,sourceVersion:n,formTemplate:r,editContainer:l,onValueChange:s}=e,d=o.React.useRef(null),c=o.React.useCallback((()=>{var e,t;(null===(e=d.current)||void 0===e?void 0:e.destroy)&&!(null===(t=d.current)||void 0===t?void 0:t.destroyed)&&d.current.destroy()}),[]),u=o.React.useCallback((()=>Oe(void 0,void 0,void 0,(function*(){var e;try{c();const n=y(t),u=b(n),f=document&&document.createElement("div");let p;if(l.current.appendChild(f),a){const t=u.getIdField()||"OBJECTID",i=`${t} IN (${a.attributes[t]})`,n=yield u.query({where:i,returnGeometry:!0,notAddFieldsToClient:!0,outFields:["*"]}),r=null===(e=null==n?void 0:n.records)||void 0===e?void 0:e[0];if(!r)return;p=yield o.dataSourceUtils.changeToJSAPIGraphic(r.feature)}else p=new Fe.default({layer:i});const v=i.fields;v&&"loaded"===i.loadStatus||(yield i.load(),v&&v.length>0&&i.set({fields:v})),d.current=new De.default({container:f,feature:p,layer:i,formTemplate:r,timeZone:te(u)}),d.current.on("value-change",(e=>{var t;const i=u.getIdField(),{fieldName:a}=e;if(a===i)return;const o=d.current.viewModel.submittable,n=p.attributes,r=d.current.viewModel.getValues();let l=null;if(r){const e=g((null===(t=d.current.viewModel.formTemplate)||void 0===t?void 0:t.elements)||[]).map((e=>"field"===e.type&&e.valueExpression&&e.fieldName)).filter((e=>!!e))||[];for(const t in r)if((null==n?void 0:n[t])!==r[t]){const i=e.includes(t);if(i&&!l&&(l=Ve.Arcade),!i){l=Ve.Normal;break}}}s(l,o)}))}catch(e){console.error(e)}}))),[a,t,i,c,l,r,s]),f=o.React.useRef(null);return o.React.useEffect((()=>{window.clearTimeout(f.current),f.current=window.setTimeout((()=>{t&&i&&l.current?u():c()}),500)}),[t,i,n,l,c,u]),o.React.useEffect((()=>{(new De.default).destroy()}),[]),d};var Ae=function(e,t,i,a){return new(i||(i=Promise))((function(o,n){function r(e){try{s(a.next(e))}catch(e){n(e)}}function l(e){try{s(a.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}s((a=a.apply(e,t||[])).next())}))};var Ve;!function(e){e.Arcade="arcade",e.Normal="normal"}(Ve||(Ve={}));const Pe=e=>{var i,a;const{label:s,config:d,canEditFeature:c,useDataSources:u}=e,{description:p,layersConfig:v,noDataMessage:g}=d,[h,S]=o.React.useState(null),[w,x]=o.React.useState(null),[j,C]=o.React.useState({}),[I,R]=o.React.useState(null),[E,_]=o.React.useState({}),[N,k]=o.React.useState((0,o.Immutable)([])),[T,L]=o.React.useState(!1),[D,F]=o.React.useState(!1),[O,M]=o.React.useState(null),[A,V]=o.React.useState(!1),[P,B]=o.React.useState(!1),U=o.React.useRef(),J=o.React.useMemo((()=>E[h]),[h,E]),G=o.hooks.useTranslation(l,o.defaultMessages,n.defaultMessages);o.React.useEffect((()=>{const e=Object.assign({},j);let t=!1;for(const i in j){v.find((e=>e.id===i))||(delete e[i],t=!0)}t&&C(e)}),[j,v]);const W=o.React.useRef(!1),$=o.React.useCallback((e=>Ae(void 0,void 0,void 0,(function*(){const t=e.feature;if(!t)return;(null==t?void 0:t.geometry)&&(t.geometry=null);const i=e.getValues();Object.keys(i).forEach((e=>{t.attributes[e]=i[e]}));const a={updateFeatures:[t]};B(!0),W.current=!0,M(null),yield se(J,a),le(J.dataSource,a),B(!1)}))),[J]),H=o.React.useCallback(((e,t)=>{M(e),V(t)}),[]),z=Me({activeId:h,activeFeature:w,sourceVersion:I,activeLayer:null==J?void 0:J.layer,formTemplate:null==J?void 0:J.formTemplate,editContainer:U,onValueChange:H}),q="full"===(null==J?void 0:J.privilege),K="normal"===(null==J?void 0:J.privilege),Y=(null==J?void 0:J.isPublic)||c||q,Q=v.find((e=>e.id===h)),te=null===(a=null===(i=null==J?void 0:J.dataSource)||void 0===i?void 0:i.getLayerDefinition)||void 0===a?void 0:a.call(i),{create:ie,update:oe,deletable:re}=f(te),de=(null==Q?void 0:Q.updateRecords)&&oe,ce=(null==Q?void 0:Q.deleteRecords)&&re,ue=(null==Q?void 0:Q.addRecords)&&ie,fe=(null==te?void 0:te.type)===o.SupportedLayerServiceTypes.Table,ve=[],me=o.React.useCallback((()=>{var e;const t=null===(e=z.current)||void 0===e?void 0:e.viewModel;(null==t?void 0:t.submittable)&&$(z.current)}),[z,$]);(q||K&&de)&&ve.push({label:G("update"),type:"primary",disabled:!(O&&A),clickHandler:me});const ge=o.React.useCallback((()=>{L(!0)}),[]),ye=o.React.useCallback((()=>{L(!1)}),[]),he=o.React.useCallback((()=>Ae(void 0,void 0,void 0,(function*(){var e;const t=null==J?void 0:J.dataSource,i=null===(e=null==t?void 0:t.getSelectedRecords())||void 0===e?void 0:e[0],a=null==i?void 0:i.feature;if(a){const e={deleteFeatures:[a]};B(!0),M(null),yield se(J,e),le(J.dataSource,e),B(!1)}L(!1)}))),[J]);(q||K&&ce)&&ve.push({label:G("delete"),type:"default",clickHandler:ge});const Se=[],we=o.React.useCallback((()=>Ae(void 0,void 0,void 0,(function*(){var e;const t=null===(e=z.current)||void 0===e?void 0:e.viewModel;if(null==t?void 0:t.submittable){const e=null==t?void 0:t.feature;if(e){const t=z.current.getValues();e.attributes=t;const i={addFeatures:[e]};B(!0),M(null),yield se(J,i),le(J.dataSource,i),S(null),B(!1)}}}))),[J,z]);fe&&(q||K&&ue)&&Se.push({label:G("add"),type:"primary",disabled:!1,clickHandler:we});const xe=o.React.useCallback((()=>{const e=X(j);if(1===e.length){let t=!0;const i=e[0],a=i.dataSource,o=a.getSelectedRecordIds();(o.length>1||!o.includes(i.getId()))&&(t=!1),a&&t&&a.clearSelection()}M(null),F(!1),S(null),x(null)}),[j]),Ie=o.React.useCallback((()=>{O?F(!0):xe()}),[O,xe]),Re=o.React.useCallback((()=>{F(!1)}),[]),Ee=o.React.useCallback(((e,t)=>{S(e),x(t)}),[]);o.React.useEffect((()=>{const e=v.filter((e=>{const t=E[e.id];if(!t)return!1;const i=t.dataSource.getLayerDefinition(),a=(null==i?void 0:i.type)===o.SupportedLayerServiceTypes.Table;return(t.isPublic||c)&&a&&("full"===t.privilege||"normal"===t.privilege&&e.addRecords)}));k(e)}),[c,v,E]);const _e=o.React.useCallback((()=>{const e=N[0].id;S(e),x(null)}),[N]),Te=o.React.useCallback((e=>Ae(void 0,void 0,void 0,(function*(){var i,a;try{const o=y(e),n=b(o),l=yield n.createJSAPILayerByDataSource();let s;const d=v.filter((t=>t.id===e))[0];if(!d)return;if(d.layerHonorMode===t.Webmap)s=l.formTemplate;else{const e=m(n.getLayerDefinition()),t=((null===(i=l.formTemplate)||void 0===i?void 0:i.elements)||[]).filter((e=>"field"===e.type)),a=ne(d.groupedFields.asMutable({deep:!0}),e,t);s=l.formTemplate?l.formTemplate.clone():new r.default,s.elements=a}const c=yield ee(n),u=l.userHasFullEditingPrivileges,f=null===(a=l.editingEnabled)||void 0===a||a;let p;p=c||u&&f?"full":f?"normal":"none";const g=yield Z(l.url);return{id:d.id,dataSource:n,layer:l,formTemplate:s,isPublic:g,privilege:p}}catch(e){console.error(e)}}))),[v]),De=o.React.useCallback((e=>Ae(void 0,void 0,void 0,(function*(){const t=yield Te(e);_((i=>{const a={};for(const o of v)o.id===e?a[o.id]=t:i[o.id]&&(a[o.id]=i[o.id]);return a}))}))),[Te,v]),Fe=o.hooks.useLatest(h);o.React.useEffect((()=>{Ae(void 0,void 0,void 0,(function*(){const e={};for(const t of v){const i=t.id;y(i)&&(e[t.id]=yield Te(t.id))}_(e),Fe.current&&!e[Fe.current]&&(S(null),x(null))}))}),[v,Te,Fe]);const Oe=o.hooks.useLatest(j),Pe=o.React.useCallback(((e,t)=>Ae(void 0,void 0,void 0,(function*(){const i=Object.assign({},Oe.current);for(const t of e){const e=y(t);if(!e)return;let a=e.getSelectedRecords();const o=Object.keys(e.getSchema().fields||{}),n=e.getIdField(),r=ae(e);if(a.length>0&&!a[0].getFieldValue(r)&&o.includes(r))try{const t=a.map((e=>e.getId())),i=yield e.query({outFields:[n,r],where:`${n} in (${t.join(",")})`});i.records&&(a=i.records)}catch(e){console.error(e)}i[t]=a}C(i),M(null);if(1===X(i).length){const[e,a]=Object.entries(i).find((([e,t])=>t.length>0));S(e),R(t),x(a[0].feature)}else S(null),x(null)}))),[Oe]),Be=o.React.useCallback(((e,t)=>{W.current?W.current=!1:Pe([e],t)}),[Pe]),Ue=o.React.useMemo((()=>v.map((e=>e.id)).asMutable()),[v]),Je=X(j).length,Ge=v.length>0,We=G("initAttEmptyMessage"),$e=Ge?g||G("noRecordTips"):We;let He;He=h?w?"form":"new":Je>1?"list":"empty";let ze=!1;return"form"===He?ze=!de&&!ce&&q:"new"===He&&(ze=!ue&&q),(0,o.jsx)("div",{className:"jimu-widget widget-edit esri-widget",css:o.css`
    &.widget-edit {
      .jimu-loading {
        z-index: 1;
      }
      .edit-con {
        display: flex;
        flex-direction: column;
      }
      .attr-height {
        overflow-y: auto;
        height: calc(100% - 113px);
        .edit-notice {
          margin: 12px 15px;
        }
      }
      .esri-feature-form {
          background-color: unset;
      }
    }
  `},P&&(0,o.jsx)(n.Loading,null),(0,o.jsx)("div",{className:"edit-con surface-1 border-0 h-100"},(0,o.jsx)(je,{widgetLabel:s,description:p,hasTableLayerAdd:N.length>0,featureFormStep:He,activeLayerInfo:J,activeFeature:w,editCount:Je,onBack:Ie,onNew:_e}),(0,o.jsx)("div",{className:(0,o.classNames)("attr-height",{"d-none":"form"!==He&&"new"!==He}),ref:U},"new"===He&&(0,o.jsx)(ke,{addLayersConfig:N,activeId:h,onChange:S}),ze&&(0,o.jsx)("calcite-notice",{class:"edit-notice",kind:"brand",open:!0,scale:"s"},(0,o.jsx)("div",{slot:"message"},G("ownerAdminNotice")))),"list"===He&&(0,o.jsx)(Ne,{editFeatures:j,layersInfo:E,layersOrder:Ue,onClickItem:Ee}),"empty"===He&&(0,o.jsx)(pe,{emptyTips:$e}),"form"===He&&ve.length>0&&Y&&(0,o.jsx)(Ce,{buttons:ve}),"new"===He&&Se.length>0&&(0,o.jsx)(Ce,{buttons:Se})),T&&(0,o.jsx)(be,{title:G("deleteRecord"),message:G("deleteRecordTips"),confirmText:G("delete"),cancelText:G("keepRecord"),onConfirm:he,onCancel:ye}),D&&(0,o.jsx)(be,{title:G("selectionChangeConfirmTitle"),message:G("selectionChangeConfirmTips"),confirmText:G("discardConfirm"),cancelText:G("discardCancel"),onConfirm:xe,onCancel:Re}),(0,o.jsx)(Le,{useDataSources:u,unsavedChange:O===Ve.Normal,onDataSourceCreated:De,onSelectionChange:Pe,onSourceVersionChange:Be}))};var Be=p(62686),Ue=p(62243),Je=p(18200),Ge=p.n(Je),We=p(48816),$e=function(e,t,i,a){return new(i||(i=Promise))((function(o,n){function r(e){try{s(a.next(e))}catch(e){n(e)}}function l(e){try{s(a.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}s((a=a.apply(e,t||[])).next())}))};const He=e=>{const{config:t,jimuMapView:i,editContainer:n,canEditFeature:r}=e,{mapViewsConfig:l,relatedRecords:s,liveDataEditing:c}=t,u=o.React.useRef(null),f=o.React.useCallback((()=>{u.current&&!u.current.destroyed&&u.current.destroy()}),[]);o.React.useEffect((()=>()=>{f()}),[f]);const[p,v]=o.React.useState([]),[m,g]=o.React.useState(!1),h=o.React.useCallback((()=>{var e,t,a,n;if(!i)return;let u=i.getAllJimuLayerViews();const f=null==l?void 0:l[i.id],p=null==f?void 0:f.customizeLayers,m=null==f?void 0:f.customJimuLayerViewIds,y=(null==f?void 0:f.layersConfig)||(0,o.Immutable)([]);p&&(u=u.sort(((e,t)=>y.findIndex((t=>t.id===e.layerDataSourceId))-y.findIndex((e=>e.id===t.layerDataSourceId)))));const h=((null===(n=null===(a=null===(t=null===(e=i.view)||void 0===e?void 0:e.map)||void 0===t?void 0:t.allLayers)||void 0===a?void 0:a.toArray)||void 0===n?void 0:n.call(a))||[]).filter((e=>{const t=d.includes(e.type),i=!u.find((t=>t.layer===e));return t&&i})),S=u.filter((e=>{const t=e.layer;return d.includes(t.type)})),w=[];S.forEach((e=>{const t=function(e,t,i,a){const n=e.layer,r=!!n.url,l=n.id.toString().includes("jimu-draw-measurements-layer"),s=n[o.ExBAddedJSAPIProperties.EXB_NOT_EDITABLE];let d=!0;d=e.fromRuntime?a:!t||i.includes(e.id);const c=e.isLayerVisible();return r&&!l&&!s&&d&&c}(e,p,m,c);t?w.push(e):h.push(e.layer)}));const x=h.map((e=>oe(e))),j=w.map((e=>$e(void 0,void 0,void 0,(function*(){var t,i,a;const o=yield e.getOrCreateLayerDataSource();if(!o)return null;const n=null===(a=null===(i=null===(t=y.filter((e=>e.id===(null==o?void 0:o.id))))||void 0===t?void 0:t[0])||void 0===i?void 0:i.asMutable)||void 0===a?void 0:a.call(i,{deep:!0}),l=b(o);return re(l,n,e,s,r)}))));Promise.all(j).then((e=>{var t;const a=e.filter((e=>!!e));g(a.some((e=>e.showUpdateBtn)));const o=a.map((e=>e.editorLayerInfo)).concat(x),n=[],r=i.view.map.allTables.toArray()||[];for(const e of o){if(!((null===(t=e.formTemplate)||void 0===t?void 0:t.elements)||[]).some((e=>"relationship"===e.type)))continue;const i=e.layer.relationships;for(const t of i){const i=t.relatedTableId,a=r.find((e=>e.layerId===i));if(!a)continue;n.find((e=>e.layer===a))||n.push({layer:a,enabled:!0,addEnabled:e.addEnabled,updateEnabled:e.updateEnabled,deleteEnabled:e.deleteEnabled})}}v(o.concat(n))}))}),[r,i,c,l,s]);o.React.useEffect((()=>{h()}),[h]);const S=o.hooks.useLatest(h);o.React.useEffect((()=>{var e,t;if(!(null===(t=null===(e=null==i?void 0:i.view)||void 0===e?void 0:e.map)||void 0===t?void 0:t.layers))return;const a=()=>{S.current()};let o=null,n=i.getAllJimuLayerViews().length;const r=e=>{e.fromRuntime?S.current():(o&&window.clearTimeout(o),o=window.setTimeout((()=>{const e=i.getAllJimuLayerViews().length;e!==n&&(S.current(),n=e)}),5e3))};return i.addJimuLayerViewsVisibleChangeListener(a),i.addJimuLayerViewCreatedListener(r),i.addJimuLayerViewRemovedListener(r),()=>{var e,t,o;null===(e=null==i?void 0:i.removeJimuLayerViewsVisibleChangeListener)||void 0===e||e.call(i,a),null===(t=null==i?void 0:i.removeJimuLayerViewCreatedListener)||void 0===t||t.call(i,r),null===(o=null==i?void 0:i.removeJimuLayerViewRemovedListener)||void 0===o||o.call(i,r)}}),[i,S]);const w=o.React.useCallback((()=>$e(void 0,void 0,void 0,(function*(){var e;const o=u.current,{selfSnapping:n,featureSnapping:r,gridSnapping:l=!1,defaultSelfEnabled:s,defaultFeatureEnabled:d,defaultGridEnabled:c=!1,snapSettingMode:f,defaultSnapLayers:p,tooltip:v,defaultTooltipEnabled:m=!1,segmentLabel:g=!0,defaultSegmentLabelEnabled:y=!1,templateFilter:b,initialReshapeMode:h,batchEditing:S=!1}=t;o.tooltipOptions.enabled=m,o.labelOptions.enabled=y,o.snappingOptions.enabled=s||d||c,o.snappingOptions.selfEnabled=s,o.snappingOptions.featureEnabled=d,o.snappingOptions.gridEnabled=c&&l,o.snappingOptions.featureSources=yield Be.SnappingUtils.getSnappingFeatureSourcesCollection(i,p);const w=f===a.Flexible&&(n||r||l);o.visibleElements.selectionToolbar=S,o.visibleElements.snappingControls=w,o.visibleElements.snappingControlsElements={enabledToggle:n||r||l,selfEnabledToggle:n,featureEnabledToggle:r,layerList:r,layerListToggleLayersButton:r,gridEnabledToggle:l,gridControls:l},o.visibleElements.tooltipsToggle=v,o.visibleElements.labelsToggle=g;const x=w||v||g&&"3d"===(null===(e=i.view)||void 0===e?void 0:e.type);o.visibleElements.settingsMenu=x,o.supportingWidgetDefaults={featureTemplates:{visibleElements:{filter:b}},sketch:{defaultUpdateOptions:{tool:h?"reshape":"transform"}}}}))),[t,i]),x=o.hooks.usePrevious(i),j=o.hooks.usePrevious(t),C=o.React.useCallback(((e,t)=>$e(void 0,void 0,void 0,(function*(){var a;if(!(null===(a=u.current)||void 0===a?void 0:a.viewModel.syncing))return;const o=i.getDataSourceIdByAPILayer(e),n=y(o);if(!n)return;const r=e.objectIdField,l=t.addedFeatures.map((e=>e.objectId));let s=[];if(l.length>0){const t=yield e.queryFeatures({where:`${r} IN (${l.join(",")})`,outFields:["*"],returnGeometry:!1});s=(null==t?void 0:t.features)||[]}const d=t.updatedFeatures.map((e=>e.objectId));let c=[];if(d.length>0){const t=yield e.queryFeatures({where:`${r} IN (${d.join(",")})`,outFields:["*"],returnGeometry:!1});c=(null==t?void 0:t.features)||[]}const f=t.deletedFeatures.map((e=>new Fe.default({attributes:{[r]:e.objectId}})));le(n,{addFeatures:s,updateFeatures:c,deleteFeatures:f})}))),[i]);return o.React.useEffect((()=>{if(i&&n.current)if(u.current&&i===x)t!==j&&w();else{f();const e=document.createElement("div");e.className="h-100",n.current.appendChild(e),u.current=new We.default({container:e,view:i.view}),w()}}),[t,f,n,i,j,x,w]),o.React.useEffect((()=>{const e=u.current;if(!e)return;const t=[];for(const e of p){if(!e.enabled)continue;const i=e.layer;if("subtype-sublayer"===i.type){const e=i.parent,a=null==e?void 0:e.on("edits",(t=>{C(e,t)}));t.push(a)}else{const e=i,a=e.on("edits",(t=>{C(e,t)}));t.push(a)}}return e.layerInfos=p,e.visibleElements.editFeaturesSection=m,()=>{for(const e of t)e.remove()}}),[p,m,C]),u.current};var ze=function(e,t,i,a){return new(i||(i=Promise))((function(o,n){function r(e){try{s(a.next(e))}catch(e){n(e)}}function l(e){try{s(a.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}s((a=a.apply(e,t||[])).next())}))};const qe=e=>{const{config:t,canEditFeature:i,useMapWidgetIds:a}=e,{mapViewsConfig:r,batchEditing:s=!1}=t,[d,u]=o.React.useState(null),[f,p]=o.React.useState(),[v,m]=o.React.useState({}),S=o.hooks.useTranslation(l),w=o.React.useRef(null),j=He({config:t,jimuMapView:d,editContainer:w,canEditFeature:i}),C=o.React.useCallback((e=>ze(void 0,void 0,void 0,(function*(){if(!d||d.isDestroyed()||!e)return;const t=null==r?void 0:r[d.id],i=null==t?void 0:t.customizeLayers,a=null==t?void 0:t.customJimuLayerViewIds,n=[];for(const t of e)try{if(!t.enabled||t.layer.isTable)continue;const e=d.getJimuLayerViewIdByAPILayer(t.layer);if(i&&!(null==a?void 0:a.includes(e)))continue;const r=(yield d.whenJimuLayerViewLoaded(e)).getLayerDataSource();if(!r||!c.includes(r.type))continue;const l=r.getMainDataSource(),s=r.getRootDataSource(),u=(0,o.Immutable)({dataSourceId:r.id,mainDataSourceId:null==l?void 0:l.id,dataViewId:r.dataViewId,rootDataSourceId:null==s?void 0:s.id});n.push(u)}catch(e){continue}p(n)}))),[d,r]),I=o.React.useCallback((e=>{u(e)}),[]),R=o.React.useCallback((e=>ze(void 0,void 0,void 0,(function*(){if(!j||!d||E.current)return;j.activeWorkflow&&j.cancelWorkflow();const t=j.effectiveSelectionManager;if(0===Q(e,d).length)(null==t?void 0:t.hasSelection)&&t.clear();else{_.current=!0;let i=[];try{i=yield((e,t)=>x(void 0,void 0,void 0,(function*(){const i=[];for(const a in t){const o=y(a),n=b(o).getIdField(),r=t[a];if((null==r?void 0:r.length)>0){const o=`${n} IN (${t[a].map((e=>{var t;return(null===(t=e)||void 0===t?void 0:t.feature).attributes[n]})).join()})`,r=e.getJimuLayerViewByDataSourceId(a),l=null==r?void 0:r.layer;if(!l)continue;const s=new h.default({where:o,outFields:["*"],returnGeometry:!0});i.push(l.queryFeatures(s))}}return(yield Promise.all(i)).reduce(((e,t)=>Array.isArray(t.features)?e.concat(t.features):e),[])})))(d,e)}catch(e){console.error("Failed to query editing features:",e)}if(0===i.length)(null==t?void 0:t.hasSelection)&&t.clear(),console.error("No features found for the selected data records.");else if(1===i.length){(null==t?void 0:t.hasSelection)&&t.clear();const e=i[0];j.startUpdateWorkflowAtFeatureEdit(e)}else i.length>1&&("2d"===d.view.type&&s?((null==t?void 0:t.hasSelection)&&t.clear(),t&&t.updateSelection({current:i,added:[],removed:[]})):j.startUpdateWorkflowAtMultipleFeatureSelection(i))}}))),[s,j,d]),E=o.React.useRef(!1),_=o.React.useRef(!1),N=(e=>{const[t,i]=o.React.useState(!0);return o.React.useEffect((()=>{let t;return e?(t=new IntersectionObserver((e=>{const t=e[0];if(!t)return;const a=t.target.checkVisibility(),o=0===t.boundingClientRect.width||0===t.boundingClientRect.height;i(a&&!o)})),t.observe(e)):i(!1),()=>{t&&t.disconnect()}}),[e]),t})(w.current),k=o.React.useCallback((e=>{const t=Object.assign({},v);for(const i of e){const e=y(i);if(!e)continue;const a=e.getSelectedRecords();t[i]=a}m(t),E.current?window.setTimeout((()=>{E.current=!1}),50):N&&R(t)}),[v,R,N]),T=o.React.useCallback((e=>{const t=Q(v,d).length;(null==j?void 0:j.viewModel.syncing)&&1!==t||k([e])}),[v,j,k,d]),L=o.hooks.useLatest(v);o.React.useEffect((()=>{var e,t;N&&!(null===(e=null==j?void 0:j.activeWorkflow)||void 0===e?void 0:e.started)&&R(L.current),!N&&(null===(t=null==j?void 0:j.activeWorkflow)||void 0===t?void 0:t.started)&&j.activeWorkflow.cancel()}),[L,j,R,N]);const[D,F]=o.React.useState(!1);o.React.useEffect((()=>{if(!j||!d)return;const e=j.effectiveSelectionManager,t="2d"===d.view.type&&s&&e.on("selection-change",(e=>ze(void 0,void 0,void 0,(function*(){var t;if(_.current)return void(_.current=!1);const i=d.getMapDataSource();for(const a of e.changes||[]){const e=a.layer;if(!e)continue;const n=o.dataSourceUtils.getDataSourceIdByJSAPILayer(i,e),r=y(n);if(!r)continue;const l=a.selection.map((e=>e.toString()))||[],s=r.getSelectedRecordIds();if(!ie(l,s)&&(0!==l.length||0!==s.length)){if(0===l.length)r.clearSelection();else{const e=null===(t=yield r.query({objectIds:l.map((e=>e.toString())),outFields:["*"],returnGeometry:!0}))||void 0===t?void 0:t.records;r.selectRecordsByIds(e.map((e=>e.getId())),e)}E.current=!0}}})))),i=Ue.watch((()=>{var e,t,i;return null===(i=null===(t=null===(e=j.viewModel)||void 0===e?void 0:e.activeWorkflow)||void 0===t?void 0:t.data)||void 0===i?void 0:i.candidates}),((t,i)=>{var a,n;if("2d"===d.view.type&&s&&e.hasSelection)return;if(_.current||j.viewModel.syncing||j.viewModel.updating)return void(void 0!==t&&(_.current=!1));const r=null===(n=null===(a=j.viewModel)||void 0===a?void 0:a.activeWorkflow)||void 0===n?void 0:n.data,l=t||((null==r?void 0:r.rootFeature)?[r.rootFeature]:[]),c={};for(const e of l||[])c[e.layer.id]||(c[e.layer.id]=[]),c[e.layer.id].push(e);const u=j.layerInfos.map((e=>e.layer));for(const e of u){const t=d.getMapDataSource(),i=o.dataSourceUtils.getDataSourceIdByJSAPILayer(t,e),a=y(i);if(!a)continue;const n=c[e.id]||[],r=[],l=[];for(const e of n){const t=a.buildRecord(e);l.push(t),r.push(t.getId())}const s=a.getSelectedRecordIds();ie(s,r)||0===s.length&&0===r.length||(a.selectRecordsByIds(r,l),E.current=!0)}})),a=Ue.watch((()=>{var e;return null===(e=j.viewModel)||void 0===e?void 0:e.formViewModel}),(e=>{if(e){if("features"in e){const t=e;t.on("value-change",(e=>{F(t.userHasChangedValues)}))}else if("feature"in e){const t=e,i=t.getValues();t.on("value-change",(e=>{var a;const o=t.layer.objectIdField,n=g((null===(a=t.formTemplate)||void 0===a?void 0:a.elements)||[]).map((e=>"field"===e.type&&e.valueExpression&&e.fieldName)).filter((e=>!!e))||[],{fieldName:r}=e;if(r===o||n.includes(r))return;const l=t.getValues();let s=!1;if(l)for(const e in l)if(!n.includes(e)&&(null==i?void 0:i[e])!==l[e]){s=!0;break}F(s)}))}}else F(!1)}));return()=>{var e,o;null===(e=null==t?void 0:t.remove)||void 0===e||e.call(t),null===(o=null==i?void 0:i.remove)||void 0===o||o.call(i),a.remove()}}),[j,d,s]),o.React.useEffect((()=>{if(!j)return;const e=Ue.watch((()=>null==j?void 0:j.layerInfos),(e=>{C(e)}),{initial:!0});return()=>{e.remove()}}),[j,C]);const O=null==a?void 0:a[0];return(0,o.jsx)("div",{className:"jimu-widget widget-edit esri-widget"},O&&(0,o.jsx)("div",{className:"edit-con h-100",ref:w}),!O&&(0,o.jsx)(n.WidgetPlaceholder,{autoFlip:!0,icon:Ge(),name:S("_widgetLabel"),"data-testid":"editPlaceholder"}),(0,o.jsx)(Be.JimuMapViewComponent,{useMapWidgetId:O,onActiveViewChange:I}),O&&!d&&(0,o.jsx)("div",{className:"jimu-secondary-loading"}),j&&(0,o.jsx)(Le,{useDataSources:f,unsavedChange:D,onSelectionChange:k,onSourceVersionChange:T}))};var Ke=function(e,t,i,a){return new(i||(i=Promise))((function(o,n){function r(e){try{s(a.next(e))}catch(e){n(e)}}function l(e){try{s(a.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}s((a=a.apply(e,t||[])).next())}))};class Ye extends o.WidgetVersionManager{constructor(){super(...arguments),this.versions=[{version:"1.7.0",description:"Add layerHonorMode to config for support smart form.",upgrader:e=>Ke(this,void 0,void 0,(function*(){let i=e;const a=(e,t)=>{const i=[],a=e=>(e.forEach((e=>{if(e.groupKey)a(e.children);else{const a=t.find((t=>t.name===e.jimuName));s.includes(e.jimuName)||i.push(Object.assign(Object.assign({},e),{editable:null==a?void 0:a.editable,editAuthority:!!(null==a?void 0:a.editable)&&(null==e?void 0:e.editAuthority)}))}})),i);return a(e)};return yield Promise.all(i.layersConfig.map((e=>new Promise((t=>{o.DataSourceManager.getInstance().createDataSourceByUseDataSource(e.useDataSource).then((i=>{const o=null==i?void 0:i.getLayerDefinition(),n=(null==o?void 0:o.fields)||[],r=e.groupedFields.map((e=>{var t;const i=n.find((t=>t.name===e.jimuName));return e.groupKey?Object.assign(Object.assign({},e),{editable:!0,editAuthority:!(null===(t=null==e?void 0:e.children)||void 0===t?void 0:t.some((e=>!1===e.editAuthority))),children:a(null==e?void 0:e.children,n)}):Object.assign(Object.assign({},e),{editable:null==i?void 0:i.editable,editAuthority:!!(null==i?void 0:i.editable)&&(null==e?void 0:e.editAuthority)})})).filter((e=>!s.includes(e.jimuName)));t(r)})).catch((()=>{t([])}))}))))).then((e=>(e.forEach(((e,a)=>{const n=i.layersConfig[a].showFields.filter((e=>!s.includes(e.jimuName)));let r=[];const l=e.asMutable({deep:!0});e.forEach((e=>{e.groupKey?r=r.concat(e.children):r.push(e)})),n.forEach((e=>{r.find((t=>t.jimuName===e.jimuName))||l.push(e)})),i=i.setIn(["layersConfig",a,"groupedFields"],(0,o.Immutable)(l)),i=i.setIn(["layersConfig",a,"layerHonorMode"],t.Custom)})),Promise.resolve(i)))).catch((()=>Promise.resolve(i)))}))},{version:"1.10.0",description:"Set old app default snapping to true",upgrader:e=>{let t=e;return t=t.set("selfSnapping",!0).set("featureSnapping",!0),t}},{version:"1.12.0",description:'Set "undefined" option to "false", and remove not editable layer',upgrader:t=>Ke(this,void 0,void 0,(function*(){var i,a,n;let r=t;const l=r.editMode===e.Geometry,s=o.DataSourceManager.getInstance(),d=[];for(const e of r.layersConfig){let t;try{t=yield s.createDataSourceByUseDataSource(null==e?void 0:e.useDataSource)}catch(e){console.error(e)}if(!t){d.push(e);continue}const r=null==t?void 0:t.getLayerDefinition(),c=(null===(i=null==t?void 0:t.layer)||void 0===i?void 0:i.isTable)||(null==r?void 0:r.type)===o.SupportedLayerServiceTypes.Table;if(l&&c)continue;const u=null==r?void 0:r.allowGeometryUpdates;if(null===(n=null===(a=null==t?void 0:t.layer)||void 0===a?void 0:a.editingEnabled)||void 0===n||n){let t;t=e.updateGeometries?Object.assign(Object.assign({},e),{updateRecords:!0,updateAttributes:!0,updateGeometries:u&&!0}):Object.assign(Object.assign({},e),{updateRecords:!1,updateAttributes:!1,updateGeometries:!1}),d.push(t)}}return r=r.setIn(["layersConfig"],d),r}))},{version:"1.13.0",description:"Update snap options",upgrader:e=>{let t=e;return t.selfSnapping&&(t=t.set("defaultSelfEnabled",!0)),t.featureSnapping&&(t=t.set("defaultFeatureEnabled",!0)),t}},{version:"1.14.0",description:"Add predefine snapping options",upgrader:e=>{let t=e;return t=t.set("snapSettingMode",a.Flexible),t}},{version:"1.15.0",description:"Add general setting options",upgrader:e=>{let t=e;return t=t.set("tooltip",!0).set("templateFilter",!0).set("relatedRecords",!0),t}},{version:"1.16.0",description:"Update map mode config",upgradeFullInfo:!0,upgrader:t=>Ke(this,void 0,void 0,(function*(){const i=t.widgetJson,a=i.config;if(!a)return t;let n=a;const{editMode:r,layersConfig:l}=a,s={},d=(e,t,i)=>Ke(this,void 0,void 0,(function*(){try{const a=yield o.DataSourceManager.getInstance().createDataSourceByUseDataSource((0,o.Immutable)({dataSourceId:e,mainDataSourceId:e,rootDataSourceId:t}));if(!a)return console.error("Cannot create layer data source.",e),null;return`${i}-${a.jimuLayerId}`}catch(e){return console.error("Cannot create layer data source.",e),null}}));if(r===e.Geometry){const e=i.useMapWidgetIds[0];for(const t of l){const i=t.id,a=i.indexOf("-"),o=t.id.substring(0,a),n=`${e}-${o}`,r=yield d(i,o,n);if(!r)continue;const l=t.asMutable({deep:!0});if(s[n]){s[n].customJimuLayerViewIds.push(r);const e=s[n].layersConfig;e.push(l),s[n].layersConfig=e}else{const e={customizeLayers:!0,customJimuLayerViewIds:[r],layersConfig:[l]};s[n]=e}}n=n.set("mapViewsConfig",s)}const c=i.set("config",(0,o.Immutable)(n));return Object.assign(Object.assign({},t),{widgetJson:c})}))}]}}const Xe=new Ye,Qe=t=>{const{label:i,config:a,useDataSources:n,useMapWidgetIds:r}=t,l=a.editMode===e.Attribute,[s,d]=o.React.useState(!1);return o.React.useEffect((()=>{x(void 0,void 0,void 0,(function*(){var e;const t=yield o.privilegeUtils.checkExbAccess(o.privilegeUtils.CheckTarget.Experience);return null===(e=null==t?void 0:t.capabilities)||void 0===e?void 0:e.canEditFeature})).then((e=>{d(e)}))}),[]),l?(0,o.jsx)(Pe,{label:i,config:a,canEditFeature:s,useDataSources:n}):(0,o.jsx)(qe,{config:a,canEditFeature:s,useMapWidgetIds:r})};Qe.versionManager=Xe;const Ze=Qe;function et(e){p.p=e}})(),v})())}}}));
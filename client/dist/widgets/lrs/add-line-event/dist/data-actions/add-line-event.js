System.register(["jimu-core","widgets/shared-code/lrs"],(function(e,t){var n={},r={};return{setters:[function(e){n.AbstractDataAction=e.AbstractDataAction,n.DataLevel=e.DataLevel,n.DataSourceStatus=e.DataSourceStatus,n.DataSourceTypes=e.DataSourceTypes,n.MutableStoreManager=e.MutableStoreManager,n.getAppStore=e.getAppStore,n.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){r.QueryRouteMeasures=e.QueryRouteMeasures,r.getDateWithTZOffset=e.getDateWithTZOffset,r.getRouteFromEndMeasures=e.getRouteFromEndMeasures,r.isDefined=e.isDefined,r.queryRouteIdOrName=e.queryRouteIdOrName}],execute:function(){e((()=>{var e={47626:e=>{"use strict";e.exports=r},79244:e=>{"use strict";e.exports=n}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,i),o.exports}i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.p="";var o={};return i.p=window.jimuConfig.baseUrl,(()=>{"use strict";i.r(o),i.d(o,{default:()=>Z});const e="object"==typeof global&&global&&global.Object===Object&&global;var t="object"==typeof self&&self&&self.Object===Object&&self;const n=e||t||Function("return this")();var r=/\s/;const a=function(e){for(var t=e.length;t--&&r.test(e.charAt(t)););return t};var s=/^\s+/;const u=function(e){return e?e.slice(0,a(e)+1).replace(s,""):e};const l=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};const d=n.Symbol;var c=Object.prototype,f=c.hasOwnProperty,m=c.toString,g=d?d.toStringTag:void 0;const D=function(e){var t=f.call(e,g),n=e[g];try{e[g]=void 0;var r=!0}catch(e){}var i=m.call(e);return r&&(t?e[g]=n:delete e[g]),i};var v=Object.prototype.toString;const p=function(e){return v.call(e)};var S=d?d.toStringTag:void 0;const y=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":S&&S in Object(e)?D(e):p(e)};const h=function(e){return null!=e&&"object"==typeof e};const b=function(e){return"symbol"==typeof e||h(e)&&"[object Symbol]"==y(e)};var N=/^[-+]0x[0-9a-f]+$/i,M=/^0b[01]+$/i,O=/^0o[0-7]+$/i,I=parseInt;const R=function(e){if("number"==typeof e)return e;if(b(e))return NaN;if(l(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=l(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=u(e);var n=M.test(e);return n||O.test(e)?I(e.slice(2),n?2:8):N.test(e)?NaN:+e};var j=1/0;const T=function(e){return e?(e=R(e))===j||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0};const P=function(e){var t=T(e),n=t%1;return t==t?n?t-n:t:0};const F=function(e,t){for(var n=-1,r=null==e?0:e.length,i=Array(r);++n<r;)i[n]=t(e[n],n,e);return i};const A=Array.isArray;var w=d?d.prototype:void 0,L=w?w.toString:void 0;const k=function e(t){if("string"==typeof t)return t;if(A(t))return F(t,e)+"";if(b(t))return L?L.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n};const x=function(e){return null==e?"":k(e)};var J=n.isFinite,E=Math.min;const _=function(e){var t=Math[e];return function(e,n){if(e=R(e),(n=null==n?0:E(P(n),292))&&J(e)){var r=(x(e)+"e").split("e"),i=t(r[0]+"e"+(+r[1]+n));return+((r=(x(i)+"e").split("e"))[0]+"e"+(+r[1]-n))}return t(e)}}("round");var C=i(79244),G=i(47626),W=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(e){o(e)}}function s(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))};class Z extends C.AbstractDataAction{isSupported(e,t){return W(this,void 0,void 0,(function*(){var n;if(e.length>1)return!1;const r=e[0],i=r.records[0];if(!(0,G.isDefined)(i))return!1;const o=i.getData(),a=JSON.parse(JSON.stringify(o)),{dataSource:s,records:u}=r,l=s.type===C.DataSourceTypes.FeatureLayer||s.type===C.DataSourceTypes.SceneLayer,d=s.isDataSourceSet(),c=t!==C.DataLevel.Records,f=r.dataSource,m=(null==f?void 0:f.supportSpatialInfo)&&(null==f?void 0:f.supportSpatialInfo()),g=t===C.DataLevel.Records&&0===(null==u?void 0:u.length),D=!s.isInAppConfig()&&!l;if(d||c||g||D||!m)return!1;let v=s;if((s.id.includes("output_point")||s.id.includes("output_line"))&&(v=s.getOriginDataSources()[0]),!(0,G.isDefined)(v))return!1;const p=q(),S=null===(n=null==p?void 0:p.widgets)||void 0===n?void 0:n[this.widgetId];let y,h;if(S.config.lrsLayers.forEach((e=>{(0,G.isDefined)(v)&&e.id===v.id&&(y=e.networkInfo)})),!y)return!1;if(!(0,G.isDefined)(y.eventLayers)||0===y.eventLayers.length)return!1;const b=y.eventLayers;if(S.config.lrsLayers.forEach((e=>{b.forEach((t=>{String(e.originName)===t&&(h=e.eventInfo)}))})),!h)return!1;const N=Object.keys(a).find((e=>e===y.routeIdFieldSchema.name)),M=Object.keys(a).find((e=>e===y.fromDateFieldSchema.name)),O=Object.keys(a).find((e=>e===y.toDateFieldSchema.name)),I=Object.keys(a).find((e=>{var t;return e===(null===(t=y.lineIdFieldSchema)||void 0===t?void 0:t.name)}));if(!(0,G.isDefined)(N))return!1;if(r.records.length>2)return!1;let R=null,j=!1;if(yield(0,C.loadArcGISJSAPIModules)(["esri/geometry/Polyline"]).then((e=>{[R]=e})).then((()=>{const e=i.getGeometry();0===new R(e).paths.length&&(j=!0)})),j)return!1;let T=!1;if(s.id.includes("output_line")&&(T=!0),T&&1!==r.records.length)return!1;if(!s||s.getStatus()===C.DataSourceStatus.NotReady)return!1;if(!T&&2===r.records.length&&!(0,G.isDefined)(I))return!1;if(!T&&2===r.records.length){const e=r.records[0],t=r.records[1],n=e.getData(),i=t.getData(),o=JSON.parse(JSON.stringify(n)),a=JSON.parse(JSON.stringify(i));if(String(o[I])!==String(a[I]))return!1;if(String(o[N])===String(a[N])&&Number(o[M])!==Number(a[M])&&Number(o[O])!==Number(a[O]))return!1}return!0}))}onExecute(e,t){return W(this,void 0,void 0,(function*(){var t;const n=e[0],{records:r,dataSource:i}=n,o=q(),a=null===(t=null==o?void 0:o.widgets)||void 0===t?void 0:t[this.widgetId],s=a.config.hideMeasures;let u,l=i;if((i.id.includes("output_point")||i.id.includes("output_line"))&&(l=i.getOriginDataSources()[0]),!(0,G.isDefined)(l))return!1;a.config.lrsLayers.forEach((e=>{(0,G.isDefined)(l)&&e.id===l.id&&(u=e.networkInfo)}));const d=r[0],c=d.getData();let f=JSON.parse(JSON.stringify(c));const m=Object.keys(f).find((e=>{var t;return e===(null===(t=u.lineOrderFieldSchema)||void 0===t?void 0:t.name)}));let g=null,D=!1;n.records.length>1&&(g=r[1],D=!0);let v=null;if((0,G.isDefined)(g)){const e=g.getData();v=JSON.parse(JSON.stringify(e));const t=f[m],n=v[m];if((0,G.isDefined)(t)&&(0,G.isDefined)(n)&&Number(t)>Number(n)){const e=f;f=v,v=e}}const p={routeId:"",routeName:"",fromMeasure:NaN,toMeasure:NaN,fromDate:void 0,toDate:void 0,selectedMeasure:NaN,selectedFromDate:void 0,selectedToDate:void 0},S=Object.keys(f).find((e=>e===u.routeIdFieldSchema.name)),y=Object.keys(f).find((e=>{var t;return e===(null===(t=u.routeNameFieldSchema)||void 0===t?void 0:t.name)})),h=Object.keys(f).find((e=>e===u.fromDateFieldSchema.name)),b=Object.keys(f).find((e=>e===u.toDateFieldSchema.name)),N=Object.keys(f).find((e=>{var t;return e===(null===(t=u.lineIdFieldSchema)||void 0===t?void 0:t.name)})),M=Object.keys(f).find((e=>{var t;return e===(null===(t=u.lineNameFieldSchema)||void 0===t?void 0:t.name)})),O=(0,G.isDefined)(f[h])?(0,G.getDateWithTZOffset)(f[h],l):null,I=(0,G.isDefined)(v)&&(0,G.isDefined)(v[h])?(0,G.getDateWithTZOffset)(v[h],l):null,R=(0,G.isDefined)(f[b])?(0,G.getDateWithTZOffset)(f[b],l):null,j=(0,G.isDefined)(v)&&(0,G.isDefined)(v[b])?(0,G.getDateWithTZOffset)(v[b],l):null;p.fromDate=O,p.toRouteFromDate=D?I:O,p.selectedFromDate=O,p.toDate=R,p.toRouteToDate=D?j:R,p.selectedToDate=R,p.routeId=(0,G.isDefined)(f[S])?String(f[S]):null,p.toRouteId=D?(0,G.isDefined)(v[S])?String(v[S]):null:(0,G.isDefined)(f[S])?String(f[S]):null,p.routeName=(0,G.isDefined)(y)&&(0,G.isDefined)(f[y])?String(f[y]):null,p.toRouteName=D?(0,G.isDefined)(v[y])?String(v[y]):null:(0,G.isDefined)(y)&&(0,G.isDefined)(f[y])?String(f[y]):null,p.lineId=(0,G.isDefined)(N)&&(0,G.isDefined)(f[N])?String(f[N]):null,p.toLineId=(0,G.isDefined)(N)&&(0,G.isDefined)(f[N])?String(f[N]):null,p.routeLineOrder=(0,G.isDefined)(m)&&(0,G.isDefined)(f[m])?Number(f[m]):null,p.toRouteLineOrder=D?(0,G.isDefined)(v[m])?Number(v[m]):null:(0,G.isDefined)(m)&&(0,G.isDefined)(f[m])?Number(f[m]):null,p.lineName=(0,G.isDefined)(M)&&(0,G.isDefined)(f[M])?String(f[M]):null,p.toLineName=(0,G.isDefined)(M)&&(0,G.isDefined)(f[M])?String(f[M]):null;const T=Object.fromEntries(Object.entries(f).map((([e,t])=>[e.toLowerCase(),t])));if(p.fromMeasure=(0,G.isDefined)(T.measure)?Number(T.measure):NaN,p.toRouteFromMeasure=(0,G.isDefined)(T.measure)?Number(T.measure):NaN,p.selectedMeasure=(0,G.isDefined)(T.measure)?Number(T.measure):NaN,p.toMeasure=(0,G.isDefined)(T.tomeasure)?Number(T.tomeasure):NaN,p.toRouteToMeasure=(0,G.isDefined)(T.tomeasure)?Number(T.tomeasure):NaN,p.selectedToMeasure=(0,G.isDefined)(T.tomeasure)?Number(T.tomeasure):NaN,p.validRoute=!0,p.validToRoute=!0,!s&&(0,G.isDefined)(f.Measure)){let e=null;yield(0,C.loadArcGISJSAPIModules)(["esri/geometry/Polyline"]).then((t=>{[e]=t})).then((()=>{const t=d.getGeometry(),n=new e(t);if(n.paths.length>0){const e=n.getPoint(0,0),t=n.paths[n.paths.length-1].length-1,r=n.getPoint(n.paths.length-1,t);p.selectedPoint=e,p.selectedToPoint=r}}))}let P=null,F=null;if((0,G.isDefined)(u)){const e=u.useRouteName?p.routeName:p.routeId;if(yield(0,G.queryRouteIdOrName)(e,u,l,!1,!0,"",p.fromDate).then((e=>W(this,void 0,void 0,(function*(){if((0,G.isDefined)(e)&&(yield Promise.all(e.features.map((e=>{const t=e.attributes[u.fromDateFieldSchema.name],n=e.attributes[u.toDateFieldSchema.name];return(p.fromDate instanceof Date&&t===p.fromDate.getTime()||t===p.fromDate)&&(p.toDate instanceof Date&&n===p.toDate.getTime()||n===p.toDate)&&(P=e.geometry),e}))),(0,G.isDefined)(P))){const e=(0,G.getRouteFromEndMeasures)(P);if((0,G.isDefined)(e)){const t=yield(0,G.QueryRouteMeasures)(l,u,e,p.fromDate,p.routeId),n=Math.min(...t),r=Math.max(...t);p.fromMeasure=_(n,u.measurePrecision),p.toRouteFromMeasure=_(n,u.measurePrecision),p.toMeasure=_(r,u.measurePrecision),p.toRouteToMeasure=p.toMeasure,p.selectedMeasure=_(n,u.measurePrecision),p.selectedToMeasure=p.toMeasure}if(s&&P.paths.length>0){const e=P.getPoint(0,0),t=P.paths[P.paths.length-1].length-1,n=P.getPoint(P.paths.length-1,t);p.selectedPoint=e,p.selectedToPoint=n,p.selectedMeasure=p.fromMeasure,p.selectedToMeasure=p.toRouteToMeasure}}})))),D){const e=u.useRouteName?p.toRouteName:p.toRouteId;yield(0,G.queryRouteIdOrName)(e.trim(),u,l,!1,!0,"",p.toRouteFromDate).then((e=>W(this,void 0,void 0,(function*(){if((0,G.isDefined)(e)&&(yield Promise.all(e.features.map((e=>(F=e.geometry,e)))),(0,G.isDefined)(F))){const e=(0,G.getRouteFromEndMeasures)(F);if((0,G.isDefined)(e)){const t=yield(0,G.QueryRouteMeasures)(l,u,e,p.toRouteFromDate,p.toRouteId),n=Math.min(...t),r=Math.max(...t);p.toRouteFromMeasure=_(n,u.measurePrecision),p.toRouteToMeasure=_(r,u.measurePrecision)}if(s&&F.paths.length>0){const e=F.paths[F.paths.length-1].length-1,t=F.getPoint(F.paths.length-1,e);p.selectedToPoint=t,p.selectedToMeasure=p.toRouteToMeasure}}}))))}}return p.selectedPolyline=(0,G.isDefined)(P)?P:null,p.selectedToPolyline=(0,G.isDefined)(P)?P:null,D&&(p.selectedToPolyline=(0,G.isDefined)(F)?F:null),C.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedNetworkDataSource",l),C.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedRouteInfo",p),!0}))}}function q(){var e,t,n;return window.jimuConfig.isBuilder?null===(t=null===(e=(0,C.getAppStore)().getState())||void 0===e?void 0:e.appStateInBuilder)||void 0===t?void 0:t.appConfig:null===(n=(0,C.getAppStore)().getState())||void 0===n?void 0:n.appConfig}})(),o})())}}}));
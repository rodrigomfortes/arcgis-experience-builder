/*! For license information please see arcgis_analysis_node_modules_arcgis_map-config-components_dist_esm-d62e86.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_map-config-components_dist_esm-d62e86"],{4631:(e,t,i)=>{i.r(t),i.d(t,{arcgis_popup:()=>b});var s=i(11254),a=i(93345),o=i(69811),n=i(10465),p=i(56612),l=i(17840),r=i(53127),c=i(51523),h=i(60262),d=i(53287),u=i(23474),m=i(82780),y=i(79865),g=i(14528),f=i(84260);async function w(e){const{layer:t,popupTemplate:i}=e,s=[];if(function(e){const{popupTemplate:t,layerDisplayType:i}=e;return i===p.l.feature&&("fields"!==(t?.content)[0]?.type||!!t.content[0]?.fieldInfos)}(e)){const e=(await(0,o.a)()).createFieldsContent({fields:await(0,l.c)(t),objectIdField:t.objectIdField,editFieldsInfo:t?.editFieldsInfo??void 0}).fieldInfos,a=new Map(i.fieldInfos.map((e=>[e.fieldName,e])));e.forEach((e=>{if(a.has(e.fieldName)){const t=a.get(e.fieldName);s.push(t.clone()),s[s.length-1].visible=!0}})),i.fieldInfos.forEach((e=>{(e.fieldName.includes(p.f.expression)||e.fieldName.includes(p.f.relationship))&&e.visible&&s.push(e.clone())}))}else i.fieldInfos.forEach((e=>{e.visible&&s.push(e.clone())}));return s}const b=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.popupUpdated=(0,s.c)(this,"popupUpdated",7),this.arcgisClose=(0,s.c)(this,"arcgisClose",7),this.arcgisPopupDismissedChange=(0,s.c)(this,"arcgisPopupDismissedChange",7),this.arcgisMultiplePopupsSelected=(0,s.c)(this,"arcgisMultiplePopupsSelected",7),this.closePopupPopovers=(0,s.c)(this,"closePopupPopovers",7),this.manager=(0,g.u)(this),this.strings=(0,f.u)({blocking:!0}),this.hasError=!1,this.isPopupOpenForCurrentLayer=!1,this.popupComponents=[],this.fieldsAndExpressionsData=[],this.fieldsOnlyData=[],this.arcadeBlockOptionsNodes=[],this.relationshipBlockOptionsNodes=[],this.relationshipIconNodes=[],this.associationsBlockNodes=[],this.layerHasAttributes=!0,this.layerHasCharts=!0,this.layerHasImages=!0,this.layerHasText=!0,this.popupState=(0,u.u)(),this.handlePopupUpdate=(0,r.d)((e=>{if(this.mapView.popup?.selectedFeature&&this.mapView.popup?.selectedFeatureWidget?.flowItems?.length){const e=this.mapView.popup.selectedFeature;this.mapView.popup.features=[],setTimeout((()=>this.mapView.popup.features=[e]),1e3)}this.multiplePopupsSelected&&this.arcgisMultiplePopupsSelected.emit(),this.disableEditing||(e&&this.layer?.popupTemplate||this.serviceType===p.s.wms||(this.layerDisplayType===p.l.feature?this.layer.popupEnabled===this.enablePopupsSwitchNode?.checked&&(this.layer.popupTemplate=this.popupTemplate.clone()):this.layerDisplayType===p.l.cluster&&(this.layer.featureReduction.popupTemplate=this.popupTemplate.clone())),this.layerDisplayType===p.l.mapNotes?(this.arcgisChange.emit({mapNotesPopupTemplate:this.mapNotesPopupEnabled?this.popupTemplate.clone():void 0}),this.popupUpdated.emit({mapNotesPopupTemplate:this.mapNotesPopupEnabled?this.popupTemplate.clone():void 0})):(this.arcgisChange.emit(),this.popupUpdated.emit()),this.disableEditing=this.multiplePopupsSelected)}),1e3),this.mapView=void 0,this.layer=void 0,this.portal=void 0,this.config=void 0,this.showConfigureFields=!1,this.hideManageExpressions=!1,this.showManageExpressions=!0,this.hidePopup=!1,this.displayPopup=!0,this.hideLayerTitle=!1,this.backButton=!1,this.dismissible=!1,this.calciteFlowProps=void 0,this.layerDisplayType=p.l.feature,this.mapNotesPopupTemplate=void 0,this.mapNotesGraphic=void 0,this.multiplePopupsSelected=!1,this.disableEditing=!1,this.store=(0,a.c)({mapView:void 0,layer:void 0,portal:void 0,config:void 0,strings:void 0,popupTemplate:void 0,layerDisplayType:void 0,serviceType:void 0,layerHasAttributes:void 0,layerSupportsAttachments:void 0,layerHasCharts:void 0,layerHasImages:void 0,layerHasText:void 0,layerSupportsArcade:void 0,layerHasRelatedRecords:!1,layerIsUNLayer:void 0,layerHasEditInfo:void 0,blockFeatureReductionArcade:!1})}arcadeChangeNotificationHandler(){const e=Array.from(this.el.shadowRoot.querySelectorAll("arcgis-popup-richtext"));if(e?.length){const t=this.popupTemplate?.toJSON().expressionInfos.map((({expression:e,name:t,returnType:i,title:s})=>({name:`expression/${t}`,alias:"New expression"===s?" ":s,type:i,description:e})));this.fieldsAndExpressionsData=t?[...t,...this.fieldsOnlyData]:this.fieldsOnlyData,e.forEach((e=>{e.arcgisColorPickerData.data=this.fieldsAndExpressionsData,e.fieldExpressionData.data=this.fieldsAndExpressionsData}))}(0,s.f)(this.el)}closePopupPopoversHandler(){this.addContentPopoverNode&&(document.body.removeChild(this.addContentPopoverNode),this.addContentPopoverNode=void 0,this.activeCalciteFabNode.disabled=!1,this.activeCalciteFabNode.setFocus(),this.handleDisablePopupPanel(!1))}async setFocus(){this.activeCalciteFabNode?.setFocus()}async update(){this.handlePopupUpdate()}async done(){const e=Array.from(this.el.shadowRoot.querySelectorAll("arcgis-popup-multimedia"));await Promise.all(e.map((async e=>await e.resetMultimediaIndex()))),this.attributesNode?.done(),this.closePopupPopovers.emit(),await this.showPreviewPopup(!1)}async componentWillLoad(){console.warn("%cmap-config-components","background: #007AC2; color: #fff; border-radius: 4px; padding: 2px 4px;",'[arcgis-popup] component in @arcgis/map-config-components is deprecated and will be removed soon. Use "arcgis-map-config-popup" instead.'),this.showManageExpressions||this.hideManageExpressions||(this.hideManageExpressions=!0),this.displayPopup||this.hidePopup||(this.hidePopup=!0),await this.loadAllModules();const{popupState:e}=this;if(this.serviceType=(0,l.a)(this.layer),this.layer&&"load"in this.layer&&await this.layer.load(),this.layerSupportsArcade=!this.hideManageExpressions&&(this.layerDisplayType===p.l.feature||this.layerDisplayType===p.l.cluster)&&this.serviceType!==p.s.ogcFeature&&this.serviceType!==p.s.imagery&&this.serviceType!==p.s.imageryTile&&this.serviceType!==p.s.wcs,this.serviceType===p.s.tile&&"url"in this.layer&&!("type"in this.layer)&&this.layer.url.indexOf(this.layer.layer.url)>-1)this.hasError=!0,console.error("popups not supported, no related feature service");else if(this.serviceType!==p.s.wms)if(this.layerDisplayType===p.l.feature){const t=this.mapView.popup.visible?this.mapView.popup.selectedFeature?.sourceLayer:void 0,i="type"in this.layer?this.layer.type:"sublayer";this.isPopupOpenForCurrentLayer="subtype-sublayer"===i?t?.subtypeCode===this.layer.subtypeCode&&t?.parent.id===this.layer.parent.id:"sublayer"===i?t?.id===this.layer.id&&t?.layer.id===this.layer.layer.id:"id"in this.layer&&t?.id===this.layer.id,this.popupTemplate=this.layer.popupTemplate?this.layer.popupTemplate.clone():this.layer.createPopupTemplate(),this.popupTemplate.fieldInfos=[...await(0,c.g)(this.layer,this.popupTemplate)],(0,l.i)(this.layer.capabilities?.data?.supportsAttachment)&&(this.layerSupportsAttachments=this.layer.capabilities.data.supportsAttachment),e.layerHasRelatedRecords=await(0,u.l)(this.layer,this.mapView,this.serviceType),this.layerHasEditInfo=!!this.layer.editFieldsInfo,this.serviceType!==p.s.mapImage||this.layer.popupTemplate||(this.layer.popupEnabled=!1)}else if(this.layerDisplayType===p.l.cluster)this.popupTemplate=this.layer.featureReduction.popupTemplate.clone(),this.layerSupportsAttachments=!1,this.layerHasEditInfo=!1;else if(this.layerDisplayType===p.l.mapNotes){if(this.mapNotesPopupTemplate)this.mapNotesPopupEnabled=!0,this.popupTemplate=this.mapNotesPopupTemplate.clone();else{this.mapNotesPopupEnabled=!1;const e=await(0,o.R)();this.popupTemplate=new e}this.layerHasAttributes=!1,this.layerSupportsAttachments=!1,this.layerHasCharts=!1,this.layerHasEditInfo=!1}this.calciteFlowProps?.calciteFab&&!this.isPopupEnabled()&&(this.calciteFlowProps.calciteFab.hidden=!0),e.layer=this.layer,e.mapView=this.mapView,e.portal=this.portal,e.config=this.config,e.strings=this.strings,e.popupTemplate=this.popupTemplate,e.layerDisplayType=this.layerDisplayType,e.serviceType=this.serviceType,e.layerHasAttributes=this.layerHasAttributes,e.layerSupportsAttachments=this.layerSupportsAttachments,e.layerHasCharts=this.layerHasCharts,e.layerHasImages=this.layerHasImages,e.layerHasText=this.layerHasText,e.layerSupportsArcade=this.layerSupportsArcade,e.layerIsUNLayer=(0,y.i)(this.popupState),e.layerHasEditInfo=this.layerHasEditInfo,e.blockFeatureReductionArcade=(0,d.d)(this.popupState),this.layerDisplayType===p.l.cluster&&(this.featureReductionArcadeHandle=this.getFeatureReductionArcadeHandle(e)),e.layerIsUNLayer&&(this.utilityNetworkLayerHandle=this.getUtilityNetworkLayerHandle(e))}async componentDidLoad(){const{strings:e}=this;if(this.popupTemplate){if("string"==typeof this.popupTemplate.content){const e=await(0,o.S)();this.popupTemplate.content=[new e({text:this.popupTemplate.content})]}Array.isArray(this.popupTemplate.content)?(await Promise.all(this.popupTemplate.content.map((async(e,t)=>{if("fields"===e.type){const t=await(0,l.c)(this.layer),i=(e.fieldInfos??await w(this.popupState)).filter((e=>{const i=t.find((t=>t.name===e.fieldName));return!i||i.visible}));e.fieldInfos=i,e.title=e.title??"",e.description=e.description??""}"attachments"!==e.type||this.layerSupportsAttachments||this.popupTemplate.content.splice(t,1)}))),this.popupTemplate.content.forEach((e=>this.addNewPopupContentToExistingPopupContent(e)))):console.error("content not supported"),(0,s.f)(this.el)}if(this.serviceType!==p.s.wms){if(this.layerDisplayType===p.l.feature&&this.watchForChangesToLayersList(),this.calciteFlowProps&&!this.calciteFlowProps.calciteFab){const t=document.createElement("calcite-fab");t.icon="plus",t.slot="fab",t.scale="s",t.appearance="outline-fill",t.kind="neutral",t.label=e.addContent,t.text=e.addContent,t.textEnabled=!0,this.isPopupEnabled()||(t.hidden=!0),this.calciteFlowProps.calciteFab=t,this.calciteFlowProps.calciteFlowItem.appendChild(t)}this.activeCalciteFabNode=this.calciteFlowProps?.calciteFab??this.internalCalciteFabNode,this.activeCalciteFabNode?.addEventListener("click",(e=>{e.stopPropagation(),this.closePopupPopovers.emit();const{popupState:t}=this;this.addContentPopoverNode||(this.addContentPopoverNode=document.createElement("arcgis-popup-add-content-popover"),this.addContentPopoverNode.referenceElement=this.activeCalciteFabNode,this.addContentPopoverNode.popupHasAttachmentInfo=this.popupTemplate.content.some((e=>"attachments"===e.type)),this.addContentPopoverNode.popoverPanelWidth=this.el.getBoundingClientRect().width,this.addContentPopoverNode.popupState=t,this.addContentPopoverNode.addEventListener("arcgisAddPopoverContent",(async e=>{const t=e.detail;await this.handleAddNewPopupContent(t)})),document.body.appendChild(this.addContentPopoverNode),this.activeCalciteFabNode.disabled=!0,this.handleDisablePopupPanel(!0))}))}this.wrappingFlowItemNode?.addEventListener("calciteFlowItemBack",(()=>this.closePopupPopovers.emit())),this.wrappingFlowItemNode?.setFocus(),this.setUpResizeObserver()}componentDidUpdate(){if(this.handlePopupUpdate(),this.scrollToNewPopupComponent){const e=this.el.shadowRoot.querySelectorAll("arcgis-calcite-block-options"),t=e[e.length-1];t?.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),t?.setFocus(),this.scrollToNewPopupComponent=!1}}async disconnectedCallback(){if(this.resizeObserver?.disconnect(),this.layerTableHandle?.remove(),this.featureReductionArcadeHandle?.remove(),this.utilityNetworkLayerHandle?.remove(),this.addContentPopoverNode?.parentElement?.removeChild(this.addContentPopoverNode),this.addContentPopoverNode=void 0,this.activeCalciteFabNode?.parentElement?.removeChild(this.activeCalciteFabNode),this.activeCalciteFabNode=void 0,this.attributesNode?.parentElement){await this.attributesNode.done();const e=this.attributesNode.parentElement;e.parentElement?.removeChild(e),this.attributesNode=void 0}if(this.expressionsNode?.parentElement){const e=this.expressionsNode.parentElement;e.parentElement?.removeChild(e),this.expressionsNode=void 0}}render(){const{strings:e,hasError:t,serviceType:i,calciteFlowProps:a,hideLayerTitle:o,dismissible:n}=this;return t?(0,s.h)(s.H,{class:"calcite-match-height"},a?(0,s.h)("div",{ref:()=>this.wrappingFlowItemNode=a.calciteFlowItem},this.renderPopupErrorMessage()):(0,s.h)("calcite-flow",{ref:e=>this.internalFlowNode=e},(0,s.h)("calcite-flow-item",{heading:e.popupHeading,closable:n,description:o?void 0:this.layer.title??void 0,onCalciteFlowItemClose:e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit(),this.arcgisPopupDismissedChange.emit()},ref:e=>this.wrappingFlowItemNode=e},this.renderPopupErrorMessage()))):(a&&(this.wrappingFlowItemNode=a.calciteFlowItem),(0,s.h)(s.H,{class:"calcite-match-height"},a?(0,s.h)(s.F,null,i===p.s.wms?this.renderEnablePopupSwitch():this.renderAllPopupContent()):(0,s.h)("calcite-flow",{customItemSelectors:"arcgis-popup-expressions",ref:e=>this.internalFlowNode=e},(0,s.h)("calcite-flow-item",{heading:e.popupHeading,closable:n,description:o?void 0:this.layer.title??void 0,onCalciteFlowItemBack:e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit(),this.arcgisPopupDismissedChange.emit()},onCalciteFlowItemClose:e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit(),this.arcgisPopupDismissedChange.emit()},ref:e=>this.wrappingFlowItemNode=e},this.renderBackButton(),i===p.s.wms?this.renderEnablePopupSwitch():this.renderAllPopupContent(),i!==p.s.wms&&this.renderAddContentFab()))))}renderPopupErrorMessage(){const{strings:e}=this;return(0,s.h)("div",{class:"error-notice"},(0,s.h)("calcite-notice",{open:!0,closable:!1,icon:"exclamation-mark-triangle",scale:"s"},(0,s.h)("div",{slot:"message"}," ",e.popupTileError)))}renderBackButton(){const{strings:e,backButton:t}=this;return t?(0,s.h)("calcite-action",{text:e.back,scale:"s",slot:"header-actions-start",onClick:e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit(),this.arcgisPopupDismissedChange.emit()}},(0,s.h)("calcite-icon",{scale:"s",icon:"rtl"===(0,n.b)(this.el)?"chevron-right":"chevron-left"})):(0,s.h)(s.F,null)}renderEnablePopupSwitch(){const{strings:e,layerDisplayType:t}=this;return(0,s.h)("calcite-label",{class:"enable-popup-switch",alignment:"start",layout:"inline-space-between"},e.enablePopup,(0,s.h)("calcite-switch",{scale:"s",checked:this.isPopupEnabled(),onCalciteSwitchChange:e=>{const i=e.target.checked;switch(t){case p.l.feature:this.layer.popupEnabled=i;break;case p.l.cluster:this.layer.featureReduction.popupEnabled=i;break;case p.l.mapNotes:this.mapNotesPopupEnabled=i;break;default:this.layer.popupEnabled=i}this.showPopupContentInPanel(i),this.handlePopupUpdate(!0),t!==p.l.mapNotes&&i&&!this.layer.popupTemplate&&(this.layer.popupTemplate=this.popupTemplate),this.showPreviewPopup(i)},ref:e=>this.enablePopupsSwitchNode=e}))}renderAllPopupContent(){const{strings:e,layerHasEditInfo:t}=this;return(0,s.h)(s.F,null,this.renderEnablePopupSwitch(),(0,s.h)("div",{hidden:!this.isPopupEnabled(),ref:e=>this.popupContentWrapperNode=e},this.renderPopupOptions(),this.renderPopupTitle(),(0,s.h)("calcite-block-group",{dragEnabled:!0,label:e.popupHeading,onCalciteBlockGroupOrderChange:e=>{const t=e.detail.oldIndex,i=e.detail.newIndex,s=this.popupTemplate.content.splice(t,1)[0];this.popupTemplate.content.splice(i,0,s);const a=this.popupComponents.splice(t,1)[0];this.popupComponents.splice(i,0,a),this.handlePopupUpdate()}},this.popupComponents),t&&this.popupTemplate.lastEditInfoEnabled?(0,s.h)("div",{class:"edit-info-summary",ref:e=>this.editInfoDivNode=e},this.renderEditInfoSummary()):null))}renderPopupOptions(){const{strings:e,layerSupportsArcade:t,showConfigureFields:i,serviceType:a}=this,o=a===p.s.imagery;return o||t||i?(0,s.h)("calcite-block",{heading:e.options,open:!0,collapsible:!0},o&&this.renderImageryOptions(),t&&this.renderManageExpressionsButton(),i&&this.renderConfigureFieldsButton()):(0,s.h)(s.F,null)}renderImageryOptions(){const{layer:e}=this,t=!!e.capabilities?.operations?.supportsQuery&&e.fields?.length,i=e.hasMultidimensions,a=(0,l.e)(e)>=10.8&&(t||i);return(0,s.h)("div",{class:"imagery-options"},this.renderIgnoreNoData(),a&&this.renderDisplayTopmostRaster())}renderIgnoreNoData(){const{strings:e}=this;return(0,s.h)("calcite-label",{alignment:"start",layout:"inline-space-between"},e.ignoreNoData,(0,s.h)("calcite-switch",{scale:"s",checked:!this.popupTemplate?.layerOptions?.showNoDataRecords,onCalciteSwitchChange:e=>{const t=e.target.checked;this.popupTemplate?.layerOptions||this.createLayerOptions(),this.popupTemplate.layerOptions.showNoDataRecords=!t,this.handlePopupUpdate()}}))}renderDisplayTopmostRaster(){const{strings:e}=this;return(0,s.h)("calcite-label",{alignment:"start",layout:"inline-space-between"},e.displayTopmost,(0,s.h)("calcite-switch",{scale:"s",checked:this.popupTemplate?.layerOptions?.returnTopmostRaster??!0,onCalciteSwitchChange:e=>{const t=e.target.checked;this.popupTemplate?.layerOptions||this.createLayerOptions(),this.popupTemplate.layerOptions.returnTopmostRaster=t,this.handlePopupUpdate()}}))}renderManageExpressionsButton(){const{strings:e}=this;return(0,s.h)("calcite-button",{alignment:"icon-end-space-between",appearance:"transparent",kind:"neutral",iconEnd:"rtl"===(0,n.b)(this.el)?"chevron-left":"chevron-right",label:e.manageExpressions,width:"full",onClick:e=>{e.stopPropagation(),this.handleManageExpressionsClick()}},e.manageExpressions)}renderConfigureFieldsButton(){const{strings:e}=this;return(0,s.h)("calcite-button",{alignment:"icon-end-space-between",appearance:"transparent",kind:"neutral",iconEnd:"rtl"===(0,n.b)(this.el)?"chevron-left":"chevron-right",label:e.configureFields,width:"full",onClick:t=>{t.stopPropagation(),this.closePopupPopovers.emit();const i=document.createElement("calcite-flow-item");i.heading=e.attributes,i.description=this.layer.title,i.selected=!0,this.wrappingFlowItemNode.selected=!1,this.attributesNode=document.createElement("arcgis-attributes"),this.attributesNode.mapView=this.mapView,this.attributesNode.layer=this.layer,this.attributesNode.portal=this.portal,this.attributesNode.config=this.config,this.attributesNode.layerDisplayType=this.layerDisplayType,this.attributesNode.calciteFlowProps=!0,this.attributesNode.hidePopup=!0,this.attributesNode.addEventListener("arcgisChange",(async e=>{e.stopPropagation(),this.popupTemplate=this.layer.popupTemplate.clone(),this.popupComponents=[],this.popupTemplate.content.forEach((e=>this.addNewPopupContentToExistingPopupContent(e)));const t=Array.from(this.el.shadowRoot.querySelectorAll("arcgis-popup-attributes"));await Promise.all(t.map((async e=>await e.syncWithFieldsList()))),(0,s.f)(this.el),this.popupState.popupTemplate=this.popupTemplate})),i.appendChild(this.attributesNode),i.addEventListener("calciteFlowItemBack",(async()=>{await(this.attributesNode?.done()),i.parentElement?.removeChild(i),this.attributesNode=void 0,this.wrappingFlowItemNode.selected=!0})),this.calciteFlowProps?this.calciteFlowProps.calciteFlow.appendChild(i):this.internalFlowNode?.appendChild(i),i.setFocus()}},e.configureFields)}renderPopupTitle(){return(0,s.h)("arcgis-popup-title",{referenceElement:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:e=>{e.stopPropagation(),this.handlePopupUpdate()}})}renderPopupAttributes(e,t){const{strings:i,popupTemplate:a}=this;return(0,s.h)("calcite-block",{key:(0,n.a)(),heading:i.fieldsList,open:t,collapsible:!0,description:e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||`${e.fieldInfos.length}/${a.fieldInfos.length} ${i.attributes_L}`},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-calcite-block-options",{calciteBlockOptions:{hasDelete:!0,hasDuplicate:!0},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e)})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"feature-details"})),(0,s.h)("arcgis-popup-attributes",{fieldsContent:e,popupFlowItem:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const{popupState:s}=this,{popupTemplate:a}=s,o=e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||`${e.fieldInfos.length}/${a.fieldInfos.length} ${i.attributes_L}`;t.target.parentElement.description=o,this.handlePopupUpdate()}}))}renderPopupAttachments(e,t){const{strings:i}=this,a=(0,l.i)(this.layer.capabilities?.attachment?.supportsResize)?this.layer.capabilities.attachment.supportsResize:!!this.layer?.capabilities?.operations?.supportsResizeAttachments,o=!!this.layer?.sourceJSON?.advancedQueryCapabilities?.supportsQueryAttachmentOrderByFields;return(0,s.h)("calcite-block",{key:(0,n.a)(),open:t,heading:i.attachments,description:e.title?`${e.title.substring(0,25)}${e.title.length>25?"...":""}`:this.getAttachmentContentDescription(e),collapsible:!0,onCalciteBlockToggle:()=>this.closePopupPopovers.emit()},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-calcite-block-options",{calciteBlockOptions:{hasDelete:!0,hasDuplicate:!0},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e)})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"attachment"})),(0,s.h)("arcgis-popup-attachments",{attachmentsContent:e,layerSupportsResizeAttachments:a,layerSupportsOrderingAttachments:o,popupFlowItem:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const i=e.title?`${e.title.substring(0,25)}${e.title.length>25?"...":""}`:this.getAttachmentContentDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderPopupMultimedia(e,t){const{strings:i}=this;return(0,s.h)("calcite-block",{key:(0,n.a)(),open:t,heading:e.mediaInfos.length>1?i.mediaGroup:i.media,description:e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||this.getMediaBlockDescription(e),collapsible:!0,onCalciteBlockToggle:()=>this.closePopupPopovers.emit()},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-calcite-block-options",{calciteBlockOptions:{hasDelete:!0,hasDuplicate:!0},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e)})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"images"})),(0,s.h)("arcgis-popup-multimedia",{blockOpen:t,mediaContent:e,popupFlowItem:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisChange:t=>{t.stopPropagation();const i=e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||this.getMediaBlockDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderPopupText(e,t){const{strings:i}=this,a=this.popupTemplate.toJSON(),o=a.fieldInfos?.map((({fieldName:e,label:t})=>({name:e,alias:t||e})));this.fieldsOnlyData=o||[];const p=this.popupTemplate?.toJSON().expressionInfos,l=p?.map((({expression:e,name:t,returnType:i,title:s})=>({name:`expression/${t}`,alias:"New expression"===s?" ":s,type:i,description:e})));return l?.length&&(this.fieldsOnlyData=this.fieldsOnlyData.filter((e=>!l.some((t=>t.name===e.name))))),this.fieldsAndExpressionsData=l?[...l,...this.fieldsOnlyData]:this.fieldsOnlyData,(0,s.h)("calcite-block",{key:(0,n.a)(),heading:i.text,open:t,collapsible:!0,description:this.getRichTextBlockDescription(e,25),onCalciteBlockToggle:()=>this.closePopupPopovers.emit()},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-calcite-block-options",{calciteBlockOptions:{hasDelete:!0,hasDuplicate:!0},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e)})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"text"})),(0,s.h)("arcgis-popup-richtext",{blockOpen:t,fieldExpressionData:{data:this.fieldsAndExpressionsData,placeholderText:i.searchFields,heading:i.selectField,label:i.fieldsListPluginName,mapView:this.mapView,layer:this.layer},arcgisColorPickerData:{data:this.fieldsAndExpressionsData,filterPlaceholder:i.searchAttributes,label:i.colorPicker,doneText:i.done,customText:i.customText,attributeText:i.attributeText},popupTextContent:e,popupFlowItem:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const i=this.getRichTextBlockDescription(e,25);t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderPopupArcade(e,t){const{strings:i}=this;return(0,s.h)("calcite-block",{key:(0,n.a)(),heading:i.arcade,description:e.expressionInfo.title??void 0,collapsible:!0,open:t},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-calcite-block-options",{calciteBlockOptions:{hasDelete:!0,hasDuplicate:!0,disableDuplicate:this.popupState.blockFeatureReductionArcade},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e),ref:e=>{e&&this.arcadeBlockOptionsNodes.push(e)}})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"code"})),(0,s.h)("arcgis-popup-arcade",{expressionContent:e,blockOpen:t,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const i=e.expressionInfo.title??"";t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderPopupRelationship(e,t){const{strings:i}=this,a=this.getRelationshipDescription(e);return(0,s.h)("calcite-block",{key:(0,n.a)(),heading:i.relatedRecords,open:t,collapsible:!0,description:a,onCalciteBlockToggle:()=>this.closePopupPopovers.emit()},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-calcite-block-options",{calciteBlockOptions:{hasDelete:!0,hasDuplicate:!0,disableDuplicate:!this.popupState.layerHasRelatedRecords},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e),ref:e=>{e&&this.relationshipBlockOptionsNodes.push(e)}})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:this.popupState.layerHasRelatedRecords?"link":"exclamation-mark-triangle",ref:e=>{e&&this.relationshipIconNodes.push(e)}})),(0,s.h)("arcgis-popup-relationship",{relationshipContent:e,popupFlowItem:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const i=this.getRelationshipDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderPopupAssociations(e,t){const{strings:i}=this;return(0,s.h)("calcite-block",{key:(0,n.a)(),disabled:!this.popupState.layerIsUNLayer,heading:i.associations.associations,description:e.title?this.getAssociationsBlockCustomDescription(e.title):this.getAssociationsBlockDefaultDescription(e),collapsible:!0,open:this.popupState.layerIsUNLayer&&t,ref:e=>{e&&this.associationsBlockNodes.push(e)}},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-calcite-block-options",{calciteBlockOptions:{hasDelete:!0,hasDuplicate:!1},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e)})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"view-associations"})),(0,s.h)("arcgis-popup-associations",{associationsContent:e,referenceElement:this.wrappingFlowItemNode,blockOpen:t,onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const i=e.title?this.getAssociationsBlockCustomDescription(e.title):this.getAssociationsBlockDefaultDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderEditInfoSummary(){const{strings:e}=this;return(0,s.h)(s.F,null,(0,s.h)("calcite-icon",{class:"edit-info-icon",icon:"user"}),(0,s.h)("div",{class:"edit-info-text"},e.editInfoSummaryHeading),(0,s.h)("calcite-action",{text:e.remove,appearance:"transparent",icon:"x",onClick:e=>{e.stopPropagation(),this.closePopupPopovers.emit(),this.popupTemplate.lastEditInfoEnabled=!1,(0,s.f)(this.el),this.activeCalciteFabNode?.setFocus()}}))}renderAddContentFab(){const{strings:e}=this;return(0,s.h)("calcite-fab",{hidden:!this.isPopupEnabled(),icon:"plus",slot:"fab",scale:"s",appearance:"outline-fill",kind:"neutral",label:e.addContent,text:e.addContent,textEnabled:!0,ref:e=>this.internalCalciteFabNode=e})}async loadAllModules(){const[e,t,i,s,a,n,p,l,r,c,h,d,u]=await Promise.all([(0,o.l)(),(0,o.T)(),(0,o.U)(),(0,o.V)(),(0,o.W)(),(0,o.X)(),(0,o.Y)(),(0,o.Z)(),(0,o._)(),(0,o.S)(),(0,o.$)(),(0,o.a0)(),(0,o.a1)()]);this.modules={reactiveUtils:e,LayerOptions:t,FieldsContent:i,AttachmentsContent:s,MediaContent:a,ImageMediaInfo:n,ColumnChartMediaInfo:p,ImageMediaInfoValue:l,ChartMediaInfoValue:r,TextContent:c,ExpressionContent:h,RelationshipContent:d,UtilityNetworkAssociationsContent:u}}isPopupEnabled(){const{layerDisplayType:e,serviceType:t}=this;switch(e){case p.l.feature:return(t===p.s.wms||!!this.layer.popupTemplate)&&this.layer.popupEnabled;case p.l.cluster:return this.layer.featureReduction.popupEnabled;case p.l.mapNotes:return this.mapNotesPopupEnabled;default:return this.layer.popupEnabled}}showPopupContentInPanel(e){const{serviceType:t}=this;t!==p.s.wms&&(this.popupContentWrapperNode.style.display=e?"block":"none",this.activeCalciteFabNode.style.display=e?"block":"none"),this.closePopupPopovers.emit()}handleDisablePopupPanel(e){this.wrappingFlowItemNode.disabled=e}createLayerOptions(){const{modules:e}=this,t=this.popupTemplate.layerOptions??new e.LayerOptions;t.showNoDataRecords=t.showNoDataRecords??!1,t.returnTopmostRaster=t.returnTopmostRaster??!0,this.popupTemplate.layerOptions=t}async showPreviewPopup(e){const{layerDisplayType:t}=this;this.hidePopup||t!==p.l.feature||this.isPopupOpenForCurrentLayer?t===p.l.mapNotes&&(e&&this.mapNotesGraphic?this.mapView.openPopup({features:[this.mapNotesGraphic],location:(0,l.d)(this.mapNotesGraphic.geometry)}):this.mapView.closePopup()):e&&this.layer.popupEnabled&&this.layer.popupTemplate?(this.mapView.popup?.features?.length&&(this.mapView.closePopup(),this.mapView.popup.features=[]),this.previewPopupController=new AbortController,await(0,h.p)(this.mapView,this.layer,this.previewPopupController)):(this.previewPopupController?.abort(),this.mapView.closePopup())}async handleAddNewPopupContent(e){this.closePopupPopovers.emit(),e===m.C.EDIT_INFO_SUMMARY?(this.popupTemplate.lastEditInfoEnabled=!0,setTimeout((()=>{this.editInfoDivNode?.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),this.activeCalciteFabNode.setFocus()}),300)):await this.createNewPopupContent(e),(0,s.f)(this.el)}async createNewPopupContent(e){const{modules:t}=this;let i=null;if(e===m.C.ATTRIBUTES){const e=await(0,l.c)(this.layer),s=(await w(this.popupState)).filter((t=>{const i=e.find((e=>e.name===t.fieldName));return!i||i.visible}));i=new t.FieldsContent({fieldInfos:s,title:"",description:""})}else if(e===m.C.ATTACHMENTS)i=new t.AttachmentsContent({displayType:void 0});else if(e===m.C.CHARTS){const e=new t.ColumnChartMediaInfo({title:"",caption:"",altText:"",value:new t.ChartMediaInfoValue({fields:[]})});i=new t.MediaContent({mediaInfos:[e]})}else if(e===m.C.IMAGES){const e=new t.ImageMediaInfo({title:"",caption:"",altText:"",value:new t.ImageMediaInfoValue({sourceURL:"",linkURL:""})});i=new t.MediaContent({mediaInfos:[e]})}else if(e===m.C.RICH_TEXT)i=new t.TextContent({text:null});else if(e===m.C.ARCADE)i=new t.ExpressionContent({expressionInfo:{expression:(0,d.g)(this.layerDisplayType,this.strings)}});else if(e===m.C.RELATIONSHIP){const e=await(0,u.g)(this.layer,this.mapView,this.serviceType);let s=e.currLayer.fields.find((e=>e.visible&&"date"===e.type));s||(s=e.currLayer.fields.find((e=>e.visible))),i=new t.RelationshipContent({displayCount:1,relationshipId:e.relationship.id,orderByFields:[{field:s.name,order:"asc"}]})}else if(e===m.C.ASSOCIATIONS){const e=[{type:"attachment"}];i=new t.UtilityNetworkAssociationsContent({associationTypes:e,displayCount:1,title:"",description:""})}this.popupTemplate.content.push(i),this.addNewPopupContentToExistingPopupContent(i,!0)}addNewPopupContentToExistingPopupContent(e,t=!1){t&&(this.scrollToNewPopupComponent=!0),"fields"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupAttributes(e,t)]:"attachments"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupAttachments(e,t)]:"media"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupMultimedia(e,t)]:"text"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupText(e,t)]:"expression"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupArcade(e,t)]:"relationship"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupRelationship(e,t)]:"utility-network-associations"===e.type&&(this.popupComponents=[...this.popupComponents,this.renderPopupAssociations(e,t)])}handleManageExpressionsClick(){const{strings:e}=this;this.closePopupPopovers.emit();const t=document.createElement("calcite-flow-item");t.heading=e.manageExpressions,t.selected=!0,this.expressionsNode=document.createElement("arcgis-popup-expressions"),this.expressionsNode.popupState=this.popupState,this.expressionsNode.addEventListener("arcgisChange",(e=>{e.stopPropagation(),this.handlePopupUpdate()})),t.appendChild(this.expressionsNode),t.addEventListener("calciteFlowItemBack",(()=>{t.parentElement?.removeChild(t),this.expressionsNode=void 0,this.wrappingFlowItemNode.selected=!0})),this.calciteFlowProps?this.calciteFlowProps.calciteFlow.appendChild(t):this.internalFlowNode?.appendChild(t),this.wrappingFlowItemNode.selected=!1,this.expressionsNode.setFocus()}handleDeleteIndividualPopupContent(e){this.closePopupPopovers.emit();const t=this.el.shadowRoot.querySelectorAll("arcgis-calcite-block-options"),i=e.target,a=Array.from(t).indexOf(i);this.popupTemplate.content.splice(a,1),this.popupComponents.splice(a,1),(0,s.f)(this.el),this.activeCalciteFabNode?.setFocus()}handleDuplicateIndividualPopupContent(e){this.closePopupPopovers.emit();const t=this.el.shadowRoot.querySelectorAll("arcgis-calcite-block-options"),i=e.target,a=Array.from(t).indexOf(i),o=this.popupTemplate.content[a].clone();this.popupTemplate.content.push(o),this.addNewPopupContentToExistingPopupContent(o,!0),(0,s.f)(this.el)}async setUpResizeObserver(){const{layerDisplayType:e}=this,t=this.el?.parentElement;if("CALCITE-SHELL-PANEL"===t?.tagName){const e=t;(0,l.i)(e.collapsed)&&(this.resizeObserver=new ResizeObserver((async()=>{if(e.collapsed)this.done();else{const{mapView:e}=this;e.popup?.active||await this.showPreviewPopup(!0)}})),this.resizeObserver.observe(e))}else(e!==p.l.mapNotes||(0,l.i)(this.mapNotesPopupTemplate))&&await this.showPreviewPopup(!0)}watchForChangesToLayersList(){const{modules:e,layerDisplayType:t,serviceType:i}=this;t===p.l.feature&&[p.s.feature,p.s.mapImage].includes(i)&&this.layer?.relationships?.length&&(this.layerTableHandle=e.reactiveUtils.watch((()=>[this.mapView.map?.allLayers.length,this.mapView.map?.allTables.length]),(async()=>{this.popupState.layerHasRelatedRecords=await(0,u.l)(this.layer,this.mapView,this.serviceType),this.relationshipBlockOptionsNodes?.forEach((e=>{e.calciteBlockOptions.disableDuplicate=!this.popupState.layerHasRelatedRecords,(0,s.f)(e)})),this.relationshipIconNodes?.forEach((e=>{e.icon=this.popupState.layerHasRelatedRecords?"link":"exclamation-mark-triangle"}))})))}getFeatureReductionArcadeHandle(e){const{modules:t}=this,{layer:i,mapView:a}=e;return t.reactiveUtils.watch((()=>a.scale),(()=>{const e=i.featureReduction;a.scale<=e.maxScale&&!this.popupState.blockFeatureReductionArcade?this.popupState.blockFeatureReductionArcade=!0:a.scale>e.maxScale&&this.popupState.blockFeatureReductionArcade&&(this.popupState.blockFeatureReductionArcade=!1),this.arcadeBlockOptionsNodes?.forEach((e=>{e.calciteBlockOptions.disableDuplicate=this.popupState.blockFeatureReductionArcade,(0,s.f)(e)}))}))}getUtilityNetworkLayerHandle(e){const{modules:t}=this,{mapView:i,layer:s}=e,{map:a}=i;return t.reactiveUtils.watch((()=>a.utilityNetworks?.length),(e=>{if(e){const e=(0,y.g)(s),t=a.utilityNetworks.find((t=>t.sourceJSON?.serviceItemId===e));this.popupState.layerIsUNLayer=(0,l.i)(t)}else this.popupState.layerIsUNLayer=!1;this.associationsBlockNodes?.forEach((e=>{e.disabled=!this.popupState.layerIsUNLayer,this.popupState.layerIsUNLayer||(e.open=!1)})),this.closePopupPopovers.emit()}))}getAttachmentContentDescription(e){const{popupState:t}=this,{strings:i}=t;switch(e.displayType){case m.A.AUTO:return i.auto;case m.A.LIST:return i.list;case m.A.PREVIEW:return i.gallery;default:return i.list}}getMediaBlockDescription(e){const{popupState:t}=this,{strings:i}=t;return e.mediaInfos.length>1?`${i.multiple} (${e.mediaInfos.length})`:e.mediaInfos.length?this.getMultimediaTypeString(e):""}getMultimediaTypeString(e){const t=e.mediaInfos[0].type,{popupState:i}=this,{strings:s}=i;return t===m.P.IMAGE?s.image:t===m.P.BAR_CHART||t===m.P.COLUMN_CHART?s.barChart:t===m.P.LINE_CHART?s.lineChart:t===m.P.PIE_CHART?s.pieChart:s.image}getRichTextBlockDescription(e,t){const i=e.text??"",s=document.createElement("div");s.innerHTML=i;const a=s.textContent||s.innerText||"";return`${a.substring(0,t)}${a.length>t?"...":""}`}getRelationshipDescription(e){const{popupState:t}=this,{strings:i,layer:s}=t,a=s.relationships.find((t=>t.id===e.relationshipId));return e.title?`${e.title.substring(0,25)}${e.title.length>25?"...":""}`:a?.name||i.selectTable}getAssociationsBlockDefaultDescription(e){const{strings:t}=this;return 1===e.associationTypes.length?this.getAssociationTypeString(e.associationTypes[0].type):`${t.multiple} (${e.associationTypes.length})`}getAssociationsBlockCustomDescription(e){return`${e.substring(0,25)}${e.length>25?"...":""}`}getAssociationTypeString(e){const{strings:t}=this;switch(e){case"attachment":return t.associations.attachment;case"connectivity":return t.associations.connectivity;case"container":return t.associations.container;case"content":return t.associations.content;case"structure":return t.associations.structure}}static get assetsDirs(){return["assets"]}get el(){return(0,s.a)(this)}};b.style=".error-notice{margin:var(--calcite-spacing-sm)}.enable-popup-switch{background-color:var(--calcite-color-foreground-1);padding:var(--calcite-spacing-lg) var(--calcite-spacing-sm) var(--calcite-spacing-xxs);border-bottom:solid 1px var(--calcite-color-foreground-3)}.imagery-options{padding:0 var(--calcite-spacing-md)}.edit-info-summary{display:flex;align-items:center;justify-content:space-between}.edit-info-icon{padding:0 var(--calcite-spacing-sm)}.edit-info-text{font-size:var(--calcite-font-size)}"},23474:(e,t,i)=>{i.d(t,{a:()=>p,c:()=>r,g:()=>d,l:()=>l,r:()=>h,u:()=>m});var s=i(56612),a=i(17840),o=i(14528),n=i(10465);function p(e){let t=[...e.map?.allLayers?.toArray()||[],...e.map?.allTables?.toArray()||[]];return t.forEach((e=>{if("map-image"===e.type||"subtype-group"===e.type){const i=e;t=t.concat([...i.sublayers])}})),t}async function l(e,t,i){const a=e.capabilities?.queryRelated?.supportsCount,o=e.capabilities?.queryRelated?.supportsPagination;if([s.s.feature,s.s.scene,s.s.mapImage,s.s.subtype].includes(i)&&e?.relationships?.length&&a&&o)for(const i of e.relationships){const s=p(t);for(const t of s){const s=t;if(await c(e,s,i))return await s.load(),await Promise.resolve(!0)}}return await Promise.resolve(!1)}async function r(e,t){const{layer:i,mapView:s}=e;if(!i)return await Promise.resolve(!1);for(const e of i.relationships)if(e.id===t.relationshipId){const t=p(s);for(const s of t){const t=s;if(await c(i,t,e))return await t.load(),await Promise.resolve(!0)}return await Promise.resolve(!1)}return await Promise.resolve(!1)}async function c(e,t,i){const s=t.url?t.url===e.url||u(t)===u(e):"type"in t.parent&&"group"===t.parent.type&&"portalItem"in e&&t.parent?.portalItem?.id===e.portalItem?.id;["feature","scene"].includes(t.type)&&s&&"layerId"in t&&!(0,a.i)(t.layerId)&&await t.load();const o="sublayer"===t.type||"subtype-sublayer"===t.type;return await Promise.resolve(["feature","scene","sublayer","subtype-group","subtype-sublayer"].includes(t.type)&&s&&(!o&&t.layerId===i.relatedTableId||o&&t.id===i.relatedTableId))}function h(e,t,i){const s=t.url?t.url===e.url||u(t)===u(e):"type"in t.parent&&"group"===t.parent.type&&"portalItem"in e&&t.parent?.portalItem?.id===e.portalItem?.id,a="sublayer"===t.type||"subtype-sublayer"===t.type;return["feature","scene","sublayer","subtype-group","subtype-sublayer"].includes(t.type)&&s&&(!a&&t.layerId===i.relatedTableId||a&&t.id===i.relatedTableId)}async function d(e,t,i){if([s.s.feature,s.s.scene,s.s.mapImage,s.s.subtype].includes(i)&&e?.relationships?.length)for(const i of e.relationships){const s=p(t);for(const t of s){const s=t;if(await c(e,s,i))return await s.load(),{relationship:i,currLayer:s}}}}function u(e){return["feature","subtype-sublayer"].indexOf(e.type)&&e.url.toLocaleLowerCase().endsWith("/featureserver")?e.url.substring(0,e.url.length-14):["feature","map-image","sublayer"].includes(e.type)&&e.url.toLocaleLowerCase().endsWith("/mapserver")?e.url.substring(0,e.url.length-10):["feature","map-image","sublayer"].includes(e.type)&&e.url.toLocaleLowerCase().includes("/mapserver/")?e.url.substring(0,e.url.toLocaleLowerCase().indexOf("/mapserver/")):"scene"===e.type&&e.url.toLocaleLowerCase().endsWith("/sceneserver")?e.url.substring(0,e.url.length-12):e.url}function m(){const e=(0,o.r)(),t=e;e.manager.onLoad((()=>{t.popupState=function(e,t){const i=y.get(e);if(i)return i;const s=(0,n.c)(e,t);if(s&&"store"in s)return y.set(e,s.store),s.store;return null}(e.el,"arcgis-popup").state}))}const y=new WeakMap},53127:(e,t,i)=>{i.d(t,{a:()=>a,d:()=>s,t:()=>o});const s=(e,t)=>{let i,s="idle";const a=async(...a)=>await new Promise((o=>{switch(s){case"flushed":s="idle",i?(clearTimeout(i),o(e(...a))):o(null);break;case"invoked":clearTimeout(i),s="idle",o(e(...a));break;case"cancelled":clearTimeout(i),s="idle",o(null);break;default:i&&clearTimeout(i),s="pending",i=setTimeout((()=>{s="idle",o(e(...a))}),t)}}));return a.flush=async function(...e){return s="flushed",await a(...e)},a.invoke=async function(...e){return s="invoked",await a(...e)},a.cancel=async function(...e){return s="cancelled",await a(...e)},a.getStatus=function(){return s},a},a=(e,t)=>{let i;return async(...s)=>await new Promise((a=>{i||(i=setTimeout((()=>{clearTimeout(i),i=void 0,a(e(...s))}),t))}))};function o(e){return new Promise((t=>setTimeout(t,e)))}},60262:(e,t,i)=>{i.d(t,{p:()=>n});var s=i(69811),a=i(56612),o=i(17840);const n=async(e,t,i)=>{e.closePopup();const s=(0,o.a)(t);if(s!==a.s.parquet&&s!==a.s.voxel){if(s!==a.s.scene||t?.associatedLayer){const a=await p(e,t,i,s);return a?(await e.openPopup({features:[a],location:a.geometry?.extent?.center??a.geometry}),e.popup&&"dockEnabled"in e.popup&&(e.popup.dockEnabled=!0),await Promise.resolve(a)):void await Promise.resolve(void 0)}await Promise.resolve(void 0)}else await Promise.resolve(void 0)},p=async(e,t,i,n)=>{try{let p,c;if(n===a.s.ogcFeature){p=await e.whenLayerView(t);const i=await(0,s.l)();await i.whenOnce((()=>!p.updating))}else if(n===a.s.stream){p=await e.whenLayerView(t);const i=await(0,s.l)();await i.whenOnce((()=>!p.updating))}else p=t;if(n===a.s.imageryTile||n===a.s.wcs){const i=e.allLayerViews.find((e=>e.layer.id===t.id)),s=await i.fetchPopupFeaturesAtLocation(t.fullExtent?.center);return s?.[0]}if(n===a.s.mapImage&&t.layer.version>=10.5&&!t.layer.capabilities?.operations?.supportsQuery&&t.layer.capabilities?.operations?.supportsIdentify){const i=await(0,o.h)(t,e);return i&&(i.sourceLayer=t),Promise.resolve(i)}const h="isTable"in t&&t.isTable,d=p.createQuery();h||(d.geometry=e.center,d.distance=e.resolution),d.outFields=["*"];const u=await p.queryFeatures(d,{signal:i.signal});if(0===u?.features?.length){const s=p.createQuery();s.geometry=e.extent,s.outFields=["*"],"knowledge-graph-sublayer"===t.type&&(s.returnGeometry=!0);const o=await p.queryFeatures(s,{signal:i.signal});if(o?.features?.length>0)c=await r(o,e,t);else{const s=p.createQuery();s.where=p.definitionExpression||"1=1",s.outFields=["*"],(t.sourceJSON?.advancedQueryCapabilities?.supportsPagination||n===a.s.ogcFeature)&&(s.start=0,s.num=1),s.outSpatialReference=e.spatialReference,c=(await p.queryFeatures(s,{signal:i.signal}))?.features?.[0]}}else c=u?.features?.[0];return c&&n===a.s.imagery&&(c=await l(t,c)),Promise.resolve(c)}catch(e){return console.log(e),void await Promise.resolve(void 0)}},l=async(e,t)=>{const i=e.createQuery();i.outFields=["*"].concat(e.rasterFields.map((e=>e.name)).filter((e=>e.startsWith("Raster.")))),i.geometry=t.geometry,i.outSpatialReference=t.geometry.spatialReference;const s=await e.queryVisibleRasters(i,{returnTopmostRaster:!0,returnDomainValues:!0});return s?.[0]??t},r=async(e,t,i)=>{const a=await(0,o.b)(i);if("point"===a){let i=[void 0,void 0];for(let s=0;s<e.features.length;s++){const a=e.features[s].geometry.distance(t.center);(0===s||(0,o.i)(i?.[1]&&i[1]>a))&&(i=[e.features[s],a])}return i[0]}if("polyline"===a){let i=[void 0,void 0];const a=await(0,s.a2)();for(let s=0;s<e.features.length;s++){const n=a.getNearestVertex(e.features[s].geometry,t.center).distance;(0===s||(0,o.i)(i?.[1]&&i[1]>n))&&(i=[e.features[s],n])}return i[0]}if("polygon"===a||"imagery"===(0,o.a)(i)){let i=[void 0,void 0];for(let s=0;s<e.features.length;s++){const a=e.features[s].geometry.centroid.distance(t.center);(0===s||(0,o.i)(i?.[1]&&i[1]>a))&&(i=[e.features[s],a])}return i[0]}return e.features[0]}},79865:(e,t,i)=>{function s(e){const{mapView:t,layer:i,portal:s}=e,{map:o}=t,{portalHostname:n}=s;if(!o)return!1;const{utilityNetworks:p}=o;if(!p)return!1;const l=s.isPortal,r="1"===window.localStorage.getItem("utility-networks-agol")&&("devext.arcgis.com"===n||"qaext.arcgis.com"===n);if(!l&&!r)return!1;const c=a(i),h=p.find((e=>e.sourceJSON?.serviceItemId===c));if(!h)return!1;return h.isUtilityLayer(i)}function a(e){return"subtype-sublayer"===e.type?e.parent.serviceItemId:e.serviceItemId}i.d(t,{g:()=>a,i:()=>s})},93345:(e,t,i)=>{i.d(t,{c:()=>l});var s=i(11254);const a=e=>!("isConnected"in e)||e.isConnected,o=((e,t)=>{let i;return(...s)=>{i&&clearTimeout(i),i=setTimeout((()=>{i=0,e(...s)}),t)}})((e=>{for(let t of e.keys())e.set(t,e.get(t).filter(a))}),2e3),n=e=>"function"==typeof e?e():e,p=(e,t)=>{const i=e.indexOf(t);i>=0&&(e[i]=e[e.length-1],e.length--)},l=(e,t)=>{const i=((e,t=(e,t)=>e!==t)=>{const i=n(e);let s=new Map(Object.entries(i??{}));const a={dispose:[],get:[],set:[],reset:[]},o=()=>{s=new Map(Object.entries(n(e)??{})),a.reset.forEach((e=>e()))},l=e=>(a.get.forEach((t=>t(e))),s.get(e)),r=(e,i)=>{const o=s.get(e);t(i,o,e)&&(s.set(e,i),a.set.forEach((t=>t(e,i,o))))},c="undefined"==typeof Proxy?{}:new Proxy(i,{get:(e,t)=>l(t),ownKeys:e=>Array.from(s.keys()),getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0}),has:(e,t)=>s.has(t),set:(e,t,i)=>(r(t,i),!0)}),h=(e,t)=>(a[e].push(t),()=>{p(a[e],t)});return{state:c,get:l,set:r,on:h,onChange:(t,i)=>{const s=h("set",((e,s)=>{e===t&&i(s)})),a=h("reset",(()=>i(n(e)[t])));return()=>{s(),a()}},use:(...e)=>{const t=e.reduce(((e,t)=>(t.set&&e.push(h("set",t.set)),t.get&&e.push(h("get",t.get)),t.reset&&e.push(h("reset",t.reset)),t.dispose&&e.push(h("dispose",t.dispose)),e)),[]);return()=>t.forEach((e=>e()))},dispose:()=>{a.dispose.forEach((e=>e())),o()},reset:o,forceUpdate:e=>{const t=s.get(e);a.set.forEach((i=>i(e,t,t)))}}})(e,t);return i.use((()=>{if("function"!=typeof s.d)return{};const e=new Map;return{dispose:()=>e.clear(),get:t=>{const i=(0,s.d)();i&&((e,t,i)=>{const s=e.get(t);s?s.includes(i)||s.push(i):e.set(t,[i])})(e,t,i)},set:t=>{const i=e.get(t);i&&e.set(t,i.filter(s.f)),o(e)},reset:()=>{e.forEach((e=>e.forEach(s.f))),o(e)}}})()),i}}}]);
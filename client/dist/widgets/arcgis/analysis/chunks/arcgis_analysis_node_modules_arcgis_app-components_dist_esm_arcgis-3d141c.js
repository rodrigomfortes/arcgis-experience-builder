/*! For license information please see arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-3d141c.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-3d141c"],{931:(e,t,a)=>{a.d(t,{l:()=>l});var i=a(93814);const l=async(e,t)=>(await i.e.exports.loadModules(e,t)).map((e=>e.__esModule&&e.default?e.default:e))},29983:(e,t,a)=>{a.r(t),a.d(t,{arcgis_field_calculate:()=>m});var i=a(87849),l=a(64099),r=a(37849),n=a(931),o=a(15332),s=a(4429);a(81034),a(37762),a(93814);async function c(e,t){const{modules:a}=r.f;var i=e.url,l=e.content||{},n=function(e){const{modules:t}=r.f;var a=t.urlUtils.urlToObject(e);for(var i in a.query=a.query||{},a.query)a.query.hasOwnProperty(i)&&(Array.isArray(a.query[i])||(a.query[i]=a.query[i].replace(/(&lt;|&gt;|<|>|%3C|%3E)/g,"")));return a}(i).query||{};l.get("f")||n.f||l.append("f","json");const o={body:l,timeout:(null==t?void 0:t.timeout)||0,method:"post",responseType:"json"};try{return(await a.esriRequest(e.url,o)).data}catch(e){throw console.error(e),e}}async function d(){const{layer:e}=r.f,t=`${e.portalItem.url}/${e.layerId}/append`,a=function(){const{originalField:e,layer:t,registeredResultId:a}=r.f,i=[{source:e.name,name:e.name},{source:t.objectIdField,name:t.objectIdField}],l=[e.name,t.objectIdField],n={fieldMappings:JSON.stringify(i),upsert:!0,skipUpdates:!1,useGlobalIds:!1,skipInserts:!0,updateGeometry:!1,appendFields:JSON.stringify(l),appendUploadId:a,appendUploadFormat:"csv",rollbackOnFailure:!0,upsertMatchingField:t.objectIdField,appendSourceInfo:"{}"};let o=new FormData;for(const e in n)o.append(e,n[e]);return o}();try{const e=await c({url:t,content:a});await u(e.statusUrl+="?f=json",500)}catch(e){throw e}}async function u(e,t){const{modules:a}=r.f,i=["processing","partial","Pending","InProgress","EXECUTING"],l=["completed","Completed","COMPLETED"];try{let r=(await a.esriRequest(e,{responseType:"json"})).data;return i.includes(r.status)?(await(0,s.t)(t),u(e,t+250)):r.status&&!l.includes(r.status)||r.code>400||""===r.status?Promise.reject():r.recordCount}catch(e){throw e}}function h(e,t,a){a&&e.unshift(a);const i=JSON.stringify(e),l=("object"!=typeof(r=i)?JSON.parse(r):r).map((e=>Object.values(e).toString())).join("\n");var r;const n=t+".csv"||0,o=new Blob([l],{type:"text/csv;charset=utf-8;"}),s=document.createElement("form");s.enctype="multipart/form-data";const c=new FormData(s);return c.append("file",o,n),c}function p(e,t){const{arcadeExecutor:a,isTable:i,layer:l,modules:n}=r.f,o=[l.objectIdField].concat(a.fieldsUsed),s=a.geometryUsed&&"hasM"in l&&l.hasM,c=a.geometryUsed&&"hasZ"in l&&l.hasZ,d=new n.Query({start:e,returnGeometry:a.geometryUsed,returnM:s,returnZ:c,outFields:o,where:t});let u=0;const h=function(){var e,t;const{layer:a}=r.f,i=a.sourceJSON;return(null===(e=i.advancedQueryCapabilities)||void 0===e?void 0:e.supportsQueryWithResultType)&&(null===(t=i.advancedQueryCapabilities)||void 0===t?void 0:t.supportsMaxRecordCountFactor)&&i.supportedQueryFormats.includes("PBF")&&i.supportsQuantizationEditMode}(),p={format:h?"pbf":"json"};return u=a.geometryUsed||i?l.sourceJSON.standardMaxRecordCount:l.sourceJSON.standardMaxRecordCountNoGeometry,d.resultType="standard",d.maxRecordCountFactor=1,d.num=u,{query:d,options:p,maxSize:u}}async function f(e,t){const{layer:a,originalField:i}=r.f;try{const l=await async function(e){const{arcadeExecutor:t,features:a,layer:i}=r.f,l=[];if(t.isAsync){const r=await t.executeAsyncBatch(e,(e=>({$feature:e,$layer:i,$datastore:i.url})),{spatialReference:i.spatialReference,rawOutput:!0});e.forEach(((e,t)=>{try{const n=r[t];if("rejected"==n.status)throw{message:n.reason,feature:e};{const t=e.attributes[i.objectIdField];let r={objectId:t,ArcadeField:n.value};a[t]||(a[t]={feature:e,calculatedValue:n.value,tableFeature:!1,passed:!1}),r=g(r),l.push(r)}}catch(t){throw"arcade"==t.calcErrorType?Object.assign(Object.assign({},t),{feature:e}):t}}))}else for(const r of e)try{const e=t.execute({$feature:r,$datastore:i.url},{spatialReference:i.spatialReference,rawOutput:!0}),n=r.attributes[i.objectIdField];let o={objectId:n,ArcadeField:e};a[n]||(a[n]={feature:r,calculatedValue:e,tableFeature:!1,passed:!1}),o=g(o),l.push(o)}catch(e){throw"arcade"==e.calcErrorType?Object.assign(Object.assign({},e),{feature:r}):e}return l}(e);return null===l?null:1===t?h(l,`uploadFile${t}`,{objectId:a.objectIdField,ArcadeField:i.name}):h(l,`uploadFile${t}`)}catch(e){throw e}}function g(e){const{features:t,originalField:a}=r.f;let i=e.ArcadeField;const l=e.objectId,n=(0,r.v)(i);if(null===i&&(i=""),/<\/?[a-z][\s\S]*>/i.test(i)&&(i=(0,o.s)(i)),t[l].calculatedValue=i,t[l].passed=n.isFieldValid,!n.isFieldValid)throw t[l].error=n.errorMessage,{calcErrorType:"arcade",message:n.errorMessage,objectId:l};var s;return"esri.arcade.arcadedate"===(null==i?void 0:i.declaredRootClass)?i=i.toISOString():"esri.core.sql.timeonly"===(null==i?void 0:i.declaredRootClass)?i=i.toStorageString():"esri.core.sql.dateonly"===(null==i?void 0:i.declaredRootClass)&&(i=i.toStorageFormat()),-1!==a.type.toLowerCase().indexOf("string")&&("string"==typeof(s=i)&&(s=s.replace(/"/g,'""')),i='"'+s+'"'),e.ArcadeField=i,e}const m=class{constructor(e){(0,i.r)(this,e),this.arcgisFieldCalculateClose=(0,i.c)(this,"arcgisFieldCalculateClose",7),this.arcgisFieldCalculateDataUpdate=(0,i.c)(this,"arcgisFieldCalculateDataUpdate",7),this.arcgisCalculationsStarted=(0,i.c)(this,"arcgisCalculationsStarted",7),this.arcgisCalculationsFinished=(0,i.c)(this,"arcgisCalculationsFinished",7),this.arcgisScriptChange=(0,i.c)(this,"arcgisScriptChange",7),this.arcgisWorkflowUpdate=(0,i.c)(this,"arcgisWorkflowUpdate",7),this.filterPanelWhere=null,this.invalidFieldOrLayer=!1,this.testFeatureFilterWhere=null,this.debouncedEditorScriptChange=(0,s.f)((()=>{this.handleEditorScriptChange()}),500),this.config=void 0,this.fieldName=void 0,this.withinPanel=!1,this.layer=void 0,this.whereClause=void 0,this.editorOpen=!1,this.filterPanelOpen=!1,this.view="both",this.calculationState="none",this.showAsyncArcadeWarning=!1}watchFieldNameHandler(e,t){var a,i;const{features:l}=r.f,n=null===(i=null===(a=r.f.layer)||void 0===a?void 0:a.fields)||void 0===i?void 0:i.find((t=>t.name===e));if(n&&e!==t&&r.f.layer.loaded){if(!(0,r.c)(n))return console.error("Field type must be editable to calculate."),void(r.f.originalField=this.layer.fields.find((e=>e.name===t)));r.f.originalField=this.layer.fields.find((t=>t.name===e));for(const e in l)l[e].calculatedValue=void 0,l[e].error=void 0,l[e].passed=void 0;this.editorOpen&&this.tableNode.calculateValues()}}async watchLayerHandler(e,t){const a=e;if(!(0,r.a)(a))return console.error("User must have rights for updating item and layer must be a hosted feature layer."),void(r.f.layer=t);await this.loadStore(!0);const i=e.fields.find((e=>(0,r.c)(e)));r.f.originalField=i,this.resetWorkflow(),this.map.layers.removeAll(),this.map.layers.add(r.f.layer),r.f.layer.popupTemplate=new r.f.modules.PopupTemplate({title:r.f.layer.displayField?`{${r.f.layer.displayField}}`:`{${r.f.layer.objectIdField}}`,content:r.p,lastEditInfoEnabled:!1})}async componentWillLoad(){await this.loadStore();const{arcadeSupported:e,isTable:t,layer:a,modules:i}=r.f;if(!(0,r.a)(a))return console.error("User must have rights for updating item and layer must be a hosted feature layer."),this.invalidFieldOrLayer=!0,Promise.reject();if(!(0,r.c)(r.f.originalField))return console.error("Field type must be editable to calculate."),this.invalidFieldOrLayer=!0,Promise.reject();if(e&&(this.arcadeProfile=i.arcade.createArcadeProfile("field-calculation")),!t){const e=a.portalItem.portal,t=e.useVectorBasemaps?e.defaultVectorBasemap:e.defaultBasemap;this.map=new i.Map({basemap:t}),this.map.add(a)}await i.IdentityManager.getCredential(a.portalItem.url)}componentDidLoad(){if(this.invalidFieldOrLayer)return;const{arcadeSupported:e,isTable:t,modules:a}=r.f;t||(this.mapAndTableActionNode.active=!0),e&&(this.lruCache=new a.RecentlyUsedCache)}async componentDidRender(){if("map"!==this.view&&this.tableNode){"features"===await this.tableNode.getMode()?this.featuresChipNode.selected=!0:this.previewChipNode.selected=!0}}async getCurrentScript(){return r.f.currentScript}async calculationsInProgress(){return"running"===this.calculationState}render(){if(!this.invalidFieldOrLayer)return(0,i.h)(i.H,null,this.withinPanel?(0,i.h)("calcite-panel",{ref:e=>this.outerContainerNode=e},(0,i.h)("calcite-shell",null,this.renderShellContent()),this.renderFooter()):(0,i.h)("calcite-dialog",{class:"field-calc-modal",open:!0,placement:"cover",escapeDisabled:!0,outsideCloseDisabled:!0,focusTrapDisabled:!0,closeDisabled:!0,onCalciteDialogOpen:e=>{e.stopImmediatePropagation(),this.closeActionNode.setFocus()},ref:e=>this.outerContainerNode=e},this.renderModalHeader(),(0,i.h)("calcite-shell",{class:"shell"},this.renderShellContent()),this.renderFooter()))}renderModalHeader(){const{layer:e,originalField:t,strings:a}=r.f;return(0,i.h)(i.F,null,(0,i.h)("div",{class:"title",slot:"header-content"},`${e.title} : ${t.alias||t.name}`),(0,i.h)("calcite-action-bar",{slot:"header-actions-end","expand-disabled":"true",layout:"horizontal"},"none"===this.calculationState&&this.renderViewActions(),(0,i.h)("calcite-action",{icon:"x",text:a.close,label:a.close,onClick:()=>this.arcgisFieldCalculateClose.emit(),ref:e=>{this.closeActionNode=e}})))}renderViewActions(){const{isTable:e,strings:t}=r.f;return(0,i.h)(i.F,null,(0,i.h)("calcite-action",{id:"table-action",disabled:e,icon:"table",text:t.table,label:t.table,onClick:()=>this.changeView("table"),ref:e=>this.tableActionNode=e}),(0,i.h)("calcite-tooltip",{class:"field-calc-tooltip",referenceElement:"table-action",placement:"bottom"},(0,i.h)("span",null,t.table)),(0,i.h)("calcite-action",{id:"map-action",disabled:e,icon:"map",text:t.map,label:t.map,onClick:()=>this.changeView("map"),ref:e=>this.mapActionNode=e}),(0,i.h)("calcite-tooltip",{class:"field-calc-tooltip",referenceElement:"map-action",placement:"bottom"},(0,i.h)("span",null,t.map)),(0,i.h)("calcite-action",{id:"map-and-table-action",disabled:e,icon:"widgets-group",text:t.mapAndTable,onClick:()=>this.changeView("both"),ref:e=>this.mapAndTableActionNode=e}),(0,i.h)("calcite-tooltip",{class:"field-calc-tooltip",referenceElement:"map-and-table-action",placement:"bottom"},(0,i.h)("span",null,t.mapAndTable)))}renderShellContent(){const{strings:e}=r.f;return"none"===this.calculationState?(0,i.h)(i.F,null,this.renderCalculatePanel(),(0,i.h)("calcite-panel",{class:"panel-border table-panel"},this.renderTableActions(),this.showAsyncArcadeWarning&&(0,i.h)("calcite-notice",{class:"async-arcade-notice",open:!0,icon:"lightbulb",width:"auto",closable:!0,onCalciteNoticeClose:()=>{this.showAsyncArcadeWarning=!1}},(0,i.h)("div",{slot:"message"},e.asyncArcadeWarning)),(0,i.h)("div",{class:"map-and-table-panels"},this.renderTable(),this.renderMap()))):this.renderRunningCalculations()}renderRunningCalculations(){const{selectedLanguage:e,strings:t}=r.f,a={hidden:"none"===this.calculationState};return(0,i.h)(i.F,null,(0,i.h)("calcite-panel",{class:a},"running"===this.calculationState?(0,i.h)("div",{class:"calculating-values-content"},(0,i.h)("div",{class:"calculating-values-label"},t.calculatingValues),(0,i.h)("calcite-loader",{label:t.calculatingValues,scale:"l",type:"SQL"===e?"indeterminate":"determinate-value",value:0,text:"SQL"===e?"":`0 / ${r.f.filteredFeatureCount}`,ref:e=>this.loaderNode=e}),this.withinPanel&&(0,i.h)("calcite-notice",{kind:"warning",icon:"exclamation-mark-triangle",width:"half",open:!0},(0,i.h)("div",{slot:"title"},t.calculationRunningWarning),(0,i.h)("div",{slot:"message"},t.calculationRunningDescription))):"success"===this.calculationState?(0,i.h)("div",{class:"calculation-finish"},(0,i.h)("svg",{class:"calculation-success-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 64 64"},(0,i.h)("path",{d:"M52.745 9.436L23.35 38.869l-9.32-9.57-7.305 7.466 16.63 16.552 26.707-26.708 9.895-10.032zm-3.252 16.61l-26.14 26.141L7.85 36.757l6.176-6.313 9.314 9.564 29.408-29.444 6.076 6.02z"})),(0,i.h)("p",{class:"calculation-result-label"},t.calculationsComplete),this.withinPanel&&(0,i.h)("calcite-button",{class:"reset-calc-button",appearance:"outline-fill",iconStart:"arrow-left",iconFlipRtl:"start",onClick:()=>{this.calculationState="none",this.resetWorkflow()}},t.doAnotherCalculation),(0,i.h)("calcite-button",{appearance:"outline-fill",iconStart:"download-to",onClick:()=>this.downloadScript()},t.downloadScript)):"error"===this.calculationState?(0,i.h)("div",{class:"calculation-finish"},(0,i.h)("svg",{class:"calculation-error-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 48 48"},(0,i.h)("path",{d:"M26.158 7.927a1.9 1.9 0 0 0-3.315 0L5.4 39.072A1.9 1.9 0 0 0 7.06 41.9h34.88a1.9 1.9 0 0 0 1.659-2.828zm16.733 32.63a1.107 1.107 0 0 1-.95.543H7.06a1.101 1.101 0 0 1-.961-1.638L23.54 8.318a1.1 1.1 0 0 1 1.919 0L42.9 39.462a1.106 1.106 0 0 1-.01 1.094zM24.1 20h.8v11h-.8zm0 14h.8v3h-.8z"})),(0,i.h)("p",{class:"calculation-result-label"},this.calculationErrorMessage),this.calculationErrorDescription&&(0,i.h)("p",{class:"calculation-error-description"},this.calculationErrorDescription),(0,i.h)("calcite-button",{appearance:"outline-fill",iconStart:"arrow-left",iconFlipRtl:"start",onClick:()=>{var e;this.calculationState="none",this.calculationErrorDescription=null,this.editorOpen=!0,null===(e=this.tableNode)||void 0===e||e.updateTableFilter(this.testFeatureFilterWhere,!0),(0,i.f)(this.hostElement),setTimeout((()=>{var e;(null===(e=r.f.arcadeExecutor)||void 0===e?void 0:e.geometryUsed)&&this.tableNode.enableGeometry(),this.changeView("both"),this.tableNode.setMode("preview"),this.previewChipNode.selected=!0,r.f.autoPreviewEnabled=!0}),300)}},t.back)):null))}renderTableActions(){var e;if("map"===this.view)return;const{autoPreviewEnabled:t,strings:a}=r.f;return(0,i.h)("div",{slot:"header-content",class:"panel-header"},(0,i.h)("calcite-chip-group",{label:"chips","selection-mode":"single-persist",disabled:!this.editorOpen},(0,i.h)("div",null,(0,i.h)("calcite-button",{appearance:"outline",kind:"neutral","icon-start":"filter",onClick:e=>{e.stopPropagation(),e.preventDefault(),this.openFilterPopover(e.currentTarget)}},a.testFeaturesFilter)),(0,i.h)("calcite-chip",{icon:"table",label:a.testFeatures,value:a.testFeatures,onClick:()=>this.tableNode.setMode("features"),ref:e=>this.featuresChipNode=e},a.testFeatures),(0,i.h)("calcite-chip",{icon:"compare",label:a.previewValues,value:a.previewValues,onClick:async()=>{this.tableNode.setMode("preview")},ref:e=>this.previewChipNode=e},a.previewValues)),(0,i.h)("div",{class:"auto-preview"},a.autoPreview,(0,i.h)("calcite-switch",{checked:t,disabled:(null===(e=r.f.arcadeExecutor)||void 0===e?void 0:e.isAsync)||!1,onCalciteSwitchChange:e=>{r.f.autoPreviewEnabled=e.target.checked,r.f.autoPreviewEnabled&&this.debouncedEditorScriptChange()},ref:e=>this.autoPreviewSwitchNode=e})))}renderTable(){const{layer:e,originalField:t,strings:a}=r.f,l={"layer-table":!0,hidden:"map"===this.view};return(0,i.h)(i.F,null,(0,i.h)("calcite-panel",{heading:e.title,class:l},(0,i.h)("calcite-label",{class:"feature-count",layout:"inline",slot:"header-actions-end"},(0,i.h)("calcite-icon",{scale:"s",icon:"test-data"}),a.testFeatures,":",(0,i.h)("div",{ref:e=>this.testFeatureCountNode=e})),(0,i.h)("arcgis-field-calculate-table",{key:`${e.title}${null==t?void 0:t.name}`,onArcgisFieldCalculateTableRecordCountUpdate:e=>{this.testFeatureCountNode&&(this.testFeatureCountNode.innerHTML=`${e.detail}`)},ref:e=>this.tableNode=e})))}renderMap(){const{isTable:e}=r.f;if(!e)return(0,i.h)("calcite-panel",{class:" map-panel "+("table"===this.view?"hidden":"")},(0,i.h)("div",{class:"viewDiv",ref:e=>{e&&(e.style.width="100%",e.style.height="100%",this.createMapViewAndPopupTemplate(e))}}))}renderCalculatePanel(){const{layer:e,modules:t}=r.f;return(0,i.h)("calcite-shell-panel",{slot:"panel-start",resizable:!0,class:"panel-border calculate-panel ",width:"l"},(0,i.h)("div",{class:"left-panel-top-slot overflow-x-auto overflow-y-hidden"},(0,i.h)("slot",{name:"left-panel-top"})),(0,i.h)("arcgis-field-calculate-editor",{editorOpen:this.editorOpen,onArcgisFieldCalculateEditorScriptChange:async()=>{var a,i;try{if(r.f.invalidScript=!1,"Arcade"===r.f.selectedLanguage){this.lruCache.clear();const l=t.arcade.createArcadeProfile("field-calculation");r.f.arcadeExecutor=await t.arcade.createArcadeExecutor(r.f.currentScript,l,{lruCache:this.lruCache,services:{portal:e.portalItem.portal}}),r.f.layer.outFields=r.f.arcadeExecutor.fieldsUsed,this.autoPreviewSwitchNode&&(this.autoPreviewSwitchNode.disabled=null===(a=r.f.arcadeExecutor)||void 0===a?void 0:a.isAsync),(null===(i=r.f.arcadeExecutor)||void 0===i?void 0:i.geometryUsed)&&this.tableNode.enableGeometry()}else if("SQL"===r.f.selectedLanguage){const a=`${e.url}/${e.layerId}/validateSQL`,i=new FormData;i.append("sql",r.f.currentScript),i.append("sqlType","expression"),i.append("f","json");(await c({url:a,content:i})).isValidSQL?(r.f.sqlEngine=await t.sql.parseWhereClause(r.f.currentScript,e.fieldsIndex),r.f.sqlEngine.currentUser=e.portalItem.portal.user.username):this.handleInvalidScript()}await this.debouncedEditorScriptChange()}catch(e){this.handleInvalidScript()}},onArcgisFieldCalculateEditorFilterChange:async e=>{this.filterPanelOpen&&await this.updateFieldCalcFilter(e.detail,!1)},onArcgisFieldCalculateEditorLanguageSelected:()=>{this.openFilterPanel(),this.tableNode.refresh(!0)},onArcgisFieldCalculateEditorResetWorkflow:()=>this.resetWorkflow(),ref:e=>this.calculationPanelNode=e}))}renderFooter(){const{totalFeatureCount:e,filteredFeatureCount:t,strings:a}=r.f;return(0,i.h)(i.F,null,(0,i.h)("div",{slot:"footer-start",class:"modal-footer"},this.renderBackButton()),(0,i.h)("div",{slot:"footer-end",class:"footer-buttons-end modal-footer"},this.withinPanel&&"none"===this.calculationState&&this.renderViewActions(),(0,i.h)("calcite-label",{class:"meter-label",alignment:"center",layout:"inline-space-between"},a.selectedFeatures,(0,i.h)("calcite-meter",{class:"meter",label:a.selectedFeatures,min:0,max:e,value:t,fillType:"single"})),(0,i.h)("calcite-label",{class:"feature-ratio",layout:"inline-space-between",ref:e=>this.featureRatioNode=e},t," / ",e),!this.withinPanel&&this.renderCancelButton(),this.renderNextButton(),this.renderRunCalculationsButton()))}renderBackButton(){const{strings:e}=r.f;return"none"===this.calculationState&&(this.editorOpen||this.filterPanelOpen)?(0,i.h)("calcite-button",{class:"button-margin",slot:"back",width:"full",alignment:"center",appearance:"transparent",iconStart:"arrow-left",iconFlipRtl:"start",onClick:()=>{this.editorOpen?(this.closeEditor(),this.openFilterPanel()):this.filterPanelOpen&&(this.closeFilterPanel(),this.arcgisWorkflowUpdate.emit("language-select"))}},e.back):null}renderNextButton(){const{filteredFeatureCount:e,selectedLanguage:t,strings:a}=r.f;return this.editorOpen||"none"!==this.calculationState?null:(0,i.h)("calcite-button",{class:"button-margin",disabled:!e||!t,width:"full",alignment:"center",appearance:"solid",iconEnd:"arrow-right",iconFlipRtl:"end",onClick:()=>{this.filterPanelOpen?(this.closeFilterPanel(),this.openEditor()):this.openFilterPanel()}},a.next)}renderRunCalculationsButton(){const{strings:e}=r.f;return this.editorOpen&&"none"===this.calculationState?(0,i.h)("calcite-button",{class:"button-margin",width:"full",alignment:"center",appearance:"solid",iconStart:"calculator",onClick:()=>this.handleRunCalculations()},e.runCalculation):null}renderCancelButton(){const{strings:e}=r.f,t=["success","error"].includes(this.calculationState);return(0,i.h)("calcite-button",{disabled:"running"===this.calculationState,class:"cancel-button",width:"full",appearance:t?"solid":"outline-fill",alignment:"center",onClick:()=>this.arcgisFieldCalculateClose.emit()},t?e.close:e.cancel)}changeView(e){const{isTable:t}=r.f;t||(this.view=e,this.mapActionNode.active="map"===this.view,this.tableActionNode.active="table"===this.view,this.mapAndTableActionNode.active="both"===this.view,this.filterPopoverNode&&"map"===this.view&&(this.outerContainerNode.removeChild(this.filterPopoverNode),this.filterPopoverNode=null))}closeEditor(){this.editorOpen=!1,this.calculationPanelNode.closeEditor()}async handleEditorScriptChange(){var e;const{arcadeExecutor:t,layer:a,selectedLanguage:i,sqlEngine:l}=r.f;t||l?((null==t?void 0:t.isAsync)&&(r.f.autoPreviewEnabled=!1,this.autoPreviewSwitchNode&&(this.autoPreviewSwitchNode.checked=!1,this.autoPreviewSwitchNode.disabled=!0)),a.outFields=(null==t?void 0:t.fieldsUsed)||l.fieldNames,this.showAsyncArcadeWarning="Arcade"===i&&(null==t?void 0:t.isAsync),await(null===(e=this.tableNode)||void 0===e?void 0:e.calculateValues())):this.tableNode.refresh(!0),this.arcgisScriptChange.emit(r.f.currentScript)}closeFilterPanel(){const{layer:e}=r.f;this.filterPanelOpen=!1,this.calculationPanelNode.closeFilterPanel(),e.definitionExpression=r.f.whereClause,this.calculationPanelNode.filterPanelWhere=r.f.whereClause}createMapViewAndPopupTemplate(e){var t;const{layer:a,modules:i}=r.f;(null===(t=r.f.mapView)||void 0===t?void 0:t.container)!==e&&(r.f.mapView?r.f.mapView.container=e:(r.f.mapView=new i.MapView({map:this.map,popup:new i.Popup({dockEnabled:!0,dockOptions:{buttonEnabled:!1,position:"top-left",breakpoint:!1},viewModel:{includeDefaultActions:!1}}),container:e,constraints:{snapToZoom:!1},extent:a.fullExtent}),a.popupTemplate=new i.PopupTemplate({title:a.displayField?`{${a.displayField}}`:`{${a.objectIdField}}`,content:r.p,lastEditInfoEnabled:!1})))}createFeatureEffect(e){const{layer:t,modules:a,whereClause:i}=r.f;t.featureEffect=i?new a.FeatureEffect({filter:{where:i},excludedEffect:`grayscale(1) opacity(${e?0:80}%) brightness(100%)`}):null}downloadScript(){const{currentScript:e}=r.f,t=document.createElement("a"),a=new Blob([e],{type:"text/plain"});t.href=URL.createObjectURL(a),t.download="script.txt",t.click(),URL.revokeObjectURL(t.href)}async handleRunCalculations(){const{arcadeExecutor:e,autoPreviewEnabled:t,currentScript:a,features:i,selectedLanguage:l,strings:n,sqlEngine:o}=r.f,s=this.tableNode&&await this.tableNode.noRowsVisible(),c=!Object.values(i).find((e=>e.tableFeature&&!e.passed));let d=!o&&!(s||c&&e);if(!c&&!s&&((null==e?void 0:e.isAsync)||!t||"map"===this.view)&&!o){d=!await this.calculationPanelNode.isTestResultValid()}if(d){const e=document.createElement("calcite-alert");e.classList.add("error-alert"),e.kind="warning",e.icon="exclamation-mark-triangle-f",e.label=n.errorAlertTitle;const t=document.createElement("div");t.slot="title",t.innerHTML=n.errorAlertTitle;const a=document.createElement("div");a.slot="message",a.innerHTML=n.errorAlertMessage;const i=document.createElement("calcite-link");return i.slot="link",i.innerHTML=n.errorAlertLink,i.onclick=()=>{"map"===this.view&&this.changeView("both"),setTimeout((()=>{this.tableNode.setMode("preview"),this.previewChipNode.selected=!0}),300)},e.append(t,a,i),e.open=!0,e.slot="alerts",void this.outerContainerNode.append(e)}this.calculationState="running",this.arcgisCalculationsStarted.emit({language:l,script:a}),this.arcgisWorkflowUpdate.emit("layer-calculation"),"Arcade"===l?this.runCalculationsArcade():"SQL"===l&&this.runCalculationsSQL()}handleInvalidScript(){const{features:e}=r.f;r.f.arcadeExecutor=void 0,r.f.sqlEngine=void 0,r.f.invalidScript=!0,(0,r.u)(),this.tableNode.refresh(!0);for(const t in e)e[t].error=void 0,e[t].calculatedValue=void 0}async loadStore(e=!1){var t,a,i;if(this.layer.loaded||await this.layer.load(),!e){(0,r.b)(r.f);const[e]=await(0,l.g)(this.hostElement);r.f.strings=e,await async function(){const[e,t,a,i,l,o,s,c,d,u,h,p,f,g,m,v,w,b,y,F,C,x]=await(0,n.l)(["esri/portal/PortalItem","esri/layers/Layer","esri/Map","esri/views/MapView","esri/widgets/FeatureTable","esri/widgets/FeatureTable/support/TableTemplate","esri/popup/support/FieldInfoFormat","esri/support/popupUtils","esri/core/reactiveUtils","esri/rest/support/Query","esri/arcade","esri/layers/support/arcadeUtils","esri/widgets/Popup","esri/PopupTemplate","esri/layers/support/FeatureEffect","esri/request","esri/core/urlUtils","esri/identity/IdentityManager","esri/core/Collection","esri/intl","esri/arcade/featureset/support/RecentlyUsedCache","esri/core/sql"]);r.f.modules={PortalItem:e,Layer:t,Map:a,MapView:i,FeatureTable:l,TableTemplate:o,FieldInfoFormat:s,popupUtils:c,reactiveUtils:d,Query:u,arcade:h,arcadeUtils:p,Popup:f,PopupTemplate:g,FeatureEffect:m,esriRequest:v,urlUtils:w,IdentityManager:b,Collection:y,intl:F,RecentlyUsedCache:C,sql:x}}()}r.f.layer=this.layer.clone(),r.f.layer.featureReduction=null,r.f.layer.effect=null,r.f.layer.featureEffect=null,r.f.layer.visible=!0,r.f.layer.definitionExpression=null,await r.f.layer.load(),r.f.originalField=this.layer.fields.filter((e=>e.name===this.fieldName))[0],r.f.numRecords=40,r.f.config=this.config,r.f.features={},r.f.autoPreviewEnabled=!0;const o=r.f.layer.portalItem.portal,s=o.isPortal||"multitenant"!==o.portalMode,c=r.f.layer.sourceJSON,d=null===(t=c.capabilities)||void 0===t?void 0:t.includes("Uploads"),u=!s||d;r.f.arcadeSupported=!(null===(a=c.capabilities)||void 0===a?void 0:a.includes("Sync"))&&!(null===(i=c.capabilities)||void 0===i?void 0:i.includes("ChangeTracking"))&&u,r.f.whereClause=this.whereClause,r.f.layer.definitionExpression=this.whereClause,r.f.isTable="feature"===r.f.layer.type&&r.f.layer.isTable,r.f.totalFeatureCount=await(0,r.g)(),r.f.filteredFeatureCount=this.whereClause?await(0,r.g)(this.whereClause):r.f.totalFeatureCount}openEditor(){var e;this.editorOpen=!0,null===(e=this.calculationPanelNode)||void 0===e||e.openEditor(),this.arcgisWorkflowUpdate.emit("script-editor")}openFilterPanel(){const{layer:e}=r.f;this.filterPanelOpen=!0,this.calculationPanelNode.openFilterPanel(),e.definitionExpression=null,this.createFeatureEffect(!1),this.arcgisWorkflowUpdate.emit("filter")}async openFilterPopover(e){const{strings:t}=r.f;if(this.filterPopoverNode)return;this.filterPopoverNode=document.createElement("calcite-popover"),this.filterPopoverNode.placement="bottom-start",this.filterPopoverNode.pointerDisabled=!0,this.filterPopoverNode.label=t.testFeaturesFilter,this.filterPopoverNode.triggerDisabled=!0,this.filterPopoverNode.referenceElement=e,this.filterPopoverNode.addEventListener("calcitePopoverClose",(()=>{this.filterPopoverNode=null}));const a=document.createElement("arcgis-common-sql-expression-config");a.style.width="30vw";const i=(await this.tableNode.getLayer()).clone();await i.load(),a.panelMaxHeight="50vh",a.layer=i,a.closable=!1,a.hideLayerTitle=!0,a.noFilterMsg=t.testFeatureFilterTipMsg,a.addEventListener("arcgisCancel",(()=>{this.outerContainerNode.removeChild(this.filterPopoverNode),this.testFeatureFilterWhere=null,this.filterPopoverNode=null,e.setFocus()})),a.addEventListener("arcgisChange",(e=>{this.testFeatureFilterWhere=e.detail})),a.addEventListener("arcgisSave",(()=>{this.outerContainerNode.removeChild(this.filterPopoverNode),this.tableNode.updateTableFilter(this.testFeatureFilterWhere),this.filterPopoverNode=null,e.setFocus()})),this.filterPopoverNode.appendChild(a),this.outerContainerNode.appendChild(this.filterPopoverNode),this.filterPopoverNode.open=!0,a.setFocus(),"updateFocusTrapElements"in this.outerContainerNode&&this.outerContainerNode.updateFocusTrapElements(this.filterPopoverNode)}resetWorkflow(){var e;const{features:t,mapView:a}=r.f;this.editorOpen=!1,this.filterPanelOpen=!1,r.f.currentScript="",r.f.arcadeExecutor=void 0,r.f.sqlEngine=void 0,r.f.invalidScript=!1,r.f.layer.definitionExpression=void 0,this.updateFieldCalcFilter(void 0,!0),(null===(e=null==a?void 0:a.popup)||void 0===e?void 0:e.visible)&&a.popup.close();for(const e in t)t[e].calculatedValue=void 0,t[e].error=void 0,t[e].passed=void 0;this.arcgisWorkflowUpdate.emit("language-select")}async runCalculationsArcade(){const{currentScript:e,features:t,layer:a,selectedLanguage:i,strings:l}=r.f;try{const t=await async function(){const{layer:e}=r.f,t=`${e.portalItem.url}/uploads/register`,a=new FormData;return a.append("itemName",`${e.portalItem.id}.csv`),a.append("description","Arcade Calculate"),await c({url:t,content:a})}();if(!t.success)return this.calculationState="error",this.arcgisCalculationsFinished.emit({language:i,script:e,success:!1}),void(this.calculationErrorMessage=l.calculationErrorGeneral);r.f.registeredResultId=t.item.itemID;const n=0,o=1,s=await this.queryAndUploadProcess(o,n),u=`${a.portalItem.url}/uploads/${r.f.registeredResultId}/commit`;let h=new FormData;h.append("parts",this.allPartsInString(s)),h.append("f","json"),await c({url:u,content:h}),await d(),this.calculationState="success",this.arcgisCalculationsFinished.emit({language:i,script:e,success:!0}),this.arcgisFieldCalculateDataUpdate.emit()}catch(r){if(this.arcgisCalculationsFinished.emit({language:i,script:e,success:!1}),this.calculationState="error","arcade"===r.calcErrorType){this.calculationErrorMessage=r.message;const e=r.feature.attributes[a.objectIdField];this.testFeatureFilterWhere=`${a.objectIdField} = ${e}`,t[e]||(t[e]={}),t[e].passed=!1}else this.calculationErrorMessage=l.calculationErrorGeneral,console.error(r)}}async runCalculationsSQL(){var e,t;const{currentScript:a,filteredFeatureCount:i,layer:l,originalField:n,selectedLanguage:o,strings:s,whereClause:d}=r.f;try{const e=`${l.url}/${l.layerId}/calculate`,t=new FormData,r=JSON.stringify([{field:n.name,sqlExpression:a}]);t.append("calcExpression",r),t.append("where",d||"1=1"),t.append("async","true"),t.append("f","json");const h=await c({url:e,content:t});if(h.error)this.calculationState="error",this.arcgisCalculationsFinished.emit({language:o,script:a,success:!1}),this.calculationErrorMessage=s.calculationErrorGeneral;else{await u(h.statusUrl+="?f=json",500)===i?(this.calculationState="success",this.arcgisCalculationsFinished.emit({language:o,script:a,success:!0})):(this.calculationState="error",this.arcgisCalculationsFinished.emit({language:o,script:a,success:!1}),this.calculationErrorMessage=s.calculationErrorGeneral)}}catch(i){console.error(i),this.calculationErrorMessage=s.calculationErrorGeneral,(null===(t=null===(e=i.details)||void 0===e?void 0:e.raw)||void 0===t?void 0:t.description)&&(this.calculationErrorDescription=i.details.raw.description),this.calculationState="error",this.arcgisCalculationsFinished.emit({language:o,script:a,success:!1})}}allPartsInString(e){let t="",a="";for(let i=1;i<=e;i++)a+=t+i,t=",";return a}async queryAndUploadProcess(e,t){const{layer:a,registeredResultId:i,whereClause:l}=r.f;let n=e||1,o=t||0;const s=p(t||0,l),d=s.maxSize;try{let t=await a.queryFeatures(s.query),l=await f(t.features,e);l.append("f","json"),l.append("partId",n);const r=`${a.portalItem.url}/uploads/${i}/uploadPart`;if(await c({url:r,content:l},{timeout:0}),!t.exceededTransferLimit)return l=void 0,t=void 0,this.updateProgressBar(n,d),n;o+=d,n++,l=void 0,t=void 0,this.updateProgressBar(n-1,d),await this.queryAndUploadProcess(n,o)}catch(e){throw e}}async updateFieldCalcFilter(e,t){var a;const{features:i}=r.f;r.f.whereClause=e,this.createFeatureEffect(t),r.f.whereClause?r.f.filteredFeatureCount=await(0,r.g)(r.f.whereClause):r.f.filteredFeatureCount=r.f.totalFeatureCount;for(const e in i)i[e].tableFeature=!1;this.featureRatioNode.innerHTML=`${r.f.filteredFeatureCount} / ${r.f.totalFeatureCount}`,await(null===(a=this.tableNode)||void 0===a?void 0:a.updateTableFilter(this.testFeatureFilterWhere))}updateProgressBar(e,t){const{selectedLanguage:a}=r.f;if(!this.loaderNode||"SQL"===a)return;const{filteredFeatureCount:i}=r.f;t<1&&(t=1);const l=i/t,n=Math.min(100,Math.floor(e/l*100));if(100===n)this.loaderNode.type="indeterminate",this.loaderNode.text="";else{const a=e*t>i?i:e*t;this.loaderNode.value=n,this.loaderNode.text=`${a} / ${i}`}}static get assetsDirs(){return["assets"]}get hostElement(){return(0,i.a)(this)}static get watchers(){return{fieldName:["watchFieldNameHandler"],layer:["watchLayerHandler"]}}};m.style=".async-arcade-notice{margin:16px 20px 0px}.auto-preview{display:flex;align-items:center;gap:12px;margin:auto;margin-left:10px}.button-margin{margin:auto}.calculate-panel{z-index:var(--calcite-z-index-header)1}.field-calc-modal{--calcite-dialog-content-space:0px}.calculation-error-icon{fill:var(--calcite-color-status-danger);width:64px;height:64px;display:unset}.calculation-error-description{font-size:20px;max-width:640px;color:var(--calcite-color-text-3);margin-block-start:-10px;margin-block-end:20px}.calculation-finish{text-align:center;margin:auto}.calculation-success-icon{fill:var(--calcite-color-status-success);width:64px;height:64px;display:unset}.calculation-result-label{text-align:center;font-size:26px;color:var(--calcite-color-text-1);margin:26px}.calculating-values-content{height:100%;align-content:center}.calculating-values-label{font-size:var(--calcite-font-size-xxl);text-align:center;margin-bottom:-50px}.cancel-button{margin:auto;margin-right:10px}.error-alert{z-index:1000;position:static}.feature-count{margin-right:10px;margin-top:auto}.feature-ratio{margin-right:20px;margin-top:15px;text-wrap:nowrap}.field-calc-tooltip{z-index:401}.footer-buttons-end{justify-content:flex-end}.hidden{display:none}.left-panel-top-slot{width:100%}.layer-table{border-radius:var(--calcite-corner-radius-round);width:auto;height:100%;box-shadow:var(--calcite-shadow-sm)}.map-and-table-panels{height:100%;margin:16px;display:grid;row-gap:16px}.map-panel{width:auto}.mapView{width:100%;height:100%}.meter{width:200px;margin-right:5px;--calcite-color-brand:#6a6a6a}.meter-label{margin-left:15px;text-wrap:nowrap;margin-top:15px}.modal-footer{display:flex;align-items:center}.panel-border{border:1px solid #e0e0e0}.panel-header{display:inline-flex;margin-left:10px}.popup-icon{width:64px;height:auto;text-align:center;display:unset}.popup-error-icon{--calcite-ui-icon-color:var(--calcite-color-status-warning)}.reset-calc-button{margin-right:10px}.table-panel{z-index:399}.title{font-size:var(--calcite-font-size-xxl);font-weight:var(--calcite-font-weight-bold)}"},64099:(e,t,a)=>{a.d(t,{a:()=>n,g:()=>c});var i=a(15332),l=a(81034),r=a(87849);function n(e){var t,a,r;const n=null!==(t=(0,i.c)(e,"[lang]"))&&void 0!==t?t:null===(r=null===(a=e.shadowRoot)||void 0===a?void 0:a.ownerDocument)||void 0===r?void 0:r.documentElement,o=((null==n?void 0:n.lang)||(null===navigator||void 0===navigator?void 0:navigator.language)||"en").toLowerCase();return l.l.has(o)?l.l.get(o):l.l.has(o.slice(0,2))?l.l.get(o.slice(0,2)):"en"}const o={};function s(e,t){const a=`${e}${t}`;return o[a]||(o[a]=function(e,t){return new Promise(((a,i)=>{fetch((0,r.d)(`../arcgis-app-assets/i18n/${e}.i18n.${t}.json`)).then((e=>{e.ok?a(e.json()):i()}),(()=>i()))}))}(e,t)),o[a]}async function c(e,t){const a=t||e.tagName.toLowerCase(),r=n(e),o=function(e){var t,a,r;const n=null!==(t=(0,i.c)(e,"[lang]"))&&void 0!==t?t:null===(r=null===(a=e.shadowRoot)||void 0===a?void 0:a.ownerDocument)||void 0===r?void 0:r.documentElement,o=((null==n?void 0:n.lang)||(null===navigator||void 0===navigator?void 0:navigator.language)||"en").toLowerCase();return l.l.has(o)?l.l.get(o):l.l.has(o.slice(0,2))?o:"en"}(e);let c;try{c=await s(a,r)}catch(e){console.warn(`no locale for ${a} (${r}) loading default locale en.`),c=await s(a,"en")}return[c,r,o]}},81034:(e,t,a)=>{a.d(t,{C:()=>o,a:()=>s,b:()=>d,f:()=>u,g:()=>n,l:()=>r,s:()=>p});var i=a(931),l=a(15332);const r=new Map([["ar","ar"],["bg","bg"],["bs","bs"],["ca","ca"],["cs","cs"],["da","da"],["de","de"],["el","el"],["en","en"],["es","es"],["et","et"],["fi","fi"],["fr","fr"],["he","he"],["hr","hr"],["hu","hu"],["id","id"],["it","it"],["ja","ja"],["ko","ko"],["lt","lt"],["lv","lv"],["nb","no"],["no","no"],["nl","nl"],["pl","pl"],["pt-br","pt-BR"],["pt-pt","pt-PT"],["ro","ro"],["ru","ru"],["sk","sk"],["sl","sl"],["sr","sr"],["sv","sv"],["th","th"],["tr","tr"],["uk","uk"],["vi","vi"],["zh-cn","zh-CN"],["zh-hk","zh-HK"],["zh-tw","zh-TW"]]);function n(e){return function(e,t,a){const i=(0,l.c)(e,`[${t}]`);return i?i.getAttribute(t):a}(e,"dir","ltr")}const o={rtl:"arcgis--rtl"};async function s(e,t){const{api:a,type:l,places:r}=t||{};if(4===a){const[t]=await(0,i.l)(["esri/intl"]),a=t.convertNumberFormatToIntlOptions({places:r,style:l,digitSeparator:!0});return t.formatNumber(e,Object.assign(Object.assign({},a),{style:l}))}const[n]=await(0,i.l)(["dojo/number"]);return n.format(e,{type:l,places:r,pattern:null==t?void 0:t.pattern})}const c={};function d(e,t){let a=document.documentElement.lang;const i="bs"===a;if(i&&(a="hr"),t){const t=`${a}-full`,i={dateStyle:"full",timeStyle:"long"};return c[t]||(c[t]=new Intl.DateTimeFormat(a,i)),c[t].format(e)}const l={year:"numeric",month:i?"numeric":"short",day:"numeric"};return c[a]||(c[a]=new Intl.DateTimeFormat(a,l)),c[a].format(e)}function u(e,t,a,i){const l=null!=e?e:"en";let r=t.unknown;return(1===a||["id","ja","ko","th","vi","zh-cn","zh-hk","zh-tw"].includes(l))&&(r=t.single),1!==a&&["en","ca","da","de","el","es","et","fi","hi","hu","it","nb","nl","pt-pt","sv","tr"].includes(l)&&(r=t.multiple),p(r,Object.assign(Object.assign({},i),{number:a}))}const h=/\$\{([^}]+)\}/g;function p(e,t,a=h){let i=e;try{i=e.replace(a,((e,a)=>function(e,t){const a=e.split(".").reduce(((e,t)=>e[t]),t);return"string"==typeof a||"number"==typeof a?a:e}(a,t).toString()))}catch(e){console.error(e)}return i}}}]);
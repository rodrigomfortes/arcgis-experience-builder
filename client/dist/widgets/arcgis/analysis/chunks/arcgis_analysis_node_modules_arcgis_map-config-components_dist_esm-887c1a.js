/*! For license information please see arcgis_analysis_node_modules_arcgis_map-config-components_dist_esm-887c1a.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_map-config-components_dist_esm-887c1a"],{36216:(e,t,i)=>{i.r(t),i.d(t,{arcgis_modal_arcade:()=>c,arcgis_popup_field_pick_list:()=>h});var s=i(11254),a=i(14528),l=i(84260),n=i(69811),o=i(56612),r=i(17840),d=i(53287);i(82780),i(10465),i(51523);const c=class{constructor(e){(0,s.r)(this,e),this.arcgisClose=(0,s.c)(this,"arcgisClose",7),this.arcgisModalArcadeClose=(0,s.c)(this,"arcgisModalArcadeClose",7),this.manager=(0,a.u)(this),this.strings=(0,l.u)({blocking:!0}),this.hideDocumentationActions=!1,this.arcadeScript="",this.arcadeProfile=void 0,this.testData=void 0,this.suggestions=[],this.returnPredictOutputType=!0,this.arcadeTitle=void 0,this.arcadeTitleEditable=!1,this.arcadeTitleEditingEnabled=!1,this.addExistingExpressions=!1,this.layer=void 0,this.scriptInvalid=!0,this.hasChanges=!1}async componentWillLoad(){if(console.warn("%cmap-config-components","background: #007AC2; color: #fff; border-radius: 4px; padding: 2px 4px;",'[arcgis-modal-arcade] component in @arcgis/map-config-components is deprecated and will be removed soon. Use "arcgis-map-config-modal-arcade" instead.'),await this.loadAllModules(),this.addExistingExpressions&&this.layer){const e=this.getExistingExpressions();e&&(this.suggestions?.length?this.suggestions.push(e):this.suggestions=[e])}this.arcadeScript.length&&(this.scriptInvalid=!1)}async loadAllModules(){this.arcade=await(0,n.G)(),this.arcadeUtils=await(0,n.bO)()}async getOutputType(){try{const e=await this.arcadeEditor.getTestResult();switch(e?.type){case"boolean":case"date":case"time":case"dateOnly":case"dictionary":case"number":return e.type;case"text":return"string";default:return null}}catch(e){return null}}getExistingExpressions(){if("subtype-sublayer"===this.layer.type)return{label:this.strings.existing,suggestions:[]};const e=this.arcadeUtils.getExpressionsFromLayer(this.layer).map((e=>({label:e?.title||e?.name||this.strings.newExpression,description:this.getStringFromProfileName(e.profileInfo?.name),code:e.expression})));return{label:this.strings.existing,suggestions:e?.length?e:[]}}getStringFromProfileName(e){switch(e){case"form-constraint":return this.strings.constraint;case"feature-z":return this.strings.featureZ;case"form-calculation":return this.strings.formCalculation;case"labeling":return this.strings.labeling;case"popup":return this.strings.popup;case"popup-element":return this.strings.popupElement;case"popup-feature-reduction":return this.strings.featureReductionPopup;case"popup-element-feature-reduction":return this.strings.featureReductionPopupElement;case"visualization":return this.strings.visualization;case"field-calculation":return this.strings.fieldCalculation;case"aggregate-field":return"Aggregate Field";default:return this.strings.unknown}}render(){return(0,s.h)(s.H,{key:"6f48e7c23f2dc9221c5ec1d92f1fb170a8ce65a2"},(0,s.h)("calcite-dialog",{key:"11edfad46fa5f87f07baa7462bb8bd5dc598d3cc",class:"arcade-dialog",open:!0,modal:!0,scale:"l",escapeDisabled:!0,outsideCloseDisabled:!0,onCalciteDialogClose:()=>{this.arcgisClose.emit(),this.arcgisModalArcadeClose.emit()}},(0,s.h)("div",{key:"3ecc4fd37a60020ab6d795507d093d4445de3a31",slot:"header-content",class:"header"},this.arcadeTitle&&this.arcadeTitleEditable?(0,s.h)("calcite-inline-editable",{scale:"l",editingEnabled:this.arcadeTitleEditingEnabled,messageOverrides:{cancelEditing:this.strings.cancel,enableEditing:this.strings.edit,confirmChanges:this.strings.done}},(0,s.h)("calcite-input",{ref:e=>this.arcadeTitleInput=e,alignment:"start",placeholder:this.strings.titlePlaceHolder,scale:"l",type:"text",value:this.arcadeTitle||this.strings.newExpression,onCalciteInputInput:()=>this.hasChanges=!0})):this.arcadeTitle||this.strings.newExpression),(0,s.h)("arcgis-arcade-editor",{key:"f5b411eff25c6b9d5d9ac210f51441041cd5e3af",class:"arcade-editor",ref:e=>this.arcadeEditor=e,hideDocumentationActions:this.hideDocumentationActions,script:this.arcadeScript,profile:this.arcadeProfile,testData:this.testData,suggestions:this.suggestions,onArcgisDiagnosticsChange:e=>{const t=e.detail;if(t?.length){for(const e of t)if(1===e?.severity)return this.scriptInvalid=!0,void(this.hasChanges=!0);this.scriptInvalid=!1}else this.scriptInvalid=!1;if(!this.hasChanges){const e=this.arcadeEditor?.script;this.hasChanges=this.arcadeScript!==e}}}),(0,s.h)("calcite-button",{key:"7eee01b1406ad38fda61f0b66cc584077f21a076",slot:"footer-end",appearance:"outline-fill",alignment:"center",scale:"m",onClick:()=>{this.arcgisClose.emit(),this.arcgisModalArcadeClose.emit()}},this.strings.cancel),(0,s.h)("calcite-button",{key:"ac2572b38d71e581d1332562823cdf743693888b",slot:"footer-end",alignment:"center",appearance:"solid",scale:"m",disabled:this.scriptInvalid||!this.hasChanges,onClick:async()=>{this.arcgisClose.emit({script:this.arcadeEditor.script,...this.arcadeTitle&&{title:this.arcadeTitleInput?.value?.trim()||this.strings.newExpression},...this.returnPredictOutputType&&{predictOutputType:await this.getOutputType()}}),this.arcgisModalArcadeClose.emit({script:this.arcadeEditor.script,...this.arcadeTitle&&{title:this.arcadeTitleInput?.value?.trim()||this.strings.newExpression},...this.returnPredictOutputType&&{predictOutputType:await this.getOutputType()}})}},this.strings.done)))}static get assetsDirs(){return["assets"]}get el(){return(0,s.a)(this)}};c.style=".arcade-dialog.sc-arcgis-modal-arcade{top:7.5%;left:7.5%;right:7.5%;--calcite-dialog-size-x:85%;--calcite-dialog-size-y:85%}.header.sc-arcgis-modal-arcade{width:55%}.arcade-editor.sc-arcgis-modal-arcade{width:100%;height:100%}arcgis-arcade-editor.sc-arcgis-modal-arcade{z-index:var(--calcite-z-index-header);--calcite-panel-content-space:0}arcgis-arcade-editor.sc-arcgis-modal-arcade>calcite-tooltip.sc-arcgis-modal-arcade{z-index:var(--calcite-z-index-tooltip)}";const h=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.arcgisClose=(0,s.c)(this,"arcgisClose",7),this.arcadeChangeNotification=(0,s.c)(this,"arcadeChangeNotification",7),this.manager=(0,a.u)(this),this.arcadeExpMap=new Map,this.popoverProps=void 0,this.selectedFields=[],this.showFilterLength=5,this.multiple=!1,this.numbersOnly=!1,this.hideCancel=!1,this.heading=void 0,this.okBtnText=void 0,this.popupState=void 0,this.lastSortBy="default",this.filterFields=void 0}async reposition(){this.popoverNode?.reposition()}async componentWillLoad(){const{popupState:e}=this,{layer:t,popupTemplate:i}=e;await this.loadAllModules(),this.layerFieldsMap=await(0,r.f)(t),this.arcadeExpMap=(0,r.m)(i),this.fieldInfos=await this.getFieldInfos(),!this.multiple&&this.selectedFields.length>1&&(this.selectedFields=[this.selectedFields[0]])}componentDidLoad(){this.flowItemNode?.setFocus()}componentWillRender(){const{popupState:e}=this,{popupTemplate:t}=e;this.arcadeExpMap=(0,r.m)(t),this.fieldFieldInfosOnly=[...this.getSortedFieldList()].filter((e=>!e.name.includes(o.f.expression))),this.expressionFieldInfosOnly=[...this.getSortedFieldList()].filter((e=>e.name.includes(o.f.expression)))}render(){const{popupState:e}=this,{strings:t,layerSupportsArcade:i}=e;return(0,s.h)(s.H,{key:"11bfb871ea207703439997b161c0bb35049f4d24",class:"js-app-flyout"},(0,s.h)("calcite-popover",{key:"e6d776a6f36aecb755eac1d8d26a4b27e88fcd11",class:"popover",placement:this.popoverProps.placement??"leading-start",open:!0,pointerDisabled:!0,referenceElement:this.popoverProps.refElement,offsetDistance:this.popoverProps.offsetDistance??-Math.round(this.popoverProps.refElement.getBoundingClientRect().width),offsetSkidding:this.popoverProps.offsetSkidding??50,label:this.heading,triggerDisabled:!0,ref:e=>this.popoverNode=e},(0,s.h)("calcite-flow",{key:"ea022ba5d64dd56ec0e9d8c8d071aaf69ca57fcf",style:{width:`${this.popoverProps.popoverWidth??this.popoverProps.refElement.getBoundingClientRect().width}px`},ref:e=>this.flowNode=e},(0,s.h)("calcite-flow-item",{key:"370184b5dfbd6cb57626c07f3f8a9b5fd4d6e749",class:"flow-item",heading:this.heading,closable:!0,onCalciteFlowItemClose:()=>this.arcgisClose.emit(),ref:e=>this.flowItemNode=e},(0,s.h)("calcite-list",{key:"e1051404d0c25f1651bffdfd5e3d19051c7076f3",class:"content",label:this.heading,selectionMode:this.multiple?"multiple":"single",filterEnabled:this.fieldInfos.length>=this.showFilterLength,filterPlaceholder:t.searchFields,onCalciteListFilter:e=>{e.stopPropagation(),this.filterFields=this.listNode.filteredItems?.map((e=>e.value))},onCalciteListChange:()=>{const e=this.listNode.selectedItems.map((e=>e.value)),t=this.selectedFields.filter((t=>e.includes(t))),i=e.filter((e=>!this.selectedFields.includes(e)));this.selectedFields=[...new Set([...t,...i])],this.arcgisChange.emit({selectedFields:this.selectedFields}),this.multiple||this.arcgisClose.emit({selectedFields:this.selectedFields})},ref:e=>this.listNode=e},this.multiple&&this.renderSelectDeselectButton(),this.fieldInfos.length>=this.showFilterLength&&this.renderSort(),i&&(0,s.h)("calcite-list-item-group",{key:"47ea56ca469590ecbef90a930342563bd510e125",heading:t.expressions},this.expressionFieldInfosOnly.length?this.expressionFieldInfosOnly.map((e=>this.renderExpressionsOnlyList(e))):(0,s.h)("calcite-label",{class:"no-expressions-label",alignment:"center"},t.noExpressions)),(0,s.h)("calcite-list-item-group",{key:"b8b19c0e276b59f904967cdf07d9a6c2da4aa339",heading:i?t.attributes:void 0},this.fieldFieldInfosOnly.map((e=>this.renderFieldsOnlyList(e))))),(0,s.h)("div",{key:"8c8a13228aee7c452ff8074ea659e8b87bcbdf4e",class:"footer",slot:"footer"},i&&this.renderAddExpressionButton(),this.multiple&&this.renderDoneButton(),!this.hideCancel&&this.renderCancelButton())))))}renderSelectDeselectButton(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)("div",{class:"select-button-wrapper"},(0,s.h)("calcite-button",{appearance:"transparent",width:"full",class:"selection-button",onClick:()=>{this.canDeselectAll()?this.selectedFields=this.filterFields?.length?this.selectedFields.filter((e=>!this.filterFields.includes(e))):[]:this.selectedFields=this.filterFields?.length?[...new Set([...this.selectedFields,...this.filterFields])]:this.fieldInfos.map((e=>e.name)),this.arcgisChange.emit({selectedFields:this.selectedFields})}},this.canDeselectAll()?t.deselectAll:t.selectAll))}renderSort(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)("calcite-dropdown",{slot:"filter-actions-end",placement:"bottom-end",overlayPositioning:"fixed"},(0,s.h)("calcite-action",{slot:"trigger",text:t.sort,title:t.sort},(0,s.h)("calcite-icon",{scale:"s",icon:"sortDescending",flipRtl:!0})),(0,s.h)("calcite-dropdown-group",null,(0,s.h)("calcite-dropdown-item",{selected:"default"===this.lastSortBy,onClick:()=>this.lastSortBy="default",onKeyDown:e=>{e.stopPropagation()," "!==e.key&&"Enter"!==e.key||(this.lastSortBy="default")}},t.default),(0,s.h)("calcite-dropdown-item",{selected:"display"===this.lastSortBy,onClick:()=>this.lastSortBy="display",onKeyDown:e=>{e.stopPropagation()," "!==e.key&&"Enter"!==e.key||(this.lastSortBy="display")}},t.displayName),(0,s.h)("calcite-dropdown-item",{selected:"type"===this.lastSortBy,onClick:()=>this.lastSortBy="type",onKeyDown:e=>{e.stopPropagation()," "!==e.key&&"Enter"!==e.key||(this.lastSortBy="type")}},t.type),(0,s.h)("calcite-dropdown-item",{selected:"field"===this.lastSortBy,onClick:()=>this.lastSortBy="field",onKeyDown:e=>{e.stopPropagation()," "!==e.key&&"Enter"!==e.key||(this.lastSortBy="field")}},t.fieldName)))}renderExpressionsOnlyList(e){const{popupState:t}=this,{strings:i,popupTemplate:a}=t;return(0,s.h)("calcite-list-item",{key:e.name,label:e.alias||e.name,value:e.name,description:`{${e.name}}`,selected:!this.multiple&&e.name===this.selectedFields[0]||this.multiple&&this.selectedFields.includes(e.name),metadata:{label:e.alias,fieldName:e.name}},(0,s.h)("div",{class:"expression-actions",slot:"actions-end"},(0,s.h)("calcite-action",{disabled:t.blockFeatureReductionArcade,text:i.edit,title:i.edit,scale:"s",icon:this.numbersOnly&&e.type.toLowerCase()!==o.a.number?"exclamation-mark-triangle":"pencil",onClick:()=>{this.arcadeExpMap.has(e.name)&&this.launchArcade(this.arcadeExpMap.get(e.name))}}),(0,s.h)("calcite-action",{text:i.remove,title:i.remove,scale:"s",icon:"trash",onClick:async()=>{const i=a.expressionInfos.find((t=>`${o.f.expression}${t.name}`===e.name));if(i){a.expressionInfos.splice(a.expressionInfos.indexOf(i),1);a.content.filter((e=>"fields"===e.type)).forEach((t=>{const i=t.fieldInfos.find((t=>t.fieldName===e.name));i&&t.fieldInfos.splice(t.fieldInfos.indexOf(i),1)}));a.content.filter((e=>"media"===e.type)).forEach((t=>{t.mediaInfos.filter((e=>"image"!==e.type)).forEach((t=>{const i=t.value.fields,s=t.value.normalizeField,a=i.find((t=>t===e.name));a&&i.splice(i.indexOf(a),1),s===e.name&&(t.value.normalizeField=null)}))}))}await(0,d.f)(t,this.FieldInfo),this.fieldInfos=this.fieldInfos.filter((t=>t.name!==e.name)),this.selectedFields=[...this.selectedFields].filter((t=>t!==e.name)),this.multiple&&this.arcgisChange.emit({selectedFields:[...new Set(this.selectedFields)]}),this.arcadeChangeNotification.emit()}})))}renderFieldsOnlyList(e){const{popupState:t}=this,{strings:i,layer:a,mapView:l,layerDisplayType:n}=t;return(0,s.h)("calcite-list-item",{key:e.name,label:e.alias||e.name,value:e.name,description:`{${e.name}}`,selected:!this.multiple&&e.name===this.selectedFields[0]||this.multiple&&this.selectedFields.includes(e.name)},n===o.l.feature&&!e.name.includes(o.f.relationship)&&(0,s.h)("calcite-action",{slot:"actions-end",text:i.info,title:i.info,scale:"s",icon:"information",onClick:t=>{t.stopPropagation();const i=t.target,s=document.createElement("calcite-flow-item");s.heading=e.alias??e.name,s.description=e.name;const n=document.createElement("arcgis-field-info");n.fieldName=e.name,n.layer=a,n.view=l,n.classList.add("content"),s.addEventListener("calciteFlowItemBack",(()=>{this.flowNode.removeChild(s),this.flowItemNode.selected=!0,i.setFocus()})),s.appendChild(n),this.flowNode.appendChild(s),s.selected=!0,this.flowItemNode.selected=!1,s.setFocus()}}))}renderAddExpressionButton(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)("calcite-button",{disabled:e.blockFeatureReductionArcade,appearance:"transparent",width:"full",iconStart:"plus",class:"add-expression-button",onClick:()=>this.launchArcade()},t.addExpression)}renderDoneButton(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)("calcite-button",{appearance:this.hideCancel?"outline-fill":"solid",width:this.hideCancel?"full":"half",onClick:()=>this.arcgisClose.emit({selectedFields:[...new Set(this.selectedFields)]})},this.okBtnText??(this.multiple?t.done:t.ok))}renderCancelButton(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)("calcite-button",{appearance:"outline-fill",width:this.multiple?"half":"full",onClick:()=>this.arcgisClose.emit()},t.cancel)}async loadAllModules(){this.PopupExpressionInfo=await(0,n.aB)(),this.FieldInfo=await(0,n.f)()}async getFieldInfos(){const{popupState:e}=this,{popupTemplate:t,layer:i}=e,s=[];let a=await(0,r.c)(i);a=a.filter((e=>e.visible));const l=new Map(t.fieldInfos.map((e=>[e.fieldName,e])));if(a.forEach((e=>{if(l.has(e.name)){const t=l.get(e.name);s.push({name:t.fieldName,alias:(0,r.o)(t,this.arcadeExpMap),type:(0,r.n)(t.fieldName,this.layerFieldsMap,this.arcadeExpMap)}),l.delete(e.name)}})),l.forEach((e=>{s.push({name:e.fieldName,alias:(0,r.o)(e,this.arcadeExpMap),type:(0,r.n)(e.fieldName,this.layerFieldsMap,this.arcadeExpMap)})})),this.numbersOnly){const e=new Set(this.selectedFields);return s.filter((t=>{const i=t.type.toLowerCase();return(e.has(t.name)||i===o.a.integer||i===o.a.smallInteger||i===o.a.bigInteger||i===o.a.single||i===o.a.double||i===o.a.long||i===o.a.number||i===o.a.oid)&&!t.name.includes(o.f.relationship)}))}return s}getSortedFieldList(){const e=[...this.fieldInfos];return"display"===this.lastSortBy?e.sort(((e,t)=>e.alias.localeCompare(t.alias))):"field"===this.lastSortBy?e.sort(((e,t)=>e.name.localeCompare(t.name))):"type"===this.lastSortBy&&e.sort(((e,t)=>e.type.localeCompare(t.type))),e}canDeselectAll(){return this.filterFields?.length?this.filterContainsAll():this.selectedFields.length===this.fieldInfos.length}filterContainsAll(){return this.filterFields.every((e=>this.selectedFields.some((t=>t===e))))}async launchArcade(e){const{popupState:t}=this,{popupTemplate:i,layerDisplayType:s,strings:a,serviceType:l,mapView:n,layer:o}=t;this.arcadeEditorNode||(this.flowItemNode.disabled=!0,this.arcadeEditorNode=document.createElement("arcgis-modal-arcade"),this.arcadeEditorNode.arcadeProfile=await(0,d.a)(o,n,l,i,s),this.arcadeEditorNode.testData=await(0,d.b)(o,n,s,i),this.arcadeEditorNode.arcadeScript=(0,d.c)(e?.expression,s,a),this.arcadeEditorNode.suggestions=(0,d.e)(o,a,"attributeExpression"),this.arcadeEditorNode.addExistingExpressions=!0,this.arcadeEditorNode.layer=o,this.arcadeEditorNode.arcadeTitle=e?.title||a.arcadeDefaultTitle,this.arcadeEditorNode.arcadeTitleEditable=!0,this.arcadeEditorNode.arcadeTitleEditingEnabled=!e?.title,document.body.appendChild(this.arcadeEditorNode),this.arcadeEditorNode.addEventListener("arcgisClose",(t=>{t.stopPropagation(),this.arcadeSetup(t.detail,e)})))}async arcadeSetup(e,t){const{popupState:i}=this,{popupTemplate:a}=i;if(e){const l=(0,d.s)(e,t?.name,this.PopupExpressionInfo,a);await(0,d.f)(i,this.FieldInfo);const n=`${o.f.expression}${l.name}`;this.fieldInfos.push({name:n,alias:l.title,type:l.returnType}),this.fieldInfos=[...new Map(this.fieldInfos.map((e=>[e.name,e]))).values()],this.multiple?this.selectedFields.push(n):this.selectedFields=[n],this.arcgisChange.emit({selectedFields:[...new Set(this.selectedFields)]}),this.arcadeChangeNotification.emit(),(0,s.f)(this.el)}this.flowItemNode.disabled=!1,document.body.removeChild(this.arcadeEditorNode),this.arcadeEditorNode=void 0}get el(){return(0,s.a)(this)}};h.style=".popover{--calcite-popover-z-index:100}.flow-item{min-height:300px}.content{max-height:calc(60vh - 142px);}.select-button-wrapper{padding:var(--calcite-spacing-sm)}.expression-actions{display:flex}.no-expressions-label{margin-top:var(--calcite-spacing-sm)}.footer{width:100%}.add-expression-button{margin:var(--calcite-spacing-sm) 0}"}}]);
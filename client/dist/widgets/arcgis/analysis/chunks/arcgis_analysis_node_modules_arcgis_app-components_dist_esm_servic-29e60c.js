/*! For license information please see arcgis_analysis_node_modules_arcgis_app-components_dist_esm_servic-29e60c.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_servic-29e60c"],{5042:(e,t,r)=>{r.d(t,{a:()=>n,g:()=>s,s:()=>a,u:()=>o});var i=r(4429);function a(e,t,r,i){!function(e,t,r){r=r||{};let i=null==r?void 0:r.expires;if("number"==typeof i){const e=new Date,t=24*i*60*60*1e3;e.setTime(Date.now()+t),i=r.expires=e}"string"!=typeof i&&(null==i?void 0:i.toUTCString)&&(r.expires=i.toUTCString());let a,s=`${e}=${encodeURIComponent(t)}`;for(a in r){s+=`; ${a}`;const e=r[a];!0!==e&&(s+=`=${e}`)}document.cookie=s}(e,i?JSON.stringify(t):t,r)}function s(e,t){const r=function(e){const t=document.cookie,r=new RegExp(`(?:^|; )${(0,i.e)(e)}=([^;]*)`),a=t.match(r);return a?decodeURIComponent(a[1]):void 0}(e);return r&&t?JSON.parse(r):r}function n(e,t){const r=window.localStorage.getItem(e);return r&&t?JSON.parse(r):r}function o(e,t,r){const i=new Date(t);var s,n,o;i.setFullYear(t.getFullYear()+1),a(e,r,{expires:i}),r?(s=e,n="true",o=!1,window.localStorage.setItem(s,o?JSON.stringify(n):n)):function(e){window.localStorage.removeItem(e)}(e)}},24869:(e,t,r)=>{r.d(t,{a:()=>s,f:()=>c,g:()=>l,s:()=>n,v:()=>o});var i=r(15912),a=r(46227);function s(e,t){const r=/(?:\.([^.]+))?$/;let i=null==e?void 0:e.replace(/^.*(\\|\/|:)/,""),s=i&&r.exec(i)[1]?r.exec(i)[1].toLowerCase():"",n="";if((null==i?void 0:i.indexOf(".rft."))>-1){const[e,t]=i.split(".rft.");s=`rft.${t}`,n=e}return i&&!n&&(n=-1===i.lastIndexOf(".")?i:i.substring(0,i.lastIndexOf("."))),n=n.replace(/\.|-/g,"_"),t&&(n=function(e){return`${e}_${(0,a.g)()}`}(n),i=`${n}.${s}`),{title:n,fileName:i,extension:s}}function n(e,t){return s(e.name,!!t)}function o(e,t){let r=e;const i=e.lastIndexOf("\\");return i>-1&&(r=r.substring(i+1,r.length)),r.replace(/\ /g,"_")===t.replace(/\ /g,"_")}function l(e){return i.a[e]?i.a[e]:i.a[Object.keys(i.a).find((t=>i.a[t].type===e))]}function c(e){if(!e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${Math.round(e/Math.pow(1024,t))} ${["B","KB","MB","GB","TB"][t]}`}},32710:(e,t,r)=>{r.d(t,{A:()=>yt,B:()=>Ge,C:()=>te,D:()=>Qe,E:()=>ie,F:()=>Ne,G:()=>U,H:()=>ft,I:()=>Ze,M:()=>j,a:()=>mt,b:()=>rt,c:()=>Z,d:()=>ne,e:()=>se,f:()=>F,g:()=>qe,h:()=>C,i:()=>nt,j:()=>B,k:()=>_e,l:()=>Je,m:()=>Be,n:()=>Ae,o:()=>He,p:()=>N,q:()=>ze,r:()=>T,s:()=>k,t:()=>De,u:()=>Fe,v:()=>z,w:()=>vt,x:()=>Xe,y:()=>Ee,z:()=>gt});var i=r(83929),a=r(50637),s=r(59317),n=r(931),o=r(87744),l=r(3826),c=r(76246),u=r(63054),d=r(24869),p=r(80379),v=r(4429),y=r(72257),m=r(15912),f=r(50020),g=r(46227),w=r(75294),h=r(37762),b=r(72411),S=r(38295),x=r(43555),O=r(5152);function I(e){const{customParameters:t}=l.a,r=e.includes("?")?"&":"?",i=(null==t?void 0:t.map((({parameter:e,value:t})=>`${e||""}${e||t?"=":""}${t||""}`)).join("&"))||"";return i?`${e}${r}${i}`:e}function T(e,{value:t,parameter:r}){const i=`${r}=${t}`,a=e.replace("&"===e[e.indexOf(i)-1]?`&${i}`:i,"");return"?"===a[a.length-1]?a.replace("?",""):a}const L=async e=>{const t=k.subscribers[e];try{await(null==t?void 0:t.unsubscribe())}catch(e){console.error(`Fail to call unsubscribe for ${t.name}: ${e}`)}},P=(0,h.c)({subscribers:{},unsubscribeAll:async()=>{await Promise.all(Object.keys(k.subscribers).map(L)),P.reset()},addSubscriber:(e,t)=>{const r=`${e}---${(0,g.g)()}`;return k.subscribers[r]={name:e,unsubscribe:t},r},unsubscribe:L,removeSubscriber:async e=>{delete k.subscribers[e]},isSubscriberValid:e=>!!k.subscribers[e]}),k=P.state,j=78643200,M={fields:[{name:"Name",type:"esriFieldTypeString",alias:"Name",nullable:!0,editable:!0,sqlType:"sqlTypeOther",visible:!0,domain:null,defaultValue:null},{name:"Location",type:"esriFieldTypeString",alias:"Location",nullable:!0,editable:!0,sqlType:"sqlTypeOther",visible:!0,domain:null,defaultValue:null},{name:"Description",type:"esriFieldTypeString",alias:"Description",nullable:!0,editable:!0,sqlType:"sqlTypeOther",visible:!0,domain:null,defaultValue:null}]};async function C(e,t,r){if("Desktop Application"===e.type)return Ae();const i=await(0,x.s)(e);return"Application"!==e.type&&"API Key"!==e.type||await U(e.developerCredentialsType,i.id,t,r),i}async function U(e,t,r,i){const s=`${r}oauth2/registerApp`;let n={itemId:t,appType:"multiple",redirect_uris:JSON.stringify(["urn:ietf:wg:oauth:2.0:oob"])};i&&(n="apiToken"===e?Object.assign(Object.assign({},n),{httpReferrers:JSON.stringify(i.httpReferrers),privileges:JSON.stringify(i.privileges),isPersonalAPIToken:i.isPersonalAPIToken}):"apikey"===i.appType?{itemId:t,appType:"apikey",redirect_uris:JSON.stringify(i.redirect_uris),httpReferrers:JSON.stringify(i.httpReferrers),privileges:JSON.stringify(i.privileges)}:{itemId:t,appType:i.appType,httpReferrers:JSON.stringify(i.httpReferrers),redirect_uris:JSON.stringify(i.redirect_uris),url:i.url,privileges:JSON.stringify(i.privileges),isPersonalAPIToken:i.isPersonalAPIToken});try{return{result:await(0,a.r)(s,n,{},"post")}}catch(e){return console.error("error:",e),{error:{code:"unhandledError"}}}}async function F(e){try{return{result:await(0,a.r)(e,{},{addTokenManually:!1}),error:null}}catch(e){return console.error("error:",e),{result:null,error:{code:"appExtensionError"}}}}const $={xmax:2e7,xmin:-2e7,ymax:2e7,ymin:-2e7,spatialReference:{wkid:102100}};function R(e,t){const r={102113:[-20037508.342788905,20037508.342788905],102100:[-20037508.342788905,20037508.342788905],3785:[-20037508.342788905,20037508.342788905],3857:[-20037508.342788905,20037508.342788905],4326:[-180,180]}[e];if(r&&t.xmin>t.xmax){const e=r[1]-t.xmin,i=t.xmax-r[0];e>i?t.xmax=r[1]+i:t.xmin=r[0]-e}}function E(e,t){var r,i;const a="ImageServer"!==t?null==e?void 0:e.spatialReference:null===(r=null==e?void 0:e.extent)||void 0===r?void 0:r.spatialReference;return a?a.wkid?a.wkid:a.wkt&&-1!==(null===(i=a.wkt)||void 0===i?void 0:i.search(/^PROJCS/i))?/^PROJCS\["[A-Za-z0-9_]*/i.exec(a.wkt)[0].split("[")[1]:null:null}async function N(e){var t,r;const[i]=await(0,n.l)([4===s.c.api?"esri/geometry/SpatialReference":"esri/SpatialReference"]),a=(null===(t=null==e?void 0:e.spatialReference)||void 0===t?void 0:t.wkid)||(null===(r=null==e?void 0:e.spatialReference)||void 0===r?void 0:r.wkt),o=new i({wkid:4326}),l=await async function(e,t){const r=[102113,102100,3857];if((null==e?void 0:e.wkt)==(null==t?void 0:t.wkt)&&((null==e?void 0:e.wkid)==(null==t?void 0:t.wkid)||(0,v.c)(e.latestWkid)&&(null==e?void 0:e.latestWkid)==(null==t?void 0:t.wkid))||(0,v.c)(null==t?void 0:t.latestWkid)&&(null==e?void 0:e.wkid)==(null==t?void 0:t.latestWkid)||(0,v.c)(null==e?void 0:e.latestWkid)&&(null==e?void 0:e.latestWkid)==(null==t?void 0:t.latestWkid))return!0;if((null==e?void 0:e.wkid)&&(null==t?void 0:t.wkid)&&r.includes(null==e?void 0:e.wkid)&&r.includes(null==t?void 0:t.wkid))return!0;return!1}(o,null==e?void 0:e.spatialReference);return a&&!l?await D(e,o):e}async function A(e,t){const{portal:r}=s.c,[i,a]=await(0,n.l)(4===s.c.api?["esri/geometry/support/webMercatorUtils","esri/rest/geometryService"]:["esri/geometry/webMercatorUtils","esri/tasks/GeometryService"]),o=[102113,102100,3857],l=e.spatialReference.wkid;if(l===t.wkid)return[e];let c;return 4326===l&&o.indexOf(t.wkid)>-1?(e.ymin=Math.max(e.ymin,-89.99),e.ymax=Math.min(e.ymax,89.99),c=i.geographicToWebMercator(e),R(t.wkid,c),c.spatialReference.wkid=t.wkid,[c]):o.indexOf(l)>-1&&4326===t.wkid?(c=i.webMercatorToGeographic(e),R(t.wkid,c),[c]):new Promise((async(i,o)=>{const l=4===s.c.api?a:new a(r.helperServices.geometry.url),c=e=>{const t=null==e?void 0:e[0];if("extent"!==(null==t?void 0:t.type)||isNaN(e[0].xmin)||isNaN(e[0].ymin)||isNaN(e[0].xmax)||isNaN(e[0].ymax)){if("point"!==(null==t?void 0:t.type)||isNaN(e[0].x)||isNaN(e[0].y))throw new Error;i(e)}else i(e)};if(4===s.c.api)try{const[i]=await(0,n.l)(["esri/rest/support/ProjectParameters"]),a=new i({geometries:[e],outSpatialReference:t});c(await l.project(r.helperServices.geometry.url,a))}catch(e){o(e)}else l.project([e],t,c,(e=>{o(e)}))}))}async function D(e,t){var r;const[i]=await(0,n.l)(["esri/geometry/Extent"]),a=new i($),s=e.clone?e.clone():new i(Object.assign({},e)),o=await A(s,t);return"extent"===(null===(r=null==o?void 0:o[0])||void 0===r?void 0:r.type)?o[0]:a}async function W(e,t){const{api:r}=s.c,[i]=await(0,n.l)([4===r?"esri/geometry/SpatialReference":"esri/SpatialReference"]),[a,o]=await(0,n.l)(["esri/layers/FeatureLayer","esri/layers/StreamLayer"]);if(!e||!(e instanceof a)||e instanceof o)return t;if(3===r){try{await e.addPlugin("esri/plugins/FeatureLayerStatistics");const r=await e.statisticsPlugin.getSuggestedScaleRange(),{minScale:a,center:s,relaxedMinScale:n}=r;if(s){let e=await J(s,1280,a);if(r.relaxedMinScale>0){let t=G(e,200),r=800;for(;t>n&&(e=J(s,r,a),t=G(e,200),r-=200,!(r<=0)););}const o=await A(e,new i({wkid:4326}));t=[[o[0].xmin,o[0].ymin],[o[0].xmax,o[0].ymax]]}}catch(e){console.warn(e)}return t}return t}async function G(e,t){const[r,i]=await(0,n.l)(["esri/config","esri/WKIDUnitConversion"]),a=e.spatialReference,s=null==a?void 0:a.wkid,o=null==a?void 0:a.wkt;let l=null;if(s)l=i.values[i[s]];else if(-1!==(null==o?void 0:o.search(/^PROJCS/i))){const e=/UNIT\[([^\]]+)\]\]$/i.exec(o);(null==e?void 0:e[1])&&(l=parseFloat(e[1].split(",")[1]))}return e.getWidth()/t*(l||20015077/180)*39.37*r.defaults.screenDPI}async function J(e,t,r){const[i]=await(0,n.l)(["esri/geometry/Extent"]);return async function(e,t,r){const[i,a]=await(0,n.l)(["esri/config","esri/WKIDUnitConversion"]),s=39.37,o=20015077/180,l=a;let c,u,d=e.spatialReference;d&&(c=d.wkid,u=d.wkt);let p=null;if(c)p=l.values[l[c]];else if(u&&-1!==u.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(u);(null==e?void 0:e[1])&&(p=parseFloat(e[1].split(",")[1]))}const v=e.expand(r*t/((p||o)*s*i.defaults.screenDPI)/e.getWidth());return v}(new i(e.x-1,e.y-.5,e.x+1,e.y+.5,e.spatialReference),t,r)}function _(e,t=4){if(!e)return _($);if("string"==typeof e)return e;if(Array.isArray(e)){if(Array.isArray(e[0])&&Array.isArray(e[1])){let t,r;return 2===e[0].length&&(t=e[0],r=e[1]),4!==e[0].length&&6!==e[0].length||(t=[e[0][0],e[0][1]],r=[e[0][2],e[0][3]],6===e[0].length&&(r=[e[0][3],e[0][4]])),`${t.join(",")},${r.join(",")}`}return e.join(",")}return`${e.xmin.toFixed(t)},${e.ymin.toFixed(t)},${e.xmax.toFixed(t)},${e.ymax.toFixed(t)}`}var K=function(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(i=Object.getOwnPropertySymbols(e);a<i.length;a++)t.indexOf(i[a])<0&&Object.prototype.propertyIsEnumerable.call(e,i[a])&&(r[i[a]]=e[i[a]])}return r};const V={currentVersion:10.51,hasVersionedData:!1,supportsDisconnectedEditing:!1,hasStaticData:!1,maxRecordCount:2e3,supportedQueryFormats:"JSON",supportsVCSProjection:!1,capabilities:"Query,Editing,Create,Update,Delete,Sync",description:"",copyrightText:"",allowGeometryUpdates:!0,units:"esriMeters",supportsAppend:!0,syncEnabled:!1,supportsApplyEditsWithGlobalIds:!1,editorTrackingInfo:{allowAnonymousToDelete:!0,allowAnonymousToQuery:!0,allowAnonymousToUpdate:!0,allowOthersToDelete:!1,allowOthersToQuery:!0,allowOthersToUpdate:!0,enableEditorTracking:!1,enableOwnershipAccessControl:!1},xssPreventionInfo:{xssPreventionEnabled:!0,xssPreventionRule:"InputOnly",xssInputRule:"rejectInvalid"},_ssl:!0},q={provider:"CUSTOMDATA",extensions:[],frameworkProperties:{},datasets:[],capabilities:"Query",type:"FeatureServer",clusterName:"default",minInstancesPerNode:0,maxInstancesPerNode:0,instancesPerContainer:1,maxWaitTime:60,maxStartupTime:300,maxIdleTime:1800,maxUsageTime:600,loadBalancing:"ROUND_ROBIN",isolationLevel:"HIGH",configuredState:"STARTED",recycleInterval:24,recycleStartTime:"00:00",keepAliveInterval:1800,private:!1,isDefault:!1,maxUploadFileSize:0,allowedUploadFileTypes:"",properties:{disableCaching:"true"}},B=async e=>{var t,r,i,a,n,o,c,u,d;const{tags:p,serviceInfo:v,typeKeywords:m,extent:f,selectedServiceInfoLayersNames:g,addFeatureLayerType:w,layerData:h}=e,{portal:S}=s.c,I=S.isPortal,T="CUSTOMDATA"===(null==v?void 0:v.provider);if(!v)throw new Error("No service info found.");try{let e;if(T)e=q,e.serviceName=v.name||y.i.title;else{e=V;try{e=null!==(t=await gt(S))&&void 0!==t?t:V,e.capabilities="Query,Editing,Create,Update,Delete",e.hasStaticData=!1}catch(e){console.warn(`Could not fetch template ${JSON.stringify(e)}`)}}const L=v;let P=null!==(r=L.layers)&&void 0!==r?r:[],k=null!==(i=L.tables)&&void 0!==i?i:[],j=null!==(a=null==h?void 0:h.layers)&&void 0!==a?a:[],M=null!==(n=null==h?void 0:h.tables)&&void 0!==n?n:[];if("build"!==w&&g){const e=e=>g[e.name];P=P.filter(e),k=k.filter(e),j=j.filter((e=>P.find((t=>t.id===e.id)))),M=M.filter((e=>k.find((t=>t.id===e.id))))}const{layers:C,tables:U}=Q(P,k),F=Object.assign(Object.assign(Object.assign({},e),v),{name:L.name||y.i.title,layers:C,tables:U}),{cleanedCreateParameters:$,relationshipParameters:R}=H(F);["serviceDescription","hasStaticData","maxRecordCount","supportedQueryFormats","capabilities","description","copyrightText","spatialReference","initialExtent","fullExtent","_ssl","allowGeometryUpdates","units","xssPreventionInfo"].forEach((e=>{const t=L[e];null!=t&&($[e]=t)})),$.name=(0,b.a)($.name),"template"===w&&($.syncEnabled=!0,$.capabilities="Query,Editing,Create,Update,Delete,Sync");const{createServiceResponse:E}=await yt($,Object.assign({asyncAddToDefinition:!I,config:s.c.config,user:s.c.user,preserveLayerIds:!0},T&&{hostingServer:s.c.hostingServer}));if(T)return{success:!0,id:E.itemId,folder:y.i.folder.id};const{itemId:A,serviceurl:D,success:W}=E,{typeKeywords:G}=(await(0,x.a)(A)).result,J=[...m,...G];v.captureGPS&&J.push("gpsMetadataEnabled");try{const e=S.defaultExtent||v.fullExtent||v.extent||f,t=e.spatialReference.wkid||e.spatialReference.wkt||"4326",r=_((e=>{const t=(e,t,r)=>e>=t&&e<=r;return t(e.ymax,-90,90)&&t(e.ymin,-90,90)&&t(e.xmax,-180,180)&&t(e.xmin,-180,180)&&e.ymax>e.ymin&&e.xmax>e.xmin})(e)?e:await N(e)),i=`https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/export?size=800,532&format=png24&bboxSR=${t}&bbox=${_(e)}&f=image`,a=y.i.folder;(null===(c=null===(o=s.c.portal)||void 0===o?void 0:o.sourceJSON)||void 0===c?void 0:c.hasClassificationSchema)&&(l.a.classification.createdUser=s.c.user.username,l.a.classification.createdDate=Date.now());const n={};return j.length&&(n.layers=j),M.length&&(n.tables=M),await Promise.all([(0,x.u)(A,Object.assign(Object.assign({title:y.i.title,typeKeywords:J.join(","),tags:(null!=p?p:y.i.tags).join(","),extent:r,snippet:y.i.snippet,description:l.a.description},Object.keys(n).length>0?{text:JSON.stringify(n)}:{}),(null===(d=null===(u=s.c.portal)||void 0===u?void 0:u.sourceJSON)||void 0===d?void 0:d.hasClassificationSchema)?{classification:JSON.stringify(l.a.classification)}:{})),R.layers||R.tables?mt(JSON.stringify(R),E.encodedServiceURL,!I):void 0,!(0,O.i)(a)&&(0,x.m)(A,a.id)]),(0,x.u)(A,{thumbnailURL:i}).catch(console.error),{success:W,id:A,folder:y.i.folder.id,serviceurl:D}}catch(e){throw(0,x.d)(A,{permanentDelete:!0}),console.error(e),e}}catch(e){throw console.error(e),e}},z=async({serviceUrl:e,restBaseUrl:t,forceAddToken:r,isSecure:i,customParameters:a})=>{var s;const{username:n,password:c,checkAuth:u}=l.a,d=a?`?${(0,o.b)(a)}`:"";try{const t=e=>ot({username:n,password:c},`${e}${d}`,{forceAddToken:r,isSecure:i,isVideoService:!1,checkAuth:u}),a=(0,o.p)(e);if(!a)return console.warn("invalid service info"),null;const{baseServerUrl:s,index:l}=a,p=await t(s),v=await Promise.all((p.layers||[]).filter((e=>null===l||e.id===l)).map((e=>t(`${s}/${e.id}`))));return{serviceInfo:p,layers:v,tables:await Promise.all((p.tables||[]).filter((e=>null===l||e.id===l)).map((e=>t(`${s}/${e.id}`))))}}catch(r){if(console.error(r),"token required"===(null===(s=r.message)||void 0===s?void 0:s.toLowerCase()))try{const{secured:r}=await st({username:n,password:c},e,t,u);return await z({serviceUrl:e,restBaseUrl:t,forceAddToken:r})}catch(e){throw e}throw r}},H=e=>{const t={},r=e=>t[e.id]=!0;e.layers.forEach(r),e.tables.forEach(r);const i=e=>t[e.relatedTableId],a=e=>{var t;return{relationships:null===(t=e.relationships)||void 0===t?void 0:t.filter(i),id:e.id}},s=e=>{var t;return(null===(t=e.relationships)||void 0===t?void 0:t.length)>0},n={layers:e.layers.map(a).filter(s),tables:e.tables.map(a).filter(s)};0===n.layers.length&&delete n.layers,0===n.tables.length&&delete n.tables;const o=e.layers.map((e=>K(e,["relationships"]))),l=e.tables.map((e=>K(e,["relationships"])));return{relationshipParameters:n,cleanedCreateParameters:Object.assign(Object.assign({},e),{layers:o,tables:l})}},Q=(e,t)=>{const r=e=>Object.assign(Object.assign({},e),{indexes:(0,v.u)(e.indexes,(e=>e.name))});return{layers:e.map(r),tables:t.map(r)}},Y="hiddenMapDiv",X=()=>{const e=document.getElementById(Y);e&&e.parentNode.removeChild(e)},Z=(e=200,t=130)=>{let r=document.getElementById(Y);r||(r=document.createElement("div"),r.id=Y,r.style.position="absolute",r.style.left="-1000px",r.style.top="-1000px",r.style.width=`${e}px`,r.style.height=`${t}px`,document.body.appendChild(r));const i=document.createElement("div"),a="hiddenMap";return i.id=a,i.style.width=`${e}px`,i.style.height=`${t}px`,r.appendChild(i),a};async function ee(e,t){const[r,i,a,s]=await(0,n.l)(["esri/tasks/PrintTemplate","esri/tasks/PrintParameters","esri/tasks/PrintTask","esri/config"]),o=new r;o.layout="MAP_ONLY",o.format="png32",o.preserveScale=!1,o.showAttribution=!1,o.showLabels=!1,o.exportOptions={width:600,height:400,dpi:96};const l=new a(t.self.helperServices.printTask.url,{}),c=new i;return c.map=e,c.template=o,s.defaults.io.timeout=12e4,new Promise(((t,r)=>{l.execute(c,(r=>{s.defaults.io.timeout=6e4,function(e){var t;e.destroy(),null===(t=document.getElementById("hiddenMapDiv"))||void 0===t||t.removeChild(document.getElementById("hiddenMap"))}(e),t(r.url)}),(e=>{s.defaults.io.timeout=6e4,r(e)}))}))}async function te(e,t,r){var i;const a=s.c.api,[o]=3===a?await(0,n.l)(["esri/tasks/Geoprocessor"]):await(0,n.l)(["esri/rest/geoprocessor"]),{portal:l}=s.c;(null!==(i=e.baseMap.baseMapLayers)&&void 0!==i?i:[]).forEach((e=>{delete e.resourceInfo})),e.mapOptions={showAttribution:!1,extent:{xmin:t[0][0],ymin:t[0][1],xmax:t[1][0],ymax:t[1][1],spatialReference:{wkid:4326}},spatialReference:r},e.exportOptions={dpi:96,outputSize:[600,400]},e.layoutOptions={};const c={Web_Map_as_JSON:JSON.stringify(e),Format:"PNG32",Layout_Template:"MAP_ONLY"};if(3===a){const e=new o(l.helperServices.printTask.url);return new Promise(((t,r)=>{e.execute(c).then((e=>{if(e){let i=!1;for(let r=0;r<e.length;r++)if("Output_File"===e[r].paramName){t(e[r].value.url),i=!0;break}i||r()}}))}))}const{results:u}=await o.execute(l.helperServices.printTask.url,c),d=u.find((e=>"data-file"===e.dataType&&e)).value.url;if(!d)throw new Error("Failed to create thumbnail");return d}async function re(e,t){return await async function(e,t){const{config:r}=s.c,i={item:{extent:t},itemData:e};try{const[e]=await(0,n.l)(["esri/arcgis/utils"]);e.arcgisUrl=`${(0,o.g)()}content/items`;const t=Z(),a=await e.createMap(i,t,{mapOptions:{nav:!1},bingMapsKey:r.self.bingKey,geometryServiceURL:s.c.portal.helperServices.geometry.url}),l=function(e){return new Promise((t=>{e._heatmapManager?e._heatmapManager.on("recalculateHeatmap",t):t()}))},c=e=>{const t=[0];return new Promise((r=>{const i=setInterval(((e,t)=>{var a;(null===(a=e.graphics)||void 0===a?void 0:a.length)||t[0]>10?(clearInterval(i),r()):t[0]=t[0]+1}),500,e,t)}))},u=e=>new Promise((t=>{"esri.layers.VectorTileLayer"===e.declaredClass&&setTimeout(t,5e3),e.on("update-start",(()=>{d(e).then(t)}))})),d=function(e){return new Promise((t=>{if(!e.updating)return t();"esri.layers.VectorTileLayer"===e.declaredClass&&setTimeout(t,1e4),e.on("update-end",t)}))},{map:p}=a,y=[];return p.graphicsLayerIds.forEach((e=>{var t;const r=p.getLayer(e);"heatmap"===(null===(t=r.renderer)||void 0===t?void 0:t.type)?y.push(l(r)):"esri.layers.WFSLayer"===r.declaredClass?y.push(c(r)):r.updating&&y.push(d(r))})),p.layerIds.forEach((e=>{const t=a.map.getLayer(e);t.updating?y.push(d(t)):"esri.layers.VectorTileLayer"===t.declaredClass&&y.push(u(t))})),y.length?(await Promise.all(y),await(0,v.t)(1e3),await ee(a.map,r)):await ee(a.map,r)}catch(e){throw new Error(`Map creation failed: ${JSON.stringify(e)}`)}}(e,t)}async function ie(e){var t;const[r]=await(0,n.l)([4===s.c.api?"esri/geometry/SpatialReference":"esri/SpatialReference"]),{config:i,portal:a}=s.c,o={};o.baseMap=i.defaultBasemap||a.defaultBasemap,o.baseMap.title="basemap",o.operationalLayers=[];let l=e.url;l||"KML"!==e.type||(l=i.restBaseUrl+"content/items/"+e.id+"/data");const c=new URL(i.restBaseUrl).hostname;if(l.indexOf(c)>-1){const e=null===(t=null==i?void 0:i.userInfo)||void 0===t?void 0:t.token;e&&(l+="?token="+e)}o.operationalLayers.push({url:l,id:"KML_"+Math.random(),opacity:1,title:e.title,visibility:!0,type:"KML"});let u=[];if("string"==typeof e.extent){const t=e.extent.split(",");u=[[parseFloat(t[0]),parseFloat(t[1])],[parseFloat(t[2]),parseFloat(t[3])]]}else u=e.extent&&e.extent.length>0?e.extent:[[-180,-90],[180,90]];return te(o,u,new r({wkid:4326}))}async function ae(e,t,r){const[i,a]=await(0,n.l)(["esri/config","esri/layers/KMLLayer"]);if(3===r?i.defaults.kmlService=t.kmlService:i.kmlServiceUrl=t.kmlService,4===r){const t=new a({url:e});await t.load();return _(t.fullExtent)}const s=new a(e);return new Promise(((e,t)=>{s.on("load",(async()=>{const t=await async function(e){const[t]=await(0,n.l)(["esri/graphicsUtils"]),r=e.getLayers();let i;return r.forEach((e=>{var r;if((null===(r=e.graphics)||void 0===r?void 0:r.length)>0){const r=t.graphicsExtent(e.graphics);i=i?i.union(r):r}})),i}(s);e(t?_(t):void 0)})),s.on("error",t)}))}const se=async(e,t,r,i,a)=>{try{const s=t.isPortal?r:`https://${t.portalHostname}/sharing/rest`,n=t.portalHostname?`${s}/content/items/${e}/data`:`${(0,x.g)(e)}/data`,o=await ae(n,i,a);return{result:await(0,x.u)(e,{url:n,extent:o})}}catch(e){return console.error(e),{error:{code:"unhandledError"}}}};function ne(e){if(!e)return null;let t=!0,r={},i={};return e.forEach((({append:e,parameter:a,value:s})=>{"layer"===e?(t=!1,i[a]=s):r[a]=s})),t?{customParameters:r}:{customParameters:r,customLayerParameters:i}}var oe;async function le(e){if(4===s.c.api)return"imagery-tile"==e.type;const[t]=await(0,n.l)(["esri/layers/RasterXLayer"]);return e instanceof t}async function ce(e){if(4===s.c.api)return"imagery"===e.type;const[t,r]=await(0,n.l)(["esri/layers/ArcGISImageServiceLayer","esri/layers/ArcGISImageServiceVectorLayer"]);return e instanceof t||e instanceof r}!function(e){e.Single="single",e.Multi="multi",e.Children="children",e.MultiChildren="multi-children",e.Ancestors="ancestors"}(oe||(oe={}));const ue={type:"esriSMS",style:"esriSMSCircle",color:[34,114,162,128],size:6,outline:{color:[34,114,162,255],width:1}},de={type:"esriSLS",style:"esriSLSSolid",color:[77,77,77,255],width:1.5},pe={type:"esriSFS",style:"esriSFSSolid",color:[227,139,79,204],outline:{type:"esriSLS",style:"esriSLSSolid",color:[255,255,255,255],width:.75}};async function ve(e){const[t,r]=await(0,n.l)(["esri/renderers/SimpleRenderer",4===s.c.api?"esri/geometry/support/jsonUtils":"esri/symbols/jsonUtils"]);switch(e){case"esriGeometryPoint":return new t(r.fromJson(ue)).toJson();case"esriGeometryPolyline":return new t(r.fromJson(de)).toJson();case"esriGeometryPolygon":return new t(r.fromJson(pe)).toJson()}}async function ye(e){const{fields:t,selectedLayer:r}=e;if(null==t?void 0:t.length){const i=t.filter((e=>"esriFieldTypeGeometry"!==e.type));if(null==i?void 0:i.length)return async function(e,t){var r,i;const a=e.displayField,s=e.name+((null==a?void 0:a.length)?`: {${a}}`:"");let n=e.fields,o=!1,l=!1,c=!1;const u=await ce(t),d=await le(t);if(u||d){const e={rasterAttributeTableFieldPrefix:"Raster."};n=null===(r=t.getCustomRasterFields)||void 0===r?void 0:r.call(t,e),c=["F32","F64"].indexOf(t.pixelType)<0,(null==t?void 0:t.capabilities)&&(o=(null==t?void 0:t.capabilities.toLowerCase().indexOf("catalog"))>-1||(null===(i=t.fields)||void 0===i?void 0:i.length)>0,l=o&&("esriImageServiceDataTypeVector-UV"===t.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===t.serviceDataType))}const p={esriFieldTypeDouble:1,esriFieldTypeSingle:1},v={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},y={esriFieldTypeDate:1};let m=",";e.editFieldsInfo&&(e.editFieldsInfo.creatorField&&(m+=`${e.editFieldsInfo.creatorField},`),e.editFieldsInfo.creationDateField&&(m+=`${e.editFieldsInfo.creationDateField},`),e.editFieldsInfo.editorField&&(m+=`${e.editFieldsInfo.editorField},`),e.editFieldsInfo.editDateField&&(m+=`${e.editFieldsInfo.editDateField},`),m=m.toLowerCase());const f={title:s,fieldInfos:n.map((r=>{let i="esriFieldTypeOID"!==r.type&&"esriFieldTypeGlobalID"!==r.type&&"esriFieldTypeGeometry"!==r.type,a=null,s=r.editable&&"esriFieldTypeOID"!==r.type&&"esriFieldTypeGlobalID"!==r.type;if(i){let s=r.name.toLowerCase(),n=`${m}stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,`;o&&(n=`${n}raster.itempixelvalue,`,l&&(n=`${n}raster.magnitude,raster.direction,`)),(n.indexOf(`,${s},`)>-1||s.indexOf("shape")>-1||s.indexOf("perimeter")>-1||s.indexOf("objectid")>-1||s.indexOf("raster.servicepixelvalue.")>-1||s.indexOf("_i")==s.length-2)&&(i=!1),r.type in v?a={places:0,digitSeparator:!0}:r.type in p?a={places:c&&(s.indexOf("raster.servicepixelvalue")>-1||s.indexOf("raster.itempixelvalue")>-1)?0:2,digitSeparator:!0}:r.type in y&&(e.currentVersion>=10||(null==t?void 0:t.version)>=10)&&(a={dateFormat:"longMonthDayYear"})}return s=s?-1===m.indexOf(`,${r.name.toLowerCase()},`):s,{fieldName:r.name,label:r.alias,isEditable:s,tooltip:"",visible:i,format:a,stringFieldOption:"textbox"}})),description:null,showAttachments:!0,mediaInfos:[],layerOptions:void 0};return ce(t)?(f.layerOptions={},f.layerOptions.showNoDataRecords=!0,f.layerOptions.returnTopmostRaster=!0):le(t)&&(f.layerOptions={},f.layerOptions.showNoDataRecords=!0),f}({name:(null==r?void 0:r.title)||"",fields:t},e)}}async function me(e,t){if(3===s.c.api){const r={opacity:1,visibility:!0,layerType:"WebTiledLayer",type:"WebTiledLayer"},i={baseMap:{title:"basemap",baseMapLayers:[],operationalLayers:[]}};if(e.id){const t=await async function(e){const{config:t}=s.c,r=`${t.restBaseUrl}content/items/${e}/data`;try{const e=await(0,a.r)(r,null,{disableIdentityLookup:!0});return e&&((null==e?void 0:e.wfsInfo)||e.wmtsInfo)?e:(null==e?void 0:e.layers)?e.layers:{}}catch(e){return e}}(e.id);i.baseMap.baseMapLayers.push(Object.assign(Object.assign({},t),r))}else i.baseMap.baseMapLayers.push(r);return re(i,t||e.extent)}{const[t,r,i,a]=await(0,n.l)(["esri/layers/WMTSLayer","esri/Map","esri/views/MapView","esri/core/reactiveUtils"]),o=new t({portalItem:{id:e.id,portal:s.c.portal}}),l=new r({layers:[o]}),c=new i({container:Z(),map:l});await a.whenOnce((()=>!c.updating)),await c.goTo(o.fullExtent);return(await c.takeScreenshot({width:c.width,height:c.height,format:"png"})).dataUrl}}const fe=e=>{var t;const r=s.c.portal;return e.thumbnailURL&&(e.thumbnailURL=function(e){var t;return(null===(t=null==e?void 0:e.staticImagesUrl)||void 0===t?void 0:t.replace("http:","https:"))||""}(r)+e.thumbnailURL),r.isPortal&&0!==(null===(t=e.thumbnailURL)||void 0===t?void 0:t.indexOf("http"))&&(e.thumbnailURL=window.location.protocol+"//"+window.location.host+e.thumbnailURL),e};const ge=(e,t)=>{const[r,i]=e.split("?");return`${r}${(null==i?void 0:i.split("&").reduce(((e,r)=>{const[i]=r.split("=");return-1===t.indexOf(i.toLowerCase())?`${e}${e?"&":"?"}${r}`:e}),""))||""}`},we=async e=>{var t;const[r]=await(0,n.l)(["esri/layers/WMSLayer"]),{customParameters:i}=e,a=ne(i),o=ge(e.url,["service","request","bbox","format","height","width","layers","srs","crs","styles","transparent","bgcolor","exceptions","time","elevation","sld","wfs"]);try{if(4===s.c.api){const i=new r({url:o,customParameters:Object.assign({},null==a?void 0:a.customParameters),customLayerParameters:Object.assign({},null==a?void 0:a.customLayerParameters)});try{const t=await i.load();return e.type="WMS",{result:Object.assign(Object.assign({},e),{type:"WMS",serviceInfo:t})}}catch(e){return{error:{code:e.message?"unhandledError":"serviceNotExist",message:null!==(t=e.message)&&void 0!==t?t:e.message}}}}await Te(o);const i=new r(o,{customParameters:Object.assign({},null==a?void 0:a.customParameters),customLayerParameters:Object.assign({},null==a?void 0:a.customLayerParameters)}),n=await new Promise(((t,r)=>{i.on("load",(()=>{e.type="WMS",t(Object.assign(Object.assign({},e),{type:"WMS",serviceInfo:i}))})),i.on("error",(e=>{var t;const{error:i}=e,a=!(null==i?void 0:i.message)||404===(null==i?void 0:i.status);r({code:a?"serviceNotExist":"unhandledError",message:null!==(t=i.message)&&void 0!==t?t:e.message})}))}));return{result:n}}catch(e){return console.error(e),{error:e}}},he=async e=>{const t=4===s.c.api?await e.load():e,{layerInfos:r,title:i,allSublayers:a}=t;return{title:i,layers:function(e){return e.map((e=>{var t;const r=null!==(t=e.legendURL)&&void 0!==t?t:e.legendEnabled?e.legendUrl:void 0;return{name:e.name,visible:!1,title:e.title.replace(/ /g,String.fromCharCode(160)),extent:e.extent,legendUrl:r||void 0,queryable:e.queryable,subLayers:e.subLayers||[]}}))}(4===s.c.api?a.items:r)}};function be(e=[],t){return delete t.id,t.subLayers&&t.subLayers.length?t.subLayers.reduce(be,e):[...e,t]}const Se=async(e,t)=>{let r=e.thumbnailURL;try{r=(await t.fetchImage(e.extent,800,532)).src}catch(e){console.error(e)}return Object.assign(Object.assign({},e),{thumbnailURL:r,extent:_(e.extent)})},xe=async(e,t)=>new Promise((r=>{const i=t=>{r(Object.assign(Object.assign({},e),{thumbnailURL:t||e.thumbnailURL,extent:_(e.extent)}))};t.getImageUrl(e.extent,800,532,i,i)})),Oe=(e,t)=>JSON.stringify({title:e.title||"",url:e.url,version:e.version,layers:t,copyright:e.copyright||"",maxHeight:e.imageMaxHeight,maxWidth:e.imageMaxWidth,spatialReferences:e.spatialReferences,format:e.imageFormat.includes("png")?null:e.imageFormat,featureInfoUrl:e.featureInfoUrl,featureInfoFormat:e.featureInfoFormat,customParameters:e.customParameters||{},customLayerParameters:e.customLayerParameters||{}}),Ie=(e,t)=>JSON.stringify({title:e.title||"",url:e.url,mapUrl:e.getMapURL,version:e.version,layers:t,copyright:e.copyright||"",maxHeight:e.maxHeight,maxWidth:e.maxWidth,spatialReferences:e.spatialReferences,format:"png"!==e.getImageFormat()?e.getImageFormat():null,featureInfoUrl:e.getFeatureInfoURL,featureInfoFormat:e.featureInfoFormat,customParameters:e.customParameters||{},customLayerParameters:e.customLayerParameters||{}});async function Te(e){var t,r,i;try{const a=await fetch(e);if("cors"===a.type&&200===a.status){const a=new URL(e).hostname,[s]=await(0,n.l)(["esri/config"]);null===(i=null===(r=null===(t=null==s?void 0:s.defaults)||void 0===t?void 0:t.io)||void 0===r?void 0:r.corsEnabledServers)||void 0===i||i.push(a)}}catch(e){}}function Le({parameter:e}){return"version"===e}const Pe=async e=>{const{customParameters:t}=e,{url:r}=e,i=ge(r,["version","service","request","layer","typename"]),a=null==t?void 0:t.find(Le),s=ne(t.filter((e=>!Le(e)))),o=Object.assign({customParameters:(null==s?void 0:s.customParameters)||{}},a?{version:a.value}:{});try{const[t]=await(0,n.l)(["esri/layers/ogc/wcsUtils"]),r=await t.getCapabilities(i,o),a=r.gridCoverages;return a&&a.length?{result:Object.assign(Object.assign({},e),{type:"WCS",url:i,serviceInfo:Object.assign(Object.assign({},r),{url:i})})}:{error:{code:"emptyFeatureLayer"}}}catch(e){return console.error(e),{error:e}}},ke=async(e,t)=>{const[r]=await(0,n.l)(["esri/layers/WFSLayer"]),{customParameters:i}=l.a,{url:a}=e,o=ge(a,["version","service","request","layer","typename"]),c=ne(i),d=await(async e=>{const{query:t}=await(0,u.u)(e);return(null==t?void 0:t.version)||"2.0.0"})(a),p=t||{version:d,url:o,customParameters:(null==c?void 0:c.customParameters)||{}};try{if(4===s.c.api){if("2.0.0"!==d)return{error:{code:"unsupportedWFSVersion"}};delete p.version,delete p.url;const[t]=await(0,n.l)(["esri/layers/ogc/wfsUtils"]),i=await t.getCapabilities(o,p),a=i.featureTypes;if(a&&a.length){const s=await t.getWFSLayerInfo(i,void 0,void 0,p),n=r.fromWFSLayerInfo(s);return n.layers=a,n.url=o,n.isComplex="esriGeometryComplex"===n.geometryType,{result:Object.assign(Object.assign({},e),{type:"WFS",serviceInfo:n})}}return{error:{code:"emptyFeatureLayer"}}}const t=new r(p);await Te(o);return{result:await new Promise(((r,i)=>{t.initialize(p,(a=>{a&&a.length?(t.layers=a,t.url=o,t.isComplex="esriGeometryComplex"===t.geometryType,r(Object.assign(Object.assign({},e),{type:"WFS",serviceInfo:t}))):i({code:"emptyFeatureLayer"})})),t.on("error",(async()=>{if("2.0.0"===t.toJson().version){const{result:t,error:s}=await ke(e,{version:"1.1.0",url:a});s&&i(s),r(t)}else if("1.1.0"===t.toJson().version){const{result:t,error:s}=await ke(e,{version:"1.0.0",url:a});s&&i(s),r(t)}else i({code:"serviceNotExist"})}))}))}}catch(e){return console.error(e),{error:e}}},je=async e=>{var t;if(!e||!(null==e?void 0:e.serviceInfo))return Promise.reject(new Error("serviceNotExist"));const r=function(e,t,r){const{customParameters:i}=ne(r),a=i.version||e.version;return delete i.version,{title:e.name,url:e.url,customParameters:i,layerType:"WCS",wcsInfo:{version:a,coverageId:t.id}}}(e.serviceInfo,e.selectedCoverage,e.customParameters),i=null===(t=null==e?void 0:e.selectedCoverage)||void 0===t?void 0:t.lonLatEnvelope,a=Object.assign(Object.assign({type:e.type,url:e.url},i?{extent:_(i)}:{}),{text:JSON.stringify(r)}),s=await Ve(a);return Object.assign(Object.assign({},a),s)},Me=async e=>{var t;if(!e||!(null==e?void 0:e.serviceInfo))return Promise.reject(new Error("serviceNotExist"));const{serviceInfo:r}=e,i=_((null===(t=r.selectedLayer)||void 0===t?void 0:t.fullExtent)||[[],[]]),a=i.split(",").map(Number);if(!r.geometryType||"none"===r.geometryType)return Promise.reject(new Error("missingGeometry"));const n={type:e.type,url:e.url,thumbnailURL:e.thumbnailURL},o=await async function(e){const{layerNamespace:t,getFeatureUrl:r,spatialReferences:i,fields:a}=e,{maxFeatures:n,geometryType:o}=l.a;let c,u,d,p;if(3===s.c.api){const t=e.toJson();c=t.url,u=t.mode,d=t.version,p=t.name}else{const t=e;c=t.url,d="2.0.0",p=t.name}const v=o||e.geometryType||"esriGeometryComplex";return{url:c,mode:u,wfsInfo:{version:d,name:p,wfsNamespace:t,featureUrl:r,supportedSpatialReferences:i,customParameters:e.customParameters||{},maxFeatures:n||e.maxFeatures||3e3},layerDefinition:{geometryType:v,drawingInfo:{renderer:await ve(v)},spatialReference:{wkid:4326},fields:a},popupInfo:await ye(e)}}(r),c=Object.assign(Object.assign({},fe(n)),{text:JSON.stringify(o),extent:i}),d=await Ve(c),p=Object.assign(Object.assign(Object.assign({},c),d),{extent:[[a[0],a[1]],[a[2],a[3]]]});try{const e=await async function(e){const{config:t}=s.c,r={baseMap:t.defaultBasemap||t.self.defaultBasemap,operationalLayers:[]},{baseMapLayers:i}=r.baseMap;let a=!1;return i.forEach((e=>{e.isReference||a||(!t.allSSL&&"https:"!=location.protocol||!(0,u.i)(e.url)&&!(0,u.s)(e.url)||(e.url=e.url.replace("http:","https:")),e.visibility=!1,a=!0,r.baseMap.baseMapLayers=[e])})),r.operationalLayers.push({type:"WFS",layerType:"WFS",opacity:1,visibility:!0,id:"wfs_xxx",wfsInfo:{maxFeatures:100}}),te(r,e)}(p.extent);return Object.assign(Object.assign({},p),{thumbnailUrl:e})}catch(e){return p}};async function Ce(e,t){const[r]=await(0,n.l)(["esri/layers/WMTSLayer"]),{customParameters:i,url:a}=e,o=ne(i),l=Object.assign(Object.assign({},t),{customLayerParameters:null==o?void 0:o.customLayerParameters,customParameters:null==o?void 0:o.customParameters})||await Object.assign(Object.assign({},async function(e){var t,r;const i=await(0,u.u)(e),a=(null===(t=i.query)||void 0===t?void 0:t.service)||"",s=(null===(r=i.query)||void 0===r?void 0:r.request)||"";return"wmts"===a.toLowerCase()&&"getcapabilities"===s.toLowerCase()||e.toLowerCase().indexOf("/1.0.0/wmtscapabilities.xml")>-1?{serviceMode:"KVP"}:{}}(a)),{customLayerParameters:(null==o?void 0:o.customLayerParameters)||{},customParameters:(null==o?void 0:o.customParameters)||{}}),c=ge(a,["version","service","request","layer","style","format","tilematrixset","tilematrix","tilerow","tilecol"]),d=c.replace(/\/1.0.0\/wmtscapabilities.xml/i,"");try{if(4===s.c.api){const t=new r(d,l),i=t;await i.load();const a=i.sublayers.toArray();return a&&a.length?(t.layers=a,{result:Object.assign(Object.assign({},e),{type:"WMTS",serviceInfo:t})}):{error:{code:"serviceNotExist"}}}await Te(c);const t=new r(d,l);let i;return{result:await new Promise(((r,a)=>{t.on("load",(({layer:s})=>{i=s.layers,i&&i.length?(t.layers=i,r(Object.assign(Object.assign({},e),{type:"WMTS",serviceInfo:t}))):a(new Error("serviceNotExist"))})),t.on("error",(t=>{var i;l.serviceMode?("The WMTS capabilities XML is not valid"===(null===(i=t.error)||void 0===i?void 0:i.message)&&a({code:"invalidWMTS"}),a({code:"serviceNotExist"})):Ce(e,{serviceMode:"KVP"}).then((({result:e,error:t})=>{t&&a(t),r(e)}),a)}))}))}}catch(e){return console.error(e),{error:e}}}async function Ue(e){if(!e)return Promise.reject("serviceNotExist");const{serviceInfo:t,selectedLayer:r,selectedTileInfo:i}=e;if(!r)return Promise.reject(new Error("layerNotSelected"));if(!i)return Promise.reject(new Error("missingGeometry"));t.selectedTileInfo=i;const{wmtsConfig:a,fullExtent:o}=await async function(e){var t;const r=4===s.c.api;try{const[i]=await(0,n.l)([r?"esri/geometry/SpatialReference":"esri/SpatialReference"]),{selectedLayer:a,selectedTileInfo:o,copyright:l}=e,c=(null==o?void 0:o.fullExtent.spatialReference)||new i({wkid:4326}),u=await A(null==a?void 0:a[r?"fullExtent":"gcsExtent"],c).then((e=>{var t;return"extent"===(null===(t=null==e?void 0:e[0])||void 0===t?void 0:t.type)?4===s.c.api?e[0]:e[0].toJson():null}));let d,p="";if(r)p=a.imageFormat;else{const e=a.formats;p=e.includes("image/png")?"image/png":e[0]}e.resourceUrls=a.resourceUrls,d=r?e.getUrlTemplate(a.id,o.id,p,a.styleId):e.getTileUrlTemplate({identifier:a.identifier,tileMatrixSet:o.tileMatrixSet,format:p});const v={templateUrl:d,copyright:function(e){return"none"!==(null==e?void 0:e.toLowerCase())?(null==e?void 0:e.length)>180?`${e.substring(0,180)}..`:"":e}(l),fullExtent:r?u.toJSON():u||e.selectedTileInfo.fullExtent,tileInfo:function(e){const{tileInfo:t}=e;return 96!==(null==t?void 0:t.dpi)&&(t.lods.forEach((e=>{e.scale=96*e.scale/t.dpi})),t.dpi=96),r?t.toJSON():t.toJson()}(o),wmtsInfo:{url:null!==(t=e.wmtsUrl)&&void 0!==t?t:e.url,layerIdentifier:r?a.id:a.identifier,tileMatrixSet:r?o.id:o.tileMatrixSet,customParameters:e.customParameters||{},customLayerParameters:e.customLayerParameters||{}}};return Promise.resolve({wmtsConfig:v,fullExtent:u})}catch(e){throw console.error(e),e}}(t).catch((e=>{throw console.error("Error getting WMTS config",e),e})),l=t.selectedLayer[4===s.c.api?"fullExtent":"gcsExtent"],c=o?l:{xmin:-180,ymin:-90,xmax:180,ymax:90},u={type:e.type,url:e.url,thumbnailURL:e.thumbnailURL},d=Object.assign(Object.assign({},fe(u)),{url:a.wmtsInfo.url,text:JSON.stringify(a),extent:`${c.xmin},${c.ymin},${c.xmax},${c.ymax}`}),p=await Ve(d),v=Object.assign(Object.assign(Object.assign({},d),p),{extent:[[c.xmin,c.ymin],[c.xmax,c.ymax]]});try{const e=await me(v),t=4===s.c.api?{type:"base64",data:e}:{type:"url",url:e},r=await(0,x.b)(p.id,t);return Object.assign(Object.assign({},v),r)}catch(e){return console.error("Error when adding WMTS URL:",e),v}}function Fe(e){var t,r;if(!e)return;const{title:i,description:a}=e;y.i.title=null!==(t=null!=i?i:y.i.title)&&void 0!==t?t:"",y.i.snippet=null!==(r=null!=a?a:y.i.snippet)&&void 0!==r?r:"",l.a.selectedLayer=e}async function $e(e,t={},r=!0){const{links:i}=e,n=Re(i,"data","application/json")||Re(i,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(null==n)throw new Error("Missing collections url");return 3===s.c.api?(0,a.r)(I(n.href),{},Object.assign(Object.assign({},t),{addTokenManually:!1}),"auto",{v3Request:{headers:{accept:"application/json"}},excludeJson:r}):(0,a.r)(I(n.href),{},Object.assign(Object.assign({},t),{addTokenManually:!1,headers:{accept:"application/json"}}),"auto",{excludeJson:r})}function Re(e,t,r){return e.find((e=>e.rel===t&&e.type===r))||e.find((e=>e.rel===t&&!e.type))}const Ee=(e,t)=>{const{newItemMode:r,typeKeywords:i,tags:a,extent:n,selectedServiceInfoLayersNames:o,addFeatureLayerType:c,layerData:u}=l.a,d=y.i.title;switch((null==d?void 0:d.length)>250&&(y.i.title=d.substring(0,250)),r){case"application":return C(e,t);case"file":return Ae();case"url":return Je(e,s.c.config,s.c.api);case"featureLayer":return B({serviceInfo:e.serviceInfo,typeKeywords:i,tags:a,extent:n,selectedServiceInfoLayersNames:o,addFeatureLayerType:c,layerData:u});default:return(0,x.s)(Object.assign({},e))}},Ne=async()=>{try{const e=l.b,t=await Ee(e,"");l.a.id=t.id;const r=await qe(l.a.id,{success:t.success});if("failed"===r.status)throw r.statusMessage;return{}}catch(e){console.error(e);const t=(null==e?void 0:e.statusMessage)||e||"";switch(!0){case t.includes("Invalid File Geodatabase"):return{error:{code:"invalidFileGeodatabase"}};case t.includes("Invalid Shapefile"):return{error:{code:"invalidShapefile"}};case t.includes("The request size is greater than the max allowed of 1024MB"):return{error:{code:"exceedsFileSize"}};default:return{error:{code:"unhandledError"}}}}},Ae=async e=>{const t=l.a.file,r=l.a.dataUrl;return!t&&r?De(e):(null==t?void 0:t.size)>j||"Esri Classifier Definition"===l.a.type?Ge():async function(){const e=(0,x.h)(s.c.user,y.i.folder),t=(0,x.e)(y.i,l.a);try{return await(0,a.a)(e,t,{},"post")}catch(e){throw(null==e?void 0:e.message)||e}}()},De=async e=>{var t;const r=(0,x.h)(s.c.user,y.i.folder),{fileName:i,dataUrl:n,extension:o}=l.a,c=(0,x.c)(y.i,l.a),u=!!l.a.overwrite,d=(null==n?void 0:n.includes("/query?"))&&(null==i?void 0:i.includes("query"))&&(null==o?void 0:o.includes("json"))?{filename:(0,g.g)(),dataUrl:n}:{},p=Object.assign(Object.assign(Object.assign({},c),{async:!0,filename:null!==(t=null==e?void 0:e.filename)&&void 0!==t?t:i,title:null==e?void 0:e.title,overwrite:u}),d);return(0,a.r)(r,p,{},"post")};async function We(e,t,r=0){const{user:i,portal:n}=s.c,{existingItem:o}=l.a;try{const{partData:l,formData:c}=e,u=`?streamdata=true&size=${l.size}&partNum=${l.partNum}&f=json`,d=`${o?(0,f.g)(await(0,f.f)(o.owner,n),n):i.userContentUrl}/items/${t}/addPart${u}`;return{response:await(0,a.a)(d,c,{"X-Esri-Authorization":`Bearer ${(0,a.g)(s.c.portal)}`},"post"),attempts:r,partSize:l.size}}catch(i){if(!l.a.id)throw"cancelled";if(++r>5)throw new Error("Upload failed - too many attempts");return We(e,t,r)}}const Ge=async e=>{var t,r,i,n;let o,c,u,d,p=!0;if(e){const{updateUrl:t,updateFormData:r,updateSourceDataId:i}=e;o=t,c=r,u=i,d=l.a.existingItem.owner}const v=()=>{if(l.a.id){p=!1;const e=l.a.id;return l.a.id=null,(0,x.i)(e,d)}},m=k.addSubscriber("addFileMultiPart",v),f=s.c.config;o=e?o:(0,x.h)(s.c.user,y.i.folder);const{fileName:g,file:h}=l.a;let S,O=null!==(t=f.multiPartBatchSize)&&void 0!==t?t:3,I=0;try{if(e)await(0,a.a)(o,c,{enctype:"multipart/form/data"},"post"),S=u;else{const e=await(0,a.r)(o,{multipart:!0,fileName:g,async:!0},{},"post");S=null!==(r=e.id)&&void 0!==r?r:e.itemId,l.a.id=S}l.a.uploadProgress=0,w.w.uploadProgress=0;let t=0;const i=function*(e){const t=l.a.file,{name:r,size:i}=t;let n=e?l.a.fileName:r,o=26214400,c=Math.ceil(i/o),u=0;for(c>1e4&&(o=Math.ceil(i/1e4),c=Math.ceil(i/o));u<c;){const e=new FormData,r=u*o,i=t.slice(r,r+o);u++;const l={partNum:u,size:i.size};e.append("partNum",String(l.partNum)),e.append("streamdata","true"),e.append("f","json"),e.append("token",(0,a.g)(s.c.portal)),e.append("file",i,n),yield{partData:l,formData:e}}return null}(!!e);await(0,b.s)((()=>{const{value:e,done:t}=i.next();return t?null:We(e,S)}),{getBatchSize:()=>O,onPromiseCompleted:e=>{const{attempts:r,partSize:i}=e;r>0?(O=Math.max(1,Math.ceil(O/2)),I=0):(I++,I>=O&&(O=Math.min(O+1,10),I=0)),t+=i;const a=Math.floor(t/h.size*100);l.a.uploadProgress=a,w.w.uploadProgress=a},onPromiseThrow(){p=!1},shouldContinue:()=>p&&k.isSubscriberValid(m)}),k.removeSubscriber(m);const{type:n,extension:d,enablePublishing:v,properties:y,existingItem:f,tileLayerPublishType:T,classification:L}=l.a,P=[];return"3dTiles"===T&&P.push(l.a.tilesLayer3dTilesLayerType),await(0,x.f)(S,{file:h,type:n,extension:d,enablePublishing:v,properties:y,existingItem:f,typeKeywords:P,classification:L},!!e)}catch(e){throw await v(),console.error(null!==(i=null==e?void 0:e.message)&&void 0!==i?i:e),null!==(n=null==e?void 0:e.message)&&void 0!==n?n:e}},Je=(e,t,r)=>{if(e.agsType)return rt(e);switch(e.type){case"KML":return async function(e,t,r){try{const[i,a]=await Promise.all([ae(e.url,t,r),ie(e)]);return await Ve(Object.assign(Object.assign({},e),{extent:i,thumbnailURL:a}))}catch(e){throw e}}(e,t,r);case"WMS":return(async e=>{const t=4===s.c.api,[r]=t?await(0,n.l)(["esri/geometry/SpatialReference"]):await(0,n.l)(["esri/SpatialReference"]),{layers:i}=l.a;if(!e||!(null==e?void 0:e.serviceInfo))return Promise.reject(new Error("serviceNotExist"));const a=fe(e),{serviceInfo:o}=a,c=[];let u;const d=i.reduce(be,[]).map((e=>{u=u?e.extent?u.union(e.extent):u:e.extent,c.push(e.name);const t={name:e.name,title:e.title,legendUrl:void 0,queryable:e.queryable};return e.legendUrl&&(t.legendUrl=e.legendUrl),t}));t||o.setVisibleLayers(c),u=u||o.fullExtent;const p=!o.spatialReferences.some((e=>e===u.spatialReference.wkid)),v={type:e.type,url:o.url,description:o.description||"",accessInformation:o.copyright||"",text:t?Oe(o,d):Ie(o,d),extent:u};p&&D(u,new r({wkid:o.spatialReferences[0]})).then((e=>v.extent=e));const y=t?await Se(v,o):await xe(v,o);return Ve(y)})(e);case"WFS":return Me(e);case"WCS":return je(e);case"WMTS":return Ue(e);case"OGCFeatureServer":return async function(e){const{serviceInfo:t,customParameters:r}=e;return t?(r.length>0&&(e.text=JSON.stringify({customParameters:ne(r).customParameters})),Ve(e)):Promise.reject(new Error("serviceNotExist"))}(e);default:return Ve(e)}},_e=async e=>(0,x.s)(e),Ke=e=>{var t,r,i,a;const{type:s,agsType:n}=e,o=(null===(t=m.a[null!=n?n:s])||void 0===t?void 0:t.typeKeywords)||[];return((null===(i=null===(r=null==e?void 0:e.serviceInfo)||void 0===r?void 0:r.layers)||void 0===i?void 0:i.some((e=>"Oriented Imagery Layer"===e.type)))||"Oriented Imagery Layer"===(null===(a=null==e?void 0:e.serviceInfo)||void 0===a?void 0:a.type))&&o.push("OrientedImageryLayer"),[...o,...e.typeKeywords||[]]},Ve=async e=>{const{type:t}=(0,d.g)(e.type),r=Object.assign(Object.assign({},e),{typeKeywords:Ke(e),type:t});return(0,x.s)(r)};async function qe(e,t={},r){var i;try{const i=s.c.user,n=null!=r?r:`${i.userContentUrl}/items/${e}/status`,o=(null==t?void 0:t.jobId)?{jobId:t.jobId}:{};return await(0,a.p)(n,{requestParams:o})}catch(r){if(!(null===(i=r.statusMessage)||void 0===i?void 0:i.includes("Item status doesn't exist"))||!t.success)throw console.error(r),r;return{itemId:e,status:"status-not-found",lastUpdatedTime:0,submissionTime:0,recordCount:0}}}async function Be(e,t){const r=y.i.folder,{user:i}=s.c;return async function(e,t,r,i){const{config:n}=s.c,o=r.id&&"/"!==r.id&&r.id!==e?`/${r.id}`:"",l=`${n.restBaseUrl}content/users/${e}${o}/items/${t}/addResources`;return(0,a.r)(l,i,{},"post")}(i.username,t,r,{fileName:"cloudProvider.json",text:JSON.stringify(e),access:"private"})}async function ze(e){const{addResponseId:t,publishResponse:r,categories:i,portal:s}=e;try{const e=[t,null==r?void 0:r.id].filter((e=>e));i&&await(0,S.u)({portal:s,itemIds:e,categories:i}),await qe(r.id,{jobId:r.jobId});const n=r.serviceUrl,o=`${n.replace("rest/services","rest/admin/services")}/rebuildCache`,l=await(0,a.r)(o,{layers:0},{},"post");return await(0,x.u)(null==r?void 0:r.id,{properties:JSON.stringify({cacheJobId:l.jobId,cacheJobUrl:l.jobUrl}),id:null==r?void 0:r.id}),{}}catch(e){return console.error(e),{error:{code:"unhandledError"}}}}async function He(e,t){try{const r=`${t}/create3DLayer`,i=Object.assign(Object.assign({},M),{name:y.i.title}),s=await(0,a.r)(r,{layer3DDefinition:JSON.stringify(i)},{},"post");return{result:await qe(e,{},s.statusURL)}}catch(e){return console.error(e),{error:{code:"failToCreate3DLayer"}}}}async function Qe(e){const{url:t,thumbnailURL:r,serviceInfo:i,extent:a}=e;if(r)return r;if(!["Map Service","Feature Service","Image Service"].includes(e.type))return null;if(["Map Service","Image Service"].includes(e.type)||-1!==t.indexOf("MapServer")){const e=_(a);return a?function(e){var t;let r,{visibleLayers:i,serviceUrl:a,serviceInfo:s,size:n,extent:o,bboxSR:l,imageSR:c,format:u}=e;if(!s)return"";let d=a.indexOf("/MapServer")>-1;if(!i&&d){let e;r=a.indexOf("/MapServer");const t=a.indexOf("?");t>-1?(e=a.substring(r+11,t),a=a.substring(0,r+10)+a.substring(t),i=e):(e=a.substring(r+11),a=a.substring(0,r+10),i=e)}!d&&s&&(d=s.capabilities?s.capabilities.toLowerCase().indexOf("map")>-1:s.supportedImageFormatTypes);let p=a;if(r=p.indexOf("?"),-1===r)if(d)p+="/export?";else{if(void 0!==s.currentVersion&&s.currentVersion>=10.1)return p+="/info/thumbnail",p;p+="/exportImage?"}else if(d)p=`${p.substring(0,r)}/export${p.substring(r,p.length)}&`;else{if(void 0!==s.currentVersion&&s.currentVersion>=10.1)return p=`${p.substring(0,r)}/info/thumbnail${p.substring(r,p.length)}`,p;p=`${p.substring(0,r)}/exportImage${p.substring(r,p.length)}&`}p+=`size=${n}&bbox=${o}`,(null==l?void 0:l.length)>0&&(p+=`&bboxSR=${l}`);(null==c?void 0:c.length)>0&&(p+=`&imageSR=${c}`);d&&(null===(t=null==s?void 0:s.supportedImageFormatTypes)||void 0===t?void 0:t.indexOf("PNG32"))>-1?p+=`&format=png32&f=${u}`:p+=d?`&format=png24&f=${u}`:`&format=jpgpng&f=${u}`;d?(null==i?void 0:i.length)>0&&(p+=`&layers=show:${i}`):p+="&interpolation=RSP_NearestNeighbor&bandIds=null";return p}({serviceUrl:t,extent:e,size:"800,532",format:"image",serviceInfo:i}):null}const{result:o,error:l}=await async function(e){var t;const{config:r,portal:i,api:a}=s.c;if(4===a)return{result:await Ye(e.id,i)};const[o,l]=await(0,n.l)(["esri/layers/FeatureLayer","esri/geometry/Extent"]),{serviceInfo:c,username:d,password:p,isSecured:v}=e,y={baseMap:r.defaultBasemap||r.self.defaultBasemap,operationalLayers:[]};y.baseMap.title="basemap";const m=y.baseMap.baseMapLayers.length;for(let e=0;e<m;e++){let t=y.baseMap.baseMapLayers[e];if(!t.isReference){!r.allSSL&&"https:"!=location.protocol||!(0,u.i)(t.url)&&!(0,u.s)(t.url)||(t.url=t.url.replace("http:","https:")),t.visibility=!1,y.baseMap.baseMapLayers=[t];break}}if(!c)return{result:""};const f=c.layers||[],g=e.url,w=await(0,u.u)(g),h=v.secured?await lt(w.path,{username:d,password:p}):null;f.reverse().forEach((async t=>{const r={url:`${g}/${t.id}${h?`?token=${h}`:""}`,id:`${e.id||Math.random()}_${t.id}`,opacity:1,title:`${e.title||"title"}_${t.id}`,visibility:!0,layerDefinition:void 0};let i=!1;f.forEach((e=>{e.id!==t.id||i||(i=!0,r.layerDefinition=e.layerDefinition)})),(!f.length||f.length&&i)&&y.operationalLayers.push(r)}));let b=[[-180,-90],[180,90]];if("string"==typeof e.extent){const t=e.extent.split(",");b=[[parseFloat(t[0]),parseFloat(t[1])],[parseFloat(t[2]),parseFloat(t[3])]]}else(null===(t=e.extent)||void 0===t?void 0:t.length)>0&&(b=e.extent);if(1===y.operationalLayers.length){let e=new o(y.operationalLayers[0].url);return new Promise((t=>{e.on("load",(async r=>{(null==r?void 0:r.layer)&&(e=r.layer);const i=await W(e,b);try{const e=await re(y,i);t({result:e})}catch(e){t({error:{code:"unhandledError",message:e}})}}))}))}{const t=e.extent,r=G(new l(t[0][0],t[0][1],t[1][0],t[1][1]),200),i=[],a=[],s=[];y.operationalLayers.forEach((e=>{const t=new o(e.url),n=new Promise((s=>{t.on("load",(t=>{i.push(e),a.push(t),t.minScale<=r&&t.maxScale>r?s(!0):s(!1)})),t.on("error",(()=>{s(!1)}))}));s.push(n)}));const n=await Promise.all(s);y.operationalLayers=i;const c=n.filter((e=>e)).length>0;try{if(!c&&a.length>0){const e=await W(a[0],t);return{result:await re(y,e)}}return{result:await re(y,t)}}catch(e){return{error:{code:"unhandledError",message:e}}}}}(e);return l?(console.error("Error generating thumbnail",l),""):o}async function Ye(e,t){var r,i,a;const[s,o,l,c,u,d,p,y]=await(0,n.l)(["esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/Basemap","esri/rest/print","esri/rest/support/PrintTemplate","esri/rest/support/PrintParameters","esri/smartMapping/heuristics/scaleRange"]);try{const n=Z(800,532),m=t.defaultBasemap.id.includes("basemap"),f=new l({portalItem:{id:e,portal:t}}),g=new s({basemap:m?"topo-vector":new c({portalItem:{id:t.defaultBasemap.id,portal:t}})}),w=new o({map:g,container:n});await g.watch("loaded");let h=0,b=0;m||({minScale:h,maxScale:b}=await y({layer:f,view:w}));const S=await f.queryExtent();w.goTo(S.extent),f.minScale=h,f.maxScale=b,w.map.add(f),w.scale=b,await(0,v.t)(2e3);const x=null!==(a=null===(i=null===(r=t.helperServices)||void 0===r?void 0:r.printTask)||void 0===i?void 0:i.url)&&void 0!==a?a:"https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task",O=new p({view:w,template:new d({format:"png32",exportOptions:{dpi:96,width:800,height:532},layout:"map-only",showLabels:!1,attributionVisible:!1})}),I=await u.execute(x,O);return X(),I.url}catch(e){return X(),null}}function Xe(e){const t=(0,u.f)(e),r=(0,o.p)(e),i=t.replace(o.v,"").match(o.e);let a=null==r?void 0:r.serverType,s=null==r?void 0:r.index;const n={mapserver:"MapServer",geocodeserver:"GeocodeServer",gpserver:"GPServer",geometryserver:"GeometryServer",geoenrichmentserver:"GeoenrichmentServer",imageserver:"ImageServer",naserver:"NAServer",featureserver:"FeatureServer",geodataserver:"GeoDataServer",globeserver:"GlobeServer",wmserver:"WMServer",sceneserver:"SceneServer",vectortileserver:"VectorTileServer",streamserver:"StreamServer",videoserver:"VideoServer",knowledgegraphserver:"KnowledgeGraphServer"};return a&&n[a.toLowerCase()]&&(a=n[a.toLowerCase()]),("ags"===a||!a&&i)&&(a="MapServer"),"MapServer"===a&&null!==s?"FeatureServer":a}async function Ze(e){var t;const{config:r}=s.c,{checkAuth:i,storeAuth:a,username:l,password:c}=e;e.title=function(e){var t;return null===(t=(0,o.p)((0,u.f)(e)))||void 0===t?void 0:t.serverName}(e.url);const d=Xe(e.url);if(!d||"SceneServer"===d&&!r.sceneViewerEnabled)return{error:{code:"unknownAGSType"}};let v=null===(t=m.a[d])||void 0===t?void 0:t.type;v||console.warn(`Unknown AGS Type ${d}`),e.type=v,e.agsType=d;try{if(!s.c.user)return{result:await tt(e)};const t=await st({username:l,password:c},e.url,(0,o.g)(s.c.portal),i),r=null==t?void 0:t.allowStoredAuth;if(!1===r&&(e.allowStoredAuth=!1),t.secured){e.isSecured=Object.assign({},t),e.allowStoredAuth=!1;const l=await async function(e,t,r){var i,a;if(499===(null==t?void 0:t.httpStatusCode)){const[t]=await(0,n.l)([3===s.c.api?"esri/IdentityManager":"esri/identity/IdentityManager"]),{url:l,password:c,username:u}=e;let d=null===(i=(await t._getTokenSvcUrl(l)).authInfo)||void 0===i?void 0:i.tokenServicesUrl;if(d){"/"!==d[d.length-1]&&(d+="/");try{const e=await st({password:c,username:u},null!=d?d:"",(0,o.g)(),r);return(null==e?void 0:e.secured)&&401===(null==e?void 0:e.httpStatusCode)}catch(e){return(null===(a=null==e?void 0:e.message)||void 0===a?void 0:a.indexOf("Http StatusCode: -1"))>-1&&-1}}}return!1}({username:e.username,password:e.password,url:e.url},t,i);if(l||401===t.httpStatusCode){if(-1===l){const r=Object.assign(Object.assign({},e),{isSecured:null,checkUrlError:!0,storeAuth:!1});return{result:await tt(r,{useProxy:t.useProxy})}}{const r=Object.assign(Object.assign({},e),{isSecured:{httpStatusCode:401,isFederatedWithWebTierAuth:l}});return{result:await tt(r,{useProxy:t.useProxy})}}}return e.isSecured=Object.assign(Object.assign({},t),{isFederatedWithWebTierAuth:l}),!1!==r&&(e.allowStoredAuth=!0),t.isOverride&&("GeoenrichmentServer"!==d||e.storeAuth?e.storeAuth=!0:e.createAsServiceProxy=!0),i&&!a?{result:await tt(e,{useProxy:t.useProxy})}:{result:e}}return{result:await tt(e,{useProxy:t.useProxy})}}catch(t){if((0,p.b)(t)){const e=t.code;if("flowAborted"===e||"unauthorized"===e||"invalidSpatialRef"===e)return{error:t}}try{const r=Object.assign(Object.assign({},e),{isSecured:e.isSecured||null,checkUrlError:t,storeAuth:!1});return{result:await tt(r)}}catch(e){return(0,p.b)(e)?{error:e}:{error:{code:"unhandledError",message:JSON.stringify(e)}}}}}let et=3;async function tt(e,t,r=0){var i,o,d,m,f,g,w,h,b,S,x,O,I,T,L,P,k,j;const{url:M=e.url,useProxy:C=!1}=null!=t?t:{},[U]=await(0,n.l)([3===s.c.api?"esri/IdentityManager":"esri/identity/IdentityManager"]),{username:F,password:$,checkAuth:R,agsType:E}=e,{tags:N=[]}=y.i||{},A=[499,498],D=(0,u.f)(M);if(!e.isSecured||401!==(null===(i=e.isSecured)||void 0===i?void 0:i.httpStatusCode)&&R||(null===(o=e.checkUrlError)||void 0===o?void 0:o.message)&&e.isSecured&&(0,c.i)(e.type))try{const t=await ot({username:F,password:$},D,{isSecure:e.isSecured,isVideoService:"Video Service"===e.type,checkAuth:R,useProxy:C});"Image Service"===e.type&&t.tileInfo&&("LERC"===t.tileInfo.format||"elevation"===(null===(d=t.cacheType)||void 0===d?void 0:d.toLowerCase())?e.agsType="ElevationServer":"raster"===(null===(m=t.cacheType)||void 0===m?void 0:m.toLowerCase())&&(e.agsType="TiledImageServer",nt(M,t)&&"TiledImageServer"!==l.a.hybridImageServiceSetting&&(e.agsType="ImageServer")));const r=t.credential||U.findCredential(M),i=t.documentInfo,a=((null==i?void 0:i.Keywords)||"").split(","),s=null!==(f=null==i?void 0:i.Title)&&void 0!==f?f:t.name;return e.tags=(0,v.b)([...a,...N]).filter((e=>e)),(null==s?void 0:s.length)>0&&(e.title=s),e.description=null!==(w=null!==(g=null==i?void 0:i.Comments)&&void 0!==g?g:t.description)&&void 0!==w?w:"",e.snippet=null!==(b=null!==(h=null==i?void 0:i.Subject)&&void 0!==h?h:t.serviceDescription)&&void 0!==b?b:"",e=Object.assign(Object.assign({},e),{thumbnailToken:(null==r?void 0:r.token)||null,extent:e.extent||t.fullExtent||t.extent,serviceInfo:Object.assign(Object.assign({},t),{isSecure:!!R,userInfo:{username:F,password:$}})}),Object.assign({},e)}catch(i){if((null===(S=null==i?void 0:i.message)||void 0===S?void 0:S.toLowerCase().includes("aborted"))||"Error: json"===(null==i?void 0:i.message))throw{code:"flowAborted",message:JSON.stringify(i.message.message)};if(A.includes(null!==(x=null==i?void 0:i.code)&&void 0!==x?x:null===(O=null==i?void 0:i.details)||void 0===O?void 0:O.httpStatus))return!1!==e.allowStoredAuth&&(e.allowStoredAuth=!e.checkUrlError),Object.assign(Object.assign({},e),{isSecured:{secured:!0},serviceInfo:{isSecure:!0},allowStoredAuth:!1!==e.allowStoredAuth&&l.a.allowStoredAuth});if(403===(null==i?void 0:i.code))throw e.serviceInfo={isSecure:!0},e.isSecured={secured:!0},{code:"forbiddenCredential",message:JSON.stringify(i)};if(i&&(null===(I=e.checkUrlError)||void 0===I?void 0:I.message)){if(null===(P=null===(L=null===(T=e.checkUrlError)||void 0===T?void 0:T.message)||void 0===L?void 0:L.includes)||void 0===P?void 0:P.call(L,"was not found"))throw{code:"serviceNotExist",message:JSON.stringify(e.checkUrlError.message)};throw{code:"unhandledError",message:JSON.stringify(e.checkUrlError.message)}}if(E&&"FeatureServer"!==E||"string"==typeof i&&i.includes("not found"))throw{code:"serviceNotExist",message:JSON.stringify(i)};if((0,p.a)(i)&&"The input spatial reference must be either a geographic or projected coordinate system"===i.details[0])throw{code:"invalidSpatialRef",message:JSON.stringify(i)};if(r<et)return await(0,v.t)(1e3*r),tt(e,t,r+1)}else if((null===(k=e.isSecured)||void 0===k?void 0:k.isFederatedWithWebTierAuth)||401===(null===(j=e.isSecured)||void 0===j?void 0:j.httpStatusCode))try{const{title:t}=e,r=await(0,a.r)(e.url,{},{addTokenManually:!1}),i=(r.documentInfo.Keywords||"").split(","),s=[...(0,v.b)([...i,...N])];return e=Object.assign(Object.assign({},e),{extent:r.fullExtent||r.extent,serviceInfo:r}),Object.assign(Object.assign({},e),{title:t,tags:s})}catch(e){if(401===e.status)throw{code:"unauthorized"};throw{code:"serviceNotExist",message:JSON.stringify(e)}}}async function rt(e){const{serviceInfo:t,username:r,password:i,isSecured:n,storeAuth:o,type:l}=e,{user:c,portal:p,config:v}=s.c,y=l,m={username:r,password:i},{thumbnailURL:f}=(0,d.g)(y),g=Object.assign(Object.assign({},e),{thumbnailURL:f||e.thumbnailURL});if((null==t?void 0:t.isSecure)&&!t.userInfo||(null==n?void 0:n.isOverride)&&!m||401!==(null==n?void 0:n.httpStatusCode)&&!m||o&&!m)throw new Error("invalidCredentials");if(n&&o){if(!(!p.isPortal||p.isPortal&&(0,u.c)()))throw new Error;if(g.serviceUsername=r,g.servicePassword=i,401===n.httpStatusCode){const e=await Ee(g,null==v?void 0:v.restBaseUrl).then((({id:e})=>(0,a.r)(`${c.userContentUrl}/items/${e}`,{},{},"post")));return it(Object.assign(Object.assign({},g),{id:e.item.id,url:e.item.url,sourceUrl:e.item.sourceUrl}),!0)}if((null==t?void 0:t.isSecure)&&!(null==t?void 0:t.userInfo))throw new Error("invalidCredentials")}return it(g)}async function it(e,t=!1){var r,i,n,o,c;const{url:u,serviceInfo:p,type:v,storeAuth:y,hybridImageServiceSetting:f,id:g}=e;let w;if(!p&&!y)throw new Error("serviceNotExist");if(y&&!p){et=15;const t=await tt(e);return et=3,Object.assign(Object.assign({},t),{success:!0,id:g,folder:null===(r=e.folder)||void 0===r?void 0:r.title})}const h=Object.assign(Object.assign({},e),{description:(null==p?void 0:p.description)||(null===(i=null==p?void 0:p.documentInfo)||void 0===i?void 0:i.Comments)||"",accessInformation:(null==p?void 0:p.copyrightText)||(null===(n=null==p?void 0:p.documentInfo)||void 0===n?void 0:n.Credits)||"",spatialReference:E(e.serviceInfo,e.agsType)});if("map service"===(null==v?void 0:v.toLowerCase())&&h.typeKeywords.push((null==p?void 0:p.singleFusedMapCache)?"Tiled":"Dynamic"),("Image Service"===v&&"TiledImageServer"===f||function(e,t){var r,i;return(null===(r=e.toLowerCase())||void 0===r?void 0:r.includes("/imageserver"))&&(null===(i=null==t?void 0:t.capabilities)||void 0===i?void 0:i.toLowerCase().includes("tilesonly"))}(u,p))&&(h.typeKeywords=m.a.TiledImageServer.typeKeywords),"Table"===(null==p?void 0:p.type)&&(h.typeKeywords=[...h.typeKeywords,"Table","Singlelayer"]),v in{StreamServer:1,ImageServer:1,WorkspaceServer:1}?h.typeKeywords.push("Singlelayer"):((null==p?void 0:p.layers)||(null==p?void 0:p.tables))&&(p.layers&&(null===(o=null==p?void 0:p.layers)||void 0===o?void 0:o.length)||!(null==p?void 0:p.tables.length)?(w=[...p.layers||[],...p.tables||[]],h.typeKeywords.push(w.length>1?"Multilayer":"Singlelayer")):(-1===h.typeKeywords.findIndex((e=>"Table"===e))&&h.typeKeywords.push("Table"),h.typeKeywords.push(p.tables.length>1?"Multilayer":"Singlelayer"))),"sceneserver"===(null==v?void 0:v.toLowerCase())){const{layers:e}=p,t=(null===(c=null==e?void 0:e[0])||void 0===c?void 0:c.layerType)||(null==p?void 0:p.layerType);t&&h.typeKeywords.push(t)}try{const{extent:e}=await async function(e){const{extent:t}=e;return e.extent=_(await N(t)),e}(Object.assign({},h)),r=h,i=(0,d.g)(r.type);if(r.type=i.type,r.typeKeywords=[...r.typeKeywords||[],...i.typeKeywords||[]],!y){const t=_(r.extent).split(","),i=[[parseFloat(t[0]),parseFloat(t[1])],[parseFloat(t[2]),parseFloat(t[3])]];r.extent=i;const a=await Qe(r);r.thumbnailURL=a,r.thumbnailURL&&r.thumbnailToken&&(r.thumbnailURL+=`${r.thumbnailURL.indexOf("?")>-1?"&":"?"}${r.thumbnailToken}`),r.extent=_("Feature Service"===r.type||"Image Service"===r.type?e:r.extent)}return y?async function(e){const{user:t}=s.c,{exportTilesAllowed:r}=l.a,i=await Ve(e),n=`${t.userContentUrl}/items/${i.id}`,{item:o}=await(0,a.r)(n,{},{},"post"),c=r?e.url:o.url,u=await tt(Object.assign(Object.assign({},e),{type:l.a.type}),c),{typeKeywords:d,thumbnailToken:p,spatialReference:v,extent:y,description:m}=u;e.id=i.id,e.typeKeywords=d,e.thumbnailToken=p,e.spatialReference=v,e.extent=y,e.description=m;try{const t=_(u.extent).split(","),r=[[parseFloat(t[0]),parseFloat(t[1])],[parseFloat(t[2]),parseFloat(t[3])]];e.extent=r;const i=await Qe(e);o.thumbnailURL=i,o.thumbnailURL&&o.thumbnailToken&&(o.thumbnailURL+=`${o.thumbnailURL.indexOf("?")>-1?"&":"?"}${o.thumbnailToken}`)}catch(e){console.error(e)}return await(0,x.u)(i.id,{thumbnailURL:o.thumbnailURL}),i}(r):t?(0,x.u)(r.id,Object.assign(Object.assign({},r),{url:r.sourceUrl})):Ve(r)}catch(t){if(y)throw t;return Ve(e)}}const at=["geocode.arcgis.com","geocodedev.arcgis.com","geocodeqa.arcgis.com","route.arcgis.com","routedev.arcgis.com","routeqa.arcgis.com","geoenrich.arcgis.com","geoenrichqa.arcgis.com","geoenrichddev.arcgis.com"];async function st(e,t,r,i,s=!1){const n=t.split("?")[0],o=`${r}portals/checkurl`,c=at.some((e=>-1!==t.indexOf(e)));if(c)return{secured:!0,isOverride:!0};{const u=!c&&t.indexOf("/VectorTileServer")>-1,d=`${o}?url=${encodeURIComponent(`${I(`${n}?f=json`)}`)}`;try{s&&await(0,a.r)(n,{},{disableIdentityLookup:!0,addTokenManually:!1});const o=await(0,a.r)(d,{},{addTokenManually:!1}),{httpStatusCode:c}=o;if(o.secured)403===c?o.secured=!1:401===c&&(o.allowStoredAuth=!1);else if(u){const a=await ot({username:e.username,password:e.password},t,{isVideoService:!1,checkAuth:i});if(l.a.exportTilesAllowed=null==a?void 0:a.exportTilesAllowed,null==a?void 0:a.exportTilesAllowed)return st(e,`${t}/exportTiles`,r,i)}return Object.assign(Object.assign({},o),{isOverride:!1})}catch(a){const{message:n,code:o}=a;return"Error checking resource"===n?s?{secured:!1,url:t,httpResponse:"",httpStatusCode:o,httpStatusMessage:n,isOverride:!1,allowStoredAuth:!1}:st(e,t,r,i,!0):"Service Proxy URL"===n?{secured:!0,url:t,httpResponse:"",httpStatusCode:o,httpStatusMessage:n,isOverride:!1,allowStoredAuth:!1,useProxy:!0}:{allowStoredAuth:!1,url:t,httpResponse:"",httpStatusCode:o,httpStatusMessage:n,isOverride:!1}}}}function nt(e,t){var r;return e.toLowerCase().indexOf("/imageserver")>-1&&"Raster"===(null==t?void 0:t.cacheType)&&-1===(null===(r=null==t?void 0:t.capabilities)||void 0===r?void 0:r.toLowerCase().indexOf("tilesonly"))}async function ot(e,t,r){var i;const a=s.c.config,[o]=await(0,n.l)([3===s.c.api?"esri/IdentityManager":"esri/identity/IdentityManager"]),{forceAddToken:l,isSecure:c,checkAuth:d}=r,{username:p,password:v}=e,y="auto",m=(0,u.i)(t),f=t.indexOf(".esri.com/server/rest/services")>-1;const g=m||f,w=at.some((e=>-1!==t.indexOf(e))),h={useProxy:null!==(i=null==r?void 0:r.useProxy)&&void 0!==i&&i,timeout:!1===a.isMultiTenant?6e4:5e3,addSSL:g,addTokenManually:c&&g&&!!a.isMultiTenant||l||!1,disableIdentityLookup:null};if(d){if(t=t.split("?")[0],w)return await ct(t,{username:p,password:v}),pt(t,h,y);{let e;(null==c?void 0:c.secured)&&p&&v&&(h.customToken=await lt(t,{username:p,password:v}));try{e=await pt(t,h,y)}catch(r){if("sign in required"!==(null==r?void 0:r.message)||!h.addTokenManually||h.disableIdentityLookup)throw r;h.addTokenManually=!1,e=await pt(t,h,y)}return e.credential=o.findCredential(t),e.credential&&o.registerToken({server:t,token:e.credential.token,userId:e.credential.userId,expires:e.credential.expires,ssl:e.credential.ssl}),e}}return h.disableIdentityLookup=!0,await pt(t,h,y)}const lt=async(e,{username:t,password:r})=>{const{token:i}=await(0,a.f)((()=>ct(e,{username:t,password:r})),"securedAGSToken",`${e}---${t}`,{getExpireAfterFromResult:e=>e.expireAfter});return i};async function ct(e,t){const r=3===s.c.api,[i,a]=r?await(0,n.l)(["esri/IdentityManager","esri/Credential"]):await(0,n.l)(["esri/identity/IdentityManager","esri/identity/Credential"]);if(t.username&&t.password){const r=await async function(e){const t=3===s.c.api,[r,i]=t?await(0,n.l)(["esri/IdentityManager","esri/ServerInfo"]):await(0,n.l)(["esri/identity/IdentityManager","esri/identity/ServerInfo"]);let a=await r.findServerInfo(e);if(!a){a=new i,a.server=await r._getOrigin(e);const{authInfo:s,tokenServiceUrl:n,currentVersion:o}=await(t?dt:ut)(e,r);a.tokenServiceUrl=(null==s?void 0:s.tokenServicesUrl)||(null==s?void 0:s.tokenServiceUrl)||n,a.currentVersion=o,a.hasServer=!0,r.registerServers([a])}return a}(e);if(i._checkProtocol(e,r,(e=>console.error(e))))try{const s=await i.generateToken(r,t),n=s.expires?Number(s.expires):null,o=!!s.ssl,l=new a({userId:t.username,server:r.server,token:s.token,expires:n,ssl:o,validity:r.shortLivedTokenValidity,resources:[e],scope:"server"});return-1===i.credentials.indexOf(l)&&i.credentials.push(l),{token:l.token,expireAfter:n}}catch(e){throw e.code=403,e}return null}}const ut=async(e,t)=>{const r=await t._getTokenSvcUrl(e);return await r.promise},dt=async(e,t)=>t._getTokenSvcUrl(e);async function pt(e,t,r="post"){try{return await(0,a.r)(I(e),{},Object.assign({},t),r)}catch(e){throw e}}async function vt(e){var t,r;let i={};if((0,c.i)(e.type))i=await Ze(e);else switch(e.type){case"OGCFeatureServer":i=await async function(e){var t,r,i,s;const{url:n}=e,o={addTokenManually:!1,headers:{accept:"application/json"}};try{const l=async(e,t)=>{var r,i,a;try{return await e()}catch(e){const s=null!==(a=null===(i=null===(r=null==e?void 0:e.message)||void 0===r?void 0:r.toLowerCase)||void 0===i?void 0:i.call(r))&&void 0!==a?a:"";if(s.includes("unexpected token")||s.includes("expected expression"))return t();throw{result:null,error:{code:"unhandledError",message:JSON.stringify(e)}}}},c=await l((()=>(0,a.r)(n,{},o,"auto",{excludeJson:!0})),(()=>(0,a.r)(n,{},o))),u=await l((()=>$e(c)),(()=>$e(c,{},!1)));return{result:Object.assign(Object.assign({},e),{extent:_(null===(s=null===(i=null===(r=null===(t=u.collections)||void 0===t?void 0:t[0])||void 0===r?void 0:r.extent)||void 0===i?void 0:i.spatial)||void 0===s?void 0:s.bbox),type:"OGCFeatureServer",serviceInfo:u,layers:u.collections}),error:null}}catch(e){return console.error("get OGC feature layer:",e),{result:null,error:{code:"unhandledError",message:JSON.stringify(e)}}}}(e);break;case"WCS":i=await Pe(e);break;case"WMS":const{result:s,error:n}=await we(e);if(n)i.error=n;else{const e=await he(s.serviceInfo);i.result=Object.assign(Object.assign({},s),e)}break;case"WFS":i=await ke(e),i.result&&(i.result.layers=i.result.serviceInfo.layers,i.result.title=null!==(t=i.result.serviceInfo.title)&&void 0!==t?t:"",i.result.isComplex="esriGeometryComplex"===i.result.serviceInfo.isComplex);break;case"WMTS":i=await Ce(e),i.result&&(i.result.layers=i.result.serviceInfo.layers,i.result.title=null!==(r=i.result.serviceInfo.title)&&void 0!==r?r:"");break;default:i={result:Object.assign({},e)}}return i}async function yt(e,t){var r,i;const{config:s,user:n,asyncAddToDefinition:o=!0,preserveLayerIds:l}=t,c="CUSTOMDATA"===e.provider,u=Object.assign({},e);void 0!==l&&(u.preserveLayerIds=l);const d={layers:null!==(r=u.layers)&&void 0!==r?r:[],tables:null!==(i=u.tables)&&void 0!==i?i:[]},p=JSON.stringify(d);delete u.layers,delete u.tables,delete u.initialExtent,delete u.fullExtent,delete u._ssl;const v=c?{service:JSON.stringify(u)}:{createParameters:JSON.stringify(u),targetType:"featureService"},y=c?`${t.hostingServer[0].url}/admin/services/createService`:`${s.restBaseUrl}content/users/${n.username}/createService`,m=await(0,a.r)(y,v,{},"post");if(c){const e=`${t.hostingServer[0].url}/admin/services/${u.serviceName}.FeatureServer`;try{return{createServiceResponse:{itemId:(await(0,a.r)(e,"post")).portalProperties.portalItems[0].itemID,encodedServiceURL:"",isView:!1,name:"",serviceItemId:"",serviceurl:"",size:0,success:!0,type:"",typeKeywords:[]},addToDefinitionResponse:null}}catch(e){throw console.error(e),e}}try{return await mt(p,m.encodedServiceURL,o),{createServiceResponse:m,addToDefinitionResponse:d}}catch(e){throw await(0,x.d)(m.itemId,{permanentDelete:!0},n),console.error(e),e}}async function mt(e,t,r=!0){if(e){const i=`${t.replace("rest/services","rest/admin/services")}/addToDefinition`;try{const t=await(0,a.r)(i,{addToDefinition:e,async:r},{},"post");return r?await(0,a.p)(t.statusURL||t.statusUrl):t}catch(i){throw r&&await mt(e,t,!1),i}}return null}function ft(e,t){const r=`${(0,o.g)(t)}content/items/${e.id}/data`;return(0,a.r)(r)}async function gt(e){var t,r;const s=null===(t=(await(0,i.q)({q:'title: "Esri Layer Templates" AND owner: "esri_en"',num:1})).results)||void 0===t?void 0:t[0];if(!s)return null;const n=null===(r=(await(0,a.r)(`${(0,o.g)(e)}/search`,{q:`title:"Points" group:"${s.id}" AND type:"Layer Template" -type:"Attachment"`,num:1})).results)||void 0===r?void 0:r[0];return n?ft(n,e):null}},46227:(e,t,r)=>{r.d(t,{g:()=>i});const i=()=>[2,1,1,1,3].map((e=>{let t="";for(let r=0;r<e;r++)t+=(65536*(1+Math.random())|0).toString(16).substring(1);return t})).join("-")},63054:(e,t,r)=>{r.d(t,{a:()=>p,b:()=>S,c:()=>g,d:()=>y,e:()=>b,f:()=>w,g:()=>v,h:()=>h,i:()=>f,j:()=>u,r:()=>c,s:()=>m,u:()=>d});var i=r(87744),a=r(59317),s=r(931),n=r(5042),o=r(76246),l=r(15912);function c(e){return"/"===(null==e?void 0:e.slice(-1))?e.slice(0,e.length-1):e}function u(e){return e.startsWith("/")||e.startsWith("\\")?e.slice(1):e}async function d(e){var t;const r=null!==(t=null===a.c||void 0===a.c?void 0:a.c.api)&&void 0!==t?t:4,[i]=4===r?await(0,s.l)(["esri/core/urlUtils"]):await(0,s.l)(["esri/urlUtils"]);let n=i.urlToObject(e);n.query=n.query||{};for(let e in n.query||{})n.query.hasOwnProperty(e)&&(Array.isArray(n.query[e])||(n.query[e]=n.query[e].replace(/(&lt;|&gt;|<|>|%3C|%3E)/g,"")));return n}function p(e){return(null==e?void 0:e.replace(/^.*\//,"").replace(/.[^.]*$/,""))||""}function v(e){const t=(null==e?void 0:e.replace(/^.*\//,"").replace(/\?+.*/,""))||"",r=t.replace(/^.*\./,"").toLowerCase();return l.A.includes(r)?t:""}function y(e){return["WFS","GeoJson","CSV","GeoRSS","KML","OGCFeatureServer","WMS","WMTS","WCS"].includes(e)}function m(e){const{config:t,portal:r}=a.c;let i=!1;if(!e)return!1;if((t.httpsDomains||[]).forEach((t=>{(e.indexOf(`.${t}/`)>-1||e.indexOf(`/${t}/`)>-1)&&(i=!0)})),!i){let t=r.portalHostname;t.indexOf("/")>-1&&(t=t.substring(0,t.indexOf("/"))),e.indexOf(t)>-1&&(i=!0)}return i}function f(e){if(!e)return!1;const{config:t,portal:r}=a.c,s=(0,i.g)(r),n=new URL(s).hostname,o=!1===t.isMultiTenant,l=-1!==e.indexOf(".arcgis.com/"),c=-1!==e.indexOf("//services")||-1!==e.indexOf("//tiles")||-1!==e.indexOf("//features")||-1!==e.indexOf("//locationservices"),u=r.supportsHostedServices&&-1!==e.indexOf(n)&&!o;return l&&c||!l&&u}function g(){var e;if(-1===window.location.protocol.toLowerCase().indexOf("https")){const t=(0,n.g)("esri_auth",!0);return"web"!==(null===(e=null==t?void 0:t.auth_tier)||void 0===e?void 0:e.toLowerCase())}return!0}function w(e){let t=e.toLowerCase();-1==t.indexOf("http://")&&-1==t.indexOf("https://")&&(t=(e="https://"+e).toLowerCase());let r=t.indexOf("//");r=t.indexOf("/",r+2),-1==r?t=(e+="/arcgis/rest/services").toLowerCase():r==t.length-1&&(t=(e+="arcgis/rest/services").toLowerCase());let i=t.indexOf("/arcgis",r);i==t.length-7?t=(e+="/rest/services").toLowerCase():i==t.length-8&&(t=(e+="rest/services").toLowerCase()),i=t.indexOf("/server",r),t.endsWith("/server")?t=(e+="/rest/services").toLowerCase():t.endsWith("/server/")&&(t=(e+="rest/services").toLowerCase());const a=t.indexOf("/rest/services",r),s=t.indexOf("/services",r),n=t.indexOf("/rest",r);return-1==a&&s>-1?t=(e=`${e.substring(0,s)}/rest/services${e.substring(s+9)}`).toLowerCase():-1==a&&n>-1&&(t=(e=`${e.substring(0,n)}/rest/services${e.substring(n+5)}`).toLowerCase()),t.indexOf("/rest/services"),e}const h=(e,t=!1)=>(e=c(e=e.trim()),/(http|https|ftp):\/\/?/.exec(e)||(e=`https://${e}`),!t&&"https:"!==location.protocol||!f(e)&&!m(e)||(e=e.replace("http:/","https:/")),e=e.indexOf("/dynamicLayer?")>-1?e.substring(0,e.indexOf("/dynamicLayer?")):e),b=(e,t=!1)=>{var r,a,s;if(!e)return{error:{code:"invalidUrl"}};if(S(e,t))return{error:{code:"httpWarning"}};const n=decodeURIComponent(e),l=n.replace(i.v,"").match(/((\.|\/)*(kml|kmz))/gi),c=n.replace(i.v,"").match(/((\/|\=)(wmts|wms|wfs|wcs))/gi),u=n.replace(i.v,"").match(/((\/|\=)(OGC|OGCFeatureServer))/gi),d=n.replace(i.v,"").match(/((\.|\/)*(rss))/gi),p=null===(r=n.replace(i.v,"").match(i.r))||void 0===r?void 0:r[1],v=n.replace(i.v,"").match(i.e),y=n.replace(i.v,"").match(/((\.|\/)*(csv))/gi),m=n.replace(i.v,"").match(/(\.|\/)((\$?{(z|level)})\/*(\$?{(x|col)})\/*(\$?{(y|row)}))/gi);let f=null;if(n.match(i.f))f="GeoJson";else if(!u||c||p)if(p&&!c)f=o.a[p];else if(v)f="Map Service";else if(c){const e="/"===(null==c?void 0:c[0].charAt(0))?"/":"=";f=null===(s=null===(a=null==c?void 0:c[0])||void 0===a?void 0:a.split(e)[1])||void 0===s?void 0:s.toUpperCase()}else l?f="KML":d?f="GeoRSS":y?f="CSV":m?f="Tile Layer":n.endsWith("KnowledgeGraphServer")&&(f="Knowledge Graph");else f="OGCFeatureServer";return{result:f}},S=(e,t)=>!t&&e.includes("http://")},75294:(e,t,r)=>{r.d(t,{w:()=>i});const i=(0,r(37762).c)({portal:null,user:null,i18n:null,scale:"m",api:4,nextText:null,uploadProgress:0}).state},76246:(e,t,r)=>{r.d(t,{a:()=>i,i:()=>a});const i={FeatureServer:"Feature Service",GeocodeServer:"Geocoding Service",GeoDataServer:"Geodata Service",GeometryServer:"Geometry Service",GeoenrichmentServer:"Geoenrichment Service",GPServer:"Geoprocessing Service",GlobeServer:"Globe Service",ImageServer:"Image Service",MapServer:"Map Service",NAServer:"Network Analysis Service",ElevationServer:"Image Service",VectorTileServer:"Vector Tile Service",SceneServer:"Scene Service",StreamServer:"Stream Service",WMServer:"Workflow Manager Service",TiledImageServer:"Image Service",VideoServer:"Video Service",KnowledgeGraphServer:"Knowledge Graph Layer"},a=e=>!!Object.values(i).includes(e)},80379:(e,t,r)=>{r.d(t,{a:()=>s,b:()=>a,i:()=>n});const i=["appExtensionError","forbiddenCredential","disabledSubscription","unauthorized","timeout","itemExists","exceedsFileSize","fileExists","emptyFile","unavailableGeocoder","dataNotAvailable","invalidShapefile","invalidFileGeodatabase","providePath","useSameFileName","invalidExtension","tokenRequired","invalidToken","invalid3DObjectFeatureClass","invalidClassification","serviceNameInvalid","titleInvalid","titleStartsWithNumber","titleRequired","titleInUseService","itemInRecycleBin","summaryInvalid","descriptionInvalid","missingUserOrPortal","dataStoreTitleInvalid","serviceNameExists","folderNameExists","serviceNotExist","unsupportedWFSVersion","invalidWMTS","invalidSpatialRef","emptyFeatureLayer","invalidFeatureLayerUrl","invalidUrl","httpWarning","flowAborted","duplicateFieldNames","failToFetchText","mapServiceError","noTilingSchemeFound","noMatchSpatialRef","invalidDataStorePublishType","noRegisteredServersForDataStore","noContentInDataStore","failToPublishFromDataStore","failToListDataStoreContents","invalidUsernameOrPassword","invalidConnection","invalidCredentials","invalidBigQueryProjectId","invalidSnowflakeServer","invalidSnowflakeRole","invalidSnowflakeWarehouse","invalidSnowflakeSchema","invalidSnowflakeDatabase","invalidAWSBucket","invalidAzureContainer","invalidJSON","invalidKeyFile","unauthorizedCredentials","unknownAGSType","unhandledError","incompatibleGeometries","multiPatchRestriction","invalidUniqueIdentifier","cannotAddNullData","exceededMaxFieldLength","invalidFieldType","failToCreate3DLayer"],a=e=>i.includes(null==e?void 0:e.code),s=e=>e&&e.hasOwnProperty("code")&&e.hasOwnProperty("message")&&e.hasOwnProperty("details")&&(!e.details||Array.isArray(e.details)),n=e=>{const t=e.toLocaleLowerCase();return t.includes("unexpected end of")||t.includes("did not match the expected pattern")}}}]);
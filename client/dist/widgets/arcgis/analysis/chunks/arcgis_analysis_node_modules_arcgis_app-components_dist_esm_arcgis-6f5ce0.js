/*! For license information please see arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-6f5ce0.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-6f5ce0"],{6750:(e,i,t)=>{function a(e){var i,t;const{dataLayer:a,type:l,sourceDataLayer:n}=e,o=null!==(i=null==a?void 0:a.geometryType)&&void 0!==i?i:null===(t=null==a?void 0:a.layerInfo)||void 0===t?void 0:t.geometryType,r="table"===(null==n?void 0:n.type.toLowerCase()),s=null==a?void 0:a.type;if("Microsoft Excel"===l||"CSV"===l){if(("address"===a.locationType&&a.addressFields||"coordinates"===a.locationType)&&"esriGeometryPoint"===(null==n?void 0:n.geometryType))return null;if(!o||"none"===a.locationType||r)return{title:"noGeometryMatchTitle",description:"noGeometryTableMessage"};if((null==n?void 0:n.geometryType)!==o)return{title:"noGeometryMatchTitle",description:"noGeometryMatchMessage"}}else{if((null==n?void 0:n.geometryType)!==(null==a?void 0:a.geometryType))return{title:"noGeometryMatchTitle",description:"noGeometryMatchMessage"};if(r&&"table"===s.toLowerCase())return{title:"noGeometryMatchTitle",description:"noGeometryTableMessage"};if(r)return{title:"noGeometryMatchTitle",description:"noGeometryMatchMessage"}}}function l(e,i,t){return"Microsoft Excel"===t||"CSV"===t?"Table"===(null==i?void 0:i.type)||("esriGeometryPoint"===(null==i?void 0:i.geometryType)&&"none"===(null==e?void 0:e.locationType)||"esriGeometryPoint"===(null==i?void 0:i.geometryType)&&(!!e.addressFields||"none"!==e.locationType)):"Table"===(null==i?void 0:i.type)||(null==e?void 0:e.geometryType)===(null==i?void 0:i.geometryType)}t.d(i,{c:()=>l,v:()=>a})},14188:(e,i,t)=>{t.r(i),t.d(i,{arcgis_new_item_pages_append_upload:()=>T});var a=t(87849),l=t(59317),n=t(24869),o=t(72257),r=t(32710),s=t(86075),d=t(3826),c=t(43555),p=t(90470),u=t(95878),y=t(44069),h=t(15912),v=t(45768),m=t(6750),g=t(50020),f=t(52763);t(37762),t(86562),t(15332),t(83929),t(50637),t(931),t(93814),t(87744),t(76246),t(63054),t(75294),t(38295),t(51102),t(56175),t(50822),t(8214),t(66111),t(60743),t(11163),t(26854),t(31544);async function b(){try{await(0,c.d)(d.a.id,{permanentDelete:!0}),d.a.id=null}catch(e){console.warn("Delete item failed",e)}}const T=class{constructor(e){(0,a.r)(this,e),this.fileSelect=(0,a.c)(this,"fileSelect",7),this.newItemUpdatePage=(0,a.c)(this,"newItemUpdatePage",7),this.newItemToggleNavigationEnabled=(0,a.c)(this,"newItemToggleNavigationEnabled",7),this.newItemPrevPage=(0,a.c)(this,"newItemPrevPage",7),this.workflowComplete=(0,a.c)(this,"workflowComplete",7),this.sourceName="",this.itemTypes=[{value:"File Geodatabase",icon:"data",publishable:!0},{value:"Shapefile",icon:"file-zip",publishable:!0}],this.insideModal=!0,this.fullHeight=!0,this.selectedZipFile="File Geodatabase",this.step="upload",this.loading=void 0,this.loaderMessage=void 0,this.loaderType="indeterminate",this.error=void 0,this.overwriteProcess=!1,this.file=void 0,this.header=void 0,this.description=void 0}async handlePrev(e){if(e.preventDefault(),!this.loading){if("analyzeZip"===this.step)return d.a.file=null,void(this.step="upload");d.a.appendOptions.layers.length>1&&(d.a.sourceDataLayer=null),this.newItemPrevPage.emit()}}async handleNext(){var e;if(this.overwriteProcess&&"overwrite"===d.a.addAppendSelectOption){const{addAppendSelectOption:i}=d.a,t=Object.assign({id:null===(e=this.publishResponse)||void 0===e?void 0:e.id,appendType:i,item:Object.assign({},d.a),overwriteStatus:this.overwriteStatus},this.publishResponse);this.workflowComplete.emit(t)}else if(d.a.file){if("zip"===d.a.extension)if(this.step="analyzeZip",d.a.type=h.a[this.selectedZipFile].type,"overwrite"===d.a.addAppendSelectOption)d.a.id=this.item.id,await this.handleOverwrite();else{await this.uploadAndAnalyzeFile()&&this.nextStep()}}else this.handleError({code:"providePath"})}async fileSelectHandler(e){var i;const t=e.detail.file;d.a.originalFileName=t.name;const{title:a,fileName:l,extension:o}=(0,n.s)(t,!0);if("overwrite"===d.a.addAppendSelectOption&&!(0,n.v)(d.a.originalFileName,this.sourceName))return void this.handleError({code:"useSameFileName"});if(d.a.initialTitle=a,d.a.file=t,d.a.fileName=l,d.a.newItemMode="file",d.a.extension=o,d.a.type="zip"===d.a.extension&&this.isEnterprise?"Shapefile":(0,v.f)(o,this.validTypes)[0].type,d.a.addAsUniqueFile=!0,"esriGeometryMultiPatch"===(null===(i=d.a.sourceDataLayer)||void 0===i?void 0:i.geometryType)&&"File Geodatabase"!==d.a.type&&"Shapefile"!==d.a.type&&"update"!==d.a.addAppendSelectOption)return this.step="upload",void this.handleError({code:"multiPatchRestriction"});const s=(null==t?void 0:t.size)>r.M&&"zip"===d.a.extension,c="overwrite"!==d.a.addAppendSelectOption&&!this.isEnterprise,p="overwrite"===d.a.addAppendSelectOption&&(null==t?void 0:t.size)>r.M;if("overwrite"!==d.a.addAppendSelectOption||s)if("zip"===d.a.extension&&(c||p))this.step="analyzeZip";else{this.step="analyze";await this.uploadAndAnalyzeFile()&&this.nextStep()}else await this.handleOverwrite()}async componentWillLoad(){var e,i;const{existingItem:t,addAppendSelectOption:a}=d.a,{config:n,portal:o}=l.c;this.item=t,this.sourceName=(null===(e=d.a.appendOptions.sourceData)||void 0===e?void 0:e.name)||this.item.name,this.i18n=u.u.i18n.appendUpload,this.config=n,this.isEnterprise=o.isPortal;const r=null===(i=d.a.appendOptions.sourceData)||void 0===i?void 0:i.type;this.allowedExtensions="overwrite"===a?(0,v.m)(["geojson"===r.toLowerCase()?"GeoJson":r]):o.isPortal?y.c:y.d,this.header=this.i18n.selectData,this.description="",this.validTypes=Object.values(h.a).filter((e=>e.appendUploadFormat)),"overwrite"===a&&this.validTypes.push(h.a["Service Definition"]),d.a.id&&await b(),d.a.file=null}async handleOverwrite(){var e;const{existingItem:i,file:t,keepDescription:a,fileName:n,appendOptions:r}=d.a;u.u.nextText="proceed";const s=i;this.loading=!0,this.overwriteProcess=!0,this.newItemToggleNavigationEnabled.emit(!1),this.loaderMessage=u.u.i18n.append.appendLoadingMessages.overwriting;const c=(0,g.g)(await(0,g.f)(this.item.owner,l.c.portal),l.c.portal),{error:y}=await(0,p.f)(r.sourceData,c,{file:t,overwrite:!0,keepDescription:a,fileName:n,existingItemId:s.id});if(y)return this.handleError(y),this.loading=!1,!1;try{const{result:t,error:a}=await(0,p.p)(i,null!==(e=o.i.title)&&void 0!==e?e:d.a.initialTitle,l.c.portal,l.c.user,d.a.appendOptions);if(a)throw a;this.publishResponse=t,this.updateAndCheckStatus(s)}catch(y){return this.handleError({code:"unhandledError"}),this.loading=!1,!1}}async updateAndCheckStatus(e){var i;const{result:t}=await(0,p.r)(e);this.newItemToggleNavigationEnabled.emit(!0);const a=await(0,r.g)(e.id,{success:null==t?void 0:t.success});this.overwriteStatus=null==a?void 0:a.status;const l=Object.assign({id:null===(i=this.publishResponse)||void 0===i?void 0:i.id,item:Object.assign({},d.a),overwriteStatus:this.overwriteStatus,appendType:d.a.addAppendSelectOption},this.publishResponse);if("completed"===(null==a?void 0:a.status.toLowerCase()))return l.overwriteStatus=null==a?void 0:a.status,void this.workflowComplete.emit(l);"failed"===(null==a?void 0:a.status.toLowerCase())&&(u.u.nextText="next",this.loading=!1,this.handleError({code:"unhandledError"}))}nextStep(){var e,i,t;let a="appendSelectLayer";const{analyzeResults:l}=d.a,n=l.publishParameters;if(1===(null===(e=l.publishParameters.layers)||void 0===e?void 0:e.length)||!l.publishParameters.layers){d.a.dataLayer=null!==(t=null===(i=null==n?void 0:n.layers)||void 0===i?void 0:i[0])&&void 0!==t?t:n;const e=(0,f.a)(d.a.type,d.a.dataLayer,d.a.sourceDataLayer);if("update"!==d.a.addAppendSelectOption){if(!(0,m.c)(d.a.dataLayer,d.a.sourceDataLayer,d.a.type))return void this.handleError({code:"incompatibleGeometries"})}a="Microsoft Excel"!==d.a.type&&"CSV"!==d.a.type||"esriGeometryPoint"!==(null===d.a||void 0===d.a?void 0:d.a.sourceDataLayer.geometryType)||"Table"===(null===d.a||void 0===d.a?void 0:d.a.sourceDataLayer.type)?"add"!==d.a.addAppendSelectOption||(e||d.a.backupLayerFields.some((e=>"esriFieldTypeDate"===e.type)))&&!this.isEnterprise?"appendKeyPairSelect":"appendMatchFields":"csvLocationFields"}this.newItemToggleNavigationEnabled.emit(!0),this.newItemUpdatePage.emit(a)}updateLoader(e,i){this.loaderType=e,this.loaderMessage=i}async uploadAndAnalyzeFile(){const{file:e,originalFileName:i,type:t}=d.a,{portal:a,user:n,config:o,lang:c}=l.c;this.loading=!0,this.newItemToggleNavigationEnabled.emit(!1),this.updateLoader((null==e?void 0:e.size)>r.M?"determinate":"indeterminate",u.u.i18n.append.appendLoadingMessages.uploading.replace("${fileName}",i));let p=null;return({error:p}=await(0,r.F)()),p?(this.handleError(p),!1):(this.updateLoader("indeterminate",this.i18n.analyzing),({error:p}=await(0,s.a)({analyzeArgs:{type:"item",itemid:d.a.id,workflow:"append"},itemArgs:{itemType:t},configArgs:{portal:a,user:n,config:o,lang:c},initialize:!0})),p&&(this.handleError(p),d.a.id&&await b()),!p)}async handleError(e){this.newItemToggleNavigationEnabled.emit(!0);let i=u.u.i18n.error,t=this.i18n.errors.errorWhileUpload;switch(e.code){case"exceedsFileSize":t=this.i18n.errors.errorExceedFileSize;break;case"invalidFileGeodatabase":i=u.u.i18n.itemProperties.invalidGeodatabase.title,t=u.u.i18n.itemProperties.invalidGeodatabase.description;break;case"invalidShapefile":i=u.u.i18n.itemProperties.invalidShapefile.title,t=u.u.i18n.itemProperties.invalidShapefile.description;break;case"useSameFileName":t=this.i18n.errors.sameFileName.replace("${x}",this.sourceName);break;case"providePath":t=this.i18n.errors.providePath;break;case"incompatibleGeometries":i=u.u.i18n.appendSelectLayer.sameGeometryWarningTitle,t=u.u.i18n.appendSelectLayer.sameGeometryWarningDescription;break;case"multiPatchRestriction":i=u.u.i18n.appendSelectLayer.sameGeometryWarningTitle,t=this.i18n.errors.multiPatchErrorDescription;break;case"unhandledError":"overwrite"===d.a.addAppendSelectOption&&(t=this.i18n.errors.errorUpdate)}("incompatibleGeometries"===e.code||"multiPatchRestriction"===e.code&&d.a.id)&&(d.a.file=null,await b()),this.loading=!1,this.error={title:i,description:t}}renderPickZip(){const e=this.itemTypes.map((({value:e,icon:i})=>({optionTitle:this.i18n[e].title,value:e,description:this.i18n[e].description,icon:i})));return(0,a.h)("calcite-label",{class:"zip-select"},(0,a.h)("div",{class:"zip-select-heading"},this.i18n.itemType),(0,a.h)("div",{class:"w-full"},(0,a.h)("div",{class:"w-full"},(0,a.h)("calcite-tile-group",{label:this.i18n.itemType,layout:"vertical",selectionMode:"single-persist"},Object.keys(e).map((i=>{const{icon:t,value:l,optionTitle:n,description:o}=e[i];return(0,a.h)("calcite-tile",{key:l,selected:l===this.selectedZipFile,heading:n,description:o,icon:t,"input-enabled":!0,"data-value":l,onCalciteTileSelect:e=>{this.selectedZipFile=e.target.dataset.value}})}))))))}render(){const{i18n:e,error:i,loaderType:t,loaderMessage:l,step:n,loading:o,config:r,sourceName:s,validTypes:c,allowedExtensions:p,isEnterprise:u}=this,y="overwrite"===d.a.addAppendSelectOption;y&&(this.header=e.selectData,this.description=e.sameFileNameDescription.replace("${fileName}",s));const h=u&&y?"120004189":"120001300",v=`${r.helpBase}${r.helpMap[h]}`;return(0,a.h)(a.H,{key:"b1b8c12fa0a5096cc41ff61252445131ee4fdfad",class:{"overflow-hidden":o}},(0,a.h)("arcgis-new-item-loader",{key:"8c38e6f0a9278de6b034c8e319538a1e96eafb58",type:t,active:o,text:l,value:Math.min(d.a.uploadProgress,99)}),"analyzeZip"!==n&&(0,a.h)("div",{key:"24173b4aad37f4461fb02a6324d74da4677d56c1",class:{"upload-step":!0,"upload-step--header-with-description":y}},(0,a.h)("arcgis-new-item-description",{key:"6d0acfac9e6f10f1e013c3e7cb6cf43cd322b7c1",header:this.header,content:this.description})),"analyzeZip"!==n&&(0,a.h)("div",{key:"372def6c0149b817a94313415c8a450b55c41e31",class:{"file-browser-container":!0,"file-browser-container--has-description":y}},(0,a.h)("arcgis-file-browser",{key:"dc154857ee35d0159c413d4e34ff4f7f8dd519ea",cloud:!1,validTypes:c,allowedExtensions:p,insideModal:!0,config:r,helpText:e.learnMore,helpLink:v,helpIdType:"append",fullHeight:!0})),"analyzeZip"===n&&(0,a.h)("div",{key:"09aec6476aa9b15f8aa41d78e60174dd3da5d990",class:"analyze-step"},(0,a.h)("arcgis-new-item-input-readonly",{key:"6d9232f422d869a49376c066976d8053a3dcc43a",label:e.file}),"zip"===d.a.extension&&this.renderPickZip()),(0,a.h)("arcgis-new-item-alert",{key:"c933ff1492af429eb0356cc6d3f661385e1aa947",heading:null==i?void 0:i.title,description:null==i?void 0:i.description,link:{href:null==i?void 0:i.link,title:null==i?void 0:i.linkText},active:!!i,onAlertDismiss:()=>this.error=null}))}get el(){return(0,a.a)(this)}};T.style=":host{overflow:hidden}.file-browser-container{display:block;height:95%}.file-browser-container--has-description{display:block;height:90%}.upload-step{margin-bottom:0px;display:block}.upload-step--header-with-description{margin-bottom:0.75rem;display:block}.read-only{z-index:50;display:block}.zip-select-heading{font-weight:500}calcite-tile-group{inline-size:100%}calcite-tile{max-inline-size:100%;min-inline-size:100%}"},45768:(e,i,t)=>{t.d(i,{a:()=>s,f:()=>n,i:()=>r,m:()=>o});var a=t(4429),l=t(15912);function n(e,i){let t;t=i?i.map((e=>e.type)):Object.keys(l.a);let a=[];return t.forEach((i=>{var t;(null===(t=l.a[i].fileExt)||void 0===t?void 0:t.indexOf(e))>=0&&a.push(l.a[i])})),a}function o(e){return e?(0,a.b)(e.flatMap((e=>{var i;return null===(i=l.a[e])||void 0===i?void 0:i.fileExt})).filter((e=>!!e))):null}const r=e=>e/1024/1024>50,s=e=>e/1024/1024>20},52763:(e,i,t)=>{t.d(i,{a:()=>c,c:()=>s,g:()=>d,h:()=>p});var a=t(3826),l=t(8214),n=t(15912),o=t(95878),r=function(e,i){var t={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&i.indexOf(a)<0&&(t[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var l=0;for(a=Object.getOwnPropertySymbols(e);l<a.length;l++)i.indexOf(a[l])<0&&Object.prototype.propertyIsEnumerable.call(e,a[l])&&(t[a[l]]=e[a[l]])}return t};function s(e,i){var t;const a=(null==e?void 0:e.type)||null,l=(null==i?void 0:i.type)||null;return l&&(l===a||(null===(t={esriFieldTypeSmallInteger:["esriFieldTypeSmallInteger"],esriFieldTypeInteger:["esriFieldTypeInteger","esriFieldTypeSmallInteger"],esriFieldTypeSingle:["esriFieldTypeSingle","esriFieldTypeDouble"],esriFieldTypeDouble:["esriFieldTypeDouble","esriFieldTypeSingle","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeBigInteger"],esriFieldTypeDate:["esriFieldTypeDate"],esriFieldTypeString:["esriFieldTypeString","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeDate","esriFieldTypeGUID","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset","esriFieldTypeBigInteger"],esriFieldTypeGUID:["esriFieldTypeGUID","esriFieldTypeString"],esriFieldTypeOID:["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeInteger"],esriFieldTypeGlobalID:["esriFieldTypeGlobalID","esriFieldTypeGUID","esriFieldTypeString"],esriFieldTypeDateOnly:["esriFieldTypeDateOnly"],esriFieldTypeTimeOnly:["esriFieldTypeTimeOnly"],esriFieldTypeTimestampOffset:["esriFieldTypeTimestampOffset"],esriFieldTypeBigInteger:["esriFieldTypeBigInteger"]}[a])||void 0===t?void 0:t.includes(l)))}function d(e){var i;const{timezone:t,analyzeResults:s,type:d,fieldMappings:c,dataLayer:p,id:u,portal:y,uidPair:h,addAppendSelectOption:v,sourceDataLayer:m,attachmentsEnabled:g,insertAttachmentsEnabled:f,featureAttachmentOption:b}=e;let T,F;const{publishParameters:w}=s,S=r(s,["publishParameters"]),O="upsert"===v||"update"===v,P=function(e){const i=e.filter((e=>e.source!==`<${o.u.i18n.appendKeyValuePair.noneField}>`)),t=i.map((({source:e,name:i})=>({source:e,name:i})));return t}(c),k=function(e){const i=e.map((e=>e.name));return i}(P),x={dateFieldsTimeReference:Object.assign(Object.assign({},(null==y?void 0:y.isPortal)?{timezone:t||"UTC"}:{ianaTimeZone:t||"GMT"}),{respectsDaylightSaving:!0})},z={sourceTableName:p.name,fieldMappings:(null==P?void 0:P.length)?JSON.stringify(P):null,upsert:O,skipInserts:"update"===v,skipUpdates:!1,useGlobalIds:O&&"esriFieldTypeGlobalID"===(null==h?void 0:h.type),updateGeometry:!O||"attributeAndGeometry"===a.a.addAppendSelectUpdateTypeOption,appendFields:k.length?JSON.stringify(k):null,appendItemId:u,appendUploadFormat:n.a[a.a.type].appendUploadFormat,rollbackOnFailure:!0};"Table"===m.type&&(w.locationType="none");const G=r(w,["layers"]);if("CSV"===d)w.layerInfo.dateFieldsTimeReference=x.dateFieldsTimeReference,F=Object.assign(Object.assign(Object.assign({},x),w),S);else if("Microsoft Excel"===d){const e=function(e,i){const t=Object.assign({},e);t.locationType=(null==i?void 0:i.locationType)||e.locationType,"address"===t.locationType?(t.addressFields=i.addressFields,t.sourceCountry=i.sourceCountry):"coordinates"===t.locationType&&(t.coordinateFieldType=i.coordinateFieldType,"LatitudeAndLongitude"===t.coordinateFieldType?(t.latitudeFieldName=i.latitudeFieldName,t.longitudeFieldName=i.longitudeFieldName):t.coordinateFieldName=i.coordinateFieldName);return t}((0,l.a)({},!0),G);e.dateFieldsTimeReference=x.dateFieldsTimeReference,G.name=p.name,F=Object.assign(Object.assign(Object.assign(Object.assign({},x),{layers:[e]}),G),S)}else F=Object.assign(Object.assign(Object.assign({},x),w),S);return T=Object.assign(Object.assign(Object.assign({},z),{appendSourceInfo:JSON.stringify(F)}),g&&function({insertAttachmentsEnabled:e}){return e?{skipAttachmentInserts:!1,skipAttachmentUpdates:!0,skipAttachmentDeletes:!0}:{skipAttachmentInserts:!0,skipAttachmentUpdates:!0,skipAttachmentDeletes:!0}}({appendType:v,insertAttachmentsEnabled:f,featureAttachmentOption:b})),"add"===v?T.upsertMatchingField=m.objectIdField||(null===(i=m.uniqueField)||void 0===i?void 0:i.name):O&&(null==h?void 0:h.isUniqueIndex)&&(T.upsertMatchingField=null==h?void 0:h.name),T}function c(e,i,t){return"File Geodatabase"===e&&t.hasAttachments&&i.hasAttachments}function p(e,i){const t=i.appendErrorMessages;let a=o.u.i18n.error,l=t.appendError;switch(e.code){case"invalidUniqueIdentifier":a=t.invalidUniqueIdentifier.title,l=t.invalidUniqueIdentifier.description;break;case"cannotAddNullData":a=t.cannotAddNullData.title,l=t.cannotAddNullData.description;break;case"exceededMaxFieldLength":a=t.exceededMaxFieldLength.title,l=t.exceededMaxFieldLength.description;break;case"invalidFieldType":a=t.invalidFieldType.title,l=t.invalidFieldType.description}return{title:a,description:l}}},84135:(e,i,t)=>{function a(e){return null!=e}t.d(i,{i:()=>a})},86075:(e,i,t)=>{t.d(i,{a:()=>u,g:()=>p,s:()=>y});var a=t(84135),l=t(3826),n=t(44069),o=t(8214),r=t(66111),s=t(87744),d=t(50637);function c(e,i,t,a){var l,n,o,r;const s=null!==(l=i.latitudeFieldName)&&void 0!==l?l:t.latitudeFieldName,d=null!==(n=i.longitudeFieldName)&&void 0!==n?n:t.longitudeFieldName,c=null!==(o=i.coordinateFieldName)&&void 0!==o?o:t.coordinateFieldName,p=null!==(r=i.coordinateFieldType)&&void 0!==r?r:t.coordinateFieldType;return a[e.name]?a[e.name]:e.name===c?null==p?void 0:p.toLowerCase():e.name===s?"latitude":e.name===d?"longitude":e.locationType||"unknown"}const p=(e,i)=>{if(!i)return e;const{layers:t,tables:a}=i;return"Map Service"===e&&!(null==t?void 0:t.length)&&(null==a?void 0:a.length)?"Feature Service":e};async function u({analyzeArgs:e,configArgs:i,itemArgs:t,initialize:p}){var u,v,m,g;const{config:f,lang:b,portal:T,user:F}=i,{itemType:w,ignoreV2FieldTypesVersion:S}=t;if(p&&(0,r.o)(F)){const e=(0,o.b)(null!==(v=null===(u=T.helperServices)||void 0===u?void 0:u.geocode)&&void 0!==v?v:[],F,T.isPortal);if(e&&(l.a.allowGeocode=e.allowGeocode,l.a.isAgoWorldGeocodeServer=e.isAgoWorldGeocodeServer,l.a.isServiceProxyAgoWorldGeocodeServer=e.isServiceProxyAgoWorldGeocodeServer,l.a.isWorldGeocodeServer=e.isWorldGeocodeServer,l.a.geocodeServers=e.geocodeServers,l.a.geocodeServiceUrl=e.geocodeServiceUrl),l.a.geocodeServers){l.a.sourceCountry=(0,o.d)(F.region,T.ipCntryCode);try{l.a.countryCodes=await async function(e,i,t){const a=(0,o.f)(e,t);let l;if(null==a?void 0:a.itemId){const e=`${i}/content/items/${a.itemId}`,t=await(0,d.r)(e),n=t.proxyFilter&&JSON.parse(t.proxyFilter).sourceCountry;n&&(l=n.split(",").map((e=>e.toLowerCase())),l.push("world"))}return Object.keys(o.c).map((e=>({label:o.c[e],value:e}))).filter((({value:e})=>!l||l.includes(e.toLowerCase()))).sort(((e,i)=>e.label<i.label?-1:e.label>i.label?1:0))}(l.a.geocodeServiceUrl,f.restBaseUrl,l.a.geocodeServers),l.a.standardizedFieldNames=await h(l.a.geocodeServiceUrl,b)}catch(e){return console.error("Geocoder unavailable",e),{error:{code:"unavailableGeocoder"}}}}}const{locationType:O,isWorldGeocodeServer:P,geocodeServiceUrl:k,geocodeServers:x,isServiceProxyAgoWorldGeocodeServer:z,sourceCountry:G,analyzeResults:I,analyzedLocationTypes:N}=l.a,D=`${f.restBaseUrl}content/features/analyze`,{isPortal:A}=T;let L,M=!1;"item"===(null==e?void 0:e.type)&&"append"===e.workflow?(L=n.a[w],M=!0):L="Microsoft Excel"===w?"excel":w.toLowerCase();const C="file"===(null==e?void 0:e.type)&&e.analyze3DData;let E={filetype:L};switch(null==e?void 0:e.type){case"url":E.sourceUrl=e.sourceUrl;break;case"item":E.itemid=e.itemid;break;case"file":E=new FormData,E.append("file",e.file),E.append("filetype",C&&"File Geodatabase"===t.itemType?"fileGeodatabase":L);break;case"text":E.text=e.text}if(!C)if(A&&k||!A){const e={enableGlobalGeocoding:!0,sourceLocale:b,locationType:O,returnEstimatedRowCount:!0,returnSize:!0};if(S||(e.fieldTypesVersion="V2"),(A||!A&&(null==x?void 0:x.length))&&(e.geocodeServiceUrl=encodeURI(k)),I||A){const i="address"===O?"addressTypes":"locationTypes";-1===N.indexOf(i)&&N.push(i),e.locationType=O||"coordinates"}(!T.isPortal&&P||T.isPortal&&z)&&(e.sourceCountryHint=I?"":G.toLowerCase(),e.sourceCountry=I?G.toLowerCase():"");const i=JSON.stringify(e);E instanceof FormData?E.append("analyzeParameters",i):E.analyzeParameters=i}else S||(E instanceof FormData?E.append("analyzeParameters",JSON.stringify({fieldTypesVersion:"V2"})):E.analyzeParameters=JSON.stringify({fieldTypesVersion:"V2"}));try{const e=await(E instanceof FormData?(0,d.a)(D,E,{},"post"):(0,d.r)(D,E,{},"post"));if(C){if(!function(e){var i;const t=null==e?void 0:e.publishParameters,a=null===(i=null==t?void 0:t.layers)||void 0===i?void 0:i[0],l=null==a?void 0:a.infoFor3D,n="esriGeometryMultiPatch"===(null==a?void 0:a.geometryType);return l&&n}(e))return{error:{code:"invalid3DObjectFeatureClass"}}}else!async function({response:e,analyzeSelectedLayer:i,initialize:t,geocodeServiceUrl:n,lang:r,portal:p,itemType:u}){var h,v,m,g,f,b;const T=l.a,F=p.isPortal,w="Microsoft Excel"===u,S=w?null!==(v=null===(h=e.publishParameters.layers)||void 0===h?void 0:h[T.selectedSheet])&&void 0!==v?v:null===(m=e.publishParameters.layers)||void 0===m?void 0:m[0]:e.publishParameters;let O;if(!F&&T.isWorldGeocodeServer||F&&T.isServiceProxyAgoWorldGeocodeServer){const e=(0,a.i)(S.sourceCountry);O=T.sourceCountry||S.sourceCountry||"world",O="wo"===O?"world":O,l.a.isWorldGeocodeServer=e,l.a.sourceCountry=O}T.allowGeocode||"address"!==S.locationType||(l.a.locationType="none");!function(e){var i,t,a,n,o,r;const{selectedSheet:s}=l.a,{publishParameters:d}=e,p=null!==(n=null!==(t=null===(i=d.layers)||void 0===i?void 0:i[s])&&void 0!==t?t:null===(a=d.layers)||void 0===a?void 0:a[0])&&void 0!==n?n:d.layerInfo;if(!p)return e;const u=null!==(r=null!==(o=p.addressFields)&&void 0!==o?o:d.addressFields)&&void 0!==r?r:{},y=Object.keys(u).reduce(((e,i)=>Object.assign(Object.assign({},e),{[u[i]]:i})),{});p.fields=p.fields.map((e=>Object.assign(Object.assign({},e),{locationType:c(e,p,d,y)}))),l.a.selectedFields&&(l.a.selectedFields=Object.keys(l.a.selectedFields).reduce(((e,i)=>{const t=l.a.selectedFields[i];return e[i]=Object.assign(Object.assign({},t),{locationType:c(t,p,d,y)}),e}),{}))}(e);const P=function(e){return function(e,i){var t,a,l,n;const{selectedFields:o,type:r,selectedSheet:s}=i;if(!o)return e;const d=e.publishParameters;let c=null==d?void 0:d.layerInfo;switch(r){case"Microsoft Excel":c=null!==(a=null===(t=null==d?void 0:d.layers)||void 0===t?void 0:t[s])&&void 0!==a?a:null===(l=null==d?void 0:d.layers)||void 0===l?void 0:l[0];break;case"GeoJson":c=null===(n=null==d?void 0:d.layers)||void 0===n?void 0:n[0]}return c.fields=c.fields.reduce(((e,i)=>{const t=o[i.name];return t&&(i.alias=t.alias,e.push(i)),e}),[]),e}(e,l.a)}(e);l.a.analyzeResults=P,(null===(g=null==P?void 0:P.publishParameters)||void 0===g?void 0:g.layers)&&(l.a.excelLayers=null===(f=null==P?void 0:P.publishParameters)||void 0===f?void 0:f.layers);const k=(0,o.a)(e,i);t?l.a.backupLayerFields=JSON.parse(JSON.stringify(k.fields)):S.standardizedFieldNames?l.a.standardizedFieldNames=S.standardizedFieldNames:y({lang:r,geocodeServiceUrl:n,locationType:l.a.locationType});"address"===l.a.locationType||"address"===k.locationType||"address"===(null===(b=null==e?void 0:e.publishParameters)||void 0===b?void 0:b.locationType)?l.a.geocodeCost=await(x=k.estimatedRecordCount,(0,d.r)(`${(0,s.g)()}portals/self/cost`,{geocodeCount:x})):l.a.geocodeCost=null;var x}({response:e,initialize:p,analyzeSelectedLayer:M,geocodeServiceUrl:k,lang:b,portal:T,itemType:w});return{}}catch(e){console.error(e);const i=(null==e?void 0:e.message)||e||"";switch(!0){case i.includes("specify data to be analyzed"):return{error:{code:"emptyFile"}};case i.includes("duplicate field names are not allowed"):return{error:{code:"duplicateFieldNames"}};case i.toLowerCase().includes("timeout"):return{error:{code:"timeout"}};case i.toLowerCase().includes("unable to analyze"):if(null===(g=null===(m=null==e?void 0:e.details)||void 0===m?void 0:m.messages[0])||void 0===g?void 0:g.toLowerCase().includes("file exceeds the max size allowed of 10mb."))return{error:{code:"exceedsFileSize"}};case i.toLowerCase().includes("error in analyzing filegeodatabase"):return{error:{code:"invalidFileGeodatabase"}}}return{error:{code:"unhandledError"}}}}async function y({lang:e,geocodeServiceUrl:i,locationType:t}){"address"===t&&(l.a.standardizedFieldNames=await h(i,e))}async function h(e,i){return(await(0,d.r)(e,{},{addTokenManually:!1})).addressFields.reduce(((e,t)=>{var a;return"unknown"!==t.name&&(e[t.name]=(null===(a=null==t?void 0:t.localizedNames)||void 0===a?void 0:a[`${i}`])||t.alias||t.name),e}),{})}}}]);
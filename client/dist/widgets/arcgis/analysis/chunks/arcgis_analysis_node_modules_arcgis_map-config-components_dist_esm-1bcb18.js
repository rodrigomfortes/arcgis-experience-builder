/*! For license information please see arcgis_analysis_node_modules_arcgis_map-config-components_dist_esm-1bcb18.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_map-config-components_dist_esm-1bcb18"],{6048:(e,t,i)=>{i.d(t,{F:()=>a});var s=i(11254),o=i(56612);const a=({fieldType:e})=>e===o.a.oid||e===o.a.guid||e===o.a.globalId?(0,s.h)("calcite-icon",{scale:"s",icon:"key"}):e===o.a.integer||e===o.a.smallInteger||e===o.a.bigInteger?(0,s.h)("calcite-icon",{scale:"s",icon:"integer"}):e===o.a.single||e===o.a.double||e===o.a.long||e===o.a.number?(0,s.h)("calcite-icon",{scale:"s",icon:"number"}):e===o.a.string?(0,s.h)("calcite-icon",{scale:"s",icon:"string"}):e===o.a.date?(0,s.h)("calcite-icon",{scale:"s",icon:"date-time"}):e===o.a.dateOnly?(0,s.h)("calcite-icon",{scale:"s",icon:"calendar"}):e===o.a.timestampOffset?(0,s.h)("calcite-icon",{scale:"s",icon:"time-zone"}):e===o.a.timeOnly?(0,s.h)("calcite-icon",{scale:"s",icon:"clock"}):(0,s.h)("calcite-icon",{scale:"s",icon:"string"})},19398:(e,t,i)=>{function s(e,t){const i="CALCITE-INPUT"===e.tagName,s=i?e.shadowRoot.querySelector("input"):e.shadowRoot.querySelector("textarea"),o=s.selectionStart,a=[e.value.slice(0,o),`{${t}}`,e.value.slice(o)].join("");e.value=a;const n=o+2+t.length;setTimeout((()=>{i?e.setFocus():(s?.setSelectionRange(n,n),s?.focus()),s?.setSelectionRange(n,n)}),1)}function o(e){const{mapView:t,layer:i,portal:s}=e,{map:o}=t,{portalHostname:n}=s;if(!o)return!1;const{utilityNetworks:l}=o;if(!l)return!1;const r=s.isPortal,p="1"===window.localStorage.getItem("utility-networks-agol")&&("devext.arcgis.com"===n||"qaext.arcgis.com"===n);if(!r&&!p)return!1;const c=a(i),d=l.find((e=>e.sourceJSON?.serviceItemId===c));if(!d)return!1;return d.isUtilityLayer(i)}function a(e){return"subtype-sublayer"===e.type?e.parent.serviceItemId:e.serviceItemId}i.d(t,{a:()=>n,b:()=>l,c:()=>s,g:()=>a,i:()=>o});const n=["attachment","connectivity","container","content","structure"];var l;!function(e){e.title="title",e.description="description",e.displayCount="displayCount"}(l||(l={}))},44735:(e,t,i)=>{function s(e,t){if(!e||!t)return;let i=t.assetsPath;i.endsWith("/")||(i+="/"),e?.firstElementChild?.insertAdjacentHTML("beforebegin",`<link rel="stylesheet" href="${i}esri/themes/light/main.css" />`)}i.d(t,{i:()=>s})},53127:(e,t,i)=>{i.d(t,{a:()=>o,d:()=>s,t:()=>a});const s=(e,t)=>{let i,s="idle";const o=async(...o)=>await new Promise((a=>{switch(s){case"flushed":s="idle",i?(clearTimeout(i),a(e(...o))):a(null);break;case"invoked":clearTimeout(i),s="idle",a(e(...o));break;case"cancelled":clearTimeout(i),s="idle",a(null);break;default:i&&clearTimeout(i),s="pending",i=setTimeout((()=>{s="idle",a(e(...o))}),t)}}));return o.flush=async function(...e){return s="flushed",await o(...e)},o.invoke=async function(...e){return s="invoked",await o(...e)},o.cancel=async function(...e){return s="cancelled",await o(...e)},o.getStatus=function(){return s},o},o=(e,t)=>{let i;return async(...s)=>await new Promise((o=>{i||(i=setTimeout((()=>{clearTimeout(i),i=void 0,o(e(...s))}),t))}))};function a(e){return new Promise((t=>setTimeout(t,e)))}},60262:(e,t,i)=>{i.d(t,{p:()=>n});var s=i(69811),o=i(56612),a=i(17840);const n=async(e,t,i)=>{e.closePopup();const s=(0,a.a)(t);if(s!==o.s.parquet&&s!==o.s.voxel){if(s!==o.s.scene||t?.associatedLayer){const o=await l(e,t,i,s);return o?(await e.openPopup({features:[o],location:o.geometry?.extent?.center??o.geometry}),e.popup&&"dockEnabled"in e.popup&&(e.popup.dockEnabled=!0),await Promise.resolve(o)):void await Promise.resolve(void 0)}await Promise.resolve(void 0)}else await Promise.resolve(void 0)},l=async(e,t,i,n)=>{try{let l,c;if(n===o.s.ogcFeature){l=await e.whenLayerView(t);const i=await(0,s.l)();await i.whenOnce((()=>!l.updating))}else if(n===o.s.stream){l=await e.whenLayerView(t);const i=await(0,s.l)();await i.whenOnce((()=>!l.updating))}else l=t;if(n===o.s.imageryTile||n===o.s.wcs){const i=e.allLayerViews.find((e=>e.layer.id===t.id)),s=await i.fetchPopupFeaturesAtLocation(t.fullExtent?.center);return s?.[0]}if(n===o.s.mapImage&&t.layer.version>=10.5&&!t.layer.capabilities?.operations?.supportsQuery&&t.layer.capabilities?.operations?.supportsIdentify){const i=await(0,a.h)(t,e);return i&&(i.sourceLayer=t),Promise.resolve(i)}const d="isTable"in t&&t.isTable,h=l.createQuery();d||(h.geometry=e.center,h.distance=e.resolution),h.outFields=["*"];const u=await l.queryFeatures(h,{signal:i.signal});if(0===u?.features?.length){const s=l.createQuery();s.geometry=e.extent,s.outFields=["*"],"knowledge-graph-sublayer"===t.type&&(s.returnGeometry=!0);const a=await l.queryFeatures(s,{signal:i.signal});if(a?.features?.length>0)c=await p(a,e,t);else{const s=l.createQuery();s.where=l.definitionExpression||"1=1",s.outFields=["*"],(t.sourceJSON?.advancedQueryCapabilities?.supportsPagination||n===o.s.ogcFeature)&&(s.start=0,s.num=1),s.outSpatialReference=e.spatialReference,c=(await l.queryFeatures(s,{signal:i.signal}))?.features?.[0]}}else c=u?.features?.[0];return c&&n===o.s.imagery&&(c=await r(t,c)),Promise.resolve(c)}catch(e){return console.log(e),void await Promise.resolve(void 0)}},r=async(e,t)=>{const i=e.createQuery();i.outFields=["*"].concat(e.rasterFields.map((e=>e.name)).filter((e=>e.startsWith("Raster.")))),i.geometry=t.geometry,i.outSpatialReference=t.geometry.spatialReference;const s=await e.queryVisibleRasters(i,{returnTopmostRaster:!0,returnDomainValues:!0});return s?.[0]??t},p=async(e,t,i)=>{const o=await(0,a.b)(i);if("point"===o){let i=[void 0,void 0];for(let s=0;s<e.features.length;s++){const o=e.features[s].geometry.distance(t.center);(0===s||(0,a.i)(i?.[1]&&i[1]>o))&&(i=[e.features[s],o])}return i[0]}if("polyline"===o){let i=[void 0,void 0];const o=await(0,s.a2)();for(let s=0;s<e.features.length;s++){const n=o.getNearestVertex(e.features[s].geometry,t.center).distance;(0===s||(0,a.i)(i?.[1]&&i[1]>n))&&(i=[e.features[s],n])}return i[0]}if("polygon"===o||"imagery"===(0,a.a)(i)){let i=[void 0,void 0];for(let s=0;s<e.features.length;s++){const o=e.features[s].geometry.centroid.distance(t.center);(0===s||(0,a.i)(i?.[1]&&i[1]>o))&&(i=[e.features[s],o])}return i[0]}return e.features[0]}},86415:(e,t,i)=>{i.r(t),i.d(t,{arcgis_map_config_fields:()=>N,arcgis_map_config_label_content:()=>T,arcgis_map_config_label_content_filter:()=>x,arcgis_map_config_label_content_style:()=>L,arcgis_map_config_label_rename_form:()=>S,arcgis_map_config_popup:()=>V,arcgis_map_config_popup_arcade:()=>$,arcgis_map_config_popup_associations:()=>z,arcgis_map_config_popup_attachments:()=>W,arcgis_map_config_popup_attributes:()=>j,arcgis_map_config_popup_expressions:()=>q,arcgis_map_config_popup_multimedia:()=>G,arcgis_map_config_popup_relationship:()=>Y,arcgis_map_config_popup_richtext:()=>X,arcgis_map_config_popup_title:()=>Q});var s=i(11254),o=i(6048),a=i(56612),n=i(17840),l=i(84947),r=i(53127),p=i(51523),c=i(60262),d=i(14528),h=i(84260),u=i(69811),m=i(10465),g=i(44735),f=i(20057),y=i(59350),b=i(93345),C=i(41244),P=i(53960),v=i(19398);i(84661);const N=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.arcgisClose=(0,s.c)(this,"arcgisClose",7),this.arcgisFieldAdded=(0,s.c)(this,"arcgisFieldAdded",7),this.arcgisFieldsDeleted=(0,s.c)(this,"arcgisFieldsDeleted",7),this.manager=(0,d.u)(this),this.strings=(0,h.u)({blocking:!0}),this.layerFieldsMap=new Map,this.arcadeExpMap=new Map,this.popupOpenForLayer=!1,this.listItemNodes=[],this.allowFieldAdd=!1,this.debouncedAttributeUpdates=(0,r.d)((()=>{this.layerDisplayType===a.l.feature?this.layer.popupTemplate=this.popupTemplate.clone():this.layerDisplayType===a.l.cluster&&(this.layer.featureReduction.popupTemplate=this.popupTemplate.clone()),this.arcgisChange.emit()}),1e3),this.mapView=void 0,this.portal=void 0,this.layer=void 0,this.config=void 0,this.hidePopup=!1,this.dismissible=!1,this.hideLayerTitle=!1,this.addFieldEnabled=!1,this.deleteFieldEnabled=!1,this.calciteFlowProps=!1,this.layerDisplayType=a.l.feature,this.reRender=!1,this.totalSelectedFields=0,this.lastSortBy="default",this.filterFields=void 0}async done(){this.closePopovers(!0),await this.showPreviewPopup(!1)}async setFocus(){this.panelNode?this.panelNode.setFocus():this.listNode?.setFocus()}async componentWillLoad(){const{mapView:e,layer:t,layerDisplayType:i}=this,s=(0,n.a)(t);if(i===a.l.feature){const o="type"in t?t.type:"sublayer",n=e.popup?.visible?e.popup.selectedFeature?.sourceLayer:void 0;this.popupOpenForLayer="subtype-sublayer"===o?n?.subtypeCode===t.subtypeCode&&n?.parent.id===t.parent.id:"sublayer"===o?n?.id===t.id&&n?.layer.id===t.layer?.id:"id"in t&&n?.id===t.id,s!==a.s.mapImage||t.popupTemplate||(t.popupEnabled=!1),this.popupTemplate=t.popupTemplate?t.popupTemplate.clone():t.createPopupTemplate(),this.popupTemplate.fieldInfos=[...await(0,p.g)(t,this.popupTemplate)],i===a.l.feature?t.popupTemplate=this.popupTemplate.clone():i===a.l.cluster&&(t.featureReduction.popupTemplate=this.popupTemplate.clone())}else this.popupTemplate=t.featureReduction.popupTemplate.clone();const o=window.customElements?.get("arcgis-field-add");this.allowFieldAdd=(0,n.i)(o)&&this.addFieldEnabled&&await(0,l.c)(t)}async componentWillRender(){this.layerFieldsMap=await(0,n.f)(this.layer),this.arcadeExpMap=(0,n.m)(this.popupTemplate)}async componentDidLoad(){await this.showPreviewPopup(!0),this.setupResizeObserver()}disconnectedCallback(){this.resizeObserver?.disconnect()}render(){const{strings:e,layer:t,hideLayerTitle:i,dismissible:o,allowFieldAdd:a,calciteFlowProps:n}=this,l=window.customElements?.get("arcgis-field-add");return(0,s.h)(s.H,{key:"94be1ad281ada10b9c96a7945417228aa248a800",class:"calcite-match-height"},n?(0,s.h)("div",null,this.renderList()):(0,s.h)("calcite-panel",{heading:e.attributesHeading,description:i?void 0:t.title??void 0,closable:o,ref:e=>this.panelNode=e,onCalcitePanelClose:async e=>{e.stopPropagation(),await this.done(),this.arcgisClose.emit()}},this.renderList(),l&&a&&this.renderFieldAddFab()))}renderList(){const{strings:e}=this;this.listItemNodes=[];const t=this.getSortedFieldList().filter((e=>-1===e.fieldName?.indexOf(a.f.relationship)));return(0,s.h)("calcite-list",{label:e.attributesHeading,filterEnabled:t.length>=5,filterPlaceholder:e.searchFields,selectionMode:"multiple",onCalciteListFilter:()=>{this.filterFields=this.listNode?.filteredItems?.map((e=>e.value))??[],this.dropdownActionNode.disabled=this.filterFields.length<=2},ref:e=>this.listNode=e},this.popupTemplate.fieldInfos.length>=5?this.renderSort():(0,s.h)(s.F,null),this.totalSelectedFields>0?(0,s.h)("div",{class:"total-selected-div"},(0,s.h)("calcite-chip",{label:e.numberFieldsSelected.replace("${number}",`${this.totalSelectedFields}`),value:"selected-fields",closable:!0,onCalciteChipClose:e=>{e.stopPropagation(),this.closePopovers(!0)}},e.numberFieldsSelected.replace("${number}",`${this.totalSelectedFields}`))):(0,s.h)(s.F,null),t.map((e=>this.renderListItem(e))))}renderSort(){const{strings:e}=this,t=this.popupTemplate.fieldInfos.every((e=>!!(0,n.n)(e.fieldName,this.layerFieldsMap,this.arcadeExpMap)));return(0,s.h)("calcite-dropdown",{slot:"filter-actions-end",placement:"bottom-end",overlayPositioning:"fixed"},(0,s.h)("calcite-action",{slot:"trigger",text:e.sort,title:e.sort,ref:e=>this.dropdownActionNode=e,disabled:this.allowFieldAdd&&this.filterFields&&this.filterFields.length<=2},(0,s.h)("calcite-icon",{scale:"s",icon:"sortDescending",flipRtl:!0})),(0,s.h)("calcite-dropdown-group",null,(0,s.h)("calcite-dropdown-item",{selected:"default"===this.lastSortBy,onClick:()=>this.lastSortBy="default",onKeyDown:e=>{e.stopPropagation()," "!==e.key&&"Enter"!==e.key||(this.lastSortBy="default")}},e.default),(0,s.h)("calcite-dropdown-item",{selected:"display"===this.lastSortBy,onClick:()=>this.lastSortBy="display",onKeyDown:e=>{e.stopPropagation()," "!==e.key&&"Enter"!==e.key||(this.lastSortBy="display")}},e.displayName),t&&(0,s.h)("calcite-dropdown-item",{selected:"type"===this.lastSortBy,onClick:()=>this.lastSortBy="type",onKeyDown:e=>{e.stopPropagation()," "!==e.key&&"Enter"!==e.key||(this.lastSortBy="type")}},e.type),(0,s.h)("calcite-dropdown-item",{selected:"field"===this.lastSortBy,onClick:()=>this.lastSortBy="field",onKeyDown:e=>{e.stopPropagation()," "!==e.key&&"Enter"!==e.key||(this.lastSortBy="field")}},e.fieldName)))}renderFieldAddFab(){const{strings:e}=this;return(0,s.h)("calcite-fab",{ref:e=>this.fieldAddFabNode=e,scale:"s",class:"floating-add-field-button",slot:"fab",kind:"neutral",appearance:"outline-fill","text-enabled":!0,text:e.addField,onClick:()=>{this.fieldAddFabNode.disabled=!0,this.openFieldAddModal()}})}async showPreviewPopup(e){const{mapView:t,layer:i,hidePopup:s,layerDisplayType:o}=this;s||o!==a.l.feature||this.popupOpenForLayer||(e&&i.popupEnabled&&i.popupTemplate?(this.previewPopupController=new AbortController,await(0,c.p)(t,i,this.previewPopupController)):(this.previewPopupController?.abort(),t.closePopup()))}setupResizeObserver(){const e=this.el?.parentElement;(0,n.i)(e.collapsed)&&(this.resizeObserver=new ResizeObserver((async()=>{e.collapsed&&await this.done()})),this.resizeObserver.observe(e))}getSortedFieldList(){const e=[...this.popupTemplate.fieldInfos];return"display"===this.lastSortBy?e.sort(((e,t)=>(0,n.o)(e,this.arcadeExpMap).localeCompare((0,n.o)(t,this.arcadeExpMap)))):"field"===this.lastSortBy?e.sort(((e,t)=>e.fieldName.localeCompare(t.fieldName))):"type"===this.lastSortBy&&e.sort(((e,t)=>{const i=(0,n.n)(e.fieldName,this.layerFieldsMap,this.arcadeExpMap),s=(0,n.n)(t.fieldName,this.layerFieldsMap,this.arcadeExpMap);return i.localeCompare(s)})),e}renderListItem(e){return(0,s.h)("calcite-list-item",{id:e.fieldName,key:e.fieldName,label:(0,n.o)(e,this.arcadeExpMap),description:`{${e.fieldName}}`,value:e.fieldName,metadata:{label:(0,n.o)(e,this.arcadeExpMap),fieldName:e.fieldName},onClick:()=>this.handleListItemClick(e.fieldName),onKeyDown:t=>{" "!==t.key&&"Enter"!==t.key||(t.preventDefault(),t.stopPropagation(),this.handleListItemClick(e.fieldName))},ref:e=>this.listItemNodes.push(e)},(0,s.h)("div",{slot:"actions-end",class:"field-icons"},(0,s.h)(o.F,{fieldType:(0,n.n)(e.fieldName,this.layerFieldsMap,this.arcadeExpMap)})))}async handleListItemClick(e){const{strings:t,mapView:i,layer:s,config:o,deleteFieldEnabled:a}=this;this.closePopovers(!1);const n=[...this.listNode.selectedItems.map((e=>e.value))];this.totalSelectedFields=n.length,this.lastSelectedFieldName=e,!this.formattingNode&&n.length&&(this.formattingNode=document.createElement("arcgis-map-config-fields-formatting"),this.formattingNode.strings=t,this.formattingNode.config=o,this.formattingNode.popoverProps={refElement:this.el},this.formattingNode.selectedFields=n,this.formattingNode.layer=s,this.formattingNode.mapView=i,this.formattingNode.popupTemplate=this.popupTemplate.clone(),this.formattingNode.deleteFieldEnabled=a,this.formattingNode.addEventListener("arcgisChange",(e=>{e.stopPropagation(),this.popupTemplate=e.detail.clone(),this.debouncedAttributeUpdates(),this.reRender=!this.reRender})),this.formattingNode.addEventListener("arcgisClose",(e=>{e.stopPropagation(),this.closePopovers(!0)})),this.formattingNode.addEventListener("arcgisFieldsDeleted",(async e=>{e.stopPropagation(),this.formattingNode?.parentElement?.removeChild(this.formattingNode),this.formattingNode=void 0,this.popupTemplate=this.layer.popupTemplate?.clone(),this.listItemNodes.forEach((e=>{e&&(e.selected=!1)})),this.totalSelectedFields=0,this.arcgisFieldsDeleted.emit(e.detail),this.debouncedAttributeUpdates()})),document.body.appendChild(this.formattingNode))}openFieldAddModal(){this.fieldAddNode=document.createElement("arcgis-field-add"),this.fieldAddNode.layer=this.layer,this.fieldAddNode.addEventListener("arcgisFieldAddFieldAdded",(async e=>{const{layer:t}=this;this.layer.popupTemplate.fieldInfos=[...t.popupTemplate.fieldInfos],this.popupTemplate=this.layer.popupTemplate.clone();const i=this.layer.popupTemplate.fieldInfos.find((t=>t.fieldName===e.detail));this.popupTemplate.fieldInfos=[...await(0,p.g)(this.layer,this.popupTemplate),i],this.arcgisFieldAdded.emit(e.detail),this.debouncedAttributeUpdates(),this.removeFieldAddNodes()})),this.fieldAddNode.addEventListener("arcgisWorkflowCancel",(async()=>this.removeFieldAddNodes())),document.body.appendChild(this.fieldAddNode)}removeFieldAddNodes(){this.fieldAddFabNode.disabled=!1,this.fieldAddNode?.parentElement?.childNodes.forEach((e=>{"ARCGIS-FIELD-ADD"===e.nodeName&&(this.fieldAddNode?.parentElement?.removeChild(e),this.fieldAddNode=void 0)}))}closePopovers(e){if(this.formattingNode&&(this.formattingNode.parentElement?.removeChild(this.formattingNode),this.formattingNode=void 0,e)){const e=this.listNode.selectedItems,t=e.find((e=>e.id===this.lastSelectedFieldName));for(const t of e.values())t.selected=!1;this.totalSelectedFields=0,this.lastSelectedFieldName=void 0,setTimeout((()=>{t?t.setFocus():this.listItemNodes[0].setFocus()}),300)}}static get assetsDirs(){return["assets"]}get el(){return(0,s.a)(this)}};N.style=".total-selected-div{padding:var(--calcite-spacing-xs)}.field-icons{padding:0 var(--calcite-spacing-xl);display:flex;align-items:center}.floating-add-field-button{padding-bottom:0.5rem}";const w=["csv","feature","geojson","oriented-imagery","stream","subtype","wfs","knowledge-graph-sublayer"],k=-20,E=-20,I=20,F=20,T=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.arcgisDuplicate=(0,s.c)(this,"arcgisDuplicate",7),this.arcgisDelete=(0,s.c)(this,"arcgisDelete",7),this.arcgisDisablePanel=(0,s.c)(this,"arcgisDisablePanel",7),this.manager=(0,d.u)(this),this.aggregationExpressionMapping=new Map,this.mapView=void 0,this.layer=void 0,this.portal=void 0,this.strings=void 0,this.layerDisplayType=a.l.feature,this.serviceType=void 0,this.calciteFlowItem=void 0,this.labelClass=void 0,this.blockOpen=!1}async componentWillLoad(){await this.loadAllModules();const{layer:e,layerDisplayType:t}=this;this.popupTemplate=t===a.l.feature?e.popupTemplate:e.featureReduction.popupTemplate,this.labelFields=await this.getLabelFields(),t===a.l.cluster&&await Promise.all(this.labelFields.map((async e=>await this.getLabelsForAggregationExpressions(e.name))))}async componentDidLoad(){const e=await(0,u.j)();(0,g.i)(this.el.shadowRoot,e)}componentDidUpdate(){this.arcgisChange.emit()}disconnectedCallback(){this.labelRenameFormNode&&document.body.removeChild(this.labelRenameFormNode),this.fieldPickListNode&&document.body.removeChild(this.fieldPickListNode),this.labelContentFilterNode&&document.body.removeChild(this.labelContentFilterNode),this.labelStyleNode&&document.body.removeChild(this.labelStyleNode)}async setFocus(){const{blockOpen:e}=this;e&&(this.mapConfigBlockOptionsNode.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),this.mapConfigBlockOptionsNode.setFocus())}async closeAllPopovers(){this.closePopovers()}render(){const{strings:e,labelClass:t,blockOpen:i}=this;return(0,s.h)(s.H,{key:"4c2e122c53215bf840162056f7e430622425634f"},(0,s.h)("calcite-block",{key:"e2d43e23930d8127bd08a85b2bdf8049f923e878",dir:(0,m.b)(this.el),heading:t.name||this.getDisplayFieldName()||e.label,open:i,collapsible:!0,onCalciteBlockToggle:()=>this.closePopovers()},(0,s.h)("div",{key:"56e3f7c76bd141f59115296064a3471d6850a60a",slot:"control"},this.renderControls()),(0,s.h)("calcite-icon",{key:"62fdeff66e409503e65c234fadabbde2aaadce8d",slot:"icon",icon:"label"}),this.renderField(),this.renderFilter(),this.renderStyle(),this.renderSlider()))}renderControls(){return(0,s.h)("arcgis-map-config-block-options",{ref:e=>this.mapConfigBlockOptionsNode=e,options:{hasDelete:!0,hasDuplicate:!0,hasRename:!0},onArcgisDelete:e=>{e.stopPropagation(),this.arcgisDelete.emit()},onArcgisDuplicate:e=>{e.stopPropagation(),this.arcgisDuplicate.emit()},onArcgisRename:()=>{this.closePopovers(),this.labelRenameFormNode||this.openRenameForm()}})}renderField(){const{strings:e,layer:t,labelClass:i,serviceType:o}=this,n=w.includes(o)||o===a.s.mapImage&&t.layer.capabilities?.exportMap?.supportsArcadeExpressionForLabeling;return(0,s.h)("calcite-label",null,e.labelAttribute,(0,s.h)("div",{class:"field-expression-div"},(0,s.h)("button",{ref:e=>this.attributesButtonNode=e,class:(n?"non-simple-field-button":"simple-field-button")+" label-content-button",title:e.field,onClick:e=>{e.stopPropagation(),this.openFieldPickList()}},(0,s.h)("span",{class:"label-content-button-text"},this.getDisplayFieldName()||i.labelExpressionInfo?.title||e.newExpression),(0,s.h)("span",{class:"label-content-button-icon"},(0,s.h)("calcite-icon",{scale:"s",icon:"chevron-down"}))),n&&(0,s.h)("calcite-action",{ref:e=>this.arcadeButtonNode=e,scale:"s",text:e.expression,onClick:e=>{e.stopPropagation(),this.openArcadeEditor()}},(0,s.h)("calcite-icon",{scale:"s",icon:"code"}))))}renderFilter(){const{strings:e,serviceType:t}=this;return t===a.s.ogcFeature||t===a.s.parquet||t===a.s.wfs||t===a.s.subtype?(0,s.h)(s.F,null):(0,s.h)("calcite-label",null,e.filter,(0,s.h)("button",{ref:e=>this.filterButtonNode=e,class:"label-content-button",title:e.editLabelFilter,onClick:e=>{e.stopPropagation(),this.closePopovers(),this.labelContentFilterNode||this.openFilter()}},(0,s.h)("span",{class:"label-content-button-text"},e.editLabelFilter),(0,s.h)("span",{class:"label-content-button-icon"},(0,s.h)("calcite-icon",{scale:"s",icon:"chevron-down"}))))}renderStyle(){const{strings:e}=this;return(0,s.h)("calcite-label",null,e.labelStyle,(0,s.h)("button",{ref:e=>this.styleButtonNode=e,class:"label-content-button",title:e.editLabelStyle,onClick:e=>{e.stopPropagation(),this.openLabelStyleNode()}},(0,s.h)("span",{class:"label-content-button-text"},e.editLabelStyle),(0,s.h)("span",{class:"label-content-button-icon"},(0,s.h)("calcite-icon",{scale:"s",icon:"chevron-down"}))))}renderSlider(){const{strings:e}=this;return(0,s.h)("calcite-label",null,e.visibleRange,(0,s.h)("div",{ref:e=>{e&&this.addScaleRangeSlider(e)}}))}async loadAllModules(){const[e,t,i,s]=await Promise.all([(0,u.j)(),(0,u.d)(),(0,u.c)(),(0,u.aH)()]);this.modules={config:e,binLabelCreator:t,clusterLabelCreator:i,ScaleRangeSlider:s}}async getLabelFields(){const{layer:e,popupTemplate:t,layerDisplayType:i}=this;if(i===a.l.feature){const i=await(0,n.c)(e);if(t?.fieldInfos){let e=[];return i.filter((e=>["string","small-integer","big-integer","integer","single","double","long","date","date-only","time-only","timestamp-offset","oid","guid","global-id"].includes(e.type))).forEach((i=>{e=[...e,i.clone()];const s=t.fieldInfos.find((e=>e.fieldName===i.name));s&&(e[e.length-1].alias=s.label)})),e}return i}return(0,n.j)(t,!1)}async getLabelsForAggregationExpressions(e){const{modules:t,mapView:i,layer:s}=this;let o;o="binning"===s.featureReduction?.type?await t.binLabelCreator.getLabelSchemes({layer:s,field:e}):await t.clusterLabelCreator.getLabelSchemes({layer:s,renderer:s?.renderer,view:i,field:e});[o?.primaryScheme,...o?.secondarySchemes??[]].forEach((e=>{e&&this.aggregationExpressionMapping.set(e?.fieldName,e?.labelingInfo?.[0]?.labelExpressionInfo?.expression??"")}))}getDisplayFieldName(){const{layerDisplayType:e,labelClass:t,labelFields:i}=this,s=e===a.l.cluster?this.getFieldNameFromAggregationExpression():t.getLabelExpressionSingleField(),o=i.find((e=>e.name===s));return o?.alias||s}openRenameForm(){const{strings:e,labelClass:t}=this;this.labelRenameFormNode=document.createElement("arcgis-map-config-label-rename-form"),this.labelRenameFormNode.strings=e,this.labelRenameFormNode.refElement=this.el,this.labelRenameFormNode.currentLabelName=t.name||this.getDisplayFieldName()||e.label,document.body.appendChild(this.labelRenameFormNode),this.arcgisDisablePanel.emit(!0),this.labelRenameFormNode.addEventListener("arcgisChange",(e=>{e.stopPropagation(),this.closePopovers();const i=e.detail;i&&(t.name=i,(0,s.f)(this.el))}))}async openFieldPickList(){const{mapView:e,layer:t,labelClass:i,labelFields:s,layerDisplayType:o,calciteFlowItem:n}=this;if(this.closePopovers(),this.calciteFlowItem.loading=!0,!this.fieldPickListNode){this.fieldPickListNode=document.createElement("arcgis-field-pick-list"),this.fieldPickListNode.popoverProps={triggerDisabled:!0,refElement:n,offsetSkidding:50},this.fieldPickListNode.fields=s,this.fieldPickListNode.layer=t,this.fieldPickListNode.mapView=e,this.fieldPickListNode.showFieldInfo=o===a.l.feature;const l=i.getLabelExpressionSingleField()||this.getFieldNameFromAggregationExpression();this.fieldPickListNode.selectedFields=l?[l]:[],this.fieldPickListNode.addEventListener("arcgisClose",(e=>{e.stopPropagation();const t=e.detail?.selectedFields?.[0];this.handleFieldPickListChange(t)})),document.body.appendChild(this.fieldPickListNode),this.fieldPickListNode.setFocus(),this.arcgisDisablePanel.emit(!0)}this.calciteFlowItem.loading=!1}getFieldNameFromAggregationExpression(){const{labelClass:e,layerDisplayType:t}=this;if(t===a.l.cluster)for(const[t,i]of this.aggregationExpressionMapping)if(i===e?.labelExpressionInfo?.expression)return t}handleFieldPickListChange(e){const{layer:t,labelClass:i,layerDisplayType:o,serviceType:n}=this;if(e){if(n===a.s.mapImage)i.labelExpression=`[${e}]`;else if(o===a.l.cluster)if(this.aggregationExpressionMapping.has(e))i.labelExpressionInfo.expression=this.aggregationExpressionMapping.get(e);else for(const[t,s]of this.aggregationExpressionMapping)t===e&&(i.labelExpressionInfo.expression=s);else{const s=t.fields.find((t=>t.name===e));i.labelExpressionInfo="coded-value"===s?.domain?.type?{expression:`$feature["${e}"]\nDomainName($feature, "${e}")`,title:void 0}:{expression:`$feature["${e}"]`,title:void 0}}(0,s.f)(this.el)}this.closePopovers()}openFilter(){const{strings:e,mapView:t,layer:i,labelClass:o,layerDisplayType:a,calciteFlowItem:n}=this;this.labelContentFilterNode=document.createElement("arcgis-map-config-label-content-filter"),this.labelContentFilterNode.referenceElement=n,this.labelContentFilterNode.labelClass=o,this.labelContentFilterNode.strings=e,this.labelContentFilterNode.layer=i,this.labelContentFilterNode.mapView=t,this.labelContentFilterNode.layerDisplayType=a,document.body.appendChild(this.labelContentFilterNode),this.arcgisDisablePanel.emit(!0),this.labelContentFilterNode.addEventListener("arcgisChange",(e=>{e.stopPropagation(),(0,s.f)(this.el)})),this.labelContentFilterNode.addEventListener("arcgisClose",(e=>{e.stopPropagation(),this.closePopovers()}))}openLabelStyleNode(){const{strings:e,mapView:t,layer:i,labelClass:o,portal:a,layerDisplayType:n,serviceType:l,calciteFlowItem:r}=this;this.closePopovers(),this.labelStyleNode||(this.labelStyleNode=document.createElement("arcgis-map-config-label-content-style"),this.labelStyleNode.view=t,this.labelStyleNode.referenceElement=r,this.labelStyleNode.labelClass=o,this.labelStyleNode.strings=e,this.labelStyleNode.layer=i,this.labelStyleNode.portal=a,this.labelStyleNode.layerDisplayType=n,this.labelStyleNode.serviceType=l,document.body.appendChild(this.labelStyleNode),this.arcgisDisablePanel.emit(!0),this.labelStyleNode.addEventListener("arcgisChange",(e=>{e.stopPropagation(),(0,s.f)(this.el)})),this.labelStyleNode.addEventListener("arcgisClose",(e=>{e.stopPropagation(),this.closePopovers()})))}async openArcadeEditor(){const{strings:e,layer:t,portal:i,labelClass:s}=this;if(this.closePopovers(),!this.arcadeEditorNode){if(this.calciteFlowItem.disabled=!0,this.arcadeEditorNode=document.createElement("arcgis-map-config-modal-arcade"),this.arcadeEditorNode.arcadeScript=s.labelExpressionInfo?.expression||"",this.arcadeEditorNode.arcadeProfile=this.getArcadeProfile(),this.arcadeEditorNode.testData=await this.getArcadeTestData(),document.URL.includes("/mapviewer/")){const t=[{label:e.timeSeries,description:e.timeSeriesDescription,code:(0,f.g)()}];this.arcadeEditorNode.suggestions=[{label:e.suggestions,suggestions:t}]}this.arcadeEditorNode.layer=t,this.arcadeEditorNode.portal=i,this.arcadeEditorNode.arcadeTitle=s.labelExpressionInfo?.title||e.newExpression,this.arcadeEditorNode.arcadeTitleEditable=!0,this.arcadeEditorNode.arcadeTitleEditingEnabled=!s.labelExpressionInfo?.title,this.arcadeEditorNode.returnPredictOutputType=!1,this.arcadeEditorNode.addExistingExpressions=!0,document.body.appendChild(this.arcadeEditorNode),this.arcadeEditorNode.addEventListener("arcgisClose",(e=>this.arcadeSetup(e.detail)))}}getArcadeProfile(){const{layer:e,popupTemplate:t,layerDisplayType:i}=this;return{id:"labeling",definitions:{$feature:i===a.l.cluster?{fields:(0,n.j)(t,!1)}:e}}}async getArcadeTestData(){const{mapView:e,layer:t,popupTemplate:i,layerDisplayType:s}=this;try{if(s===a.l.cluster)return{profileVariableInstances:{$feature:await(0,n.k)(e,t,i),$view:{scale:"scale"in e?e.scale:void 0,timeProperties:e.timeExtent?{currentStart:e.timeExtent.start,currentEnd:e.timeExtent.end,startIncluded:!0,endIncluded:!0}:void 0}},spatialReference:e.spatialReference,timeZone:e.timeZone};let o;return o="subtype-sublayer"===t.type?t.parent.url:t.url,{profileVariableInstances:{$feature:(await(0,n.l)(t,e)).features[0],$layer:t,$map:e.map,$view:{scale:"scale"in e?e.scale:void 0,timeProperties:e.timeExtent?{currentStart:e.timeExtent.start,currentEnd:e.timeExtent.end,startIncluded:!0,endIncluded:!0}:void 0},$datastore:o},spatialReference:e.spatialReference,timeZone:e.timeZone}}catch(e){console.log(e)}}arcadeSetup(e){const{labelClass:t}=this;e&&(t.labelExpressionInfo?.expression?(t.labelExpressionInfo.expression=e.script,t.labelExpressionInfo.title=e.title):t.labelExpressionInfo={expression:e.script,title:e.title},(0,s.f)(this.el)),this.calciteFlowItem.disabled=!1,this.arcadeEditorNode&&(document.body.removeChild(this.arcadeEditorNode),this.arcadeEditorNode=void 0),this.arcadeButtonNode?.setFocus()}addScaleRangeSlider(e){const{modules:t,mapView:i,portal:o,labelClass:a,scaleRangeSlider:n}=this;n||(this.scaleRangeSlider=new t.ScaleRangeSlider({view:i,region:o.region||"wo",minScale:a.minScale||0,maxScale:a.maxScale||0,container:e}),this.scaleRangeSlider.watch(["minScale","maxScale"],((e,t,i)=>{"minScale"===i?a.minScale=e:"maxScale"===i&&(a.maxScale=e),this.closePopovers(),(0,s.f)(this.el)})))}closePopovers(){this.labelRenameFormNode&&(document.body.removeChild(this.labelRenameFormNode),this.labelRenameFormNode=void 0,this.mapConfigBlockOptionsNode?.setFocus()),this.fieldPickListNode&&(document.body.removeChild(this.fieldPickListNode),this.fieldPickListNode=void 0,this.attributesButtonNode?.focus()),this.labelContentFilterNode&&(document.body.removeChild(this.labelContentFilterNode),this.labelContentFilterNode=void 0,this.filterButtonNode?.focus()),this.labelStyleNode&&(document.body.removeChild(this.labelStyleNode),this.labelStyleNode=void 0,this.styleButtonNode?.focus()),this.mapConfigBlockOptionsNode?.closeDropdown(),this.arcgisDisablePanel.emit(!1)}get el(){return(0,s.a)(this)}};T.style=".field-expression-div {\n  align-items: center;\n  display: flex;\n  justify-content: space-between;\n  width: 100%;\n  border: 1px solid var(--calcite-color-foreground-3);\n  border-radius: var(--calcite-border-width-md);\n}\n\n.field-expression-div calcite-action {\n  flex: 0 0 auto;\n}\n\n.label-content-button {\n  background: var(--calcite-color-foreground-1);\n  border: 1px solid var(--calcite-color-foreground-3);\n  border-radius: var(--calcite-border-width-md);\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: var(--calcite-spacing-sm) var(--calcite-spacing-xxs);\n  cursor: pointer;\n  width: 100%;\n  text-align: unset;\n  transition:\n    background-color 75ms ease-in-out,\n    border-color 75ms ease-in-out;\n}\n\n.label-content-button:hover {\n  background-color: var(--calcite-color-foreground-3);\n  border-color: var(--calcite-color-border-3);\n}\n\n.non-simple-field-button {\n  width: calc(100% - 32px);\n  border: none;\n  border-radius: 0;\n  border-right: 1px solid var(--calcite-color-foreground-3);\n}\n\n.simple-field-button {\n  border: none;\n}\n\n.label-content-button-text {\n  font-family: var(--calcite-font-family);\n  font-size: var(--calcite-font-size);\n  flex: 0 1 auto;\n  overflow: hidden;\n  padding: 0 var(--calcite-spacing-xxs);\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.label-content-button-icon {\n  flex: 0 0 0%;\n  padding: 0 var(--calcite-spacing-sm);\n}\n\n.esri-scale-range-slider {\n  min-width: 100%;\n}\n\n:dir(rtl) {\n  .non-simple-field-button {\n    border-left: 1px solid var(--calcite-color-foreground-3);\n    border-right: 0;\n  }\n}\n";const x=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.arcgisClose=(0,s.c)(this,"arcgisClose",7),this.manager=(0,d.u)(this),this.strings=void 0,this.referenceElement=void 0,this.mapView=void 0,this.layer=void 0,this.labelClass=void 0,this.layerDisplayType=void 0}async reposition(){this.popoverNode?.reposition()}componentDidLoad(){this.sqlExpressionConfigNode?.setFocus()}render(){const{strings:e,mapView:t,layer:i,labelClass:o,layerDisplayType:n}=this;return(0,s.h)(s.H,{key:"8da4bdf8ba45308bcc6bc3b7c7fbf21a27f1ea05",class:"js-app-flyout"},(0,s.h)("calcite-popover",{key:"f5d15b8936ba21d6addf4fd579ae6a0ca6f8839c",dir:(0,m.b)(this.el),class:"popover",ref:e=>this.popoverNode=e,placement:"leading-start",open:!0,pointerDisabled:!0,referenceElement:this.referenceElement,offsetDistance:-Math.round(this.referenceElement.getBoundingClientRect().width),offsetSkidding:0,label:e.filter},(0,s.h)("arcgis-common-sql-expression-config",{key:"da4e23953309c281060e2a84b1432371c3e44294",ref:e=>this.sqlExpressionConfigNode=e,closable:!0,mode:n!==a.l.feature?"feature-reduction":void 0,labelClass:o,layer:i,view:t,hideLayerTitle:!0,style:{width:`${this.referenceElement.getBoundingClientRect().width}px`,height:this.referenceElement.getBoundingClientRect().height-2+"px"},onArcgisChange:e=>{e.stopPropagation(),this.labelClass.where=e.detail,this.arcgisChange.emit()},onArcgisClose:()=>this.arcgisClose.emit()})))}get el(){return(0,s.a)(this)}};x.style=".popover{--calcite-popover-z-index:100}";const L=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.arcgisClose=(0,s.c)(this,"arcgisClose",7),this.manager=(0,d.u)(this),this.resizeObserver=new ResizeObserver((e=>{const t=e.pop();this.hasNarrowReferenceElement=t.contentRect.width<=275,(0,s.f)(this.el)})),this.hasNarrowReferenceElement=!1,this.flipPercentLabels=!1,this.view=void 0,this.layer=void 0,this.portal=void 0,this.strings=void 0,this.layerDisplayType=a.l.feature,this.serviceType=void 0,this.referenceElement=void 0,this.labelClass=void 0}async reposition(){this.popoverNode?.reposition()}async componentWillLoad(){const{layer:e,serviceType:t,portal:i}=this;this.Color=await(0,u.ab)();const s=await(0,u.z)();this.layerGeometryType=await(0,n.b)(e),this.fontMap=t===a.s.mapImage?y.m:await(0,y.g)(i);const o=(0,m.b)(this.el),l=new Intl.NumberFormat(s.getLocale(),{style:"percent"}).format(0);this.flipPercentLabels="rtl"===o?l.endsWith("%"):l.startsWith("%")}componentDidLoad(){this.panelNode?.setFocus(),this.resizeObserver.observe(this.referenceElement)}disconnectedCallback(){this.fontPickerNode&&this.fontPickerNode.parentElement?.removeChild(this.fontPickerNode),this.resizeObserver.unobserve(this.referenceElement)}render(){const{strings:e,layer:t,layerDisplayType:i,layerGeometryType:o}=this,n=i===a.l.cluster&&"binning"===t.featureReduction?.type,l=!n,r=n||"polyline"!==o,p=!n&&"polyline"===o,c=this.referenceElement.getBoundingClientRect();return(0,s.h)(s.H,{key:"c5ed943ce6a4a01c2e9d3e0e0b21795b1e137392",class:"js-app-flyout"},(0,s.h)("calcite-popover",{key:"83386b944cdcb5421af87e0183724ffa5bd44105",class:"popover",placement:"leading-start",open:!0,pointerDisabled:!0,referenceElement:this.referenceElement,offsetDistance:-Math.round(c.width),offsetSkidding:50,label:e.labelStyle,triggerDisabled:!0,ref:e=>this.popoverNode=e},(0,s.h)("calcite-panel",{key:"bc3e0bdfcde1beef8405b6943b4ee0e998c1580b",ref:e=>this.panelNode=e,closable:!0,class:"panel",style:{width:c.width-2+"px",maxHeight:.8*c.height+"px"},onCalcitePanelClose:()=>this.arcgisClose.emit()},(0,s.h)("div",{key:"14fc208fdffbdc47240e2d8d7e531c1f75eb919f",slot:"header-content"},e.labelStyle),(0,s.h)("calcite-block",{key:"ad2bc1ebed25ff36d2c623fefb8d60b07e3cf781",heading:void 0,label:e.labelStyle,collapsible:!1,open:!0},this.renderFontFamilySelection(),this.renderFontSizeSelection(),this.renderColor(),this.renderTransparency(),this.renderHaloBlock(),this.renderBackgroundBlock(),l&&this.renderPlacement(),r&&this.renderOffset(),p?(0,s.h)(s.F,null,this.renderOverrunControl(),this.renderRepeatLabel(),this.renderRepeatDistance()):null))))}renderFontFamilySelection(){const{strings:e}=this;return(0,s.h)("calcite-label",null,e.font,(0,s.h)("calcite-button",{alignment:"icon-end-space-between",appearance:"outline-fill",kind:"neutral",iconEnd:"chevron-down",label:(0,y.f)(this.labelClass?.symbol?.font),width:"full",onClick:()=>this.openFontPopover(),ref:e=>this.fontNode=e},(0,y.f)(this.labelClass?.symbol?.font)))}renderFontSizeSelection(){const{strings:e}=this;return(0,s.h)("calcite-label",null,e.size,(0,s.h)("calcite-input-number",{scale:"s",inputMode:"decimal",min:5,max:125,value:`${this.labelClass.symbol.font.size/.75||5}`,onCalciteInputNumberInput:e=>{this.waitOnUser(e,(e=>{this.labelClass.symbol.font.size=.75*Number(e.value),this.arcgisChange.emit()}),5)}}))}renderColor(){const{strings:e}=this;return(0,s.h)("calcite-label",null,e.color,(0,s.h)("arcgis-color-input",{color:this.labelClass.symbol.color?.toHex()||"#ffffff",storageId:"arcgis-symbol-styler-storage-colors",popoverProps:{refElement:this.panelNode,placement:"leading-start",offsetDistance:-Math.round(this.referenceElement.getBoundingClientRect().width),offsetSkidding:50,maxHeight:.8*this.referenceElement.getBoundingClientRect().height-52+"px"},onArcgisChange:e=>{e.stopPropagation();const t=e.target.color,i=this.labelClass.symbol.color.a;this.labelClass.symbol.color=new this.Color(t),this.labelClass.symbol.color.a=i,this.arcgisChange.emit()},onArcgisPickerOpen:()=>{setTimeout((()=>{this.fontNode.disabled=!0,this.placementNode&&(this.placementNode.disabled=!0)}),200)},onArcgisPickerClose:()=>{this.fontNode.disabled=!1,this.placementNode&&(this.placementNode.disabled=!1)}}))}renderTransparency(){const{strings:e,flipPercentLabels:t}=this;return(0,s.h)("calcite-label",null,e.transparency,(0,s.h)("arcgis-slider-input",{min:0,max:100,step:1,unitsLabel:"%",flipLabels:t,value:Math.round((0,n.p)(this.labelClass.symbol.color?.a??1)),onArcgisValueChange:e=>{const t=e.detail,i=(0,n.t)(t);this.labelClass.symbol.color.a=i,this.arcgisChange.emit(),(0,s.f)(this.el)},withSteppers:!this.hasNarrowReferenceElement,label:e.transparency}))}renderHaloBlock(){const{strings:e}=this;return(0,s.h)("calcite-block-section",{text:e.halo,toggleDisplay:"switch",open:!!this.labelClass.symbol.haloColor,onCalciteBlockSectionToggle:e=>{e.stopPropagation(),this.handleHaloToggle()}},this.renderHaloColor(),this.renderHaloTransparency(),this.renderHaloSize())}renderHaloColor(){const{strings:e}=this;return(0,s.h)("calcite-label",null,e.color,(0,s.h)("arcgis-color-input",{color:this.labelClass.symbol.haloColor?.toHex()||"#ffffff",storageId:"arcgis-symbol-styler-storage-colors",popoverProps:{refElement:this.panelNode,placement:"leading-start",offsetDistance:-Math.round(this.referenceElement.getBoundingClientRect().width),offsetSkidding:50},onArcgisChange:e=>{e.stopPropagation();const t=e.target.color,i=this.labelClass.symbol.haloColor.a;this.labelClass.symbol.haloColor=new this.Color(t),this.labelClass.symbol.haloColor.a=i,this.arcgisChange.emit()},onArcgisPickerOpen:()=>{setTimeout((()=>{this.fontNode.disabled=!0,this.placementNode&&(this.placementNode.disabled=!0)}),200)},onArcgisPickerClose:()=>{this.fontNode.disabled=!1,this.placementNode&&(this.placementNode.disabled=!1)},ref:e=>this.haloColorNode=e}))}renderHaloTransparency(){const{strings:e,flipPercentLabels:t}=this;return(0,s.h)("calcite-label",null,e.transparency,(0,s.h)("arcgis-slider-input",{min:0,max:100,step:1,unitsLabel:"%",flipLabels:t,value:Math.round((0,n.p)(this.labelClass.symbol.haloColor?.a??1)),onArcgisValueChange:e=>{const t=e.detail,i=(0,n.t)(t);this.labelClass.symbol.haloColor.a=i,this.arcgisChange.emit(),(0,s.f)(this.el)},withSteppers:!this.hasNarrowReferenceElement,label:e.transparency}))}renderHaloSize(){const{strings:e}=this;return(0,s.h)("calcite-label",null,e.size,(0,s.h)("calcite-input-number",{scale:"s",inputMode:"decimal",min:1,max:10,value:""+(this.labelClass.symbol.haloSize??.75)/.75,onCalciteInputNumberInput:e=>{this.waitOnUser(e,(e=>{this.labelClass.symbol.haloSize=.75*Number(e.value),this.arcgisChange.emit()}),1)}}))}renderBackgroundBlock(){const{strings:e}=this;return"polyline"===this.layerGeometryType?(0,s.h)(s.F,null):(0,s.h)("calcite-block-section",{text:e.background,toggleDisplay:"switch",open:!!this.labelClass.symbol.backgroundColor,onCalciteBlockSectionToggle:e=>{e.stopPropagation(),this.handleBackgroundToggle()}},this.renderBackgroundColor(),this.renderBackgroundTransparency(),this.renderBackgroundOutlineColor(),this.renderBackgroundOutlineTransparency(),this.renderBackgroundOutlineSize())}renderBackgroundColor(){const{strings:e}=this;return(0,s.h)("calcite-label",null,e.color,(0,s.h)("arcgis-color-input",{color:this.labelClass.symbol.backgroundColor?.toHex()||"#ffffff",storageId:"arcgis-symbol-styler-storage-colors",popoverProps:{refElement:this.panelNode,placement:"leading-start",offsetDistance:-Math.round(this.referenceElement.getBoundingClientRect().width),offsetSkidding:50},onArcgisChange:e=>{e.stopPropagation();const t=e.target.color,i=this.labelClass.symbol.backgroundColor.a;this.labelClass.symbol.backgroundColor=new this.Color(t),this.labelClass.symbol.backgroundColor.a=i,this.arcgisChange.emit()},onArcgisPickerOpen:()=>{setTimeout((()=>{this.fontNode.disabled=!0,this.placementNode&&(this.placementNode.disabled=!0)}),200)},onArcgisPickerClose:()=>{this.fontNode.disabled=!1,this.placementNode&&(this.placementNode.disabled=!1)},ref:e=>this.backgroundColorNode=e}))}renderBackgroundTransparency(){const{strings:e,flipPercentLabels:t}=this;return(0,s.h)("calcite-label",null,e.transparency,(0,s.h)("arcgis-slider-input",{min:0,max:100,step:1,unitsLabel:"%",flipLabels:t,value:Math.round((0,n.p)(this.labelClass.symbol.backgroundColor?.a??1)),onArcgisValueChange:e=>{const t=e.detail,i=(0,n.t)(t);this.labelClass.symbol.backgroundColor.a=i,this.arcgisChange.emit(),(0,s.f)(this.el)},withSteppers:!this.hasNarrowReferenceElement,label:e.transparency}))}renderBackgroundOutlineColor(){const{strings:e}=this;return(0,s.h)("calcite-label",null,e.outlineColor,(0,s.h)("arcgis-color-input",{color:this.labelClass.symbol.borderLineColor?.toHex()||"#ffffff",storageId:"arcgis-symbol-styler-storage-colors",popoverProps:{refElement:this.panelNode,placement:"leading-start",offsetDistance:-Math.round(this.referenceElement.getBoundingClientRect().width),offsetSkidding:50},onArcgisChange:e=>{e.stopPropagation();const t=e.target.color,i=this.labelClass.symbol.borderLineColor.a;this.labelClass.symbol.borderLineColor=new this.Color(t),this.labelClass.symbol.borderLineColor.a=i,this.arcgisChange.emit()},onArcgisPickerOpen:()=>{setTimeout((()=>{this.fontNode.disabled=!0,this.placementNode&&(this.placementNode.disabled=!0)}),200)},onArcgisPickerClose:()=>{this.fontNode.disabled=!1,this.placementNode&&(this.placementNode.disabled=!1)},ref:e=>this.borderLineColorNode=e}))}renderBackgroundOutlineTransparency(){const{strings:e,flipPercentLabels:t}=this;return(0,s.h)("calcite-label",null,e.outlineTransparency,(0,s.h)("arcgis-slider-input",{min:0,max:100,step:1,unitsLabel:"%",flipLabels:t,value:Math.round((0,n.p)(this.labelClass.symbol.borderLineColor?.a??1)),onArcgisValueChange:e=>{const t=e.detail,i=(0,n.t)(t);this.labelClass.symbol.borderLineColor.a=i,this.arcgisChange.emit(),(0,s.f)(this.el)},withSteppers:!this.hasNarrowReferenceElement,label:e.transparency}))}renderBackgroundOutlineSize(){const{strings:e}=this;return(0,s.h)("calcite-label",null,e.outlineWidth,(0,s.h)("calcite-input-number",{id:"borderLineSizePicker_Id",scale:"s",inputMode:"decimal",min:0,max:18,value:""+(this.labelClass.symbol.borderLineSize??.75)/.75,onCalciteInputNumberInput:e=>{this.waitOnUser(e,(e=>{this.labelClass.symbol.borderLineSize=.75*Number(e.value),this.arcgisChange.emit()}),5)},ref:e=>this.borderLineSizeNode=e}))}renderPlacement(){const{strings:e,layerGeometryType:t,serviceType:i}=this,o=["multipoint","point","polyline"].includes(t),n=[a.s.csv,a.s.feature,a.s.geojson,a.s.mapImage,a.s.ogcFeature].includes(i);if(!o||!n)return(0,s.h)(s.F,null);const l=this.getPlacementArray();return(0,s.h)("calcite-label",{class:"placement-label"},e.placement,(0,s.h)("calcite-select",{label:e.placement,onCalciteSelectChange:e=>{this.labelClass.labelPlacement=e.currentTarget.selectedOption.value,this.arcgisChange.emit()},ref:e=>this.placementNode=e},l.map((t=>(0,s.h)("calcite-option",{value:t,selected:this.labelClass.labelPlacement===t},e[t]||t)))))}renderOffset(){const{strings:e}=this;return(0,s.h)("div",{class:"offset-div"},(0,s.h)("calcite-label",null,e.offset,(0,s.h)("arcgis-map-config-xy-slider",{ref:e=>this.xySliderNode=e,x:this.labelClass.symbol.xoffset||0,y:-this.labelClass.symbol.yoffset||0,minX:k,minY:E,maxX:I,maxY:F,step:1,snappable:!0,onArcgisInput:e=>{e.stopPropagation();const t=e.currentTarget;this.handleOffsetChange({x:t.x||0,y:-t.y||0})}})),(0,s.h)("div",null,(0,s.h)("calcite-label",{scale:"s"},e.offsetX,(0,s.h)("calcite-input-number",{scale:"s",placeholder:e.offsetX,value:`${this.labelClass.symbol.xoffset||0}`,inputMode:"decimal",min:k,max:I,ref:e=>this.offsetXNode=e,onCalciteInputNumberInput:e=>this.waitOnUser(e,(()=>{this.handleOffsetChange({x:Number(this.offsetXNode.value)||0,y:Number(this.offsetYNode.value)||0})}),0)})),(0,s.h)("calcite-label",{scale:"s"},e.offsetY,(0,s.h)("calcite-input-number",{scale:"s",placeholder:e.offsetY,value:`${this.labelClass.symbol.yoffset||0}`,inputMode:"decimal",min:E,max:F,ref:e=>this.offsetYNode=e,onCalciteInputNumberInput:e=>this.waitOnUser(e,(()=>{this.handleOffsetChange({x:Number(this.offsetXNode.value)||0,y:Number(this.offsetYNode.value)||0})}),0)}))))}renderOverrunControl(){const{strings:e}=this;return(0,s.h)("calcite-label",{alignment:"start",layout:"inline-space-between"},e.allowOverrun,(0,s.h)("calcite-switch",{scale:"s",checked:this.labelClass.allowOverrun,onCalciteSwitchChange:e=>{this.labelClass.allowOverrun=e.target.checked,this.arcgisChange.emit()}}))}renderRepeatLabel(){const{strings:e}=this;return(0,s.h)("calcite-label",{alignment:"start",layout:"inline-space-between"},e.repeatLabel,(0,s.h)("calcite-switch",{scale:"s",checked:this.labelClass.repeatLabel,onCalciteSwitchChange:e=>{this.labelClass.repeatLabel=e.target.checked,(0,s.f)(this.el),this.arcgisChange.emit()}}))}renderRepeatDistance(){const{strings:e}=this;return(0,s.h)("calcite-label",null,e.labelRepeat,(0,s.h)("calcite-input-number",{disabled:!this.labelClass.repeatLabel,scale:"s",inputMode:"decimal",min:0,value:`${this.labelClass.repeatLabelDistance||0}`,onCalciteInputNumberInput:e=>{this.waitOnUser(e,(e=>{this.labelClass.repeatLabelDistance=Number(e.value),this.arcgisChange.emit()}),0)}}))}getPlacementArray(){const{layer:e,layerDisplayType:t,layerGeometryType:i}=this;return t===a.l.cluster&&"binning"===e.featureReduction?.type?[]:"point"===i||"multipoint"===i?y.p:"polyline"===i?y.a:[]}openFontPopover(){if(!this.fontPickerNode){this.panelNode.disabled=!0,this.fontPickerNode=document.createElement("arcgis-map-config-font-picker"),this.fontPickerNode.enableMapSpecificFontList=!0,this.fontPickerNode.view=this.view,this.fontPickerNode.fontMap=this.fontMap,this.fontPickerNode.font=this.labelClass?.symbol?.font;const e=this.referenceElement.getBoundingClientRect();this.fontPickerNode.popoverProps={refElement:this.referenceElement,offsetSkidding:50,overlayPositioning:"fixed",maxHeight:.8*e.height+"px"},this.fontPickerNode.addEventListener("arcgisClose",(()=>this.closeFontPopover())),this.fontPickerNode.addEventListener("arcgisChange",(e=>{const t=e.detail;this.changeFont(t)})),document.body.appendChild(this.fontPickerNode)}}closeFontPopover(){this.panelNode.disabled=!1,this.fontPickerNode?.parentElement?.removeChild(this.fontPickerNode),this.fontPickerNode=void 0,this.panelNode?.setFocus()}changeFont(e){const t=this.labelClass?.symbol?.font;e&&t&&(t.family=e.family,t.weight=e.weight,t.style=e.style),(0,s.f)(this.el),this.arcgisChange.emit()}handleHaloToggle(){this.labelClass.symbol.haloColor?(this.tempHaloColor=this.labelClass.symbol.haloColor,this.labelClass.symbol.haloColor=null):(this.labelClass.symbol.haloColor=this.tempHaloColor??new this.Color("white"),this.labelClass.symbol.haloSize=.75*(this.labelClass.symbol.haloSize||1),this.haloColorNode.color=this.labelClass.symbol.haloColor?.toHex()||"#ffffff")}handleBackgroundToggle(){this.labelClass.symbol.backgroundColor?(this.tempBackgroundColor=this.labelClass.symbol.backgroundColor,this.tempBorderLineColor=this.labelClass.symbol.borderLineColor,this.tempBorderLineSize=this.labelClass.symbol.borderLineSize,this.labelClass.symbol.backgroundColor=null,this.labelClass.symbol.borderLineColor=null,this.labelClass.symbol.borderLineSize=null):(this.labelClass.symbol.backgroundColor=this.tempBackgroundColor||new this.Color("white"),this.backgroundColorNode.color=this.labelClass.symbol.backgroundColor?.toHex()||"#ffffff",this.labelClass.symbol.borderLineColor=this.tempBorderLineColor||new this.Color("white"),this.borderLineColorNode.color=this.labelClass.symbol.borderLineColor?.toHex()||"#ffffff",this.labelClass.symbol.borderLineSize=this.tempBorderLineSize??.75,this.borderLineSizeNode.value=""+(this.labelClass.symbol.borderLineSize??.75)/.75)}handleOffsetChange(e){this.labelClass.symbol.xoffset=e.x,this.offsetXNode.value=`${this.labelClass.symbol.xoffset}`,this.xySliderNode.x=e.x,this.labelClass.symbol.yoffset=e.y,this.offsetYNode.value=`${this.labelClass.symbol.yoffset}`,this.xySliderNode.y=-e.y,this.arcgisChange.emit()}waitOnUser(e,t,i){const s=e.target;this.typingHandle&&(clearTimeout(this.typingHandle),this.typingHandle=void 0);const o=s.value,a=Number.parseFloat(o);o?(0,n.i)(s.min)&&(0,n.i)(s.max)&&(s.min>a||s.max<a)?this.typingHandle=setTimeout((()=>{this.typingHandle=void 0,s.min>a?(s.value=`${s.min}`,t(s)):s.max<a&&(s.value=`${s.max}`,t(s))}),750):o.startsWith("-")&&(0===a||Number.isNaN(a))||t(s):this.typingHandle=setTimeout((()=>{this.typingHandle=void 0,s.value=`${i}`,t(s)}),2e3)}get el(){return(0,s.a)(this)}};L.style=".popover{--calcite-popover-z-index:100}.offset-div{align-items:center;display:flex;gap:16px;justify-content:space-between}.placement-label{margin-top:12px}";const S=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.manager=(0,d.u)(this),this.strings=void 0,this.refElement=void 0,this.currentLabelName=void 0}async reposition(){this.popoverNode?.reposition()}componentDidLoad(){this.panelNode?.setFocus()}render(){const{strings:e,currentLabelName:t}=this;return(0,s.h)(s.H,{key:"a5c010f7387cd2ddeeac872d0b627ef0c11fa63f",class:"js-app-flyout"},(0,s.h)("calcite-popover",{key:"555b751e6dc6104305478f39538767c687ff15b9",dir:(0,m.b)(this.el),class:"popover",placement:"leading-start",open:!0,pointerDisabled:!0,referenceElement:this.refElement,offsetDistance:-Math.round(this.refElement.getBoundingClientRect().width),offsetSkidding:0,label:e.popoverRenameHeader,ref:e=>this.popoverNode=e},(0,s.h)("calcite-panel",{key:"a13bbdd2f97089f3cedf414b3844b056868adcb2",ref:e=>this.panelNode=e,closable:!0,style:{width:`${this.refElement.getBoundingClientRect().width}px`},onCalcitePanelClose:()=>this.handleLabelNameChange(!1)},(0,s.h)("div",{key:"a8b3d50b12abcb66c623d1859d183812286422ab",slot:"header-content"},e.popoverRenameHeader),(0,s.h)("section",{key:"82d06fc7dd89a6ab650f2dbf2b7928691a1fda80",class:"rename-label-wrapper"},(0,s.h)("calcite-input",{key:"f5ff72342a27013a0bd70376843b763872424435",type:"text",required:!0,autofocus:!0,ref:e=>this.inputNode=e,value:t}),(0,s.h)("div",{key:"2a697c0166549fe9967846be83ba3bf82da7883e",class:"input-controls"},(0,s.h)("calcite-button",{key:"b056156ccdbda13e6d586729b2a249916a81b65b",scale:"m",label:e.ok,onClick:()=>this.handleLabelNameChange(!0)},e.ok),(0,s.h)("calcite-button",{key:"e5afda36bd8cfc0dd23ee3f1c18ffce3597f975c",appearance:"outline-fill",label:e.cancel,onClick:()=>this.handleLabelNameChange(!1)},e.cancel))))))}handleLabelNameChange(e){this.arcgisChange.emit(e?this.inputNode.value:null)}get el(){return(0,s.a)(this)}};async function A(e){const{layer:t,popupTemplate:i}=e,s=[];if(function(e){const{popupTemplate:t,layerDisplayType:i}=e;return i===a.l.feature&&("fields"!==(t?.content)[0]?.type||!!t.content[0]?.fieldInfos)}(e)){const e=(await(0,u.a)()).createFieldsContent({fields:await(0,n.c)(t),objectIdField:t.objectIdField,editFieldsInfo:t?.editFieldsInfo??void 0}).fieldInfos,o=new Map(i.fieldInfos.map((e=>[e.fieldName,e])));e.forEach((e=>{if(o.has(e.fieldName)){const t=o.get(e.fieldName);s.push(t.clone()),s[s.length-1].visible=!0}})),i.fieldInfos.forEach((e=>{(e.fieldName.includes(a.f.expression)||e.fieldName.includes(a.f.relationship))&&e.visible&&s.push(e.clone())}))}else i.fieldInfos.forEach((e=>{e.visible&&s.push(e.clone())}));return s}function D(e){let t=[...e.map?.allLayers?.toArray()||[],...e.map?.allTables?.toArray()||[]];return t.forEach((e=>{if("map-image"===e.type||"subtype-group"===e.type){const i=e;t=t.concat([...i.sublayers])}})),t}async function R(e,t,i){const s=e.capabilities?.queryRelated?.supportsCount,o=e.capabilities?.queryRelated?.supportsPagination;if([a.s.feature,a.s.scene,a.s.mapImage,a.s.subtype].includes(i)&&e?.relationships?.length&&s&&o)for(const i of e.relationships){const s=D(t);for(const t of s){const s=t;if(await B(e,s,i))return await s.load(),await Promise.resolve(!0)}}return await Promise.resolve(!1)}async function M(e,t){const{layer:i,mapView:s}=e;if(!i)return await Promise.resolve(!1);for(const e of i.relationships)if(e.id===t.relationshipId){const t=D(s);for(const s of t){const t=s;if(await B(i,t,e))return await t.load(),await Promise.resolve(!0)}return await Promise.resolve(!1)}return await Promise.resolve(!1)}async function B(e,t,i){const s=t.url?t.url===e.url||H(t)===H(e):"type"in t.parent&&"group"===t.parent.type&&"portalItem"in e&&t.parent?.portalItem?.id===e.portalItem?.id;["feature","scene"].includes(t.type)&&s&&"layerId"in t&&!(0,n.i)(t.layerId)&&await t.load();const o="sublayer"===t.type||"subtype-sublayer"===t.type;return await Promise.resolve(["feature","scene","sublayer","subtype-group","subtype-sublayer"].includes(t.type)&&s&&(!o&&t.layerId===i.relatedTableId||o&&t.id===i.relatedTableId))}function O(e,t,i){const s=t.url?t.url===e.url||H(t)===H(e):"type"in t.parent&&"group"===t.parent.type&&"portalItem"in e&&t.parent?.portalItem?.id===e.portalItem?.id,o="sublayer"===t.type||"subtype-sublayer"===t.type;return["feature","scene","sublayer","subtype-group","subtype-sublayer"].includes(t.type)&&s&&(!o&&t.layerId===i.relatedTableId||o&&t.id===i.relatedTableId)}function H(e){return["feature","subtype-sublayer"].indexOf(e.type)&&e.url.toLocaleLowerCase().endsWith("/featureserver")?e.url.substring(0,e.url.length-14):["feature","map-image","sublayer"].includes(e.type)&&e.url.toLocaleLowerCase().endsWith("/mapserver")?e.url.substring(0,e.url.length-10):["feature","map-image","sublayer"].includes(e.type)&&e.url.toLocaleLowerCase().includes("/mapserver/")?e.url.substring(0,e.url.toLocaleLowerCase().indexOf("/mapserver/")):"scene"===e.type&&e.url.toLocaleLowerCase().endsWith("/sceneserver")?e.url.substring(0,e.url.length-12):e.url}function U(){const e=(0,d.r)(),t=e;e.manager.onLoad((()=>{t.popupState=function(e,t){const i=_.get(e);if(i)return i;const s=(0,m.c)(e,t);if(s&&"store"in s)return _.set(e,s.store),s.store;return null}(e.el,"arcgis-map-config-popup").state}))}S.style=".popover{--calcite-popover-z-index:100}.rename-label-wrapper{padding:var(--calcite-spacing-sm)}.input-controls{display:flex;justify-content:flex-end;padding-top:var(--calcite-spacing-lg);width:100%}";const _=new WeakMap;const V=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.arcgisClose=(0,s.c)(this,"arcgisClose",7),this.arcgisMultiplePopupsSelected=(0,s.c)(this,"arcgisMultiplePopupsSelected",7),this.closePopupPopovers=(0,s.c)(this,"closePopupPopovers",7),this.manager=(0,d.u)(this),this.strings=(0,h.u)({blocking:!0}),this.hasError=!1,this.isPopupOpenForCurrentLayer=!1,this.popupComponents=[],this.fieldsAndExpressionsData=[],this.fieldsOnlyData=[],this.arcadeBlockOptionsNodes=[],this.relationshipBlockOptionsNodes=[],this.relationshipIconNodes=[],this.associationsBlockNodes=[],this.layerHasAttributes=!0,this.layerHasCharts=!0,this.layerHasImages=!0,this.layerHasText=!0,this.popupState=U(),this.handlePopupUpdate=(0,r.d)((e=>{if(this.mapView.popup?.selectedFeature&&this.mapView.popup?.selectedFeatureWidget?.flowItems?.length){const e=this.mapView.popup.selectedFeature;this.mapView.popup.features=[],setTimeout((()=>this.mapView.popup.features=[e]),1e3)}this.multiplePopupsSelected&&this.arcgisMultiplePopupsSelected.emit(),this.disableEditing||(e&&this.layer?.popupTemplate||this.serviceType===a.s.wms||(this.layerDisplayType===a.l.feature?this.layer.popupEnabled===this.enablePopupsSwitchNode?.checked&&(this.layer.popupTemplate=this.popupTemplate.clone()):this.layerDisplayType===a.l.cluster&&(this.layer.featureReduction.popupTemplate=this.popupTemplate.clone())),this.layerDisplayType===a.l.mapNotes?this.arcgisChange.emit({mapNotesPopupTemplate:this.mapNotesPopupEnabled?this.popupTemplate.clone():void 0}):this.arcgisChange.emit(),this.disableEditing=this.multiplePopupsSelected)}),1e3),this.mapView=void 0,this.layer=void 0,this.portal=void 0,this.config=void 0,this.showConfigureFields=!1,this.hideManageExpressions=!1,this.hidePopup=!1,this.hideLayerTitle=!1,this.backButton=!1,this.dismissible=!1,this.calciteFlowProps=void 0,this.layerDisplayType=a.l.feature,this.mapNotesPopupTemplate=void 0,this.mapNotesGraphic=void 0,this.multiplePopupsSelected=!1,this.disableEditing=!1,this.store=(0,b.c)({mapView:void 0,layer:void 0,portal:void 0,config:void 0,strings:void 0,popupTemplate:void 0,layerDisplayType:void 0,serviceType:void 0,layerHasAttributes:void 0,layerSupportsAttachments:void 0,layerHasCharts:void 0,layerHasImages:void 0,layerHasText:void 0,layerSupportsArcade:void 0,layerHasRelatedRecords:!1,layerIsUNLayer:void 0,layerHasEditInfo:void 0,blockFeatureReductionArcade:!1})}arcadeChangeNotificationHandler(){const e=Array.from(this.el.shadowRoot.querySelectorAll("arcgis-map-config-popup-richtext"));if(e?.length){const t=this.popupTemplate?.toJSON().expressionInfos.map((({expression:e,name:t,returnType:i,title:s})=>({name:`expression/${t}`,alias:"New expression"===s?" ":s,type:i,description:e})));this.fieldsAndExpressionsData=t?[...t,...this.fieldsOnlyData]:this.fieldsOnlyData,e.forEach((e=>{e.arcgisColorPickerData.data=this.fieldsAndExpressionsData,e.fieldExpressionData.data=this.fieldsAndExpressionsData}))}(0,s.f)(this.el)}closePopupPopoversHandler(){this.addContentPopoverNode&&(document.body.removeChild(this.addContentPopoverNode),this.addContentPopoverNode=void 0,this.activeCalciteFabNode.disabled=!1,this.activeCalciteFabNode.setFocus(),this.handleDisablePopupPanel(!1))}async setFocus(){this.activeCalciteFabNode?.setFocus()}async update(){this.handlePopupUpdate()}async done(){const e=Array.from(this.el.shadowRoot.querySelectorAll("arcgis-map-config-popup-multimedia"));await Promise.all(e.map((async e=>await e.resetMultimediaIndex()))),this.fieldsNode?.done(),this.closePopupPopovers.emit(),await this.showPreviewPopup(!1)}async componentWillLoad(){await this.loadAllModules();const{popupState:e}=this;if(this.serviceType=(0,n.a)(this.layer),this.layer&&"load"in this.layer&&await this.layer.load(),this.layerSupportsArcade=!this.hideManageExpressions&&(this.layerDisplayType===a.l.feature||this.layerDisplayType===a.l.cluster)&&this.serviceType!==a.s.ogcFeature&&this.serviceType!==a.s.imagery&&this.serviceType!==a.s.imageryTile&&this.serviceType!==a.s.wcs,this.serviceType===a.s.tile&&"url"in this.layer&&!("type"in this.layer)&&this.layer.url.indexOf(this.layer.layer.url)>-1)this.hasError=!0,console.error("popups not supported, no related feature service");else if(this.serviceType!==a.s.wms)if(this.layerDisplayType===a.l.feature){const t=this.mapView.popup.visible?this.mapView.popup.selectedFeature?.sourceLayer:void 0,i="type"in this.layer?this.layer.type:"sublayer";this.isPopupOpenForCurrentLayer="subtype-sublayer"===i?t?.subtypeCode===this.layer.subtypeCode&&t?.parent.id===this.layer.parent.id:"sublayer"===i?t?.id===this.layer.id&&t?.layer.id===this.layer.layer.id:"id"in this.layer&&t?.id===this.layer.id,this.popupTemplate=this.layer.popupTemplate?this.layer.popupTemplate.clone():this.layer.createPopupTemplate(),this.popupTemplate.fieldInfos=[...await(0,p.g)(this.layer,this.popupTemplate)],(0,n.i)(this.layer.capabilities?.data?.supportsAttachment)&&(this.layerSupportsAttachments=this.layer.capabilities.data.supportsAttachment),e.layerHasRelatedRecords=await R(this.layer,this.mapView,this.serviceType),this.layerHasEditInfo=!!this.layer.editFieldsInfo,this.serviceType!==a.s.mapImage||this.layer.popupTemplate||(this.layer.popupEnabled=!1)}else if(this.layerDisplayType===a.l.cluster)this.popupTemplate=this.layer.featureReduction.popupTemplate.clone(),this.layerSupportsAttachments=!1,this.layerHasEditInfo=!1;else if(this.layerDisplayType===a.l.mapNotes){if(this.mapNotesPopupTemplate)this.mapNotesPopupEnabled=!0,this.popupTemplate=this.mapNotesPopupTemplate.clone();else{this.mapNotesPopupEnabled=!1;const e=await(0,u.R)();this.popupTemplate=new e}this.layerHasAttributes=!1,this.layerSupportsAttachments=!1,this.layerHasCharts=!1,this.layerHasEditInfo=!1}this.calciteFlowProps?.calciteFab&&!this.isPopupEnabled()&&(this.calciteFlowProps.calciteFab.hidden=!0),e.layer=this.layer,e.mapView=this.mapView,e.portal=this.portal,e.config=this.config,e.strings=this.strings,e.popupTemplate=this.popupTemplate,e.layerDisplayType=this.layerDisplayType,e.serviceType=this.serviceType,e.layerHasAttributes=this.layerHasAttributes,e.layerSupportsAttachments=this.layerSupportsAttachments,e.layerHasCharts=this.layerHasCharts,e.layerHasImages=this.layerHasImages,e.layerHasText=this.layerHasText,e.layerSupportsArcade=this.layerSupportsArcade,e.layerIsUNLayer=(0,v.i)(this.popupState),e.layerHasEditInfo=this.layerHasEditInfo,e.blockFeatureReductionArcade=(0,C.d)(this.popupState),this.layerDisplayType===a.l.cluster&&(this.featureReductionArcadeHandle=this.getFeatureReductionArcadeHandle(e)),e.layerIsUNLayer&&(this.utilityNetworkLayerHandle=this.getUtilityNetworkLayerHandle(e))}async componentDidLoad(){const{strings:e}=this;if(this.popupTemplate){if("string"==typeof this.popupTemplate.content){const e=await(0,u.S)();this.popupTemplate.content=[new e({text:this.popupTemplate.content})]}Array.isArray(this.popupTemplate.content)?(await Promise.all(this.popupTemplate.content.map((async(e,t)=>{if("fields"===e.type){const t=await(0,n.c)(this.layer),i=(e.fieldInfos??await A(this.popupState)).filter((e=>{const i=t.find((t=>t.name===e.fieldName));return!i||i.visible}));e.fieldInfos=i,e.title=e.title??"",e.description=e.description??""}"attachments"!==e.type||this.layerSupportsAttachments||this.popupTemplate.content.splice(t,1)}))),this.popupTemplate.content.forEach((e=>this.addNewPopupContentToExistingPopupContent(e)))):console.error("content not supported"),(0,s.f)(this.el)}if(this.serviceType!==a.s.wms){if(this.layerDisplayType===a.l.feature&&this.watchForChangesToLayersList(),this.calciteFlowProps&&!this.calciteFlowProps.calciteFab){const t=document.createElement("calcite-fab");t.icon="plus",t.slot="fab",t.scale="s",t.appearance="outline-fill",t.kind="neutral",t.label=e.addContent,t.text=e.addContent,t.textEnabled=!0,this.isPopupEnabled()||(t.hidden=!0),this.calciteFlowProps.calciteFab=t,this.calciteFlowProps.calciteFlowItem.appendChild(t)}this.activeCalciteFabNode=this.calciteFlowProps?.calciteFab??this.internalCalciteFabNode,this.activeCalciteFabNode?.addEventListener("click",(e=>{e.stopPropagation(),this.closePopupPopovers.emit();const{popupState:t}=this;this.addContentPopoverNode||(this.addContentPopoverNode=document.createElement("arcgis-map-config-popup-add-content-popover"),this.addContentPopoverNode.referenceElement=this.activeCalciteFabNode,this.addContentPopoverNode.popupHasAttachmentInfo=this.popupTemplate.content.some((e=>"attachments"===e.type)),this.addContentPopoverNode.popoverPanelWidth=this.el.getBoundingClientRect().width,this.addContentPopoverNode.popupState=t,this.addContentPopoverNode.addEventListener("arcgisAddPopoverContent",(async e=>{const t=e.detail;await this.handleAddNewPopupContent(t)})),document.body.appendChild(this.addContentPopoverNode),this.activeCalciteFabNode.disabled=!0,this.handleDisablePopupPanel(!0))}))}this.wrappingFlowItemNode?.addEventListener("calciteFlowItemBack",(()=>this.closePopupPopovers.emit())),this.wrappingFlowItemNode?.setFocus(),this.setUpResizeObserver()}componentDidUpdate(){if(this.handlePopupUpdate(),this.scrollToNewPopupComponent){const e=this.el.shadowRoot.querySelectorAll("arcgis-map-config-block-options"),t=e[e.length-1];t?.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),t?.setFocus(),this.scrollToNewPopupComponent=!1}}async disconnectedCallback(){if(this.resizeObserver?.disconnect(),this.layerTableHandle?.remove(),this.featureReductionArcadeHandle?.remove(),this.utilityNetworkLayerHandle?.remove(),this.addContentPopoverNode?.parentElement?.removeChild(this.addContentPopoverNode),this.addContentPopoverNode=void 0,this.activeCalciteFabNode?.parentElement?.removeChild(this.activeCalciteFabNode),this.activeCalciteFabNode=void 0,this.fieldsNode?.parentElement){await this.fieldsNode.done();const e=this.fieldsNode.parentElement;e.parentElement?.removeChild(e),this.fieldsNode=void 0}if(this.expressionsNode?.parentElement){const e=this.expressionsNode.parentElement;e.parentElement?.removeChild(e),this.expressionsNode=void 0}}render(){const{strings:e,hasError:t,serviceType:i,calciteFlowProps:o,hideLayerTitle:n,dismissible:l}=this;return t?(0,s.h)(s.H,{class:"calcite-match-height"},o?(0,s.h)("div",{ref:()=>this.wrappingFlowItemNode=o.calciteFlowItem},this.renderPopupErrorMessage()):(0,s.h)("calcite-flow",{ref:e=>this.internalFlowNode=e},(0,s.h)("calcite-flow-item",{heading:e.popupHeading,closable:l,description:n?void 0:this.layer.title??void 0,onCalciteFlowItemClose:e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit()},ref:e=>this.wrappingFlowItemNode=e},this.renderPopupErrorMessage()))):(o&&(this.wrappingFlowItemNode=o.calciteFlowItem),(0,s.h)(s.H,{class:"calcite-match-height"},o?(0,s.h)(s.F,null,i===a.s.wms?this.renderEnablePopupSwitch():this.renderAllPopupContent()):(0,s.h)("calcite-flow",{customItemSelectors:"arcgis-map-config-popup-expressions",ref:e=>this.internalFlowNode=e},(0,s.h)("calcite-flow-item",{heading:e.popupHeading,closable:l,description:n?void 0:this.layer.title??void 0,onCalciteFlowItemBack:e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit()},onCalciteFlowItemClose:e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit()},ref:e=>this.wrappingFlowItemNode=e},this.renderBackButton(),i===a.s.wms?this.renderEnablePopupSwitch():this.renderAllPopupContent(),i!==a.s.wms&&this.renderAddContentFab()))))}renderPopupErrorMessage(){const{strings:e}=this;return(0,s.h)("div",{class:"error-notice"},(0,s.h)("calcite-notice",{open:!0,closable:!1,icon:"exclamation-mark-triangle",scale:"s"},(0,s.h)("div",{slot:"message"}," ",e.popupTileError)))}renderBackButton(){const{strings:e,backButton:t}=this;return t?(0,s.h)("calcite-action",{text:e.back,scale:"s",slot:"header-actions-start",onClick:e=>{e.stopPropagation(),this.done(),this.arcgisClose.emit()}},(0,s.h)("calcite-icon",{scale:"s",icon:"rtl"===(0,m.b)(this.el)?"chevron-right":"chevron-left"})):(0,s.h)(s.F,null)}renderEnablePopupSwitch(){const{strings:e,layerDisplayType:t}=this;return(0,s.h)("calcite-label",{class:"enable-popup-switch",alignment:"start",layout:"inline-space-between"},e.enablePopup,(0,s.h)("calcite-switch",{scale:"s",checked:this.isPopupEnabled(),onCalciteSwitchChange:e=>{const i=e.target.checked;switch(t){case a.l.feature:this.layer.popupEnabled=i;break;case a.l.cluster:this.layer.featureReduction.popupEnabled=i;break;case a.l.mapNotes:this.mapNotesPopupEnabled=i;break;default:this.layer.popupEnabled=i}this.showPopupContentInPanel(i),this.handlePopupUpdate(!0),t!==a.l.mapNotes&&i&&!this.layer.popupTemplate&&(this.layer.popupTemplate=this.popupTemplate),this.showPreviewPopup(i)},ref:e=>this.enablePopupsSwitchNode=e}))}renderAllPopupContent(){const{strings:e,layerHasEditInfo:t}=this;return(0,s.h)(s.F,null,this.renderEnablePopupSwitch(),(0,s.h)("div",{hidden:!this.isPopupEnabled(),ref:e=>this.popupContentWrapperNode=e},this.renderPopupOptions(),this.renderPopupTitle(),(0,s.h)("calcite-block-group",{dragEnabled:!0,label:e.popupHeading,onCalciteBlockGroupOrderChange:e=>{const t=e.detail.oldIndex,i=e.detail.newIndex,s=this.popupTemplate.content.splice(t,1)[0];this.popupTemplate.content.splice(i,0,s);const o=this.popupComponents.splice(t,1)[0];this.popupComponents.splice(i,0,o),this.handlePopupUpdate()}},this.popupComponents),t&&this.popupTemplate.lastEditInfoEnabled?(0,s.h)("div",{class:"edit-info-summary",ref:e=>this.editInfoDivNode=e},this.renderEditInfoSummary()):null))}renderPopupOptions(){const{strings:e,layerSupportsArcade:t,showConfigureFields:i,serviceType:o}=this,n=o===a.s.imagery;return n||t||i?(0,s.h)("calcite-block",{heading:e.options,open:!0,collapsible:!0},n&&this.renderImageryOptions(),t&&this.renderManageExpressionsButton(),i&&this.renderConfigureFieldsButton()):(0,s.h)(s.F,null)}renderImageryOptions(){const{layer:e}=this,t=!!e.capabilities?.operations?.supportsQuery&&e.fields?.length,i=e.hasMultidimensions,o=(0,n.e)(e)>=10.8&&(t||i);return(0,s.h)("div",{class:"imagery-options"},this.renderIgnoreNoData(),o&&this.renderDisplayTopmostRaster())}renderIgnoreNoData(){const{strings:e}=this;return(0,s.h)("calcite-label",{alignment:"start",layout:"inline-space-between"},e.ignoreNoData,(0,s.h)("calcite-switch",{scale:"s",checked:!this.popupTemplate?.layerOptions?.showNoDataRecords,onCalciteSwitchChange:e=>{const t=e.target.checked;this.popupTemplate?.layerOptions||this.createLayerOptions(),this.popupTemplate.layerOptions.showNoDataRecords=!t,this.handlePopupUpdate()}}))}renderDisplayTopmostRaster(){const{strings:e}=this;return(0,s.h)("calcite-label",{alignment:"start",layout:"inline-space-between"},e.displayTopmost,(0,s.h)("calcite-switch",{scale:"s",checked:this.popupTemplate?.layerOptions?.returnTopmostRaster??!0,onCalciteSwitchChange:e=>{const t=e.target.checked;this.popupTemplate?.layerOptions||this.createLayerOptions(),this.popupTemplate.layerOptions.returnTopmostRaster=t,this.handlePopupUpdate()}}))}renderManageExpressionsButton(){const{strings:e}=this;return(0,s.h)("calcite-button",{alignment:"icon-end-space-between",appearance:"transparent",kind:"neutral",iconEnd:"rtl"===(0,m.b)(this.el)?"chevron-left":"chevron-right",label:e.manageExpressions,width:"full",onClick:e=>{e.stopPropagation(),this.handleManageExpressionsClick()}},e.manageExpressions)}renderConfigureFieldsButton(){const{strings:e}=this;return(0,s.h)("calcite-button",{alignment:"icon-end-space-between",appearance:"transparent",kind:"neutral",iconEnd:"rtl"===(0,m.b)(this.el)?"chevron-left":"chevron-right",label:e.configureFields,width:"full",onClick:t=>{t.stopPropagation(),this.closePopupPopovers.emit();const i=document.createElement("calcite-flow-item");i.heading=e.attributes,i.description=this.layer.title,i.selected=!0,this.wrappingFlowItemNode.selected=!1,this.fieldsNode=document.createElement("arcgis-map-config-fields"),this.fieldsNode.mapView=this.mapView,this.fieldsNode.layer=this.layer,this.fieldsNode.portal=this.portal,this.fieldsNode.config=this.config,this.fieldsNode.layerDisplayType=this.layerDisplayType,this.fieldsNode.calciteFlowProps=!0,this.fieldsNode.hidePopup=!0,this.fieldsNode.addEventListener("arcgisChange",(async e=>{e.stopPropagation(),this.popupTemplate=this.layer.popupTemplate.clone(),this.popupComponents=[],this.popupTemplate.content.forEach((e=>this.addNewPopupContentToExistingPopupContent(e)));const t=Array.from(this.el.shadowRoot.querySelectorAll("arcgis-map-config-popup-attributes"));await Promise.all(t.map((async e=>await e.syncWithFieldsList()))),(0,s.f)(this.el),this.popupState.popupTemplate=this.popupTemplate})),i.appendChild(this.fieldsNode),i.addEventListener("calciteFlowItemBack",(async()=>{await(this.fieldsNode?.done()),i.parentElement?.removeChild(i),this.fieldsNode=void 0,this.wrappingFlowItemNode.selected=!0})),this.calciteFlowProps?this.calciteFlowProps.calciteFlow.appendChild(i):this.internalFlowNode?.appendChild(i),i.setFocus()}},e.configureFields)}renderPopupTitle(){return(0,s.h)("arcgis-map-config-popup-title",{referenceElement:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:e=>{e.stopPropagation(),this.handlePopupUpdate()}})}renderPopupAttributes(e,t){const{strings:i,popupTemplate:o}=this;return(0,s.h)("calcite-block",{key:(0,m.a)(),heading:i.fieldsList,open:t,collapsible:!0,description:e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||`${e.fieldInfos.length}/${o.fieldInfos.length} ${i.attributes_L}`},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-map-config-block-options",{options:{hasDelete:!0,hasDuplicate:!0},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e)})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"feature-details"})),(0,s.h)("arcgis-map-config-popup-attributes",{fieldsContent:e,popupFlowItem:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const{popupState:s}=this,{popupTemplate:o}=s,a=e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||`${e.fieldInfos.length}/${o.fieldInfos.length} ${i.attributes_L}`;t.target.parentElement.description=a,this.handlePopupUpdate()}}))}renderPopupAttachments(e,t){const{strings:i}=this,o=(0,n.i)(this.layer.capabilities?.attachment?.supportsResize)?this.layer.capabilities.attachment.supportsResize:!!this.layer?.capabilities?.operations?.supportsResizeAttachments,a=!!this.layer?.sourceJSON?.advancedQueryCapabilities?.supportsQueryAttachmentOrderByFields;return(0,s.h)("calcite-block",{key:(0,m.a)(),open:t,heading:i.attachments,description:e.title?`${e.title.substring(0,25)}${e.title.length>25?"...":""}`:this.getAttachmentContentDescription(e),collapsible:!0,onCalciteBlockToggle:()=>this.closePopupPopovers.emit()},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-map-config-block-options",{options:{hasDelete:!0,hasDuplicate:!0},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e)})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"attachment"})),(0,s.h)("arcgis-map-config-popup-attachments",{attachmentsContent:e,layerSupportsResizeAttachments:o,layerSupportsOrderingAttachments:a,popupFlowItem:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const i=e.title?`${e.title.substring(0,25)}${e.title.length>25?"...":""}`:this.getAttachmentContentDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderPopupMultimedia(e,t){const{strings:i}=this;return(0,s.h)("calcite-block",{key:(0,m.a)(),open:t,heading:e.mediaInfos.length>1?i.mediaGroup:i.media,description:e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||this.getMediaBlockDescription(e),collapsible:!0,onCalciteBlockToggle:()=>this.closePopupPopovers.emit()},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-map-config-block-options",{options:{hasDelete:!0,hasDuplicate:!0},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e)})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"images"})),(0,s.h)("arcgis-map-config-popup-multimedia",{blockOpen:t,mediaContent:e,popupFlowItem:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisChange:t=>{t.stopPropagation();const i=e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||this.getMediaBlockDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderPopupText(e,t){const{strings:i}=this,o=this.popupTemplate.toJSON(),a=o.fieldInfos?.map((({fieldName:e,label:t})=>({name:e,alias:t||e})));this.fieldsOnlyData=a||[];const n=this.popupTemplate?.toJSON().expressionInfos,l=n?.map((({expression:e,name:t,returnType:i,title:s})=>({name:`expression/${t}`,alias:"New expression"===s?" ":s,type:i,description:e})));return l?.length&&(this.fieldsOnlyData=this.fieldsOnlyData.filter((e=>!l.some((t=>t.name===e.name))))),this.fieldsAndExpressionsData=l?[...l,...this.fieldsOnlyData]:this.fieldsOnlyData,(0,s.h)("calcite-block",{key:(0,m.a)(),heading:i.text,open:t,collapsible:!0,description:this.getRichTextBlockDescription(e,25),onCalciteBlockToggle:()=>this.closePopupPopovers.emit()},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-map-config-block-options",{options:{hasDelete:!0,hasDuplicate:!0},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e)})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"text"})),(0,s.h)("arcgis-map-config-popup-richtext",{blockOpen:t,fieldExpressionData:{data:this.fieldsAndExpressionsData,placeholderText:i.searchFields,heading:i.selectField,label:i.fieldsListPluginName,mapView:this.mapView,layer:this.layer},arcgisColorPickerData:{data:this.fieldsAndExpressionsData,filterPlaceholder:i.searchAttributes,label:i.colorPicker,doneText:i.done,customText:i.customText,attributeText:i.attributeText},popupTextContent:e,popupFlowItem:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const i=this.getRichTextBlockDescription(e,25);t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderPopupArcade(e,t){const{strings:i}=this;return(0,s.h)("calcite-block",{key:(0,m.a)(),heading:i.arcade,description:e.expressionInfo.title??void 0,collapsible:!0,open:t},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-map-config-block-options",{options:{hasDelete:!0,hasDuplicate:!0,disableDuplicate:this.popupState.blockFeatureReductionArcade},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e),ref:e=>{e&&this.arcadeBlockOptionsNodes.push(e)}})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"code"})),(0,s.h)("arcgis-map-config-popup-arcade",{expressionContent:e,blockOpen:t,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const i=e.expressionInfo.title??"";t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderPopupRelationship(e,t){const{strings:i}=this,o=this.getRelationshipDescription(e);return(0,s.h)("calcite-block",{key:(0,m.a)(),heading:i.relatedRecords,open:t,collapsible:!0,description:o,onCalciteBlockToggle:()=>this.closePopupPopovers.emit()},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-map-config-block-options",{options:{hasDelete:!0,hasDuplicate:!0,disableDuplicate:!this.popupState.layerHasRelatedRecords},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e),ref:e=>{e&&this.relationshipBlockOptionsNodes.push(e)}})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:this.popupState.layerHasRelatedRecords?"link":"exclamation-mark-triangle",ref:e=>{e&&this.relationshipIconNodes.push(e)}})),(0,s.h)("arcgis-map-config-popup-relationship",{relationshipContent:e,popupFlowItem:this.wrappingFlowItemNode,onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const i=this.getRelationshipDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderPopupAssociations(e,t){const{strings:i}=this;return(0,s.h)("calcite-block",{key:(0,m.a)(),disabled:!this.popupState.layerIsUNLayer,heading:i.associations.associations,description:e.title?this.getAssociationsBlockCustomDescription(e.title):this.getAssociationsBlockDefaultDescription(e),collapsible:!0,open:this.popupState.layerIsUNLayer&&t,ref:e=>{e&&this.associationsBlockNodes.push(e)}},(0,s.h)("div",{slot:"control"},(0,s.h)("arcgis-map-config-block-options",{options:{hasDelete:!0,hasDuplicate:!1},onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onArcgisDuplicate:e=>this.handleDuplicateIndividualPopupContent(e)})),(0,s.h)("div",{slot:"icon"},(0,s.h)("calcite-icon",{icon:"view-associations"})),(0,s.h)("arcgis-map-config-popup-associations",{associationsContent:e,referenceElement:this.wrappingFlowItemNode,blockOpen:t,onArcgisDelete:e=>this.handleDeleteIndividualPopupContent(e),onDisablePopupPanel:e=>{const t=e.detail;this.handleDisablePopupPanel(t)},onArcgisChange:t=>{t.stopPropagation();const i=e.title?this.getAssociationsBlockCustomDescription(e.title):this.getAssociationsBlockDefaultDescription(e);t.target.parentElement.description=i,this.handlePopupUpdate()}}))}renderEditInfoSummary(){const{strings:e}=this;return(0,s.h)(s.F,null,(0,s.h)("calcite-icon",{class:"edit-info-icon",icon:"user"}),(0,s.h)("div",{class:"edit-info-text"},e.editInfoSummaryHeading),(0,s.h)("calcite-action",{text:e.remove,appearance:"transparent",icon:"x",onClick:e=>{e.stopPropagation(),this.closePopupPopovers.emit(),this.popupTemplate.lastEditInfoEnabled=!1,(0,s.f)(this.el),this.activeCalciteFabNode?.setFocus()}}))}renderAddContentFab(){const{strings:e}=this;return(0,s.h)("calcite-fab",{hidden:!this.isPopupEnabled(),icon:"plus",slot:"fab",scale:"s",appearance:"outline-fill",kind:"neutral",label:e.addContent,text:e.addContent,textEnabled:!0,ref:e=>this.internalCalciteFabNode=e})}async loadAllModules(){const[e,t,i,s,o,a,n,l,r,p,c,d,h]=await Promise.all([(0,u.l)(),(0,u.T)(),(0,u.U)(),(0,u.V)(),(0,u.W)(),(0,u.X)(),(0,u.Y)(),(0,u.Z)(),(0,u._)(),(0,u.S)(),(0,u.$)(),(0,u.a0)(),(0,u.a1)()]);this.modules={reactiveUtils:e,LayerOptions:t,FieldsContent:i,AttachmentsContent:s,MediaContent:o,ImageMediaInfo:a,ColumnChartMediaInfo:n,ImageMediaInfoValue:l,ChartMediaInfoValue:r,TextContent:p,ExpressionContent:c,RelationshipContent:d,UtilityNetworkAssociationsContent:h}}isPopupEnabled(){const{layerDisplayType:e,serviceType:t}=this;switch(e){case a.l.feature:return(t===a.s.wms||!!this.layer.popupTemplate)&&this.layer.popupEnabled;case a.l.cluster:return this.layer.featureReduction.popupEnabled;case a.l.mapNotes:return this.mapNotesPopupEnabled;default:return this.layer.popupEnabled}}showPopupContentInPanel(e){const{serviceType:t}=this;t!==a.s.wms&&(this.popupContentWrapperNode.style.display=e?"block":"none",this.activeCalciteFabNode.style.display=e?"block":"none"),this.closePopupPopovers.emit()}handleDisablePopupPanel(e){this.wrappingFlowItemNode.disabled=e}createLayerOptions(){const{modules:e}=this,t=this.popupTemplate.layerOptions??new e.LayerOptions;t.showNoDataRecords=t.showNoDataRecords??!1,t.returnTopmostRaster=t.returnTopmostRaster??!0,this.popupTemplate.layerOptions=t}async showPreviewPopup(e){const{layerDisplayType:t}=this;this.hidePopup||t!==a.l.feature||this.isPopupOpenForCurrentLayer?t===a.l.mapNotes&&(e&&this.mapNotesGraphic?this.mapView.openPopup({features:[this.mapNotesGraphic],location:(0,n.d)(this.mapNotesGraphic.geometry)}):this.mapView.closePopup()):e&&this.layer.popupEnabled&&this.layer.popupTemplate?(this.mapView.popup?.features?.length&&(this.mapView.closePopup(),this.mapView.popup.features=[]),this.previewPopupController=new AbortController,await(0,c.p)(this.mapView,this.layer,this.previewPopupController)):(this.previewPopupController?.abort(),this.mapView.closePopup())}async handleAddNewPopupContent(e){this.closePopupPopovers.emit(),e===P.C.EDIT_INFO_SUMMARY?(this.popupTemplate.lastEditInfoEnabled=!0,setTimeout((()=>{this.editInfoDivNode?.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),this.activeCalciteFabNode.setFocus()}),300)):await this.createNewPopupContent(e),(0,s.f)(this.el)}async createNewPopupContent(e){const{modules:t}=this;let i=null;if(e===P.C.ATTRIBUTES){const e=await(0,n.c)(this.layer),s=(await A(this.popupState)).filter((t=>{const i=e.find((e=>e.name===t.fieldName));return!i||i.visible}));i=new t.FieldsContent({fieldInfos:s,title:"",description:""})}else if(e===P.C.ATTACHMENTS)i=new t.AttachmentsContent({displayType:void 0});else if(e===P.C.CHARTS){const e=new t.ColumnChartMediaInfo({title:"",caption:"",altText:"",value:new t.ChartMediaInfoValue({fields:[]})});i=new t.MediaContent({mediaInfos:[e]})}else if(e===P.C.IMAGES){const e=new t.ImageMediaInfo({title:"",caption:"",altText:"",value:new t.ImageMediaInfoValue({sourceURL:"",linkURL:""})});i=new t.MediaContent({mediaInfos:[e]})}else if(e===P.C.RICH_TEXT)i=new t.TextContent({text:null});else if(e===P.C.ARCADE)i=new t.ExpressionContent({expressionInfo:{expression:(0,C.g)(this.layerDisplayType,this.strings)}});else if(e===P.C.RELATIONSHIP){const e=await async function(e,t,i){if([a.s.feature,a.s.scene,a.s.mapImage,a.s.subtype].includes(i)&&e?.relationships?.length)for(const i of e.relationships){const s=D(t);for(const t of s){const s=t;if(await B(e,s,i))return await s.load(),{relationship:i,currLayer:s}}}}(this.layer,this.mapView,this.serviceType);let s=e.currLayer.fields.find((e=>e.visible&&"date"===e.type));s||(s=e.currLayer.fields.find((e=>e.visible))),i=new t.RelationshipContent({displayCount:1,relationshipId:e.relationship.id,orderByFields:[{field:s.name,order:"asc"}]})}else if(e===P.C.ASSOCIATIONS){const e=[{type:"attachment"}];i=new t.UtilityNetworkAssociationsContent({associationTypes:e,displayCount:1,title:"",description:""})}this.popupTemplate.content.push(i),this.addNewPopupContentToExistingPopupContent(i,!0)}addNewPopupContentToExistingPopupContent(e,t=!1){t&&(this.scrollToNewPopupComponent=!0),"fields"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupAttributes(e,t)]:"attachments"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupAttachments(e,t)]:"media"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupMultimedia(e,t)]:"text"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupText(e,t)]:"expression"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupArcade(e,t)]:"relationship"===e.type?this.popupComponents=[...this.popupComponents,this.renderPopupRelationship(e,t)]:"utility-network-associations"===e.type&&(this.popupComponents=[...this.popupComponents,this.renderPopupAssociations(e,t)])}handleManageExpressionsClick(){const{strings:e}=this;this.closePopupPopovers.emit();const t=document.createElement("calcite-flow-item");t.heading=e.manageExpressions,t.selected=!0,this.expressionsNode=document.createElement("arcgis-map-config-popup-expressions"),this.expressionsNode.popupState=this.popupState,this.expressionsNode.addEventListener("arcgisChange",(e=>{e.stopPropagation(),this.handlePopupUpdate()})),t.appendChild(this.expressionsNode),t.addEventListener("calciteFlowItemBack",(()=>{t.parentElement?.removeChild(t),this.expressionsNode=void 0,this.wrappingFlowItemNode.selected=!0})),this.calciteFlowProps?this.calciteFlowProps.calciteFlow.appendChild(t):this.internalFlowNode?.appendChild(t),this.wrappingFlowItemNode.selected=!1,this.expressionsNode.setFocus()}handleDeleteIndividualPopupContent(e){this.closePopupPopovers.emit();const t=this.el.shadowRoot.querySelectorAll("arcgis-map-config-block-options"),i=e.target,o=Array.from(t).indexOf(i);this.popupTemplate.content.splice(o,1),this.popupComponents.splice(o,1),(0,s.f)(this.el),this.activeCalciteFabNode?.setFocus()}handleDuplicateIndividualPopupContent(e){this.closePopupPopovers.emit();const t=this.el.shadowRoot.querySelectorAll("arcgis-map-config-block-options"),i=e.target,o=Array.from(t).indexOf(i),a=this.popupTemplate.content[o].clone();this.popupTemplate.content.push(a),this.addNewPopupContentToExistingPopupContent(a,!0),(0,s.f)(this.el)}async setUpResizeObserver(){const{layerDisplayType:e}=this,t=this.el?.parentElement;if("CALCITE-SHELL-PANEL"===t?.tagName){const e=t;(0,n.i)(e.collapsed)&&(this.resizeObserver=new ResizeObserver((async()=>{if(e.collapsed)this.done();else{const{mapView:e}=this;e.popup?.active||await this.showPreviewPopup(!0)}})),this.resizeObserver.observe(e))}else(e!==a.l.mapNotes||(0,n.i)(this.mapNotesPopupTemplate))&&await this.showPreviewPopup(!0)}watchForChangesToLayersList(){const{modules:e,layerDisplayType:t,serviceType:i}=this;t===a.l.feature&&[a.s.feature,a.s.mapImage].includes(i)&&this.layer?.relationships?.length&&(this.layerTableHandle=e.reactiveUtils.watch((()=>[this.mapView.map?.allLayers.length,this.mapView.map?.allTables.length]),(async()=>{this.popupState.layerHasRelatedRecords=await R(this.layer,this.mapView,this.serviceType),this.relationshipBlockOptionsNodes?.forEach((e=>{e.options.disableDuplicate=!this.popupState.layerHasRelatedRecords,(0,s.f)(e)})),this.relationshipIconNodes?.forEach((e=>{e.icon=this.popupState.layerHasRelatedRecords?"link":"exclamation-mark-triangle"}))})))}getFeatureReductionArcadeHandle(e){const{modules:t}=this,{layer:i,mapView:o}=e;return t.reactiveUtils.watch((()=>o.scale),(()=>{const e=i.featureReduction;o.scale<=e.maxScale&&!this.popupState.blockFeatureReductionArcade?this.popupState.blockFeatureReductionArcade=!0:o.scale>e.maxScale&&this.popupState.blockFeatureReductionArcade&&(this.popupState.blockFeatureReductionArcade=!1),this.arcadeBlockOptionsNodes?.forEach((e=>{e.options.disableDuplicate=this.popupState.blockFeatureReductionArcade,(0,s.f)(e)}))}))}getUtilityNetworkLayerHandle(e){const{modules:t}=this,{mapView:i,layer:s}=e,{map:o}=i;return t.reactiveUtils.watch((()=>o.utilityNetworks?.length),(e=>{if(e){const e=(0,v.g)(s),t=o.utilityNetworks.find((t=>t.sourceJSON?.serviceItemId===e));this.popupState.layerIsUNLayer=(0,n.i)(t)}else this.popupState.layerIsUNLayer=!1;this.associationsBlockNodes?.forEach((e=>{e.disabled=!this.popupState.layerIsUNLayer,this.popupState.layerIsUNLayer||(e.open=!1)})),this.closePopupPopovers.emit()}))}getAttachmentContentDescription(e){const{popupState:t}=this,{strings:i}=t;switch(e.displayType){case P.A.AUTO:return i.auto;case P.A.LIST:return i.list;case P.A.PREVIEW:return i.gallery;default:return i.list}}getMediaBlockDescription(e){const{popupState:t}=this,{strings:i}=t;return e.mediaInfos.length>1?`${i.multiple} (${e.mediaInfos.length})`:e.mediaInfos.length?this.getMultimediaTypeString(e):""}getMultimediaTypeString(e){const t=e.mediaInfos[0].type,{popupState:i}=this,{strings:s}=i;return t===P.P.IMAGE?s.image:t===P.P.BAR_CHART||t===P.P.COLUMN_CHART?s.barChart:t===P.P.LINE_CHART?s.lineChart:t===P.P.PIE_CHART?s.pieChart:s.image}getRichTextBlockDescription(e,t){const i=e.text??"",s=document.createElement("div");s.innerHTML=i;const o=s.textContent||s.innerText||"";return`${o.substring(0,t)}${o.length>t?"...":""}`}getRelationshipDescription(e){const{popupState:t}=this,{strings:i,layer:s}=t,o=s.relationships.find((t=>t.id===e.relationshipId));return e.title?`${e.title.substring(0,25)}${e.title.length>25?"...":""}`:o?.name||i.selectTable}getAssociationsBlockDefaultDescription(e){const{strings:t}=this;return 1===e.associationTypes.length?this.getAssociationTypeString(e.associationTypes[0].type):`${t.multiple} (${e.associationTypes.length})`}getAssociationsBlockCustomDescription(e){return`${e.substring(0,25)}${e.length>25?"...":""}`}getAssociationTypeString(e){const{strings:t}=this;switch(e){case"attachment":return t.associations.attachment;case"connectivity":return t.associations.connectivity;case"container":return t.associations.container;case"content":return t.associations.content;case"structure":return t.associations.structure}}static get assetsDirs(){return["assets"]}get el(){return(0,s.a)(this)}};V.style=".error-notice{margin:var(--calcite-spacing-sm)}.enable-popup-switch{background-color:var(--calcite-color-foreground-1);padding:var(--calcite-spacing-lg) var(--calcite-spacing-sm) var(--calcite-spacing-xxs);border-bottom:solid 1px var(--calcite-color-foreground-3)}.imagery-options{padding:0 var(--calcite-spacing-md)}.edit-info-summary{display:flex;align-items:center;justify-content:space-between}.edit-info-icon{padding:0 var(--calcite-spacing-sm)}.edit-info-text{font-size:var(--calcite-font-size)}";const $=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.closePopupPopovers=(0,s.c)(this,"closePopupPopovers",7),this.disablePopupPanel=(0,s.c)(this,"disablePopupPanel",7),this.manager=(0,d.u)(this),this.popupState=U(),this.blockOpen=!1,this.expressionContent=void 0}async componentDidLoad(){this.blockOpen&&await this.launchArcade()}render(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)(s.H,{key:"44c6d46eb94ebf2086c1d593d19f78f83149b35a"},(0,s.h)("calcite-button",{key:"799c4f0e446aee4e45deec93984cb1e042955f24",disabled:e.blockFeatureReductionArcade,appearance:"transparent",width:"full",onClick:async()=>await this.launchArcade()},t.editExpression))}async launchArcade(){const{popupState:e}=this,{layer:t,mapView:i,portal:s,layerDisplayType:o,popupTemplate:a,serviceType:n,strings:l}=e;this.arcadeEditorNode||(this.disablePopupPanel.emit(!0),this.arcadeEditorNode=document.createElement("arcgis-map-config-modal-arcade"),this.arcadeEditorNode.arcadeProfile=await(0,C.a)(t,i,n,a,o),this.arcadeEditorNode.testData=await(0,C.b)(t,i,o,a),this.arcadeEditorNode.arcadeScript=(0,C.c)(this.expressionContent.expressionInfo?.expression,o,l),this.arcadeEditorNode.suggestions=(0,C.e)(t,l,"popupElement"),this.arcadeEditorNode.addExistingExpressions=!0,this.arcadeEditorNode.layer=t,this.arcadeEditorNode.portal=s,this.arcadeEditorNode.arcadeTitle=this.expressionContent.expressionInfo?.title||l.arcadeDefaultTitle,this.arcadeEditorNode.arcadeTitleEditable=!0,this.arcadeEditorNode.arcadeTitleEditingEnabled=!this.expressionContent.expressionInfo?.title,this.arcadeEditorNode.returnPredictOutputType=!1,document.body.appendChild(this.arcadeEditorNode),this.arcadeEditorNode.addEventListener("arcgisClose",(e=>{e.stopPropagation(),this.arcadeSetup(e.detail)})))}arcadeSetup(e){e&&(this.expressionContent.expressionInfo.expression=e.script,this.expressionContent.expressionInfo.title=e.title,(0,s.f)(this.el),this.arcgisChange.emit()),this.disablePopupPanel.emit(!1),this.arcadeEditorNode&&(document.body.removeChild(this.arcadeEditorNode),this.arcadeEditorNode=void 0)}get el(){return(0,s.a)(this)}},z=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.arcgisDelete=(0,s.c)(this,"arcgisDelete",7),this.closePopupPopovers=(0,s.c)(this,"closePopupPopovers",7),this.disablePopupPanel=(0,s.c)(this,"disablePopupPanel",7),this.manager=(0,d.u)(this),this.popupState=U(),this.referenceElement=void 0,this.blockOpen=!1,this.associationsContent=void 0}closePopupPopoversHandler(){this.associationConfigPopoverNode?.parentElement?.removeChild(this.associationConfigPopoverNode),this.associationConfigPopoverNode=void 0,this.pickListNode?.parentElement?.removeChild(this.pickListNode),this.pickListNode=void 0,this.disablePopupPanel.emit(!1)}componentDidLoad(){const{blockOpen:e,associationsContent:t}=this;e&&(this.addAssociationsButtonNode?.scrollIntoView({behavior:"auto",block:"nearest",inline:"start"}),1===t.associationTypes.length&&this.openAssociationConfigPopoverNode(t.associationTypes[0]))}componentDidUpdate(){this.arcgisChange.emit()}render(){const{popupState:e}=this,{strings:t}=e,{associationsContent:i}=this,o=v.a.every((e=>(0,n.i)(i.associationTypes.find((t=>t.type===e)))));return(0,s.h)(s.H,{key:"a776145eeaacb43a96b55391b6617a33756ed3f5"},this.renderFormInput(t.title,v.b.title,i.title,t.enterTitle,(e=>this.titleNode=e)),this.renderFormInput(t.desc,v.b.description,i.description,t.enterDescription,(e=>this.descriptionNode=e)),this.renderFormInput(t.associations.previewCount,v.b.displayCount,`${i.displayCount??""}`,t.associations.enterPreviewCount),(0,s.h)("calcite-label",{key:"e323c71ef62d843b730aaced36bdab63a2fd09d7",class:"disable-spacing",scale:"s"},t.associations.types),(0,s.h)("calcite-list",{key:"dee0d7f5a7b7138ed30e95e65882ccd5fdc3955d",label:t.associations.types,dragEnabled:!0,onCalciteListOrderChange:e=>{const t=e.detail.oldIndex,i=e.detail.newIndex;this.handleListOrderChange(t,i)}},this.associationsContent.associationTypes.map(((e,i)=>(0,s.h)("calcite-list-item",{key:e.type,label:e.title?this.getAssociationsBlockCustomDescription(e.title):t.noTitle,description:this.getAssociationTypeString(e.type),onClick:t=>{t.stopPropagation(),this.closePopupPopovers.emit(),this.openAssociationConfigPopoverNode(e)}},(0,s.h)("calcite-action",{slot:"actions-end",appearance:"transparent",text:t.remove,onClick:e=>{e.stopPropagation(),this.closePopupPopovers.emit(),this.associationsContent.associationTypes.splice(i,1),0===this.associationsContent.associationTypes.length?this.arcgisDelete.emit():this.arcgisChange.emit(),(0,s.f)(this.el)}},(0,s.h)("calcite-icon",{scale:"s",icon:"x"})))))),o?(0,s.h)(s.F,null):(0,s.h)("calcite-button",{ref:e=>this.addAssociationsButtonNode=e,title:t.associations.addAssociation,appearance:"outline-fill",round:!0,scale:"s",class:"add-association-button",iconStart:"plus",onClick:e=>{if(e.stopPropagation(),this.closePopupPopovers.emit(),!this.associationConfigPopoverNode){const e=this.associationsContent.associationTypes.map((e=>e.type)),t={type:v.a.filter((t=>!e.includes(t)))[0]};this.associationsContent.associationTypes.push(t),this.openAssociationConfigPopoverNode(t),this.arcgisChange.emit()}}}))}renderFormInput(e,t,i,o,a){const{popupState:n}=this,{strings:l,popupTemplate:r}=n;return(0,s.h)("calcite-label",{scale:"s"},e,t===v.b.displayCount?(0,s.h)("calcite-input-number",{autofocus:!0,integer:!0,min:0,max:100,value:i,placeholder:o,onCalciteInputNumberInput:e=>{e.stopPropagation();const t=e.target,i=t.value,s=this.associationsContent.displayCount,o=Number.parseInt(i);s!==o&&(Number.isNaN(o)?(this.associationsContent.displayCount=null,t.value=""):o>t.max?(this.associationsContent.displayCount=t.max,t.value=`${t.max}`):o<t.min?(this.associationsContent.displayCount=t.min,t.value=`${t.min}`):this.associationsContent.displayCount=o,this.arcgisChange.emit())},onClick:()=>this.closePopupPopovers.emit()}):(0,s.h)("div",{class:"form-input-button"},t===v.b.title?(0,s.h)("calcite-input",{class:"input",type:"text",autofocus:!0,value:i,placeholder:o,onCalciteInputInput:e=>{e.stopPropagation();const t=e.target.value;this.associationsContent.title=t,this.arcgisChange.emit()},onClick:()=>this.closePopupPopovers.emit(),ref:a}):(0,s.h)("calcite-text-area",{resize:"vertical",autofocus:!0,value:i,placeholder:o,onCalciteTextAreaInput:e=>{e.stopPropagation();const t=e.target.value;this.associationsContent.description=t,(0,s.f)(this.el),this.arcgisChange.emit()},ref:a}),r.fieldInfos?.length?(0,s.h)("calcite-action",{text:l.attributes,scale:"s",icon:"brackets-curly",onClick:()=>{const{popupState:e}=this;this.closePopupPopovers.emit(),this.pickListNode||(this.pickListNode=document.createElement("arcgis-map-config-popup-field-pick-list"),this.pickListNode.popupState=e,this.pickListNode.popoverProps={refElement:this.referenceElement,offsetSkidding:50},this.pickListNode.heading=l.addField,this.pickListNode.multiple=!1,this.pickListNode.addEventListener("arcgisChange",(e=>{e.stopPropagation();const i=e.detail.selectedFields[0];this.handlePickListChange(i,t)})),this.pickListNode.addEventListener("arcgisClose",(e=>{e.stopPropagation(),this.closePopupPopovers.emit()})),document.body.appendChild(this.pickListNode),this.disablePopupPanel.emit(!0))}}):(0,s.h)(s.F,null)))}handleListOrderChange(e,t){const i=this.associationsContent.associationTypes[e];this.associationsContent.associationTypes.splice(e,1),this.associationsContent.associationTypes.splice(t,0,i),this.arcgisChange.emit(),this.closePopupPopovers.emit(),(0,s.f)(this.el)}getAssociationsBlockCustomDescription(e){return`${e.substring(0,25)}${e.length>25?"...":""}`}getAssociationTypeString(e){const{popupState:t}=this,{strings:i}=t;switch(e){case"attachment":return i.associations.attachment;case"connectivity":return i.associations.connectivity;case"container":return i.associations.container;case"content":return i.associations.content;case"structure":return i.associations.structure}}handlePickListChange(e,t){t===v.b.title?((0,v.c)(this.titleNode,e),this.associationsContent.title=this.titleNode.value):((0,v.c)(this.descriptionNode,e),this.associationsContent.description=this.descriptionNode.value),this.closePopupPopovers.emit(),this.arcgisChange.emit()}openAssociationConfigPopoverNode(e){const{popupState:t}=this;this.associationConfigPopoverNode=document.createElement("arcgis-map-config-popup-association-config-popover"),this.associationConfigPopoverNode.popupState=t,this.associationConfigPopoverNode.referenceElement=this.referenceElement,this.associationConfigPopoverNode.associationsContent=this.associationsContent,this.associationConfigPopoverNode.associationType=e,this.associationConfigPopoverNode.addEventListener("arcgisChange",(e=>{e.stopPropagation(),(0,s.f)(this.el)})),document.body.appendChild(this.associationConfigPopoverNode),this.disablePopupPanel.emit(!0)}get el(){return(0,s.a)(this)}};z.style=".disable-spacing{--calcite-label-margin-bottom:0}.form-input-button{display:flex}.input{width:100%}calcite-text-area{width:100%;--calcite-text-area-min-width:0;--calcite-text-area-min-height:42px}.add-association-button{display:flex;justify-content:center;margin-top:var(--calcite-spacing-sm)}";const W=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.closePopupPopovers=(0,s.c)(this,"closePopupPopovers",7),this.disablePopupPanel=(0,s.c)(this,"disablePopupPanel",7),this.manager=(0,d.u)(this),this.attachmentSortOptionsMap=new Map,this.popupState=U(),this.popupFlowItem=void 0,this.blockOpen=!1,this.attachmentsContent=void 0,this.layerSupportsResizeAttachments=void 0,this.layerSupportsOrderingAttachments=void 0}closePopupPopoversHandler(){this.pickListNode&&(document.body.removeChild(this.pickListNode),this.pickListNode=void 0,this.disablePopupPanel.emit(!1))}componentWillLoad(){this.setUpAttachmentSortByMap(),this.layerSupportsResizeAttachments?this.attachmentsContent.displayType||(this.attachmentsContent.displayType=P.A.AUTO,this.arcgisChange.emit()):this.attachmentsContent.displayType=P.A.LIST,this.attachmentsContent.title=this.attachmentsContent.title||"",this.attachmentsContent.description=this.attachmentsContent.description||""}componentDidUpdate(){this.arcgisChange.emit()}disconnectedCallback(){this.pickListNode&&document.body.removeChild(this.pickListNode)}render(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)(s.H,{key:"82c4248bda36a95d56d5692c1ba29eb6b6a6f2d8"},this.renderAttachmentDisplayType(),(0,s.h)("div",{key:"f6bafe9f7e3950cf9ebd9102f8f66e1f826dad9e"},this.renderFormInput("title",t.title,this.attachmentsContent.title,t.enterTitle,(e=>this.attachmentsTitleNode=e)),this.renderFormInput("description",t.desc,this.attachmentsContent.description,t.enterDescription,(e=>this.attachmentsDescriptionNode=e)),this.layerSupportsOrderingAttachments&&this.renderSortBy(),this.layerSupportsOrderingAttachments&&this.renderSortOrder(),!this.layerSupportsResizeAttachments&&this.renderListOnlyMessage()))}renderAttachmentDisplayType(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)("calcite-label",null,t.displayAttachmentsAs,(0,s.h)("calcite-segmented-control",{width:"full",scale:"s",disabled:!this.layerSupportsResizeAttachments,onCalciteSegmentedControlChange:e=>{const t=e.target.selectedItem;this.attachmentsContent.displayType=t.value,(0,s.f)(this.el)}},(0,s.h)("calcite-segmented-control-item",{value:P.A.AUTO,iconStart:"check",checked:this.attachmentsContent.displayType===P.A.AUTO},t.auto),(0,s.h)("calcite-segmented-control-item",{value:P.A.LIST,iconStart:"list",checked:this.attachmentsContent.displayType===P.A.LIST},t.list),(0,s.h)("calcite-segmented-control-item",{value:P.A.PREVIEW,iconStart:"image",checked:this.attachmentsContent.displayType===P.A.PREVIEW},t.gallery)),(0,s.h)("calcite-label",{scale:"s"},this.getDisplayTypeMessage()))}renderFormInput(e,t,i,o,a){const{popupState:n}=this,{strings:l,popupTemplate:r}=n;return(0,s.h)("calcite-label",{scale:"s"},t,(0,s.h)("div",{class:"form-input-button"},"title"===e?(0,s.h)("calcite-input",{class:"input",type:"text",autofocus:!0,value:i,placeholder:o,onCalciteInputInput:e=>{e.stopPropagation();const t=e.target.value;this.attachmentsContent.title=t,(0,s.f)(this.el)},onClick:()=>this.closePopupPopovers.emit(),ref:a}):(0,s.h)("calcite-text-area",{resize:"vertical",autofocus:!0,value:i,placeholder:o,onCalciteTextAreaInput:e=>{e.stopPropagation();const t=e.target.value;this.attachmentsContent.description=t,(0,s.f)(this.el),this.arcgisChange.emit()},ref:a}),r.fieldInfos?.length&&(0,s.h)("calcite-action",{text:l.attributes,scale:"s",icon:"brackets-curly",onClick:()=>{const{popupState:t}=this;this.closePopupPopovers.emit(),this.pickListNode||(this.pickListNode=document.createElement("arcgis-map-config-popup-field-pick-list"),this.pickListNode.popoverProps={refElement:this.popupFlowItem},this.pickListNode.multiple=!1,this.pickListNode.heading=l.addField,this.pickListNode.popupState=t,this.pickListNode.addEventListener("arcgisChange",(t=>{t.stopPropagation();const i=t.detail.selectedFields[0];this.handlePickListChange(i,e)})),this.pickListNode.addEventListener("arcgisClose",(e=>{e.stopPropagation(),this.closePopupPopovers.emit()})),document.body.appendChild(this.pickListNode),this.disablePopupPanel.emit(!0))}})))}renderSortBy(){const{popupState:e,attachmentSortOptionsMap:t}=this,{strings:i}=e,o=(0,n.i)(this.attachmentsContent.orderByFields?.[0]),a=Array.from(t.entries()).map((([e,t])=>{const a=o?this.attachmentsContent.orderByFields[0].field===t:"id"===e;return(0,s.h)("calcite-dropdown-item",{selected:a,onClick:()=>{o?this.attachmentsContent.orderByFields[0].field=t:this.attachmentsContent.orderByFields=[{field:t,order:"ascending"}],(0,s.f)(this.el)}},i[e])}));return(0,s.h)("calcite-label",null,i.sortBy,(0,s.h)("calcite-dropdown",{overlayPositioning:"fixed"},(0,s.h)("calcite-button",{slot:"trigger",appearance:"outline-fill",kind:"neutral",iconEnd:"chevronDown",alignment:"icon-end-space-between",width:"full"},o?i[Array.from(t.entries()).find((([,e])=>this.attachmentsContent.orderByFields[0].field===e))[0]]:i.id),a))}renderSortOrder(){const{popupState:e}=this,{strings:t}=e,i=(0,n.i)(this.attachmentsContent.orderByFields?.[0]);return(0,s.h)("calcite-label",null,t.sortOrder,(0,s.h)("calcite-dropdown",{overlayPositioning:"fixed"},(0,s.h)("calcite-button",{slot:"trigger",appearance:"outline-fill",kind:"neutral",iconEnd:"chevronDown",alignment:"icon-end-space-between",width:"full"},i?t[this.attachmentsContent.orderByFields[0].order]:t.ascending),(0,s.h)("calcite-dropdown-item",{selected:!i||"ascending"===this.attachmentsContent.orderByFields[0].order,onClick:()=>{i?this.attachmentsContent.orderByFields[0].order="ascending":this.attachmentsContent.orderByFields=[{field:this.attachmentSortOptionsMap.get("id"),order:"ascending"}],(0,s.f)(this.el)}},t.ascending),(0,s.h)("calcite-dropdown-item",{selected:"descending"===this.attachmentsContent.orderByFields?.[0]?.order,onClick:()=>{i?this.attachmentsContent.orderByFields[0].order="descending":this.attachmentsContent.orderByFields=[{field:this.attachmentSortOptionsMap.get("id"),order:"descending"}],(0,s.f)(this.el)}},t.descending)))}renderListOnlyMessage(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)("div",{class:"list-warning-wrapper"},(0,s.h)("span",{class:"list-warning-icon"},(0,s.h)("calcite-icon",{scale:"s",icon:"exclamation-mark-triangle"})),(0,s.h)("span",{class:"list-warning-text"},t.layerOnlySupportsListView))}setUpAttachmentSortByMap(){const{popupState:e}=this,{layer:t}=e;if(this.attachmentSortOptionsMap.set("id","ATTACHMENTID"),this.attachmentSortOptionsMap.set("contentType","CONTENT_TYPE"),this.attachmentSortOptionsMap.set("name","ATT_NAME"),this.attachmentSortOptionsMap.set("size","DATA_SIZE"),"fields"in t){t.fields.find((e=>"global-id"===e.type))&&this.attachmentSortOptionsMap.set("globalId","AttachmentGlobalId")}}getDisplayTypeMessage(){const{popupState:e}=this,{strings:t}=e;switch(this.attachmentsContent.displayType){case P.A.AUTO:return t.autoDisplayMessage;case P.A.LIST:return t.listDisplayMessage;case P.A.PREVIEW:return t.previewDisplayMessage;default:return t.listDisplayMessage}}handlePickListChange(e,t){"title"===t?((0,v.c)(this.attachmentsTitleNode,e),this.attachmentsContent.title=this.attachmentsTitleNode.value):"description"===t&&((0,v.c)(this.attachmentsDescriptionNode,e),this.attachmentsContent.description=this.attachmentsDescriptionNode.value),this.closePopupPopovers.emit(),(0,s.f)(this.el)}get el(){return(0,s.a)(this)}};W.style=".form-input-button{display:flex}.input{width:100%}calcite-text-area{width:100%;--calcite-text-area-min-width:0;--calcite-text-area-min-height:42px}.list-warning-wrapper{border:1px solid var(--calcite-color-foreground-3);display:flex;font-size:var(--calcite-font-size-sm)}.list-warning-icon{display:flex;align-items:center;padding:0 var(--calcite-spacing-sm);background-color:var(--calcite-color-foreground-2)}.list-warning-text{padding:var(--calcite-spacing-xs) var(--calcite-spacing-sm)}";const j=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.closePopupPopovers=(0,s.c)(this,"closePopupPopovers",7),this.disablePopupPanel=(0,s.c)(this,"disablePopupPanel",7),this.manager=(0,d.u)(this),this.arcadeExpMap=new Map,this.listItems=[],this.popupState=U(),this.popupFlowItem=void 0,this.fieldsContent=void 0}arcadeChangeNotificationHandler(){(0,s.f)(this.el)}closePopupPopoversHandler(){this.selectFieldsPickListNode&&(document.body.removeChild(this.selectFieldsPickListNode),this.selectFieldsPickListNode=void 0,this.blockOptionsNode?.setFocus(),this.disablePopupPanel.emit(!1)),this.fieldsContentPickListNode&&(document.body.removeChild(this.fieldsContentPickListNode),this.fieldsContentPickListNode=void 0,this.disablePopupPanel.emit(!1))}async syncWithFieldsList(){this.fieldsContent.fieldInfos.forEach(((e,t)=>{this.fieldInfoMap.has(e.fieldName)&&(this.fieldsContent.fieldInfos[t]=this.fieldInfoMap.get(e.fieldName).clone(),this.fieldsContent.fieldInfos[t].visible=!0)})),(0,s.f)(this.el)}componentWillLoad(){this.setUpFieldMapInfo()}componentWillRender(){const{popupState:e}=this,{popupTemplate:t}=e;this.setUpFieldMapInfo(),this.arcadeExpMap=(0,n.m)(t),this.listItems=[],this.fieldsContent.fieldInfos.forEach((e=>this.listItems.push(this.renderListItem(e))))}componentDidUpdate(){this.arcgisChange.emit()}disconnectedCallback(){this.selectFieldsPickListNode&&document.body.removeChild(this.selectFieldsPickListNode),this.fieldsContentPickListNode&&document.body.removeChild(this.fieldsContentPickListNode)}render(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)(s.H,{key:"5ee54dba9cba4fbefd95f775b81d41bb89ca9a09"},this.renderFormInput("title",t.title,this.fieldsContent.title,t.enterTitle,(e=>this.titleNode=e)),this.renderFormInput("description",t.desc,this.fieldsContent.description,t.enterDescription,(e=>this.descriptionNode=e)),(0,s.h)("calcite-button",{key:"2cdd8df22a4d0e4a767e3c06c90c76652023e5e2",class:"select-fields-button",appearance:"transparent",width:"full",onClick:e=>{e.stopPropagation(),this.openSelectFieldsPickList()}},t.selectAttributes),(0,s.h)("calcite-list",{key:"1e1e07060623c008c5826e7e27a97c0e8794e57f",label:t.attributes,dragEnabled:!0,onCalciteListOrderChange:e=>{const t=e.target,i=[];t.childNodes.forEach((e=>{this.fieldsContent.fieldInfos.forEach((t=>{t.fieldName===e.value&&i.push(t)}))})),this.fieldsContent.fieldInfos=i,this.arcgisChange.emit()}},this.listItems))}renderListItem(e){const{popupState:t}=this,{strings:i}=t;return(0,s.h)("calcite-list-item",{key:e.fieldName,label:(0,n.o)(e,this.arcadeExpMap),value:e.fieldName},(0,s.h)("calcite-action",{slot:"actions-end",appearance:"transparent",text:i.remove,onClick:()=>this.removeField(e.fieldName)},(0,s.h)("calcite-icon",{scale:"s",icon:"x"})))}renderFormInput(e,t,i,o,a){const{popupState:n}=this,{strings:l,popupTemplate:r}=n;return(0,s.h)("calcite-label",{scale:"s"},t,(0,s.h)("div",{class:"form-input-button"},"title"===e?(0,s.h)("calcite-input",{class:"input",type:"text",autofocus:!0,value:i,placeholder:o,onCalciteInputInput:e=>{e.stopPropagation();const t=e.target.value;this.fieldsContent.title=t,(0,s.f)(this.el),this.arcgisChange.emit()},onClick:()=>this.closePopupPopovers.emit(),ref:a}):(0,s.h)("calcite-text-area",{resize:"vertical",autofocus:!0,value:i,placeholder:o,onCalciteTextAreaInput:e=>{e.stopPropagation();const t=e.target.value;this.fieldsContent.description=t,(0,s.f)(this.el),this.arcgisChange.emit()},ref:a}),r.fieldInfos?.length&&(0,s.h)("calcite-action",{text:l.attributes,scale:"s",icon:"brackets-curly",onClick:()=>{const{popupState:t}=this;this.closePopupPopovers.emit(),this.fieldsContentPickListNode||(this.fieldsContentPickListNode=document.createElement("arcgis-map-config-popup-field-pick-list"),this.fieldsContentPickListNode.popoverProps={refElement:this.popupFlowItem,offsetSkidding:50},this.fieldsContentPickListNode.multiple=!1,this.fieldsContentPickListNode.heading=l.addField,this.fieldsContentPickListNode.popupState=t,this.fieldsContentPickListNode.addEventListener("arcgisChange",(t=>{t.stopPropagation();const i=t.detail.selectedFields[0];this.handleFieldsContentPickListChange(i,e)})),this.fieldsContentPickListNode.addEventListener("arcgisClose",(e=>{e.stopPropagation(),this.closePopupPopovers.emit()})),document.body.appendChild(this.fieldsContentPickListNode),this.disablePopupPanel.emit(!0))}})))}setUpFieldMapInfo(){const{popupState:e}=this,{popupTemplate:t}=e;this.fieldInfoMap=new Map(t.fieldInfos.map((e=>[e.fieldName,e])))}openSelectFieldsPickList(){const{popupState:e}=this,{strings:t}=e;this.closePopupPopovers.emit(),this.selectFieldsPickListNode||(this.selectFieldsPickListNode=document.createElement("arcgis-map-config-popup-field-pick-list"),this.selectFieldsPickListNode.popoverProps={refElement:this.popupFlowItem},this.selectFieldsPickListNode.selectedFields=this.getSelectedFields(),this.selectFieldsPickListNode.hideCancel=!0,this.selectFieldsPickListNode.multiple=!0,this.selectFieldsPickListNode.heading=t.selectFields,this.selectFieldsPickListNode.okBtnText=t.done,this.selectFieldsPickListNode.popupState=e,this.selectFieldsPickListNode.addEventListener("arcgisChange",(e=>{e.stopPropagation();const t=e.detail.selectedFields;this.handleSelectFieldsPickListChange(t)})),this.selectFieldsPickListNode.addEventListener("arcgisClose",(e=>{e.stopPropagation(),this.closePopupPopovers.emit()})),document.body.appendChild(this.selectFieldsPickListNode),this.disablePopupPanel.emit(!0))}getSelectedFields(){return this.fieldsContent.fieldInfos.map((e=>e.fieldName))}handleSelectFieldsPickListChange(e){this.setUpFieldMapInfo();const t=[];e.forEach((e=>{if(this.fieldInfoMap.has(e)){const i=this.fieldInfoMap.get(e)?.clone();i.visible=!0,t.push(i)}})),this.fieldsContent.fieldInfos=[...t],(0,s.f)(this.el),this.arcgisChange.emit()}handleFieldsContentPickListChange(e,t){"title"===t?((0,v.c)(this.titleNode,e),this.fieldsContent.title=this.titleNode.value):"description"===t&&((0,v.c)(this.descriptionNode,e),this.fieldsContent.description=this.descriptionNode.value),this.closePopupPopovers.emit(),(0,s.f)(this.el),this.arcgisChange.emit()}removeField(e){this.closePopupPopovers.emit();const t=this.fieldsContent.fieldInfos.find((t=>t.fieldName===e));t&&this.fieldsContent.fieldInfos.splice(this.fieldsContent.fieldInfos.indexOf(t),1),(0,s.f)(this.el),this.arcgisChange.emit()}get el(){return(0,s.a)(this)}};j.style=".form-input-button{display:flex}.input{width:100%}calcite-text-area{width:100%;--calcite-text-area-min-width:0;--calcite-text-area-min-height:42px}.select-fields-button{margin-bottom:var(--calcite-spacing-sm)}";const q=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.arcadeChangeNotification=(0,s.c)(this,"arcadeChangeNotification",7),this.manager=(0,d.u)(this),this.filterLength=5,this.calciteListItems=[],this.popupState=void 0}async componentWillLoad(){await this.loadAllModules()}componentWillRender(){const{popupState:e}=this,{popupTemplate:t}=e;this.calciteListItems=[],t.expressionInfos?.length&&t.expressionInfos.forEach((e=>this.calciteListItems.push(this.getCalciteListItem(e))))}async setFocus(){this.panelNode?.setFocus()}render(){const{popupState:e,filterLength:t}=this,{strings:i,popupTemplate:o}=e;return(0,s.h)(s.H,{key:"7e3d6fd46c6d93c3b1a09d40d9ca5d3490896185",class:"calcite-match-height"},(0,s.h)("calcite-panel",{key:"205fe7b9720e8784f204678464834fe9a66080ef",ref:e=>this.panelNode=e},o.expressionInfos?.length?(0,s.h)("calcite-list",{label:i.manageExpressions,filterEnabled:this.calciteListItems.length>=t},this.calciteListItems):null,this.renderAddExpression()))}renderAddExpression(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)("calcite-fab",{disabled:e.blockFeatureReductionArcade,slot:"fab",class:"fab",icon:"plus",scale:"s",appearance:"outline-fill",kind:"neutral",label:t.addExpression,text:t.addExpression,textEnabled:!0,onClick:e=>{e.stopPropagation(),this.launchArcade()},ref:e=>this.fabNode=e})}async loadAllModules(){this.FieldInfo=await(0,u.f)(),this.PopupExpressionInfo=await(0,u.aB)()}getCalciteListItem(e){const{popupState:t}=this,{strings:i}=t;return(0,s.h)("calcite-list-item",{disabled:t.blockFeatureReductionArcade,label:e.title,description:`{${a.f.expression}${e.name}}`,value:e.name,onClick:t=>{t.stopPropagation(),this.launchArcade(e)}},(0,s.h)("calcite-action",{slot:"actions-end",appearance:"transparent",text:i.remove,onClick:t=>{t.stopPropagation(),this.handleRemoveArcadeExpression(e.name)}},(0,s.h)("calcite-icon",{scale:"s",icon:"x"})))}async launchArcade(e){const{popupState:t}=this,{layer:i,mapView:s,portal:o,layerDisplayType:a,strings:n,serviceType:l,popupTemplate:r}=t;this.arcadeEditorNode||(this.panelNode.disabled=!0,this.arcadeEditorNode=document.createElement("arcgis-map-config-modal-arcade"),this.arcadeEditorNode.arcadeProfile=await(0,C.a)(i,s,l,r,a),this.arcadeEditorNode.testData=await(0,C.b)(i,s,a,r),this.arcadeEditorNode.arcadeScript=(0,C.c)(e?.expression,a,n),this.arcadeEditorNode.suggestions=(0,C.e)(i,n,"attributeExpression"),this.arcadeEditorNode.addExistingExpressions=!0,this.arcadeEditorNode.layer=i,this.arcadeEditorNode.portal=o,this.arcadeEditorNode.arcadeTitle=e?.title||n.arcadeDefaultTitle,this.arcadeEditorNode.arcadeTitleEditable=!0,this.arcadeEditorNode.arcadeTitleEditingEnabled=!e?.title,document.body.appendChild(this.arcadeEditorNode),this.arcadeEditorNode.addEventListener("arcgisClose",(t=>{t.stopPropagation(),this.arcadeSetup(t.detail,e),setTimeout((()=>{this.fabNode?.setFocus()}),300)})))}async arcadeSetup(e,t){const{popupState:i}=this,{popupTemplate:s}=i;e&&((0,C.s)(e,t?.name,this.PopupExpressionInfo,s),await this.setUpPopupExpressionDisplay()),this.panelNode.disabled=!1,document.body.removeChild(this.arcadeEditorNode),this.arcadeEditorNode=void 0}async setUpPopupExpressionDisplay(){const{popupState:e}=this;await(0,C.f)(e,this.FieldInfo),this.arcadeChangeNotification.emit(),(0,s.f)(this.el),this.arcgisChange.emit()}handleRemoveArcadeExpression(e){const{popupState:t}=this,{popupTemplate:i}=t,s=i.expressionInfos.find((t=>t.name===e));if(s){i.expressionInfos.splice(i.expressionInfos.indexOf(s),1);i.content.filter((e=>"fields"===e.type)).forEach((t=>{const i=t.fieldInfos.find((t=>t.fieldName===`${a.f.expression}${e}`));i&&t.fieldInfos.splice(t.fieldInfos.indexOf(i),1)}));i.content.filter((e=>"media"===e.type)).forEach((t=>{t.mediaInfos.filter((e=>"image"!==e.type)).forEach((t=>{const i=t.value.fields,s=t.value.normalizeField,o=i.find((t=>t===`${a.f.expression}${e}`));o&&i.splice(i.indexOf(o),1),s===`${a.f.expression}${e}`&&(t.value.normalizeField=null)}))}))}this.setUpPopupExpressionDisplay()}get el(){return(0,s.a)(this)}};q.style=":host{height:100%}";const G=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.arcgisDelete=(0,s.c)(this,"arcgisDelete",7),this.closePopupPopovers=(0,s.c)(this,"closePopupPopovers",7),this.disablePopupPanel=(0,s.c)(this,"disablePopupPanel",7),this.manager=(0,d.u)(this),this.popupState=U(),this.popupFlowItem=void 0,this.blockOpen=!1,this.mediaContent=void 0}arcadeChangeNotificationHandler(){(0,s.f)(this.el)}closePopupPopoversHandler(){this.imageNode&&(document.body.removeChild(this.imageNode),this.imageNode=void 0,this.addMediaButtonNode?.setFocus(),this.disablePopupPanel.emit(!1)),this.chartNode&&(document.body.removeChild(this.chartNode),this.chartNode=void 0,this.addMediaButtonNode?.setFocus(),this.disablePopupPanel.emit(!1)),this.mediaContentPopoverNode&&(document.body.removeChild(this.mediaContentPopoverNode),this.mediaContentPopoverNode=void 0,this.addMediaButtonNode.disabled=!1,this.addMediaButtonNode?.setFocus(),this.disablePopupPanel.emit(!1)),this.pickListNode&&(document.body.removeChild(this.pickListNode),this.pickListNode=void 0,this.disablePopupPanel.emit(!1))}async resetMultimediaIndex(){this.setActiveMediaInfoIndex(0,!0)}async componentWillLoad(){await this.loadAllModules(),this.modules.reactiveUtils.watch((()=>this.popupState.mapView.popup?.selectedFeature),(()=>this.setActiveMediaInfoIndex(0))),this.modules.reactiveUtils.watch((()=>this.popupState.mapView.popup?.visible),(()=>this.setActiveMediaInfoIndex(0))),this.mediaContent.title=this.mediaContent.title||"",this.mediaContent.description=this.mediaContent.description||""}componentDidLoad(){this.blockOpen&&(this.addMediaButtonNode?.scrollIntoView({behavior:"auto",block:"nearest",inline:"start"}),1===this.mediaContent.mediaInfos.length&&this.openMediaInfoPopover(this.mediaContent.mediaInfos[0],0))}componentDidUpdate(){this.arcgisChange.emit()}disconnectedCallback(){this.imageNode&&document.body.removeChild(this.imageNode),this.chartNode&&document.body.removeChild(this.chartNode),this.mediaContentPopoverNode&&document.body.removeChild(this.mediaContentPopoverNode),this.pickListNode&&document.body.removeChild(this.pickListNode)}render(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)(s.H,{key:"3860eb37747b1e35c60b4e472f39dd7cacadf438"},this.renderFormInput("title",t.title,this.mediaContent.title,t.enterTitle,(e=>this.titleNode=e)),this.renderFormInput("description",t.desc,this.mediaContent.description,t.enterDescription,(e=>this.descriptionNode=e)),(0,s.h)("calcite-label",{key:"4d0a1cc8a6c28a5032f6db5d52d6fe7f23425d53",class:"disable-spacing",scale:"s"},t.mediaContent),(0,s.h)("calcite-list",{key:"4e5eb2946185a4f3f00e2495cf5961eee3d8f506",label:t.mediaContent,dragEnabled:!0,onCalciteListOrderChange:e=>{const t=e.detail.oldIndex,i=e.detail.newIndex;this.handleListOrderChange(t,i)}},this.mediaContent.mediaInfos.map(((e,i)=>(0,s.h)("calcite-list-item",{key:JSON.stringify(e),label:e.title&&`${e.title.substring(0,25)}${e.title.length>25?"...":""}`||t.noTitle,description:this.getMultimediaTypeString(e.type),onClick:t=>{t.stopPropagation(),this.closePopupPopovers.emit();t.composedPath().some((e=>"CALCITE-SORT-HANDLE"===e.tagName))||this.openMediaInfoPopover(e,i)}},(0,s.h)("calcite-action",{slot:"actions-end",appearance:"transparent",text:t.remove,onClick:e=>{e.stopPropagation(),this.closePopupPopovers.emit(),this.mediaContent.mediaInfos.splice(i,1),0===this.mediaContent.mediaInfos.length?this.arcgisDelete.emit():(this.setActiveMediaInfoIndex(0),this.arcgisChange.emit()),(0,s.f)(this.el)}},(0,s.h)("calcite-icon",{scale:"s",icon:"x"})))))),(0,s.h)("calcite-button",{key:"649f504126dec8b85985ebb95ef132fc512d2bc1",title:t.addMedia,appearance:"outline-fill",round:!0,scale:"s",class:"add-media-button",iconStart:"plus",onClick:e=>{const{popupState:t}=this;e.stopPropagation(),this.closePopupPopovers.emit(),this.mediaContentPopoverNode||(this.mediaContentPopoverNode=document.createElement("arcgis-map-config-popup-add-content-popover"),this.mediaContentPopoverNode.referenceElement=this.addMediaButtonNode,this.mediaContentPopoverNode.popoverPanelWidth=this.el.getBoundingClientRect().width,this.mediaContentPopoverNode.isMultimediaContent=!0,this.mediaContentPopoverNode.popupState=t,this.mediaContentPopoverNode.addEventListener("arcgisAddMultimediaContent",(e=>{const t=e.detail;this.handleAddMultimediaContentToExistingContent(t)})),document.body.appendChild(this.mediaContentPopoverNode),this.addMediaButtonNode.disabled=!0,this.disablePopupPanel.emit(!0))},ref:e=>this.addMediaButtonNode=e}))}renderFormInput(e,t,i,o,a){return(0,s.h)("calcite-label",{scale:"s"},t,(0,s.h)("div",{class:"form-input-button"},"title"===e?(0,s.h)("calcite-input",{class:"input",type:"text",autofocus:!0,value:i,placeholder:o,onCalciteInputInput:e=>{e.stopPropagation();const t=e.target.value;this.mediaContent.title=t,(0,s.f)(this.el)},onClick:()=>this.closePopupPopovers.emit(),ref:a}):(0,s.h)("calcite-text-area",{resize:"vertical",autofocus:!0,value:i,placeholder:o,onCalciteTextAreaInput:e=>{e.stopPropagation();const t=e.target.value;this.mediaContent.description=t,(0,s.f)(this.el),this.arcgisChange.emit()},ref:a}),this.popupState.popupTemplate.fieldInfos?.length&&(0,s.h)("calcite-action",{text:this.popupState.strings.attributes,scale:"s",icon:"brackets-curly",onClick:()=>{const{popupState:t}=this;this.closePopupPopovers.emit(),this.pickListNode||(this.pickListNode=document.createElement("arcgis-map-config-popup-field-pick-list"),this.pickListNode.popoverProps={refElement:this.popupFlowItem},this.pickListNode.multiple=!1,this.pickListNode.heading=t.strings.addField,this.pickListNode.popupState=t,this.pickListNode.addEventListener("arcgisChange",(t=>{t.stopPropagation();const i=t.detail.selectedFields[0];this.handlePickListChange(i,e)})),this.pickListNode.addEventListener("arcgisClose",(e=>{e.stopPropagation(),this.closePopupPopovers.emit()})),document.body.appendChild(this.pickListNode),this.disablePopupPanel.emit(!0))}})))}async loadAllModules(){const[e,t,i,s,o]=await Promise.all([(0,u.l)(),(0,u.X)(),(0,u.Y)(),(0,u.Z)(),(0,u._)()]);this.modules={reactiveUtils:e,ImageMediaInfo:t,ColumnChartMediaInfo:i,ImageMediaInfoValue:s,ChartMediaInfoValue:o}}async handleAddMultimediaContentToExistingContent(e){const{modules:t}=this;let i;this.closePopupPopovers.emit(),e===P.C.IMAGES?i=new t.ImageMediaInfo({title:"",caption:"",altText:"",value:new t.ImageMediaInfoValue({sourceURL:"",linkURL:""})}):e===P.C.CHARTS&&(i=new t.ColumnChartMediaInfo({title:"",caption:"",altText:"",value:new t.ChartMediaInfoValue({fields:[]})})),this.mediaContent.mediaInfos.push(i),(0,s.f)(this.el),this.openMediaInfoPopover(i,this.mediaContent.mediaInfos.length-1)}getMultimediaTypeString(e){const{popupState:t}=this,{strings:i}=t;return e===P.P.IMAGE?i.image:e===P.P.BAR_CHART||e===P.P.COLUMN_CHART?i.barChart:e===P.P.LINE_CHART?i.lineChart:e===P.P.PIE_CHART?i.pieChart:i.image}setActiveMediaInfoIndex(e,t){this.mediaContent.activeMediaInfoIndex=e||0,t&&this.arcgisChange.emit()}openMediaInfoPopover(e,t){const{popupState:i}=this;e.type===P.P.IMAGE?(this.imageNode=document.createElement("arcgis-map-config-popup-image"),this.imageNode.referenceElement=this.popupFlowItem,this.imageNode.imageMediaInfo=e,this.imageNode.mediaIndexPosition=t,this.imageNode.popupState=i,this.imageNode.addEventListener("arcgisMultimediaChange",(e=>{const t=e.detail;this.setActiveMediaInfoIndex(t),(0,s.f)(this.el)})),document.body.appendChild(this.imageNode)):(this.chartNode=document.createElement("arcgis-map-config-popup-chart"),this.chartNode.referenceElement=this.popupFlowItem,this.chartNode.chartMediaInfo=e,this.chartNode.mediaContent=this.mediaContent,this.chartNode.mediaIndexPosition=t,this.chartNode.popupState=i,this.chartNode.addEventListener("arcgisMultimediaChange",(e=>{const t=e.detail;this.setActiveMediaInfoIndex(t),(0,s.f)(this.el)})),document.body.appendChild(this.chartNode)),this.disablePopupPanel.emit(!0)}handlePickListChange(e,t){"title"===t?((0,v.c)(this.titleNode,e),this.mediaContent.title=this.titleNode.value):"description"===t&&((0,v.c)(this.descriptionNode,e),this.mediaContent.description=this.descriptionNode.value),this.closePopupPopovers.emit(),(0,s.f)(this.el)}handleListOrderChange(e,t){const i=this.mediaContent.mediaInfos[e];this.mediaContent.mediaInfos.splice(e,1),this.mediaContent.mediaInfos.splice(t,0,i),this.arcgisChange.emit(),this.closePopupPopovers.emit(),this.setActiveMediaInfoIndex(0,!0),(0,s.f)(this.el)}get el(){return(0,s.a)(this)}};G.style=".add-media-button{display:flex;justify-content:center;margin-top:var(--calcite-spacing-sm)}.form-input-button{display:flex}.input{width:100%}calcite-text-area{width:100%;--calcite-text-area-min-width:0;--calcite-text-area-min-height:42px}.disable-spacing{--calcite-label-margin-bottom:0}";const Y=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.closePopupPopovers=(0,s.c)(this,"closePopupPopovers",7),this.disablePopupPanel=(0,s.c)(this,"disablePopupPanel",7),this.manager=(0,d.u)(this),this.maxPreviewCount=11,this.popupState=U(),this.popupFlowItem=void 0,this.relationshipContent=void 0,this.hasRelationshipLayer=!0}closePopupPopoversHandler(){this.relationshipFormInputPickListNode&&(document.body.removeChild(this.relationshipFormInputPickListNode),this.relationshipFormInputPickListNode=void 0,this.disablePopupPanel.emit(!1)),this.sortByPickerNode&&(document.body.removeChild(this.sortByPickerNode),this.sortByPickerNode=void 0,this.disablePopupPanel.emit(!1))}async componentWillLoad(){const{popupState:e}=this;await this.loadAllModules(),this.hasRelationshipLayer=await M(e,this.relationshipContent),this.relationshipContent.title=this.relationshipContent.title||"",this.relationshipContent.description=this.relationshipContent.description||""}componentDidLoad(){this.setUpLayerTableListWatcher()}componentDidUpdate(){this.arcgisChange.emit()}disconnectedCallback(){this.relationshipFormInputPickListNode&&document.body.removeChild(this.relationshipFormInputPickListNode),this.sortByPickerNode&&document.body.removeChild(this.sortByPickerNode),this.layerTableListWatcher?.remove()}render(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)(s.H,{key:"933e93a58c64066db6c692727ff6b081471a7c38"},this.renderFormInput("title",t.title,this.relationshipContent.title,t.enterTitle,(e=>this.relationshipTitleNode=e)),this.renderFormInput("description",t.desc,this.relationshipContent.description,t.enterDescription,(e=>this.relationshipDescriptionNode=e)),this.renderRelationshipSelector(),this.renderSortBy(),this.renderSortOrder(),this.renderPreviewCount())}renderFormInput(e,t,i,o,a){return(0,s.h)("calcite-label",{scale:"s"},t,(0,s.h)("div",{class:"form-input-button"},"title"===e?(0,s.h)("calcite-input",{class:"input",type:"text",autofocus:!0,value:i,placeholder:o,disabled:!this.hasRelationshipLayer,onCalciteInputInput:e=>{e.stopPropagation();const t=e.target.value;this.relationshipContent.title=t,(0,s.f)(this.el)},onClick:()=>this.closePopupPopovers.emit(),ref:a}):(0,s.h)("calcite-text-area",{resize:"vertical",autofocus:!0,value:i,placeholder:o,onCalciteTextAreaInput:e=>{e.stopPropagation();const t=e.target.value;this.relationshipContent.description=t,(0,s.f)(this.el),this.arcgisChange.emit()},ref:a}),this.popupState.popupTemplate.fieldInfos?.length&&(0,s.h)("calcite-action",{text:this.popupState.strings.attributes,scale:"s",icon:"brackets-curly",disabled:!this.hasRelationshipLayer,onClick:()=>{const{popupState:t}=this;this.closePopupPopovers.emit(),this.relationshipFormInputPickListNode||(this.relationshipFormInputPickListNode=document.createElement("arcgis-map-config-popup-field-pick-list"),this.relationshipFormInputPickListNode.popoverProps={refElement:this.popupFlowItem,offsetSkidding:50},this.relationshipFormInputPickListNode.multiple=!1,this.relationshipFormInputPickListNode.heading=this.popupState.strings.addField,this.relationshipFormInputPickListNode.popupState=t,this.relationshipFormInputPickListNode.addEventListener("arcgisChange",(t=>{t.stopPropagation();const i=t.detail.selectedFields[0];this.handleRelationshipFormInputPickListChange(i,e)})),this.relationshipFormInputPickListNode.addEventListener("arcgisClose",(e=>{e.stopPropagation(),this.closePopupPopovers.emit()})),document.body.appendChild(this.relationshipFormInputPickListNode),this.disablePopupPanel.emit(!0))}})))}renderRelationshipSelector(){const{popupState:e}=this,{strings:t,layer:i,mapView:o}=e,a=i.relationships.find((e=>e.id===this.relationshipContent.relationshipId)),n=i.relationships.map((e=>{const a=D(o);for(const o of a){const a=o;if(O(i,a,e))return(0,s.h)("calcite-dropdown-item",{selected:this.relationshipContent.relationshipId===e.id,onClick:async()=>{await a.load(),this.relationshipContent.relationshipId=e.id,this.relationshipContent.orderByFields=[new this.RelatedRecordsInfoFieldOrder({field:a.fields.find((e=>e.visible)).name,order:this.relationshipContent.orderByFields?.[0].order||"asc"})],(0,s.f)(this.el)}},e.name||t.relationship)}}));return(0,s.h)("calcite-label",null,t.relationship,(0,s.h)("calcite-dropdown",{disabled:!this.hasRelationshipLayer,overlayPositioning:"fixed",class:"dropdown"},(0,s.h)("calcite-button",{slot:"trigger",appearance:"outline-fill",kind:"neutral",iconEnd:"chevronDown",alignment:"icon-end-space-between",width:"full"},a?.name||t.relationship),(0,s.h)("calcite-dropdown-group",null,n)))}renderSortBy(){const{popupState:e}=this,{strings:t,layer:i,mapView:o}=e;return(0,s.h)("calcite-label",null,t.sortBy,(0,s.h)("calcite-button",{appearance:"outline-fill",kind:"neutral",iconEnd:"chevronDown",alignment:"icon-end-space-between",width:"full",disabled:!this.hasRelationshipLayer,onClick:()=>{i.relationships.map((async e=>{const t=D(o);for(const s of t){const t=s;this.relationshipContent.relationshipId===e.id&&O(i,t,e)&&this.openSortByPickList(t)}}))}},this.relationshipContent?.orderByFields?.[0]?.field||t.default))}renderSortOrder(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)("calcite-label",null,t.sortOrder,(0,s.h)("calcite-dropdown",{disabled:!this.hasRelationshipLayer,overlayPositioning:"fixed"},(0,s.h)("calcite-button",{slot:"trigger",appearance:"outline-fill",kind:"neutral",iconEnd:"chevronDown",alignment:"icon-end-space-between",width:"full"},"desc"===this.relationshipContent.orderByFields?.[0].order?t.descending:t.ascending),(0,s.h)("calcite-dropdown-item",{selected:"asc"===this.relationshipContent.orderByFields?.[0].order,onClick:()=>{this.relationshipContent.orderByFields[0].order="asc",(0,s.f)(this.el)}},t.ascending),(0,s.h)("calcite-dropdown-item",{selected:"desc"===this.relationshipContent.orderByFields?.[0].order,onClick:()=>{this.relationshipContent.orderByFields[0].order="desc",(0,s.f)(this.el)}},t.descending)))}renderPreviewCount(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)("calcite-label",null,t.previewCount,(0,s.h)("calcite-dropdown",{disabled:!this.hasRelationshipLayer,overlayPositioning:"fixed"},(0,s.h)("calcite-button",{slot:"trigger",appearance:"outline-fill",kind:"neutral",iconEnd:"chevronDown",alignment:"icon-end-space-between",width:"full"},(0===this.relationshipContent.displayCount?t.none:this.relationshipContent.displayCount)??1),(0,s.h)("calcite-dropdown-group",null,[...Array(this.maxPreviewCount).keys()].map((e=>(0,s.h)("calcite-dropdown-item",{selected:this.relationshipContent.displayCount===e,onClick:()=>{this.relationshipContent.displayCount=e,(0,s.f)(this.el)}},0===e?t.none:e))))))}async loadAllModules(){this.RelatedRecordsInfoFieldOrder=await(0,u.aC)(),this.reactiveUtils=await(0,u.l)()}handleRelationshipFormInputPickListChange(e,t){"title"===t?((0,v.c)(this.relationshipTitleNode,e),this.relationshipContent.title=this.relationshipTitleNode.value):"description"===t&&((0,v.c)(this.relationshipDescriptionNode,e),this.relationshipContent.description=this.relationshipDescriptionNode.value),this.closePopupPopovers.emit(),(0,s.f)(this.el)}openSortByPickList(e){const{popupState:t}=this,{mapView:i}=t;this.closePopupPopovers.emit(),this.sortByPickerNode||(this.sortByPickerNode=document.createElement("arcgis-field-pick-list"),this.sortByPickerNode.popoverProps={triggerDisabled:!0,refElement:this.popupFlowItem,offsetSkidding:50},this.sortByPickerNode.fields=e.fields.filter((e=>e.visible)),this.sortByPickerNode.layer=e,this.sortByPickerNode.mapView=i,this.sortByPickerNode.showFieldInfo=!0,this.sortByPickerNode.showFieldName=!0,this.sortByPickerNode.selectedFields=this.relationshipContent?.orderByFields?.[0]?.field?[this.relationshipContent?.orderByFields?.[0]?.field]:[],this.sortByPickerNode.addEventListener("arcgisClose",(e=>{e.stopPropagation();const t=e.detail?.selectedFields?.[0];this.handleSortByPickListChange(t)})),document.body.appendChild(this.sortByPickerNode),this.sortByPickerNode.setFocus(),this.disablePopupPanel.emit(!0))}handleSortByPickListChange(e){e&&(this.relationshipContent.orderByFields[0].field=e,(0,s.f)(this.el)),this.closePopupPopovers.emit()}setUpLayerTableListWatcher(){const{reactiveUtils:e}=this;this.layerTableListWatcher=e.watch((()=>[this.popupState.mapView.map?.allLayers.length,this.popupState.mapView.map?.allTables.length]),(async()=>{const{popupState:e}=this;this.hasRelationshipLayer=await M(e,this.relationshipContent)}))}get el(){return(0,s.a)(this)}};Y.style=".form-input-button{display:flex}.input{width:100%}calcite-text-area{width:100%;--calcite-text-area-min-width:0;--calcite-text-area-min-height:42px}.dropdown{width:100%}";const X=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.closePopupPopovers=(0,s.c)(this,"closePopupPopovers",7),this.disablePopupPanel=(0,s.c)(this,"disablePopupPanel",7),this.manager=(0,d.u)(this),this.arcadeExpMap=new Map,this.popupState=U(),this.popupFlowItem=void 0,this.blockOpen=!1,this.popupTextContent=void 0,this.fieldExpressionData=void 0,this.arcgisColorPickerData=void 0}arcadeChangeNotificationHandler(){this.setUpCkEditorMentionFields()}closePopupPopoversHandler(){this.ckEditorPopoverNode&&(document.body.removeChild(this.ckEditorPopoverNode),this.ckEditorPopoverNode=void 0,this.disablePopupPanel.emit(!1))}async componentWillLoad(){this.intl=await(0,u.z)()}componentDidLoad(){this.setUpCkEditorMentionFields(),this.blockOpen&&this.openRichTextEditor()}componentDidUpdate(){this.arcgisChange.emit()}disconnectedCallback(){this.ckEditorPopoverNode&&document.body.removeChild(this.ckEditorPopoverNode)}render(){const{popupState:e}=this,{strings:t}=e;return(0,s.h)(s.H,{key:"4c64189f4722fe69ea3ba3af1a6fa312ec6f5192"},(0,s.h)("calcite-button",{key:"d6facac81a1ff836a7167c58824b61784702c84b",appearance:"transparent",width:"full",onClick:()=>this.openRichTextEditor()},t.editText))}setUpCkEditorMentionFields(){const{popupState:e}=this,{popupTemplate:t}=e;this.ckEditorMentionFields=[],this.arcadeExpMap=(0,n.m)(t),t.fieldInfos?.forEach((e=>{e.fieldName&&this.ckEditorMentionFields.push({id:`{${e.fieldName}}`,name:(0,n.o)(e,this.arcadeExpMap)})}))}openRichTextEditor(){const{popupState:e,intl:t}=this,{strings:i,popupTemplate:o}=e;this.closePopupPopovers.emit(),this.ckEditorPopoverNode=document.createElement("arcgis-ckeditor5-popover"),this.ckEditorPopoverNode.guid=(0,m.a)(),this.ckEditorPopoverNode.refElement=this.popupFlowItem,this.ckEditorPopoverNode.intlOk=i.ok,this.ckEditorPopoverNode.intlCancel=i.cancel,this.ckEditorPopoverNode.addEventListener("arcgisPopoverClosed",(e=>{e.stopPropagation(),(0,n.i)(e.detail?.data?.length)&&(this.popupTextContent.text=e.detail.data,(0,s.f)(this.el)),this.closePopupPopovers.emit()}));const a=document.createElement("arcgis-ckeditor5");a.customConfig={FieldExpression:{...this.fieldExpressionData,layer:void 0,mapView:void 0},ArcgisColorPicker:{...this.arcgisColorPickerData,enableFields:!!this.arcgisColorPickerData.data?.length}},a.textData=this.popupTextContent.text??"",a.mentionFields=this.ckEditorMentionFields,a.intlTextPlaceHolder=o.fieldInfos?.length?i.textPlaceHolder:i.textPlaceHolderLabel,a.currentLanguage=t.getLocale(),a.setFocus(),this.ckEditorPopoverNode.appendChild(a),document.body.appendChild(this.ckEditorPopoverNode),this.disablePopupPanel.emit(!0)}get el(){return(0,s.a)(this)}},Q=class{constructor(e){(0,s.r)(this,e),this.arcgisChange=(0,s.c)(this,"arcgisChange",7),this.closePopupPopovers=(0,s.c)(this,"closePopupPopovers",7),this.disablePopupPanel=(0,s.c)(this,"disablePopupPanel",7),this.manager=(0,d.u)(this),this.popupState=U(),this.referenceElement=void 0}closePopupPopoversHandler(){this.pickListNode&&(document.body.removeChild(this.pickListNode),this.pickListNode=void 0,this.inputNode.setFocus(),this.disablePopupPanel.emit(!1))}render(){const{popupState:e}=this,{popupTemplate:t,strings:i}=e,o=t.title;return(0,s.h)(s.H,{key:"db44a6391dc907709c8651d7d0ee8b4dc4047566"},(0,s.h)("calcite-block",{key:"16ce0c581c991067513517d486dcf4a8e406daef",collapsible:!0,heading:i.popupTitle,description:o&&`${o.substring(0,25)}${o.length>25?"...":""}`},(0,s.h)("div",{key:"32870c2178ba3ea7b06ec1cd08bb490d190558fc",slot:"icon"},(0,s.h)("calcite-icon",{key:"d3ad4f0b9ff62fc1d10eda1de41fdab3dc728f85",icon:"title"})),(0,s.h)("div",{key:"7f2c3b02a1caa2759c0de7f77ca20330ae6cd434",class:"form-input-button"},(0,s.h)("calcite-input",{key:"83a3cc4e81f77ead82edee31d20bf9be8699ecb3",class:"input",type:"text",autofocus:!0,value:o,onCalciteInputInput:e=>{e.stopPropagation(),this.handleTitleChange()},onClick:()=>this.closePopupPopovers.emit(),ref:e=>this.inputNode=e}),t.fieldInfos?.length&&(0,s.h)("calcite-action",{key:"4c977c593e369964da6278055c247bf7294cc565",scale:"s",text:i.attributes,icon:"brackets-curly",onClick:e=>{e.stopPropagation(),this.openPickList()}}))))}handleTitleChange(){const{popupState:e}=this,{popupTemplate:t}=e;t.title=this.inputNode.value,(0,s.f)(this.el),this.arcgisChange.emit()}openPickList(){this.closePopupPopovers.emit();const{popupState:e}=this,{strings:t}=e;this.pickListNode=document.createElement("arcgis-map-config-popup-field-pick-list"),this.pickListNode.popupState=e,this.pickListNode.popoverProps={refElement:this.referenceElement},this.pickListNode.heading=t.addField,this.pickListNode.multiple=!1,this.pickListNode.addEventListener("arcgisChange",(e=>{e.stopPropagation();const t=e.detail.selectedFields;this.handlePickListChange(t)})),this.pickListNode.addEventListener("arcgisClose",(e=>{e.stopPropagation(),this.closePopupPopovers.emit()})),document.body.appendChild(this.pickListNode),this.disablePopupPanel.emit(!0)}handlePickListChange(e){const t=e[0];(0,v.c)(this.inputNode,t),this.handleTitleChange(),this.closePopupPopovers.emit()}get el(){return(0,s.a)(this)}};Q.style=".form-input-button{display:flex}.input{width:100%}"},93345:(e,t,i)=>{i.d(t,{c:()=>r});var s=i(11254);const o=e=>!("isConnected"in e)||e.isConnected,a=((e,t)=>{let i;return(...s)=>{i&&clearTimeout(i),i=setTimeout((()=>{i=0,e(...s)}),t)}})((e=>{for(let t of e.keys())e.set(t,e.get(t).filter(o))}),2e3),n=e=>"function"==typeof e?e():e,l=(e,t)=>{const i=e.indexOf(t);i>=0&&(e[i]=e[e.length-1],e.length--)},r=(e,t)=>{const i=((e,t=(e,t)=>e!==t)=>{const i=n(e);let s=new Map(Object.entries(i??{}));const o={dispose:[],get:[],set:[],reset:[]},a=()=>{s=new Map(Object.entries(n(e)??{})),o.reset.forEach((e=>e()))},r=e=>(o.get.forEach((t=>t(e))),s.get(e)),p=(e,i)=>{const a=s.get(e);t(i,a,e)&&(s.set(e,i),o.set.forEach((t=>t(e,i,a))))},c="undefined"==typeof Proxy?{}:new Proxy(i,{get:(e,t)=>r(t),ownKeys:e=>Array.from(s.keys()),getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0}),has:(e,t)=>s.has(t),set:(e,t,i)=>(p(t,i),!0)}),d=(e,t)=>(o[e].push(t),()=>{l(o[e],t)});return{state:c,get:r,set:p,on:d,onChange:(t,i)=>{const s=d("set",((e,s)=>{e===t&&i(s)})),o=d("reset",(()=>i(n(e)[t])));return()=>{s(),o()}},use:(...e)=>{const t=e.reduce(((e,t)=>(t.set&&e.push(d("set",t.set)),t.get&&e.push(d("get",t.get)),t.reset&&e.push(d("reset",t.reset)),t.dispose&&e.push(d("dispose",t.dispose)),e)),[]);return()=>t.forEach((e=>e()))},dispose:()=>{o.dispose.forEach((e=>e())),a()},reset:a,forceUpdate:e=>{const t=s.get(e);o.set.forEach((i=>i(e,t,t)))}}})(e,t);return i.use((()=>{if("function"!=typeof s.d)return{};const e=new Map;return{dispose:()=>e.clear(),get:t=>{const i=(0,s.d)();i&&((e,t,i)=>{const s=e.get(t);s?s.includes(i)||s.push(i):e.set(t,[i])})(e,t,i)},set:t=>{const i=e.get(t);i&&e.set(t,i.filter(s.f)),a(e)},reset:()=>{e.forEach((e=>e.forEach(s.f))),a(e)}}})()),i}}}]);
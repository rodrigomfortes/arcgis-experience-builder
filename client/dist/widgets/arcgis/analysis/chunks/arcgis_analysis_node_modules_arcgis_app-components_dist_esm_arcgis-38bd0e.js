/*! For license information please see arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-38bd0e.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-38bd0e"],{86308:(e,t,i)=>{i.r(t),i.d(t,{arcgis_field_calculate_editor:()=>o,arcgis_field_calculate_table:()=>d});var a=i(87849),l=i(4429),s=i(37849);i(93814),i(15332),i(37762);function r(){const{layer:e}=s.f;return{id:"field-calculation",definitions:{$layer:e}}}async function c(e){const{layer:t}=s.f;return{profileVariableInstances:{$feature:await n(e),$layer:t,$datastore:t.url},spatialReference:t.spatialReference,services:{portal:t.portalItem.portal}}}async function n(e){var t;const{layer:i}=s.f;let a=null;if("fields"in i){const i=await(0,s.d)(e);(null===(t=null==i?void 0:i.features)||void 0===t?void 0:t.length)&&(a=i.features[0].clone())}return a}const o=class{constructor(e){(0,a.r)(this,e),this.arcgisFieldCalculateEditorScriptChange=(0,a.c)(this,"arcgisFieldCalculateEditorScriptChange",7),this.arcgisFieldCalculateEditorFilterChange=(0,a.c)(this,"arcgisFieldCalculateEditorFilterChange",7),this.arcgisFieldCalculateEditorLanguageSelected=(0,a.c)(this,"arcgisFieldCalculateEditorLanguageSelected",7),this.arcgisFieldCalculateEditorResetWorkflow=(0,a.c)(this,"arcgisFieldCalculateEditorResetWorkflow",7),this.script=s.f.currentScript||"",this.resizeObserver=new ResizeObserver((e=>{const t=e.pop();this.hideSideBar=t.contentRect.width<=600})),this.debouncedScriptChange=(0,l.f)((()=>{this.arcgisFieldCalculateEditorScriptChange.emit()}),500),this.editorOpen=!1,this.filterPanelWhere=void 0,this.filterPanelOpen=!1,this.hideSideBar=void 0}async watchPropHandler(e,t){this.arcadeEditorNode&&e!==t&&(this.arcadeEditorNode.testData=await c(e))}disconnectedCallback(){this.resizeObserver.disconnect()}async closeEditor(){this.editorOpen=!1}async openEditor(){this.editorOpen=!0}async openFilterPanel(){this.filterPanelOpen=!0}async closeFilterPanel(){this.filterPanelOpen=!1}async isTestResultValid(){try{let e=await this.arcadeEditorNode.getTestResult();if("error"===e.type)return!1;return(0,s.v)("null"===e.type?null:e.value).isFieldValid}catch(e){return!1}}render(){return(0,a.h)(a.H,{key:"ce4855fa79215540d3fc8836c1037e7ffaaf180c"},this.renderLanguageSelect(),this.renderFilterPanel(),this.renderEditor())}renderFilterPanel(){if(!this.filterPanelOpen)return;const{isTable:e,layer:t,mapView:i,strings:l,whereClause:r}=s.f;return(0,a.h)("calcite-panel",{heading:l.defineFilter},(0,a.h)("arcgis-common-sql-expression-config",{class:"filter",layer:t,whereClause:r,mode:"basic",view:e?null:i,closable:!1,hideButtons:!0,hideLayerTitle:!0,panelHeading:l.defineFilter,noFilterMsg:l.emptyFilterText,leadingText:l.filterPanelDescription,clearText:l.clearAll,onArcgisChange:e=>{this.arcgisFieldCalculateEditorFilterChange.emit(e.detail)}}))}renderEditor(){const{selectedLanguage:e,strings:t}=s.f;if(!this.editorOpen)return null;const i="Arcade"===e?this.renderArcadeEditor():this.renderSQLEditor();return(0,a.h)("calcite-panel",{heading:"Arcade"===e?t.arcadeExpression:t.sqlExpression},i)}renderArcadeEditor(){const{whereClause:e}=s.f;return(0,a.h)("arcgis-arcade-editor",{class:"editor",script:this.script,hideSideBar:this.hideSideBar,onArcgisScriptChange:e=>{s.f.currentScript=e.detail,this.script=e.detail,this.debouncedScriptChange()},ref:async t=>{t&&(this.arcadeEditorNode=t,t.profile=function(){const{layer:e}=s.f;return{id:"field-calculation",definitions:{$feature:e,$datastore:e}}}(),t.testData=await c(e),this.resizeObserver.observe(t))}})}renderSQLEditor(){return(0,a.h)("arcgis-sql-expression-editor",{class:"editor",script:this.script,profile:r(),hideSideBar:this.hideSideBar,onArcgisScriptChange:e=>{s.f.currentScript=e.detail,this.script=e.detail,this.debouncedScriptChange()},ref:e=>{e&&this.resizeObserver.observe(e)}})}renderLanguageSelect(){if(this.editorOpen||this.filterPanelOpen)return;const{arcadeSupported:e,config:t,layer:i,originalField:l,strings:r}=s.f,{helpMap:c,helpBase:n}=t;return(0,a.h)("calcite-panel",null,(0,a.h)("div",{class:"panel-title",slot:"header-content"},r.editorPanelHeading),(0,a.h)("calcite-label",{class:"language-select-text"},r.languageSelect),(0,a.h)("calcite-tile-group",{label:r.languageSelect,layout:"vertical",class:"language-select",selectionMode:"single-persist"},(0,a.h)("calcite-notice",{class:"arcade-blocked-notice",kind:"info",open:!e},(0,a.h)("div",{slot:"title"},r.languageNotSupported),(0,a.h)("div",{slot:"message"},i.portalItem.portal.isPortal?r.arcadeNotSupportedEN:r.arcadeNotSupported),(0,a.h)("calcite-link",{slot:"link",target:"_blank",href:`${n}${c[120005320]}`},r.learnMoreEditing)),(0,a.h)("calcite-tile",{class:"language-select-tile",disabled:!e,selected:"Arcade"===s.f.selectedLanguage,onClick:()=>this.handleLanguageSelect("Arcade"),onKeyDown:e=>{" "!==e.key&&"Enter"!==e.key||this.handleLanguageSelect("Arcade")}},(0,a.h)("div",{slot:"content-bottom",class:"language-select-description"},(0,a.h)("calcite-label",{class:(e?"":"disabled")+" language-select-description-header"},r.arcade),(0,a.h)("calcite-label",{class:""+(e?"":"disabled")},r.idealFor,(0,a.h)("ul",{class:` ${e?"":"disabled"} language-select-description-text`},(0,a.h)("li",null,r.arcadeDescription1),(0,a.h)("li",null,r.arcadeDescription2))))),(0,a.h)("calcite-tile",{class:"language-select-tile",selected:"SQL"===s.f.selectedLanguage,onClick:()=>this.handleLanguageSelect("SQL"),onKeyDown:e=>{" "!==e.key&&"Enter"!==e.key||this.handleLanguageSelect("SQL")}},(0,a.h)("div",{slot:"content-bottom",class:"language-select-description"},(0,a.h)("calcite-label",{class:"language-select-description-header"},r.sql),(0,a.h)("calcite-label",null,r.idealFor,(0,a.h)("ul",{class:"language-select-description-text"},(0,a.h)("li",null,r.sqlDescription1),(0,a.h)("li",null,r.sqlDescription2),(0,a.h)("li",null,r.sqlDescription3)))))))}handleLanguageSelect(e){s.f.selectedLanguage!==e&&(s.f.selectedLanguage=e,this.script="",this.arcgisFieldCalculateEditorResetWorkflow.emit()),this.arcgisFieldCalculateEditorLanguageSelected.emit()}get hostElement(){return(0,a.a)(this)}static get watchers(){return{filterPanelWhere:["watchPropHandler"]}}};o.style=".sc-arcgis-field-calculate-editor-h{height:100%;position:relative;display:contents}.arcade-blocked-notice.sc-arcgis-field-calculate-editor{margin-bottom:15px}arcgis-arcade-editor.sc-arcgis-field-calculate-editor,arcgis-sql-expression-editor.sc-arcgis-field-calculate-editor{z-index:calc(var(--calcite-z-index-header) + 1)}arcgis-arcade-editor.sc-arcgis-field-calculate-editor>calcite-tooltip.sc-arcgis-field-calculate-editor,arcgis-sql-expression-editor.sc-arcgis-field-calculate-editor>calcite-tooltip.sc-arcgis-field-calculate-editor{z-index:var(--calcite-z-index-tooltip)}.calculate-button.sc-arcgis-field-calculate-editor{display:inline-flex}.calculate-card.sc-arcgis-field-calculate-editor{cursor:pointer}.disabled.sc-arcgis-field-calculate-editor{opacity:var(--calcite-opacity-disabled)}.editor.sc-arcgis-field-calculate-editor{width:100%;height:100%}.hidden.sc-arcgis-field-calculate-editor{display:none}.language-select-description.sc-arcgis-field-calculate-editor{display:flex;flex-direction:column;width:100%}.language-select-description-header.sc-arcgis-field-calculate-editor{font-weight:500}.language-select-tile.sc-arcgis-field-calculate-editor{opacity:1;min-inline-size:100%}.language-select-description-text.sc-arcgis-field-calculate-editor{list-style:revert;margin:revert;padding:revert;color:var(--calcite-color-text-3);font-size:var(--calcite-font-size-sm)}.language-select-text.sc-arcgis-field-calculate-editor{margin:20px 10px 0}.language-select.sc-arcgis-field-calculate-editor{margin:10px}.panel-border.sc-arcgis-field-calculate-editor{border:1px solid #e0e0e0}.panel-title.sc-arcgis-field-calculate-editor{font-size:var(--calcite-font-size-0);line-height:2rem;font-weight:var(--calcite-font-weight-medium);color:var(--calcite-color-text-1)}.sql-editor-temp.sc-arcgis-field-calculate-editor{margin:20px 10px 0}.editor-wrapper.sc-arcgis-field-calculate-editor{display:flex;flex-direction:column;align-items:center;margin:4rem 2rem;height:70vh;min-height:400px}.filter.sc-arcgis-field-calculate-editor{height:100%;overflow-y:auto}";const d=class{constructor(e){(0,a.r)(this,e),this.arcgisFieldCalculateTableRecordCountUpdate=(0,a.c)(this,"arcgisFieldCalculateTableRecordCountUpdate",7),this.mode="features",this.objectIds=[],this.testButtons={}}async enableGeometry(){this.table&&!this.table.returnGeometryEnabled&&(this.table.returnGeometryEnabled=!0,this.table.returnMEnabled=!0,this.table.returnZEnabled=!0,this.table.refresh())}async getMode(){return this.mode}async getLayer(){return this.layer}async calculateValues(){const{features:e}=s.f;for(const t in e)e[t].calculatedValue=void 0,e[t].error=void 0,e[t].passed=!1,s.f.autoPreviewEnabled&&this.calculateCellValues(e[t].feature);this.table.refreshCellContent(),(0,s.u)()}async noRowsVisible(){return 0===this.numVisibleRows}async refresh(e){var t;e?this.table.refreshCellContent():await(null===(t=this.table)||void 0===t?void 0:t.refresh()),this.populateTestFeaturesFromTable()}async resetTableTemplates(){if("preview"===this.mode){const e=this.getPreviewValuesTemplates();this.table.tableTemplate={columnTemplates:e}}else{const e=this.getTestFeaturesTemplates();this.table.tableTemplate={columnTemplates:e}}}async setMode(e){this.mode!==e&&(this.mode=e,this.resetTableTemplates())}async updateTableFilter(e,t=!1){var i;const{whereClause:a}=s.f,l=this.getCombinedWhere(e,a);this.objectIds=await this.queryForObjectIds(l),this.numVisibleRows=(null===(i=this.objectIds)||void 0===i?void 0:i.length)||0,this.layer.definitionExpression=e,t||(this.table.objectIds.removeAll(),this.table.maxSize=this.objectIds.length,this.objectIds.length&&this.table.objectIds.addMany(this.objectIds),this.populateTestFeaturesFromTable())}async componentWillLoad(){const{layer:e,whereClause:t}=s.f;this.layer=e.clone(),this.layer.definitionExpression=null,await this.layer.load(),this.objectIds=await this.queryForObjectIds(t),this.numVisibleRows=this.objectIds.length}async componentDidLoad(){const{config:e}=s.f;this.hostElement.shadowRoot.firstElementChild.insertAdjacentHTML("beforebegin",`<link rel="stylesheet" href="${e.jsapiUrl}/themes/light/main.css"/>`)}render(){const{layer:e,originalField:t,modules:i}=s.f;if(!e||!t)return(0,a.h)(a.F,null);let l=[];switch(this.mode){case"features":l=this.getTestFeaturesTemplates();break;case"preview":l=this.getPreviewValuesTemplates()}return this.table=new i.FeatureTable({layer:this.layer,tableTemplate:{columnTemplates:l},objectIds:this.objectIds,visibleElements:{columnMenus:!1,header:!1,menu:!1,selectionColumn:!1,columnDescriptions:!1},container:null,maxSize:this.objectIds.length}),i.reactiveUtils.watch((()=>this.table.viewModel.store.pageCache.size),(e=>{e>0&&(this.populateTestFeaturesFromTable(),this.calculateValues())})),(0,a.h)(a.H,null,(0,a.h)("div",{key:l.toString(),ref:e=>{e&&(this.table.container=e)}}))}getTestFeaturesTemplates(){const{originalField:e}=s.f;let t=[];return this.layer.fields.forEach((i=>{i.name!==e.name&&t.push({type:"field",fieldName:i.name,label:i.alias})})),t.push(this.getOriginalFieldColumnTemplate()),t}getCombinedWhere(e,t){return e&&t?`(${e}) AND (${t})`:e||t}getPreviewValuesTemplates(){const{layer:e,originalField:t,strings:i}=s.f;let a=[];return a.push({type:"field",fieldName:e.objectIdField,label:e.fields.find((t=>t.name===e.objectIdField)).alias}),a.push(this.getOriginalFieldColumnTemplate()),a.push({type:"column",label:i.calculated,fieldName:`${t.name}Calculated`,sortable:!1,invalid:!1,textWrap:!0,formatFunction:({feature:e})=>{const{arcadeExecutor:t,autoPreviewEnabled:a,features:l,invalidScript:r,sqlEngine:c}=s.f,n=e.attributes[this.layer.objectIdField];if(t||c){if(r&&a)return"";if((0,s.e)(l[n].calculatedValue))return l[n].error&&!(0,s.i)(l[n].calculatedValue)?l[n].calculatedValue:this.getCellDisplayValue(l[n].calculatedValue);if(l[n].error)return"";if(a||!t&&!c){const t=(0,s.j)(e);return l[n].error?t:this.getCellDisplayValue(t)}if(!this.testButtons[n]){const a=document.createElement("calcite-button");a.appearance="transparent",a.innerHTML=i.testCalculation,a.iconEnd="play",a.onclick=async()=>{a.loading=!0,(null==t?void 0:t.isAsync)?await(0,s.h)(e):(0,s.j)(e),this.table.refreshCellContent()},this.testButtons[n]=a}return this.testButtons[n].loading=!1,this.testButtons[n]}return""}}),a.push(this.getErrorsTemplate()),a}getErrorsTemplate(){const{originalField:e,strings:t}=s.f;return{type:"column",label:t.errors,fieldName:`${e.name}Errors`,sortable:!1,textWrap:!0,formatFunction:({feature:e})=>{const{features:i,invalidScript:a}=s.f,r=e.attributes[this.layer.objectIdField],c=(0,l.c)(i[r].error);if(!(0,s.e)(i[r].calculatedValue)&&!c&&!a)return null;const n=document.createElement("div"),o=document.createElement("calcite-icon");o.scale="s",o.icon=c||a?"exclamation-mark-triangle-f":"check-circle",o.classList.add(c||a?"warning-icon":"success-icon");const d=document.createElement("div");return d.innerHTML=c?i[r].error:a?t.popupError:t.noErrors,n.append(o),n.append(d),n.classList.add("cell-with-icon"),n}}}getOriginalFieldColumnTemplate(){const{originalField:e,strings:t}=s.f;return{type:"column",label:"features"===this.mode?e.alias:t.original,fieldName:e.name,frozenToEnd:"features"===this.mode,sortable:!1,textWrap:!0,invalid:"features"===this.mode,formatFunction:({feature:t})=>{const i=t.attributes[e.name];if((0,s.e)(i))return this.getCellDisplayValue(i)}}}async queryForObjectIds(e){const{numRecords:t}=s.f,i=this.layer.createQuery();i.returnGeometry=!1,i.num=t,i.where=e;try{const e=await this.layer.queryObjectIds(i);return this.arcgisFieldCalculateTableRecordCountUpdate.emit(e.length),e}catch(e){return this.arcgisFieldCalculateTableRecordCountUpdate.emit(0),[]}}calculateCellValues(e){const{arcadeExecutor:t,features:i,sqlEngine:a}=s.f;if(t||a){const a=e.attributes[this.layer.objectIdField];if(!(0,s.e)(i[a].calculatedValue)){if(null==t?void 0:t.isAsync)return;(0,s.j)(e)}}}getCellDisplayValue(e){e=(0,s.k)(e);if([/^\s*(https?:\/\/([^\s]+))\s*$/i,/^\s*(tel:([^\s]+))\s*$/i,/^\s*(mailto:([^\s]+))\s*$/i,/^\s*(arcgis-appstudio-player:\/\/([^\s]+))\s*$/i,/^\s*(arcgis-collector:\/\/([^\s]+))\s*$/i,/^\s*(arcgis-explorer:\/\/([^\s]+))\s*$/i,/^\s*(arcgis-navigator:\/\/([^\s]+))\s*$/i,/^\s*(arcgis-survey123:\/\/([^\s]+))\s*$/i,/^\s*(arcgis-trek2there:\/\/([^\s]+))\s*$/i,/^\s*(arcgis-workforce:\/\/([^\s]+))\s*$/i,/^\s*(iform:\/\/([^\s]+))\s*$/i,/^\s*(flow:\/\/([^\s]+))\s*$/i,/^\s*(lfmobile:\/\/([^\s]+))\s*$/i,/^\s*(mspbi:\/\/([^\s]+))\s*$/i].find((t=>t.test(e)))){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t}if(/<\/?[a-z][\s\S]*>/i.test(e)){const t=document.createElement("span");return t.textContent=e,t}return e}populateTestFeaturesFromTable(){const{features:e}=s.f;(this.table.viewModel.store.pageCache.get(0)||[]).forEach((t=>{const i=t.feature,a=t.objectId;e[a]||(e[a]={}),e[a].feature=i}));for(const t in e)e[t].tableFeature=this.table.objectIds.includes(parseInt(t))}get hostElement(){return(0,a.a)(this)}};d.style=":host{height:100%}.cell-with-icon{display:flex;align-items:center;-moz-column-gap:10px;column-gap:10px}.warning-icon{--calcite-ui-icon-color:var(--calcite-color-status-warning)}.success-icon{--calcite-ui-icon-color:var(--calcite-color-status-success)}"}}]);
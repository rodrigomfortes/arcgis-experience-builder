var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,s=1,r=arguments.length;s<r;s++)for(var i in t=arguments[s])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,n,a,u){return new(a=a||Promise)(function(s,t){function r(e){try{o(u.next(e))}catch(e){t(e)}}function i(e){try{o(u.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?s(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(r,i)}o((u=u.apply(e,n||[])).next())})},__generator=this&&this.__generator||function(r,i){var o,n,a,u={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},l=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return l.next=e(0),l.throw=e(1),l.return=e(2),"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function e(s){return function(e){var t=[s,e];if(o)throw new TypeError("Generator is already executing.");for(;u=l&&t[l=0]?0:u;)try{if(o=1,n&&(a=2&t[0]?n.return:t[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,t[1])).done)return a;switch(n=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,n=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(a=0<(a=u.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3]))u.label=t[1];else if(6===t[0]&&u.label<a[1])u.label=a[1],a=t;else{if(!(a&&u.label<a[2])){a[2]&&u.ops.pop(),u.trys.pop();continue}u.label=a[2],u.ops.push(t)}}t=i.call(r,u)}catch(e){t=[6,e],n=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},fs=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.addItem=addItem,exports.copyApp=copyApp,exports.deleteThumbnail=deleteThumbnail,exports.updateAppItem=updateAppItem,exports.getItemData=getItemData,exports.items=items,exports.searchItem=searchItem,exports.removeItem=removeItem,exports.addResources=addResources,exports.updateResources=updateResources,exports.resources=resources,exports.resource=resource,exports.removeResources=removeResources,exports.getUserTags=getUserTags,require("fs-extra")),path=require("path"),utils_1=(require("../../../global"),require("./utils")),url=(require("isomorphic-form-data"),require("url")),uploadThumbnail=(0,utils_1.getThumbnailUpdateMulter)(),upload=(0,utils_1.getUploadMulter)();function addItem(f,h){return __awaiter(this,void 0,void 0,function(){var t,s,r,i,o,n,a,u,l,c,p,d,_;return __generator(this,function(e){switch(e.label){case 0:t={error:{message:"",success:!1}};try{if(f.type="json",(s=f.request.body||{}).typeKeywords?s.typeKeywords=Array.isArray(s.typeKeywords)?s.typeKeywords:s.typeKeywords.split(","):delete s.typeKeywords,s.hasOwnProperty("snippet")&&delete s.snippet,delete s.thumbnail,r=(0,utils_1.addItemParamsIsPass)(s))return t.error.message=r,[2,(0,utils_1.requestException)(t,f)];fs.ensureDirSync(utils_1.appFolderPath),i=Date.now(),o=fs.readdirSync(utils_1.appFolderPath),n=(0,utils_1.getFolderIndex)(o,0)+"",s.id=n,s.created=i,s.modified=i,s.owner=s.username,delete(a=__assign(__assign({},utils_1.infoJson),s)).text,a=(0,utils_1.deepClone)(a),u=path.join(utils_1.appFolderPath,n),l=path.join(u,"info.json"),c=path.join(u,"config.json"),fs.mkdirSync(u),(0,utils_1.updateAppInfo)(a,l),p={__not_publish:!0},d=JSON.stringify(p),s.text&&(d="string"==typeof s.text?s.text:JSON.stringify(s.text,null,2)),fs.writeFileSync(c,d),_={folder:"apps/".concat(n),id:n,success:!0},(0,utils_1.commonResponse)(f,_)}catch(e){t.error.message=e,(0,utils_1.writeResponseLog)(e,!0),f.body=t}return[4,h()];case 1:return e.sent(),[2]}})})}function copyApp(f,h){return __awaiter(this,void 0,void 0,function(){var t,s,r,i,o,n,a,u,l,c,p,d,_;return __generator(this,function(e){switch(e.label){case 0:t={error:{message:"",success:!1}};try{if(f.type="json",s=f.request.body||{},r=s.title,i=s.tags,o=(0,utils_1.getIdFromUrl)(f),n=path.join(utils_1.appFolderPath,o),null==utils_1.appFolderPath||!utils_1.appFolderPath.startsWith("")||null==n||!n.startsWith(utils_1.appFolderPath))return[2];if(!fs.existsSync(n))return t.error.message="Item not exist",[2,(0,utils_1.requestException)(t,f)];if(a=fs.readdirSync(utils_1.appFolderPath),u=(0,utils_1.getFolderIndex)(a,0)+"",null==(l=path.join(utils_1.appFolderPath,u))||!l.startsWith(utils_1.appFolderPath))return[2];if(fs.copySync(n,l),c=path.join(utils_1.appFolderPath,u,"info.json"),!fs.existsSync(c))return t.error.message="No app info",[2,(0,utils_1.requestException)(t,f)];p=JSON.parse(fs.readFileSync(c,"utf8")),r&&(p.title=r),i&&(p.title=i),d=Date.now(),p.created=d,p.modified=d,(0,utils_1.updateAppInfo)(p,c),_={itemId:u,success:!0},(0,utils_1.commonResponse)(f,_)}catch(e){t.error.message=e,(0,utils_1.writeResponseLog)(e,!0),f.body=t}return[4,h()];case 1:return e.sent(),[2]}})})}function deleteThumbnail(u,l){return __awaiter(this,void 0,void 0,function(){var t,s,r,i,o,n,a;return __generator(this,function(e){switch(e.label){case 0:t={error:{message:"",success:!1}};try{if(u.type="json",s=(0,utils_1.getIdFromUrl)(u),r=path.join(utils_1.appFolderPath,s),i=path.join(utils_1.appFolderPath,s,"info.json"),null==utils_1.appFolderPath||!utils_1.appFolderPath.startsWith("")||null==i||!i.startsWith(utils_1.appFolderPath)||null==r||!r.startsWith(utils_1.appFolderPath))return[2];if(!fs.existsSync(r))return t.error.message="Item not exist",[2,(0,utils_1.requestException)(t,u)];if(!fs.existsSync(i))return t.error.message="No app info",[2,(0,utils_1.requestException)(t,u)];if(((o=JSON.parse(fs.readFileSync(i,"utf8"))).thumbnail=null,utils_1.updateAppInfo)(o,i),null==(n=path.join(utils_1.appFolderPath,s,"thumbnail"))||!n.startsWith(utils_1.appFolderPath))return[2];fs.removeSync(n),a={itemId:s,success:!0},(0,utils_1.commonResponse)(u,a)}catch(e){t.error.message=e,(0,utils_1.writeResponseLog)(e,!0),u.body=t}return[4,l()];case 1:return e.sent(),[2]}})})}function updateAppItem(l,s){return __awaiter(this,void 0,void 0,function(){var u,t;return __generator(this,function(e){switch(e.label){case 0:u={message:"",itemId:"",success:!1},e.label=1;case 1:return e.trys.push([1,3,,4]),[4,uploadThumbnail.single("thumbnail")(l,s).then(function(e){var t,s,r=l.request.body||{},i=(0,utils_1.getIdFromUrl)(l),o=l.request.headers["content-type"],n=(delete r.thumbnail,r.typeKeywords?r.typeKeywords=Array.isArray(r.typeKeywords)?r.typeKeywords:r.typeKeywords.split(","):delete r.typeKeywords,path.join(utils_1.appFolderPath,i,"info.json")),a=path.join(utils_1.appFolderPath,i,"config.json");if(null!=n&&n.startsWith(utils_1.appFolderPath)&&null!=a&&a.startsWith(utils_1.appFolderPath))return fs.existsSync(n)&&fs.existsSync(a)?(t=JSON.parse(fs.readFileSync(n,"utf8")),s=path.join(utils_1.appFolderPath,i,"thumbnail"),-1!==o.indexOf("/form-data")&&null!=s&&s.startsWith(utils_1.appFolderPath)&&(o=fs.readdirSync(s),t.thumbnail="thumbnail/".concat(o[0])),r.text&&(s="string"==typeof r.text?JSON.parse(r.text):r.text,o=JSON.stringify(__assign({},s),null,2),(null==s?void 0:s.__not_publish)||fs.writeFileSync(a,o),delete r.text),r.username&&(r.owner=r.username),r.modified=Date.now(),s=__assign(__assign({},t),r),JSON.stringify(s,null,2)&&s&&0<(null==(a=Object.keys(s))?void 0:a.length)?((0,utils_1.updateAppInfo)(s,n),void(0,utils_1.commonResponse)(l,{id:i,success:!0})):(u.message="Failed to update app item",u.itemId=i,(0,utils_1.requestException)(u,l))):(u.message="no file",u.itemId=i,(0,utils_1.requestException)(u,l))}).catch(function(e){u.message="upload failed",l.body=u})];case 2:return e.sent(),[3,4];case 3:return t=e.sent(),u.message=t,(0,utils_1.writeResponseLog)(t,!0),l.body=u,[3,4];case 4:return[2]}})})}function getItemData(a,u){return __awaiter(this,void 0,void 0,function(){var t,s,r,i,o,n;return __generator(this,function(e){switch(e.label){case 0:t={error:{message:"",id:"",success:!1}};try{if(s=(0,utils_1.getIdFromUrl)(a),null==(r=path.join(utils_1.appFolderPath,s,"config.json"))||!r.startsWith(utils_1.appFolderPath))return[2];if(!fs.existsSync(r))return t.error.message="no file",t.error.id=s,i={message:"no item",id:s,success:!1},(0,utils_1.commonResponse)(a,i),[2,!1];o=JSON.parse(fs.readFileSync(r,"utf8")),n=__assign(__assign({},o),{id:s,success:!0}),(0,utils_1.commonResponse)(a,n)}catch(e){t.error.message=e,(0,utils_1.writeResponseLog)(e,!0),a.body=t}return[4,u()];case 1:return e.sent(),[2]}})})}function items(a,u){return __awaiter(this,void 0,void 0,function(){var t,s,r,i,o,n;return __generator(this,function(e){switch(e.label){case 0:if(t={error:{message:"",id:"",success:!1}},s=a.req.url,!s.includes("/sharing/rest/content/users/items/"))return[2,!1];try{if(r=(0,utils_1.getIdFromUrl)(a,0),null==(i=path.join(utils_1.appFolderPath,r,"info.json"))||!i.startsWith(utils_1.appFolderPath))return[2];if(!fs.existsSync(i))return t.error.message="Item does not exist or is inaccessible.",t.error.id=r,[2,(0,utils_1.requestException)(t,a)];o=JSON.parse(fs.readFileSync(i,"utf8")),n=__assign(__assign({},o),{id:r,success:!0}),(0,utils_1.commonResponse)(a,n)}catch(e){t.error.message=e,(0,utils_1.writeResponseLog)(e,!0),a.body=t}return[4,u()];case 1:return e.sent(),[2]}})})}function searchItem(F,x){return __awaiter(this,void 0,void 0,function(){var t,s,r,i,o,n,a,u,l,c,p,d,_,f,h,m,y,g,w,b,v;return __generator(this,function(e){switch(e.label){case 0:try{t=[],s=void 0,r=F.request.method,s="GET"===r?url.parse(F.request.url,!0).query:F.request.body||{},i=utils_1.appFolderPath,fs.existsSync(i)&&(o=fs.readdirSync(i),n=s.q,a="",n&&-1!==n.indexOf(")")&&(u=n.split("owner:")||[],null!=(w=null===u?void 0:u[1]))&&w.includes("(")&&(a=null==(v=null==(b=u[1])?void 0:b.split("(")[1])?void 0:v.split(")")[0]),n&&-1!==n.indexOf("title:")&&(a=n?n.split("title:")[1]:""),l=[],o.forEach(function(e){var e=path.join(i,e,"info.json");fs.pathExistsSync(e)&&(e=JSON.parse(fs.readFileSync(e,"utf-8")),l.push(e))}),t=(0,utils_1.fuzzyMatching)(l,a,"title",!0)),t=(0,utils_1.filterByType)(t,s.q),c=t,p=(0,utils_1.getOwner)(s.q),c=(0,utils_1.filterDataByOwner)(c,p.owner,p.isNot),d=(0,utils_1.getTypekeywords)(s.q),c=(0,utils_1.filterDataByTypekeywords)(c,d.typekeywords,d.isNot),(_=null==s?void 0:s.portalUrl)&&(c=(0,utils_1.filterDataByPortalUrl)(c,_)),s.sortOrder&&(c=(0,utils_1.sortByNumber)(c,"created",s.sortOrder)),"modified"!==s.sortField&&"created"!==s.sortField||(c=(0,utils_1.sortByNumber)(c,s.sortField)),"title"===s.sortField&&(c=(0,utils_1.sortByInitial)(c,s.sortField)),f=Number(s.start)||0,h=Number(s.num)||10,m=f+h,y=[],c.forEach(function(e,t){t+=1;f<=t&&t<m&&y.push(e)}),g={nextStart:m,num:y.length,query:s.q,results:y,start:s.start,total:c.length},(0,utils_1.commonResponse)(F,g)}catch(e){(0,utils_1.writeResponseLog)(e,!0),F.body={error:e}}return[4,x()];case 1:return e.sent(),[2]}})})}function removeItem(o,n){return __awaiter(this,void 0,void 0,function(){var t,s,r,i;return __generator(this,function(e){switch(e.label){case 0:t={message:"",itemId:"",success:!1};try{if(s=(0,utils_1.getIdFromUrl)(o),null==(r=path.join(utils_1.appFolderPath,s))||!r.startsWith(utils_1.appFolderPath))return[2];if(!fs.existsSync(r))return t.message="no folder",t.itemId=s,[2,(0,utils_1.requestException)(t,o)];fs.removeSync(r),i={id:s,success:!0},(0,utils_1.commonResponse)(o,i)}catch(e){t.message=e,(0,utils_1.writeResponseLog)(e,!0),o.body=t}return[4,n()];case 1:return e.sent(),[2]}})})}function addResources(i,r){return __awaiter(this,void 0,void 0,function(){var t,s;return __generator(this,function(e){switch(e.label){case 0:t={error:{message:"",details:[],success:!1}},e.label=1;case 1:return e.trys.push([1,3,,4]),[4,upload.single("file")(i,r).then(function(e){var t=(0,utils_1.getIdFromUrl)(i),s=i.request.body,r=path.join(utils_1.appFolderPath,t,"resources",s.resourcesPrefix,s.fileName),r=((0,utils_1.formatJson)(r,s.fileName),(0,utils_1.getOwnerFromInfo)(t));(0,utils_1.commonResponse)(i,{folder:t,itemId:t,owner:r,success:!0})}).catch(function(e){t.error.message="upload failed",i.body=t})];case 2:return e.sent(),[3,4];case 3:return s=e.sent(),t.error.message=s,(0,utils_1.writeResponseLog)(s,!0),i.body=t,[3,4];case 4:return[2]}})})}function updateResources(o,r){return __awaiter(this,void 0,void 0,function(){var t,s;return __generator(this,function(e){switch(e.label){case 0:t={message:"",success:!1},e.label=1;case 1:return e.trys.push([1,3,,4]),[4,upload.single("file")(o,r).then(function(e){var t=(0,utils_1.getIdFromUrl)(o),s=o.request.body,r=path.join(utils_1.appFolderPath,t,"resources",s.resourcesPrefix,s.fileName),i=(0,utils_1.getOwnerFromInfo)(t),r=((0,utils_1.formatJson)(r,s.fileName),{folder:t,itemId:t,owner:i,success:!0});(0,utils_1.commonResponse)(o,r)}).catch(function(e){t.message="upload failed",o.body=t})];case 2:return e.sent(),[3,4];case 3:return s=e.sent(),t.message=s,(0,utils_1.writeResponseLog)(s,!0),o.body=t,[3,4];case 4:return[2]}})})}function resources(n,a){return __awaiter(this,void 0,void 0,function(){var t,s,r,i,o;return __generator(this,function(e){switch(e.label){case 0:try{if(t=(0,utils_1.getIdFromUrl)(n),null==(s=path.join(utils_1.appFolderPath,t,"resources"))||!s.startsWith(utils_1.appFolderPath))return[2];if(!fs.existsSync(s))return r={total:0,start:1,num:0,nextStart:-1,resources:[],success:!1},(0,utils_1.commonResponse)(n,r),[2,!1];i=(0,utils_1.readFolder)(s,"resources/"),o={total:i.length,start:1,num:i.length,nextStart:-1,resources:i,success:!0},(0,utils_1.commonResponse)(n,o)}catch(e){(0,utils_1.writeResponseLog)(e,!0),n.body={error:e}}return[4,a()];case 1:return e.sent(),[2]}})})}function resource(o,n){return __awaiter(this,void 0,void 0,function(){var t,s,r,i;return __generator(this,function(e){switch(e.label){case 0:try{if(t=o.params.id,s=o.params.resourceName,null==(r=path.join(utils_1.appFolderPath,t,"resources",s))||!r.startsWith(utils_1.appFolderPath))return[2];if(!fs.existsSync(r))return[2,!(o.response.status=404)];i=fs.readFileSync(r,"utf-8"),(0,utils_1.commonResponse)(o,i)}catch(e){(0,utils_1.writeResponseLog)(e,!0),o.body={error:e}}return[4,n()];case 1:return e.sent(),[2]}})})}function removeResources(n,a){return __awaiter(this,void 0,void 0,function(){var t,s,r,i,o;return __generator(this,function(e){switch(e.label){case 0:t={error:{code:404,message:"",details:[],id:"",success:!1}};try{if((s=n.request.body||{}).deleteAll=!!s.hasOwnProperty("deleteAll")&&s.deleteAll,r=(0,utils_1.getIdFromUrl)(n),t.error.id=r,!s.deleteAll&&!s.resource)return t.error.message="no resource",[2,(0,utils_1.requestException)(t,n)];if(i=s.deleteAll?path.join(utils_1.appFolderPath,r,"resources"):path.join(utils_1.appFolderPath,r,"resources",s.resource),null==utils_1.appFolderPath||!utils_1.appFolderPath.startsWith("")||null==i||!i.startsWith(utils_1.appFolderPath))return[2];if(!fs.existsSync(i))return t.error.message="no folder",[2,(0,utils_1.requestException)(t,n)];fs.removeSync(i),o={id:r,success:!0},(0,utils_1.commonResponse)(n,o)}catch(e){t.error.message=e,(0,utils_1.writeResponseLog)(e,!0),n.body=t}return[4,a()];case 1:return e.sent(),[2]}})})}function getUserTags(a,u){return __awaiter(this,void 0,void 0,function(){var t,s,r,i,o,n;return __generator(this,function(e){switch(e.label){case 0:t={error:{code:404,message:"",details:[],success:!1}};try{s=a.params.userName,r=path.join(utils_1.publicPath,"user_resources","tags.json"),i=JSON.parse(fs.readFileSync(r,"utf-8")||"{}"),o=(null==i?void 0:i[s])||[],n={tags:o,success:!0},(0,utils_1.commonResponse)(a,n)}catch(e){t.error.message=e,(0,utils_1.writeResponseLog)(e,!0),a.body=t}return[4,u()];case 1:return e.sent(),[2]}})})}
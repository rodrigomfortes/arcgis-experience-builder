var WidgetInfoType,__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,s,l,u){return new(l=l||Promise)(function(i,t){function r(e){try{o(u.next(e))}catch(e){t(e)}}function n(e){try{o(u.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?i(e.value):((t=e.value)instanceof l?t:new l(function(e){e(t)})).then(r,n)}o((u=u.apply(e,s||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,s,l,u={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=e(0),a.throw=e(1),a.return=e(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function e(i){return function(e){var t=[i,e];if(o)throw new TypeError("Generator is already executing.");for(;u=a&&t[a=0]?0:u;)try{if(o=1,s&&(l=2&t[0]?s.return:t[0]?s.throw||((l=s.return)&&l.call(s),0):s.next)&&!(l=l.call(s,t[1])).done)return l;switch(s=0,(t=l?[2&t[0],l.value]:t)[0]){case 0:case 1:l=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,s=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(l=0<(l=u.trys).length&&l[l.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!l||t[1]>l[0]&&t[1]<l[3]))u.label=t[1];else if(6===t[0]&&u.label<l[1])u.label=l[1],l=t;else{if(!(l&&u.label<l[2])){l[2]&&u.ops.pop(),u.trys.pop();continue}u.label=l[2],u.ops.push(t)}}t=n.call(r,u)}catch(e){t=[6,e],s=0}finally{o=l=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},fs=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.unZipToFolder=exports.isProtocolRelative=exports.removeProtocol=void 0,exports.checkItemVersion=checkItemVersion,exports.importApp=importApp,require("fs-extra")),semver=require("semver"),path=require("path"),utils_1=(require("../../../global"),require("./utils")),JSZip=(require("isomorphic-form-data"),require("jszip")),multer=require("@koa/multer"),importAppMulter=getImportAppMulter();function checkItemVersion(u,r){return __awaiter(this,void 0,void 0,function(){var l,t,i=this;return __generator(this,function(e){switch(e.label){case 0:l={error:{message:"",errorCode:null,success:!1,checkWidgetVersionResult:[],appVersion:null,errWidgetMsg:null}},e.label=1;case 1:return e.trys.push([1,3,,4]),[4,importAppMulter.single("appZip")(u,r).then(function(e){return __awaiter(i,void 0,void 0,function(){var t,i,r,n,o,s;return __generator(this,function(e){switch(e.label){case 0:return u.type="json",t=u.request.body||{},o=(null==(o=u.request.file)?void 0:o.path)||"",s=(null==(s=null==o?void 0:o.split("apps\\")[1])?void 0:s.split("\\importAppZip")[0])||(null==(s=null==o?void 0:o.split("apps/")[1])?void 0:s.split("/importAppZip")[0]),s=path.join(utils_1.appFolderPath,s),i=path.join(s,"/resources/config/config.json"),[4,checkIsAppValid(o)];case 1:return e.sent()||!1?[4,(r=!1,exports.unZipToFolder)(o,s)]:(l.error.message="Invalid App",l.error.errorCode="001",fs.removeSync(s),[2,(0,utils_1.requestException)(l,u)]);case 2:return e.sent(),checkAppVersion(i,null==t?void 0:t.currentVersion)||(r=!0),0<(null==(n=checkWidgetVersion(i))?void 0:n.length)&&(r=!0),fs.removeSync(s),n={isHeightVersionApp:r},(0,utils_1.commonResponse)(u,n),[2]}})})}).catch(function(e){l.error.message=e,u.body=l})];case 2:return e.sent(),[3,4];case 3:return t=e.sent(),l.error.message=t,(0,utils_1.writeResponseLog)(t,!0),u.body=l,[3,4];case 4:return[2]}})})}function importApp(f,r){return __awaiter(this,void 0,void 0,function(){var d,t,i=this;return __generator(this,function(e){switch(e.label){case 0:d={error:{message:"",errorCode:null,success:!1,checkWidgetVersionResult:[],appVersion:null,errWidgetMsg:null,portalUrl:null,express:null}},e.label=1;case 1:return e.trys.push([1,3,,4]),[4,importAppMulter.single("appZip")(f,r).then(function(e){return __awaiter(i,void 0,void 0,function(){var t,i,r,n,o,s,l,u,a,p,c;return __generator(this,function(e){switch(e.label){case 0:return f.type="json",t=f.request.body||{},p=(null==(p=f.request.file)?void 0:p.path)||"",c=(null==(c=null==p?void 0:p.split("apps\\")[1])?void 0:c.split("\\importAppZip")[0])||(null==(c=null==p?void 0:p.split("apps/")[1])?void 0:c.split("/importAppZip")[0]),i=path.join(utils_1.appFolderPath,c),r=path.join(i,"/resources/config/config.json"),n=path.join(i,"info.json"),[4,checkIsAppValid(p)];case 1:return e.sent()||!1?[4,(0,exports.unZipToFolder)(p,i)]:(d.error.message="Invalid App",d.error.errorCode="001",fs.removeSync(i),[2,(0,utils_1.requestException)(d,f)]);case 2:return(e.sent(),o=getZipAppVersion(r),u=checkIsSamePortal(r,t.portalUrl),l=u.isSamePortal,u=u.appPortalUrl,l)?(l=t.typeKeywords.includes(utils_1.TYPE_KEYWORDS_OF_EXPRESS_APP),l=checkIsSameMode(r,l),s=l.isSameMode,l=l.express,s?checkIsSameType(r,t.type)?[4,copyCustomWidget(r,i)]:(d.error.message="Web Experience"===t.type?"Failed to import app. This is an app template. Please switch to the Templates tab and try again.":"Failed to import template. This is an app. Please switch to the Apps tab and try again.",d.error.errorCode="Web Experience"===t.type?"004":"006",d.error.appVersion=o,fs.removeSync(i),[2,(0,utils_1.requestException)(d,f)]):(d.error.message=l?"Failed to import app. Express app cannot be imported into the full-feature app list.":"Failed to import app. Full-feature app cannot be imported into the express app list.",d.error.errorCode="002",d.error.express=l,fs.removeSync(i),[2,(0,utils_1.requestException)(d,f)])):(d.error.message="Failed to import the app. This app can only be imported by users of portal: ".concat(u," "),d.error.errorCode="003",d.error.portalUrl=u,d.error.appVersion=o,fs.removeSync(i),[2,(0,utils_1.requestException)(d,f)]);case 3:return e.sent(),fs.removeSync(path.join(i,"/importAppZip")),updateNewAppConfig(r,t.portalUrl),null!=t&&t.typeKeywords?((s=Array.isArray(t.typeKeywords)?t.typeKeywords:t.typeKeywords.split(",")).push("version: ".concat(o)),t.typeKeywords=s):delete t.typeKeywords,delete t.snippet,delete t.thumbnail,delete t.currentVersion,fs.ensureDirSync(utils_1.appFolderPath),l=getAppAttributes(i),u=Date.now(),t.id=c,t.created=u,t.modified=u,t.owner=t.username,t.snippet=l.description||null,t.thumbnail=l.thumbnail||null,delete(a=__assign(__assign({},utils_1.infoJson),t)).text,a=(0,utils_1.deepClone)(a),fs.ensureDirSync(i),a=JSON.stringify(a,null,2),fs.writeFileSync(n,a),a={__not_publish:!0},a=JSON.stringify(a),fs.writeFileSync(path.join(i,"config.json"),a),a={folder:"apps/".concat(c),id:c,success:!0},(0,utils_1.commonResponse)(f,a),[2]}})})}).catch(function(e){d.error.message=e,f.body=d})];case 2:return e.sent(),[3,4];case 3:return t=e.sent(),d.error.message=t,(0,utils_1.writeResponseLog)(t,!0),f.body=d,[3,4];case 4:return[2]}})})}function getAppAttributes(e){var e=path.join(e,"resources/config/config.json");return fs.existsSync(e)?(null==(e=JSON.parse(fs.readFileSync(e,"utf8")))?void 0:e.attributes)||{}:null}function checkAppVersion(e,t){return!!fs.existsSync(e)&&!(!(e=getZipAppVersion(e))||!t||semver.gt(e,t))}function getZipAppVersion(e){return fs.existsSync(e)?null==(e=JSON.parse(fs.readFileSync(e,"utf8")))?void 0:e.exbVersion:null}function updateNewAppConfig(e,t){if(!fs.existsSync(e))return null;var i=JSON.parse(fs.readFileSync(e,"utf8"))||{},r=(delete i.appProxies,delete i.historyLabels,delete i.attributes.express,JSON.stringify(i,null,2)),n=(new Date).getTime();i.timestamp="".concat(n),Object.keys(i.widgets).forEach(function(e){e=i.widgets[e];e.itemId&&e.uri&&delete e.uri}),fs.writeFileSync(e,r)}function checkIsSamePortal(e,t){return fs.existsSync(e)?!!(e=(null==(e=null===(e=JSON.parse(fs.readFileSync(e,"utf8"))||{})?void 0:e.attributes)?void 0:e.portalUrl)||"")&&(e=(0,exports.removeProtocol)(e),{isSamePortal:(0,exports.removeProtocol)(t)===e,appPortalUrl:e}):null}function checkIsSameMode(e,t){return void 0===t&&(t=!1),fs.existsSync(e)?{isSameMode:t===(t="boolean"==typeof(null==(e=null===(t=JSON.parse(fs.readFileSync(e,"utf8"))||{})?void 0:t.attributes)?void 0:e.express)&&(null==(e=null===t?void 0:t.attributes)?void 0:e.express)),express:t}:null}function checkIsSameType(e,t){return e=fs.realpathSync(e),!(!fs.existsSync(e)||(e=(null==(e=null===(e=JSON.parse(fs.readFileSync(e,"utf8"))||{})?void 0:e.attributes)?void 0:e.type)||"")&&(null==e?void 0:e.trim())!==(null==t?void 0:t.trim()))}(e=>{e.ExistedInfo="ExistedInfo",e.Info="Info"})(WidgetInfoType=WidgetInfoType||{});var removeProtocol=function(e,t){void 0===t&&(t=!1);return(0,exports.isProtocolRelative)(e)||(e=e.replace(/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,""),t&&1<e.length&&"/"===e[0]&&"/"===e[1])?e.slice(2):e},isProtocolRelative=(exports.removeProtocol=removeProtocol,function(e){return null!=e&&void 0!==e&&"/"===e[0]&&"/"===e[1]});function getImportAppMulter(){var e=multer.diskStorage({destination:function(e,t,i){try{Promise.resolve(!0).then(function(){fs.ensureDirSync(utils_1.appFolderPath);var e=fs.readdirSync(utils_1.appFolderPath),e=(0,utils_1.getFolderIndex)(e,0)+"",e=path.join(utils_1.appFolderPath,e),e=(fs.mkdirSync(e),path.join(e,"importAppZip"));fs.emptyDirSync(e),i(null,e)})}catch(e){console.log(e)}},filename:function(e,t,i){var t=t.originalname.split("."),r=t[t.length-1];i(null,"appZip."+(r=1===t.length?"zip":r))}});return multer({storage:e})}function checkIsAppValid(r){return __awaiter(this,void 0,void 0,function(){var t,i;return __generator(this,function(e){switch(e.label){case 0:return[4,verifyUploadedAppZip(r)];case 1:return t=e.sent()||[],i=!0,null!=t&&t.forEach(function(e){i=i&&e}),[2,i]}})})}function verifyUploadedAppZip(i){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){return(t=[]).push(checkFileExistInZip(i,"config.json")),t.push(checkFolderExistInZip(i,"jimu-ui")),t.push(checkFolderExistInZip(i,"jimu-theme")),t.push(checkFolderExistInZip(i,"jimu-layouts")),t.push(checkFolderExistInZip(i,"jimu-core")),t.push(checkFolderExistInZip(i,"jimu-for-builder")),t.push(checkFolderExistInZip(i,"widgets")),t.push(checkFolderExistInZip(i,"config")),[2,Promise.all(t)]})})}function checkFileExistInZip(t,i){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,JSZip.loadAsync(fs.readFileSync(t)).then(function(e){e=e.file(new RegExp(i));return!!(null!=e&&e.length&&0<e.length)})]})})}function checkFolderExistInZip(t,i){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,JSZip.loadAsync(fs.readFileSync(t)).then(function(e){e=e.folder(new RegExp(i));return!!(null!=e&&e.length&&0<e.length)})]})})}exports.isProtocolRelative=isProtocolRelative;var unZipToFolder=function(t,n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,(new JSZip).loadAsync(fs.readFileSync(t)).then(function(r){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(e){return i=[],fs.ensureDirSync(n),Object.keys(r.files).forEach(function(e){var t=(null==e?void 0:e.includes("/config.json"))&&!(null!=e&&e.includes("/widgets"))&&5===(null==e?void 0:e.split("/").length);null!=e&&e.includes("/resources")&&!t?i.push(createFileOfResources(e,n,r)):null!=e&&e.includes("/config.json")&&3===(null==e?void 0:e.split("/").length)?i.push(createFileOfResources(e,n,r,!0)):null!=e&&e.includes("/widgets")?i.push(createWidgetsFile(e,n,r)):null!=e&&e.includes("/thumbnail/")&&i.push(createThumbnailFile(e,n,r))}),[2,Promise.all(i)]})})})]})})};function createFileOfResources(e,t,i){return __awaiter(this,arguments,void 0,function(t,i,r,n){var o;return void 0===n&&(n=!1),__generator(this,function(e){return o=n?"resources/config/config.json":"resources/".concat(null==t?void 0:t.split("/resources/")[1]),o=path.join(i,o),[2,createFile(t,o,r)]})})}function createWidgetsFile(i,r,n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){return t=path.join(r,"importAppZip/widgets/".concat(null==i?void 0:i.split("/widgets/")[1])),[2,createFile(i,t,n)]})})}function createThumbnailFile(i,r,n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){return t=path.join(r,"/thumbnail/".concat(null==i?void 0:i.split("/thumbnail/")[1])),[2,createFile(i,t,n)]})})}function createFile(r,n,o){return __awaiter(this,void 0,void 0,function(){var t,i;return __generator(this,function(e){return t=o.file(r),i=normalizeZipPath(n),null==t||!0===t.dir?(fs.ensureDirSync(i),[2,Promise.resolve()]):[2,t.async("nodebuffer").then(function(e){if(!fs.existsSync(i))return fs.writeFileSync(i,e)})]})})}function normalizeZipPath(e){return e=(e=path.normalize(e)).replace(/\\/g,"/")}function checkWidgetVersion(e){var r,t=path.join(utils_1.CLIENT_PATH,utils_1.DIST_FOLDER),n=[],o=JSON.parse(fs.readFileSync(e,"utf8")),s=getAllWidgetsInfo(t,WidgetInfoType.Info)||[],e=o.widgets||{};if(o.widgets)for(var i in e)(e=>{var t=null==(r=o.widgets)?void 0:r[e],e=null==(r=s.filter(function(e){return e.uri===t.uri}))?void 0:r[0],i=null==t?void 0:t.version;e&&0!==(null==s?void 0:s.length)&&(e=null==(r=null==e?void 0:e.manifest)?void 0:r.version,semver.gt(i,e))&&n.push({widgetLabel:null==t?void 0:t.label,widgetVersionInZip:i})})(i);return n}function copyCustomWidget(r,u){return __awaiter(this,void 0,void 0,function(){var n,t,o,s,l,i=this;return __generator(this,function(e){switch(e.label){case 0:return n=path.join(utils_1.CLIENT_PATH,utils_1.DIST_FOLDER),t=JSON.parse(fs.readFileSync(r,"utf8")),t=(0,utils_1.getWidgetsUriFromAppConfig)(t),t=(null==t?void 0:t.customWidgetsUri)||[],o=getAllWidgetsInfo(n,WidgetInfoType.Info)||getAllWidgetsInfo(n,WidgetInfoType.ExistedInfo)||[],s=getAllWidgetsInfo(n,WidgetInfoType.ExistedInfo)||getAllWidgetsInfo(n,WidgetInfoType.Info)||[],l=getAllWidgetsInfo("".concat(u,"/importAppZip"),WidgetInfoType.Info)||[],[4,Promise.all(t.map(function(r){return __awaiter(i,void 0,void 0,function(){var t,i;return __generator(this,function(e){return 0<(null==(i=null==o?void 0:o.filter(function(e){return(null==e?void 0:e.uri)===r}))?void 0:i.length)||0<(null==(i=null==s?void 0:s.filter(function(e){return(null==e?void 0:e.uri)===r}))?void 0:i.length)?[2,Promise.resolve()]:((i=null==(i=null==l?void 0:l.filter(function(e){return(null==e?void 0:e.uri)===r}))?void 0:i[0])&&((t=getCustomWidgetInfoIndex())||0===t?o.splice(t,0,i):o.push(i),t=JSON.stringify(o,null,2),fs.writeFileSync(path.join(n,utils_1.WIDGET_INFO_PATH),t),fs.existsSync(path.join(n,utils_1.WIDGET_EXISTED_INFO_PATH)))&&(s.push(i),t=JSON.stringify(s,null,2),fs.writeFileSync(path.join(n,utils_1.WIDGET_EXISTED_INFO_PATH),t)),fs.existsSync(path.join(n,r))?[2]:[2,fs.copy(path.join("".concat(u,"/importAppZip"),r),path.join(n,r))])})})}))];case 1:return e.sent(),[2]}})})}function getCustomWidgetInfoIndex(){var e=path.join(utils_1.CLIENT_PATH,utils_1.DIST_FOLDER),i=getLastExistedWidgetUri(),e=getAllWidgetsInfo(e,WidgetInfoType.Info)||[],r=null;return e.forEach(function(e,t){e.uri===i&&(r=t+1)}),r}function getLastExistedWidgetUri(){var e=path.join(utils_1.CLIENT_PATH,utils_1.DIST_FOLDER);return fs.existsSync(path.join(e,utils_1.WIDGET_EXISTED_INFO_PATH))?null==(e=null==(e=getAllWidgetsInfo(e,WidgetInfoType.ExistedInfo))?void 0:e[(null==e?void 0:e.length)-1])?void 0:e.uri:null}function getAllWidgetsInfo(e,t){t=(t=void 0===t?WidgetInfoType.ExistedInfo:t)===WidgetInfoType.Info?fs.existsSync(path.join(e,utils_1.WIDGET_INFO_PATH))?path.join(e,utils_1.WIDGET_INFO_PATH):null:fs.existsSync(path.join(e,utils_1.WIDGET_EXISTED_INFO_PATH))?path.join(e,utils_1.WIDGET_EXISTED_INFO_PATH):null;return t?JSON.parse(fs.readFileSync(t,"utf8")):null}exports.unZipToFolder=unZipToFolder;
var __awaiter=this&&this.__awaiter||function(t,u,s,c){return new(s=s||Promise)(function(n,e){function r(t){try{o(c.next(t))}catch(t){e(t)}}function a(t){try{o(c.throw(t))}catch(t){e(t)}}function o(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(r,a)}o((c=c.apply(t,u||[])).next())})},__generator=this&&this.__generator||function(r,a){var o,u,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=t(0),i.throw=t(1),i.return=t(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function t(n){return function(t){var e=[n,t];if(o)throw new TypeError("Generator is already executing.");for(;c=i&&e[i=0]?0:c;)try{if(o=1,u&&(s=2&e[0]?u.return:e[0]?u.throw||((s=u.return)&&s.call(u),0):u.next)&&!(s=s.call(u,e[1])).done)return s;switch(u=0,(e=s?[2&e[0],s.value]:e)[0]){case 0:case 1:s=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,u=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3]))c.label=e[1];else if(6===e[0]&&c.label<s[1])c.label=s[1],s=e;else{if(!(s&&c.label<s[2])){s[2]&&c.ops.pop(),c.trys.pop();continue}c.label=s[2],c.ops.push(e)}}e=a.call(r,c)}catch(t){e=[6,t],u=0}finally{o=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}},path=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle404=handle404,require("path")),path_utils_1=require("./path-utils");function handle404(c){return function(u,s){return __awaiter(this,void 0,void 0,function(){var e,n,r,a,o;return __generator(this,function(t){switch(t.label){case 0:return t.trys.push([0,7,,8]),e=c.urlPath,n=c.path,r=u.path,e==="".concat(c.mountPath,"site/")&&(r!==c.mountPath&&r!=="".concat(c.mountPath,"page/set-portalurl")&&r!=="".concat(c.mountPath,"page/landing")||(r="".concat(c.mountPath,"site")),n=n.substr(0,n.length-"site/".length)),new RegExp("^".concat(e)).test((0,path_utils_1.fixPath)(r))?[3,2]:[4,s()];case 1:return t.sent(),[2];case 2:return 404===u.response.status?[3,4]:[4,s()];case 3:return t.sent(),[2];case 4:return(0,path_utils_1.isIndexPath)(r,e)?(u.res.setHeader("Cache-Control","no-cache"),a=u.response,[4,(0,path_utils_1.readAndreplaceContent)(path.join(n,"index.html"))]):[3,6];case 5:return a.body=t.sent(),[2];case 6:return[3,8];case 7:return o=t.sent(),u.response.body={error:o},[3,8];case 8:return[4,s()];case 9:return t.sent(),[2]}})})}}require("../../global");